# 开发者指南与质量门槛（SAGE - 包级）

- 版本：2026-01-14
- 适用范围：当前包（本文件位于 `packages/<package>/docs/governance/DEVELOPER_GUIDE.md`）

本指南把“制度”落到“能执行的工程约束”。本包的所有代码改动必须遵守以下规则。

______________________________________________________________________

## 1. 架构守护机制（强制）

### 1.1 依赖层级（禁止向上依赖 / 禁止循环依赖）

SAGE 采用 L1-L5 分层。任何“向上依赖”都视为架构违规，必须阻断合入。

- L1：`sage-common`
- L2：`sage-platform`
- L3：`sage-kernel`, `sage-libs`
- L4：`sage-middleware`
- L5：`sage-cli`, `sage-tools`

### 1.2 Libs vs Middleware 规则（强制）

如果代码需要调用“向上能力”（例如 VectorDB/Memory/Refiner/外部服务/重后端/网络服务），它 **不是库**，必须放在
`sage-middleware`（operators/components）。

> 迁移时不保留兼容 re-export shim：更新所有调用方，快速失败。

### 1.3 Control Plane-only（强制）

LLM 引擎操作必须走 Control Plane，禁止直接启动引擎/直连端口。

______________________________________________________________________

## 2. 自动化检查（CI + pre-commit）（强制）

### 2.1 安装一致性

- 必须使用 `./quickstart.sh --dev --yes` 安装开发环境。
- 禁止手工 `pip install` 临时安装依赖（依赖必须写入 `pyproject.toml`）。

### 2.2 本地质量与测试

建议在仓库根目录执行：

- `sage-dev quality check --all-files`
- `sage-dev project test --coverage`

______________________________________________________________________

## 3. 强制规范（必须出现的质量门槛）

### 3.1 Mock-First（强制）

- CI 必须能在无 GPU 环境跑通核心测试。
- 新增能力必须提供 Mock/CPU 路径，避免把“硬件”当作默认前提。

### 3.2 Fail-Fast（强制）

- 禁止静默默认值、禁止隐式回退（fallback）。
- 关键配置缺失必须明确报错（例如用 `os.environ["KEY"]` 或显式校验并抛异常）。

### 3.3 Protocol-First（按适用范围执行）

当本包提供“公共接口/抽象/跨包契约”时：

- 先定义接口/类型（Protocol/ABC/Schema）
- 再实现具体逻辑
- 再补测试与示例

______________________________________________________________________

## 4. 新模块/新能力接入步骤（可执行）

1. **定义范围**：确认属于本包；若需要向上能力，按规则提升到 `sage-middleware`。
1. **接口优先**：先定义可复用接口（如适用）。
1. **最小可跑**：提供无 GPU 的最小可跑实现（Mock/CPU）。
1. **测试**：至少包含单元测试；关键路径补回归测试。
1. **文档**：更新本包 README 与本包 governance 文档（必要时）。
1. **质量门槛**：本地 `sage-dev quality` 与测试通过。

______________________________________________________________________

## 5. 常见错误与修复

- **依赖倒挂**：`sage-libs` 引入 `sage-middleware` → 必须拆分/上移实现。
- **文档位置违规**：禁止在根 `docs/` 放 Markdown；包级文档只能放 `packages/<pkg>/docs/`。
- **依赖未声明**：新增依赖未写入 `pyproject.toml` → 必须补齐声明并统一版本。
