cmake_minimum_required(VERSION 3.20...3.27)
project(
    ${SKBUILD_PROJECT_NAME}
    VERSION ${SKBUILD_PROJECT_VERSION}
    LANGUAGES CXX C
)

# ============================================================================
# å…¨å±€ç¼–è¯‘è®¾ç½®
# ============================================================================
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# ============================================================================
# æŸ¥æ‰¾ä¾èµ–
# ============================================================================
find_package(Python REQUIRED COMPONENTS Interpreter Development.Module)
find_package(pybind11 CONFIG REQUIRED)
find_package(Threads REQUIRED)
find_package(OpenMP)

message(STATUS "")
message(STATUS "=== SAGE Middleware Build Configuration ===")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
if(OpenMP_CXX_FOUND)
    message(STATUS "OpenMP: ${OpenMP_CXX_VERSION}")
endif()
message(STATUS "==========================================")
message(STATUS "")

# ============================================================================
# sage_db - Vector Database C++ Library + Python Bindings
# ============================================================================
set(SAGE_DB_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/middleware/components/sage_db")
set(SAGE_DB_SUBMODULE "${SAGE_DB_DIR}/sageDB")

if(EXISTS "${SAGE_DB_SUBMODULE}/CMakeLists.txt")
    message(STATUS "Adding sage_db submodule...")

    # è®©å­æ¨¡å—ä¿æŒç‹¬ç«‹å®Œæ•´ï¼šå¯ä»¥è‡ªå·±ç¼–è¯‘ã€æµ‹è¯•ã€æ„å»º Python bindings
    # Middleware åªæ˜¯å¼•ç”¨å­æ¨¡å—å·²ç»æ„å»ºå¥½çš„ Python bindings
    # ä½†åœ¨ middleware æ„å»ºæ—¶è·³è¿‡æµ‹è¯•ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
    set(BUILD_TESTS OFF CACHE BOOL "Skip tests in middleware build" FORCE)
    set(BUILD_PYTHON_BINDINGS ON CACHE BOOL "Enable Python bindings in submodule" FORCE)
    add_subdirectory(${SAGE_DB_SUBMODULE} sage_db_build)

    message(STATUS "  âœ“ sage_db configured (with independent Python bindings)")
else()
    message(WARNING "sage_db submodule not found at ${SAGE_DB_SUBMODULE}")
endif()

# ============================================================================
# sage_flow - Stream Processing C++ Library + Python Bindings
# ============================================================================
set(SAGE_FLOW_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/middleware/components/sage_flow")
set(SAGE_FLOW_SUBMODULE "${SAGE_FLOW_DIR}/sageFlow")

if(EXISTS "${SAGE_FLOW_SUBMODULE}/CMakeLists.txt")
    message(STATUS "Adding sage_flow submodule...")

    # è®©å­æ¨¡å—ä¿æŒç‹¬ç«‹å®Œæ•´ï¼šå¯ä»¥è‡ªå·±ç¼–è¯‘ã€æµ‹è¯•ã€æ„å»º Python bindings
    # ä½†åœ¨ middleware æ„å»ºæ—¶è·³è¿‡æµ‹è¯•ä»¥é¿å…å¾ªç¯ä¾èµ–é—®é¢˜
    set(BUILD_TESTS OFF CACHE BOOL "Skip tests to avoid circular dependencies" FORCE)
    set(BUILD_PYTHON_BINDINGS ON CACHE BOOL "Enable Python bindings in submodule" FORCE)
    add_subdirectory(${SAGE_FLOW_SUBMODULE} sage_flow_build)

    message(STATUS "  âœ“ sage_flow configured (with independent Python bindings)")
else()
    message(WARNING "sage_flow submodule not found at ${SAGE_FLOW_SUBMODULE}")
endif()

# ============================================================================
# sage_tsdb - Time Series Database C++ Library + Python Bindings
# ============================================================================
set(SAGE_TSDB_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/middleware/components/sage_tsdb")
set(SAGE_TSDB_SUBMODULE "${SAGE_TSDB_DIR}/sageTSDB")

if(EXISTS "${SAGE_TSDB_SUBMODULE}/CMakeLists.txt")
    message(STATUS "Adding sage_tsdb submodule...")

    # è®©å­æ¨¡å—ä¿æŒç‹¬ç«‹å®Œæ•´ï¼šå¯ä»¥è‡ªå·±ç¼–è¯‘ã€æµ‹è¯•ã€æ„å»º Python bindings
    # ä½†åœ¨ middleware æ„å»ºæ—¶è·³è¿‡æµ‹è¯•ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
    set(BUILD_TESTS OFF CACHE BOOL "Skip tests in middleware build" FORCE)
    set(BUILD_PYTHON_BINDINGS ON CACHE BOOL "Enable Python bindings in submodule" FORCE)
    add_subdirectory(${SAGE_TSDB_SUBMODULE} sage_tsdb_build)

    message(STATUS "  âœ“ sage_tsdb configured (with independent Python bindings)")
else()
    message(WARNING "sage_tsdb submodule not found at ${SAGE_TSDB_SUBMODULE}")
endif()

# ============================================================================
# é…ç½®æ‘˜è¦
# ============================================================================
message(STATUS "")
message(STATUS "SAGE Middleware C++ Extensions - Build Summary")
message(STATUS "===============================================")
message(STATUS "Project: ${SKBUILD_PROJECT_NAME} v${SKBUILD_PROJECT_VERSION}")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "")
message(STATUS "ğŸ” SKBUILD Variables:")
message(STATUS "  SKBUILD_STATE: ${SKBUILD_STATE}")
message(STATUS "  SKBUILD_PLATLIB_DIR: ${SKBUILD_PLATLIB_DIR}")
message(STATUS "")
message(STATUS "Extensions:")
if(TARGET _sage_db)
    message(STATUS "  âœ“ sage_db")
else()
    message(STATUS "  âœ— sage_db (not configured)")
endif()
if(TARGET _sage_flow)
    message(STATUS "  âœ“ sage_flow")
else()
    message(STATUS "  âœ— sage_flow (not configured)")
endif()
if(TARGET _sage_tsdb)
    message(STATUS "  âœ“ sage_tsdb")
else()
    message(STATUS "  âœ— sage_tsdb (not configured)")
endif()
message(STATUS "===============================================")
message(STATUS "")
