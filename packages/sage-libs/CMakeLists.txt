cmake_minimum_required(VERSION 3.10...3.27)
project(
    ${SKBUILD_PROJECT_NAME}
    VERSION ${SKBUILD_PROJECT_VERSION}
    LANGUAGES CXX C
)

# ============================================================================
# ÂÖ®Â±ÄÁºñËØëËÆæÁΩÆ
# ============================================================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ÁºñËØëÈÄâÈ°π
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# ============================================================================
# Êü•Êâæ‰æùËµñ
# ============================================================================
find_package(Python REQUIRED COMPONENTS Interpreter Development.Module)
find_package(pybind11 CONFIG REQUIRED)

message(STATUS "")
message(STATUS "=== SAGE Libs Build Configuration ===")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "======================================")
message(STATUS "")

# ============================================================================
# LibAMM - Approximate Matrix Multiplication Library
# ============================================================================
set(LIBAMM_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/libs/libamm")

# ËÆæÁΩÆÁªü‰∏ÄÁöÑÊûÑÂª∫ËæìÂá∫ÁõÆÂΩï
set(SAGE_BUILD_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../.sage/build")

if(EXISTS "${LIBAMM_DIR}/CMakeLists.txt")
    message(STATUS "Adding LibAMM submodule...")
    message(STATUS "  Build output: ${SAGE_BUILD_ROOT}/libamm")

    # Ê£ÄÊü• PyTorch ÊòØÂê¶ÂèØÁî®ÔºàLibAMM ÈúÄË¶ÅÔºâ
    execute_process(
        COMMAND ${Python_EXECUTABLE} -c "import torch; print(torch.__version__)"
        RESULT_VARIABLE TORCH_CHECK_RESULT
        OUTPUT_VARIABLE TORCH_VERSION
        ERROR_QUIET
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )

    if(TORCH_CHECK_RESULT EQUAL 0)
        message(STATUS "  PyTorch found: ${TORCH_VERSION}")

        # Ê£ÄÊü• PyTorch ÊòØÂê¶‰∏∫ CUDA ÁâàÊú¨ÔºàÈÄöËøáÁâàÊú¨Â≠óÁ¨¶‰∏≤Ê£ÄÊµãÔºåÂ¶Ç "2.7.1+cu126"Ôºâ
        string(FIND "${TORCH_VERSION}" "+cu" CUDA_POS)
        if(NOT CUDA_POS EQUAL -1)
            # PyTorch ÊòØ CUDA ÁâàÊú¨
            message(STATUS "  PyTorch type: CUDA version detected")
            find_program(NVCC_EXECUTABLE nvcc)
            if(NOT NVCC_EXECUTABLE)
                message(STATUS "  CUDA compiler (nvcc) not found")
                message(STATUS "  ")
                message(STATUS "========================================")
                message(STATUS "  Ëá™Âä®ÂàáÊç¢Âà∞ CPU ÁâàÊú¨ÁöÑ PyTorch")
                message(STATUS "========================================")
                message(STATUS "")
                message(STATUS "LibAMM ÈúÄË¶ÅÁºñËØë C++ Êâ©Â±ïÔºå‰ΩÜÊ£ÄÊµãÂà∞Ôºö")
                message(STATUS "  - PyTorch ÁâàÊú¨: ${TORCH_VERSION} (CUDA)")
                message(STATUS "  - CUDA ÁºñËØëÂô®: Êú™ÊâæÂà∞")
                message(STATUS "")
                message(STATUS "Â∞ÜËá™Âä®ÂÆâË£Ö CPU ÁâàÊú¨ÁöÑ PyTorch...")
                message(STATUS "")

                # Ëá™Âä®ÂÆâË£Ö CPU ÁâàÊú¨ÁöÑ PyTorch
                execute_process(
                    COMMAND ${Python_EXECUTABLE} -m pip install --force-reinstall
                            "torch>=2.0.0" --index-url https://download.pytorch.org/whl/cpu
                    RESULT_VARIABLE TORCH_INSTALL_RESULT
                    OUTPUT_VARIABLE TORCH_INSTALL_OUTPUT
                    ERROR_VARIABLE TORCH_INSTALL_ERROR
                )

                if(TORCH_INSTALL_RESULT EQUAL 0)
                    message(STATUS "‚úÖ ÊàêÂäüÂÆâË£Ö CPU ÁâàÊú¨ÁöÑ PyTorch")
                    message(STATUS "   Áé∞Âú®ÂèØ‰ª•ÁªßÁª≠ÁºñËØë LibAMM...")
                    message(STATUS "========================================")
                    message(STATUS "")
                else()
                    message(FATAL_ERROR "‚ùå Êó†Ê≥ïËá™Âä®ÂÆâË£Ö CPU ÁâàÊú¨ÁöÑ PyTorch\n${TORCH_INSTALL_ERROR}")
                endif()
            else()
                message(STATUS "  CUDA compiler found: ${NVCC_EXECUTABLE}")
                message(STATUS "  Will build LibAMM with CUDA support")
            endif()
        else()
            # PyTorch ÊòØ CPU ÁâàÊú¨
            message(STATUS "  PyTorch type: CPU-only")
            message(STATUS "  Perfect for LibAMM CPU-only build")
        endif()

        message(STATUS "  Building LibAMM...")

        # ËÆæÁΩÆ LibAMM ÁöÑÁºñËØëÈÄâÈ°π
        set(BUILD_BENCHMARK OFF CACHE BOOL "Skip LibAMM benchmark" FORCE)
        set(ENABLE_PYBIND ON CACHE BOOL "Enable Python bindings" FORCE)
        set(ENABLE_HDF5 ON CACHE BOOL "Enable HDF5 support" FORCE)
        set(ENABLE_PAPI OFF CACHE BOOL "Disable PAPI" FORCE)

        # ËÆæÁΩÆ CUDACXX ÁéØÂ¢ÉÂèòÈáèÔºàÂç≥‰Ωø‰∏çÂ≠òÂú® nvcc ‰πüËÆæÁΩÆÔºåÂèÇËÄÉ buildCPUOnly.shÔºâ
        set(ENV{CUDACXX} "/usr/local/cuda/bin/nvcc")

        add_subdirectory(${LIBAMM_DIR} ${SAGE_BUILD_ROOT}/libamm)
        message(STATUS "  ‚úì LibAMM configured (with NumPy interface)")
    else()
        message(WARNING "  PyTorch not found - skipping LibAMM build")
        message(WARNING "  To build LibAMM, install with: pip install isage-libs[amm]")
        message(WARNING "  Or install PyTorch: pip install torch>=2.0.0")
    endif()
else()
    message(WARNING "LibAMM submodule not found at ${LIBAMM_DIR}")
    message(WARNING "  To build LibAMM, ensure the submodule is initialized")
endif()

# ============================================================================
# ÈÖçÁΩÆÊëòË¶Å
# ============================================================================
message(STATUS "")
message(STATUS "SAGE Libs C++ Extensions - Build Summary")
message(STATUS "=========================================")
message(STATUS "Project: ${SKBUILD_PROJECT_NAME} v${SKBUILD_PROJECT_VERSION}")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "")
message(STATUS "üîç SKBUILD Variables:")
message(STATUS "  SKBUILD_STATE: ${SKBUILD_STATE}")
message(STATUS "  SKBUILD_PLATLIB_DIR: ${SKBUILD_PLATLIB_DIR}")
message(STATUS "")
message(STATUS "Extensions:")
if(TARGET PyAMM)
    message(STATUS "  ‚úì LibAMM (PyAMM)")
else()
    message(STATUS "  ‚úó LibAMM (not configured)")
endif()
message(STATUS "=========================================")
message(STATUS "")
