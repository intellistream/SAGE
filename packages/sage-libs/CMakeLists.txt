cmake_minimum_required(VERSION 3.10...3.27)
project(
    ${SKBUILD_PROJECT_NAME}
    VERSION ${SKBUILD_PROJECT_VERSION}
    LANGUAGES CXX C
)

# ============================================================================
# å…¨å±€ç¼–è¯‘è®¾ç½®
# ============================================================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# ============================================================================
# æŸ¥æ‰¾ä¾èµ–
# ============================================================================
find_package(Python REQUIRED COMPONENTS Interpreter Development.Module)
find_package(pybind11 CONFIG REQUIRED)

message(STATUS "")
message(STATUS "=== SAGE Libs Build Configuration ===")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "======================================")
message(STATUS "")

# ============================================================================
# LibAMM - Approximate Matrix Multiplication Library
# ============================================================================
set(LIBAMM_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/libs/libamm")

# è®¾ç½®ç»Ÿä¸€çš„æ„å»ºè¾“å‡ºç›®å½•
set(SAGE_BUILD_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../../.sage/build")

if(EXISTS "${LIBAMM_DIR}/CMakeLists.txt")
    message(STATUS "Adding LibAMM submodule...")
    message(STATUS "  Build output: ${SAGE_BUILD_ROOT}/libamm")

    # æ£€æŸ¥ PyTorch æ˜¯å¦å¯ç”¨ï¼ˆLibAMM éœ€è¦ï¼‰
    execute_process(
        COMMAND ${Python_EXECUTABLE} -c "import torch; print(torch.__version__)"
        RESULT_VARIABLE TORCH_CHECK_RESULT
        OUTPUT_VARIABLE TORCH_VERSION
        ERROR_QUIET
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )

    if(TORCH_CHECK_RESULT EQUAL 0)
        message(STATUS "  PyTorch found: ${TORCH_VERSION}")

        # æ£€æŸ¥ PyTorch æ˜¯å¦ä¸º CUDA ç‰ˆæœ¬ï¼ˆé€šè¿‡ç‰ˆæœ¬å­—ç¬¦ä¸²æ£€æµ‹ï¼Œå¦‚ "2.7.1+cu126"ï¼‰
        string(FIND "${TORCH_VERSION}" "+cu" CUDA_POS)
        if(NOT CUDA_POS EQUAL -1)
            # PyTorch æ˜¯ CUDA ç‰ˆæœ¬
            message(STATUS "  PyTorch type: CUDA version detected")
            find_program(NVCC_EXECUTABLE nvcc)
            if(NOT NVCC_EXECUTABLE)
                message(STATUS "  CUDA compiler (nvcc) not found")
                message(STATUS "  ")
                message(STATUS "========================================")
                message(STATUS "  è‡ªåŠ¨åˆ‡æ¢åˆ° CPU ç‰ˆæœ¬çš„ PyTorch")
                message(STATUS "========================================")
                message(STATUS "")
                message(STATUS "LibAMM éœ€è¦ç¼–è¯‘ C++ æ‰©å±•ï¼Œä½†æ£€æµ‹åˆ°ï¼š")
                message(STATUS "  - PyTorch ç‰ˆæœ¬: ${TORCH_VERSION} (CUDA)")
                message(STATUS "  - CUDA ç¼–è¯‘å™¨: æœªæ‰¾åˆ°")
                message(STATUS "")
                message(STATUS "å°†è‡ªåŠ¨å®‰è£… CPU ç‰ˆæœ¬çš„ PyTorch...")
                message(STATUS "")

                # è‡ªåŠ¨å®‰è£… CPU ç‰ˆæœ¬çš„ PyTorch
                execute_process(
                    COMMAND ${Python_EXECUTABLE} -m pip install --force-reinstall
                            "torch>=2.0.0" --index-url https://download.pytorch.org/whl/cpu
                    RESULT_VARIABLE TORCH_INSTALL_RESULT
                    OUTPUT_VARIABLE TORCH_INSTALL_OUTPUT
                    ERROR_VARIABLE TORCH_INSTALL_ERROR
                )

                if(TORCH_INSTALL_RESULT EQUAL 0)
                    message(STATUS "âœ… æˆåŠŸå®‰è£… CPU ç‰ˆæœ¬çš„ PyTorch")
                    message(STATUS "   ç°åœ¨å¯ä»¥ç»§ç»­ç¼–è¯‘ LibAMM...")
                    message(STATUS "========================================")
                    message(STATUS "")
                else()
                    message(FATAL_ERROR "âŒ æ— æ³•è‡ªåŠ¨å®‰è£… CPU ç‰ˆæœ¬çš„ PyTorch\n${TORCH_INSTALL_ERROR}")
                endif()
            else()
                message(STATUS "  CUDA compiler found: ${NVCC_EXECUTABLE}")
                message(STATUS "  Will build LibAMM with CUDA support")
            endif()
        else()
            # PyTorch æ˜¯ CPU ç‰ˆæœ¬
            message(STATUS "  PyTorch type: CPU-only")
            message(STATUS "  Perfect for LibAMM CPU-only build")
        endif()

        message(STATUS "  Building LibAMM...")

        # è®¾ç½® LibAMM çš„ç¼–è¯‘é€‰é¡¹
        set(BUILD_BENCHMARK OFF CACHE BOOL "Skip LibAMM benchmark" FORCE)
        set(ENABLE_PYBIND ON CACHE BOOL "Enable Python bindings" FORCE)
        set(ENABLE_HDF5 ON CACHE BOOL "Enable HDF5 support" FORCE)
        set(ENABLE_PAPI OFF CACHE BOOL "Disable PAPI" FORCE)

        # è®¾ç½® CUDACXX ç¯å¢ƒå˜é‡ï¼ˆå³ä½¿ä¸å­˜åœ¨ nvcc ä¹Ÿè®¾ç½®ï¼Œå‚è€ƒ buildCPUOnly.shï¼‰
        set(ENV{CUDACXX} "/usr/local/cuda/bin/nvcc")

        add_subdirectory(${LIBAMM_DIR} ${SAGE_BUILD_ROOT}/libamm)
        message(STATUS "  âœ“ LibAMM configured (with NumPy interface)")
    else()
        message(WARNING "  PyTorch not found - skipping LibAMM build")
        message(WARNING "  To build LibAMM, install with: pip install isage-libs[amm]")
        message(WARNING "  Or install PyTorch: pip install torch>=2.0.0")
    endif()
else()
    message(WARNING "LibAMM submodule not found at ${LIBAMM_DIR}")
    message(WARNING "  To build LibAMM, ensure the submodule is initialized")
endif()

# ============================================================================
# é…ç½®æ‘˜è¦
# ============================================================================
message(STATUS "")
message(STATUS "SAGE Libs C++ Extensions - Build Summary")
message(STATUS "=========================================")
message(STATUS "Project: ${SKBUILD_PROJECT_NAME} v${SKBUILD_PROJECT_VERSION}")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "pybind11: ${pybind11_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "")
message(STATUS "ğŸ” SKBUILD Variables:")
message(STATUS "  SKBUILD_STATE: ${SKBUILD_STATE}")
message(STATUS "  SKBUILD_PLATLIB_DIR: ${SKBUILD_PLATLIB_DIR}")
message(STATUS "")
message(STATUS "Extensions:")
if(TARGET PyAMM)
    message(STATUS "  âœ“ LibAMM (PyAMM)")
else()
    message(STATUS "  âœ— LibAMM (not configured)")
endif()
message(STATUS "=========================================")
message(STATUS "")

# ============================================================================
# å®‰è£… Python æºæ–‡ä»¶
# ============================================================================
# scikit-build-core éœ€è¦æ˜ç¡®å‘ŠçŸ¥è¦å®‰è£…å“ªäº› Python æ–‡ä»¶
# è¿™ç¡®ä¿çº¯ Python ä»£ç ï¼ˆå¦‚ sage.libs.context.compressionï¼‰ä¹Ÿè¢«æ­£ç¡®å®‰è£…
message(STATUS "Configuring Python source installation...")

# å®‰è£…æ‰€æœ‰ Python åŒ…åˆ° site-packages/sage
install(
    DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/"
    DESTINATION "${SKBUILD_PLATLIB_DIR}/sage"
    COMPONENT python
    FILES_MATCHING
    PATTERN "*.py"
    PATTERN "*.pyi"
    PATTERN "py.typed"
    PATTERN "__pycache__" EXCLUDE
    PATTERN "*.pyc" EXCLUDE
    PATTERN ".pytest_cache" EXCLUDE
    PATTERN "tests" EXCLUDE
)

message(STATUS "  âœ“ Python source files will be installed to: ${SKBUILD_PLATLIB_DIR}/sage")
message(STATUS "")
