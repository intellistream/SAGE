"""
Data Paths Configuration for Agent Benchmark

This module provides centralized management of data paths for agent benchmark.
It follows SAGE's two-layer data architecture:
1. Source Layer: Original data accessed via DataManager
2. Runtime Layer: Generated data for specific experiments

Usage:
    from sage.benchmark.benchmark_agent.data_paths import (
        get_source_paths,
        get_runtime_paths,
        ensure_runtime_dirs,
        DataPathsConfig,
    )

    # Get source data paths (read-only)
    source = get_source_paths()
    tools_file = source.tools_catalog

    # Get runtime data paths
    runtime = get_runtime_paths()
    output_dir = runtime.tool_selection_dir

    # Ensure runtime directories exist
    ensure_runtime_dirs()
"""

import os
from dataclasses import dataclass
from pathlib import Path
from typing import Optional


def _find_sage_root() -> Path:
    """
    Find SAGE project root directory.

    Looks for .git directory or SAGE_ROOT environment variable.
    """
    # Check environment variable first
    if "SAGE_ROOT" in os.environ:
        return Path(os.environ["SAGE_ROOT"])

    # Walk up from current file to find project root
    current = Path(__file__).resolve()
    while current.parent != current:
        if (current / ".git").exists() and (current / "packages").exists():
            return current
        current = current.parent

    # Fallback to current working directory
    return Path.cwd()


def _find_package_root() -> Path:
    """Find sage-benchmark package root."""
    current = Path(__file__).resolve()
    # Navigate up to find sage-benchmark/src
    while current.parent != current:
        if current.name == "sage-benchmark":
            return current
        current = current.parent

    # Fallback
    sage_root = _find_sage_root()
    return sage_root / "packages" / "sage-benchmark"


@dataclass
class SourcePaths:
    """
    Paths to source data (read-only, via DataManager).

    These are the original data files that should not be modified directly.
    Use DataManager for standard access.
    """

    # Root directories
    data_root: Path

    # Agent benchmark data
    benchmark_dir: Path
    benchmark_splits_dir: Path
    benchmark_metadata_dir: Path

    # Agent tools data
    tools_dir: Path
    tools_data_dir: Path

    # Agent SFT data
    sft_dir: Path
    sft_data_dir: Path

    @property
    def tool_selection_file(self) -> Path:
        """Tool selection benchmark data file."""
        return self.benchmark_splits_dir / "tool_selection.jsonl"

    @property
    def task_planning_file(self) -> Path:
        """Task planning benchmark data file."""
        return self.benchmark_splits_dir / "task_planning.jsonl"

    @property
    def timing_judgment_file(self) -> Path:
        """Timing judgment benchmark data file."""
        return self.benchmark_splits_dir / "timing_judgment.jsonl"

    @property
    def tools_catalog(self) -> Path:
        """Tools catalog file."""
        return self.tools_data_dir / "tool_catalog.jsonl"

    @property
    def tools_categories(self) -> Path:
        """Tools categories file."""
        return self.tools_data_dir / "categories.json"

    @property
    def sft_conversations(self) -> Path:
        """SFT conversations file."""
        return self.sft_data_dir / "sft_conversations.jsonl"


@dataclass
class RuntimePaths:
    """
    Paths to runtime/generated data.

    These are generated by prepare_*.py scripts for specific experiments.
    Stored in .sage/benchmark/data/ (gitignored).
    """

    # Root directories
    data_root: Path
    results_root: Path

    # Task-specific data directories
    tool_selection_dir: Path
    task_planning_dir: Path
    timing_judgment_dir: Path

    # Results directories
    tool_selection_results: Path
    task_planning_results: Path
    timing_judgment_results: Path

    @property
    def tool_selection_base(self) -> Path:
        """Base tool selection data file."""
        return self.tool_selection_dir / "tool_selection.jsonl"

    def tool_selection_with_candidates(self, num_candidates: int) -> Path:
        """Tool selection data file with specific candidate pool size."""
        return self.tool_selection_dir / f"tool_selection_{num_candidates}.jsonl"

    @property
    def task_planning_base(self) -> Path:
        """Base task planning data file."""
        return self.task_planning_dir / "task_planning.jsonl"

    def timing_split_file(self, split: str) -> Path:
        """Timing judgment data file for specific split."""
        return self.timing_judgment_dir / f"{split}.jsonl"


@dataclass
class DataPathsConfig:
    """
    Complete data paths configuration.

    Provides access to both source and runtime paths.
    """

    source: SourcePaths
    runtime: RuntimePaths

    @property
    def sage_root(self) -> Path:
        """SAGE project root."""
        return _find_sage_root()

    @property
    def package_root(self) -> Path:
        """sage-benchmark package root."""
        return _find_package_root()


# Module-level cached config
_config: Optional[DataPathsConfig] = None


def get_source_paths() -> SourcePaths:
    """
    Get source data paths.

    Returns:
        SourcePaths object with paths to original data files.
    """
    package_root = _find_package_root()
    data_root = package_root / "src" / "sage" / "data" / "sources"

    return SourcePaths(
        data_root=data_root,
        # Agent benchmark
        benchmark_dir=data_root / "agent_benchmark",
        benchmark_splits_dir=data_root / "agent_benchmark" / "splits",
        benchmark_metadata_dir=data_root / "agent_benchmark" / "metadata",
        # Agent tools
        tools_dir=data_root / "agent_tools",
        tools_data_dir=data_root / "agent_tools" / "data",
        # Agent SFT
        sft_dir=data_root / "agent_sft",
        sft_data_dir=data_root / "agent_sft" / "data",
    )


def get_runtime_paths() -> RuntimePaths:
    """
    Get runtime/generated data paths.

    Returns:
        RuntimePaths object with paths to generated data files.
    """
    sage_root = _find_sage_root()

    # Use .sage directory for runtime data
    data_root = sage_root / ".sage" / "benchmark" / "data"
    results_root = sage_root / ".sage" / "benchmark" / "results"

    return RuntimePaths(
        data_root=data_root,
        results_root=results_root,
        # Data directories
        tool_selection_dir=data_root / "tool_selection",
        task_planning_dir=data_root / "task_planning",
        timing_judgment_dir=data_root / "timing_judgment",
        # Results directories
        tool_selection_results=results_root / "tool_selection",
        task_planning_results=results_root / "task_planning",
        timing_judgment_results=results_root / "timing_judgment",
    )


def get_data_paths_config() -> DataPathsConfig:
    """
    Get complete data paths configuration.

    Returns cached config object.
    """
    global _config
    if _config is None:
        _config = DataPathsConfig(
            source=get_source_paths(),
            runtime=get_runtime_paths(),
        )
    return _config


def ensure_runtime_dirs() -> None:
    """
    Ensure all runtime directories exist.

    Call this before writing generated data.
    """
    runtime = get_runtime_paths()

    # Create data directories
    runtime.tool_selection_dir.mkdir(parents=True, exist_ok=True)
    runtime.task_planning_dir.mkdir(parents=True, exist_ok=True)
    runtime.timing_judgment_dir.mkdir(parents=True, exist_ok=True)

    # Create results directories
    runtime.tool_selection_results.mkdir(parents=True, exist_ok=True)
    runtime.task_planning_results.mkdir(parents=True, exist_ok=True)
    runtime.timing_judgment_results.mkdir(parents=True, exist_ok=True)


def print_data_paths_summary() -> None:
    """Print summary of all data paths for debugging."""
    config = get_data_paths_config()

    print("\n" + "=" * 60)
    print("SAGE Agent Benchmark Data Paths")
    print("=" * 60)

    print("\nðŸ“‚ Source Data (read-only, via DataManager):")
    print(f"   Root: {config.source.data_root}")
    print(f"   Tool Selection: {config.source.tool_selection_file}")
    print(f"   Task Planning: {config.source.task_planning_file}")
    print(f"   Timing Judgment: {config.source.timing_judgment_file}")
    print(f"   Tools Catalog: {config.source.tools_catalog}")
    print(f"   SFT Data: {config.source.sft_conversations}")

    print("\nðŸ“‚ Runtime Data (generated, in .sage/):")
    print(f"   Root: {config.runtime.data_root}")
    print(f"   Tool Selection: {config.runtime.tool_selection_dir}")
    print(f"   Task Planning: {config.runtime.task_planning_dir}")
    print(f"   Timing Judgment: {config.runtime.timing_judgment_dir}")

    print("\nðŸ“‚ Results:")
    print(f"   Root: {config.runtime.results_root}")

    # Check existence
    print("\nðŸ“‹ Status:")
    source_exists = config.source.tool_selection_file.exists()
    runtime_exists = config.runtime.tool_selection_dir.exists()
    print(f"   Source data exists: {'âœ…' if source_exists else 'âŒ'}")
    print(f"   Runtime data exists: {'âœ…' if runtime_exists else 'âŒ'}")
    print("=" * 60)


# Backwards compatibility aliases
def get_data_paths() -> dict:
    """
    Legacy function for backwards compatibility.

    Returns dict with source data paths.
    Prefer using get_source_paths() or get_runtime_paths() directly.
    """
    source = get_source_paths()
    return {
        "tools_dir": source.tools_data_dir,
        "benchmark_dir": source.benchmark_splits_dir,
        "output_dir": get_runtime_paths().tool_selection_dir,
    }


if __name__ == "__main__":
    # Print summary when run directly
    print_data_paths_summary()
