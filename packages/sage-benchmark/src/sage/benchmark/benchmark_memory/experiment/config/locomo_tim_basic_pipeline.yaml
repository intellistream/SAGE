# ============================================================
# TiM Pipeline 配置 (基础版 - 无蒸馏)
# 论文: Think-in-Memory: Recalling and Post-thinking Enable LLMs with Long-Term Memory
# 变体: TiM 基础版 - Hash + 事件消歧，不执行蒸馏
# 特点: 相比 TiM-distill，不执行 thoughts 生成和冗余压缩
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely using exact words from the context whenever possible. If the information is not mentioned in the conversation, respond with "Not mentioned in the conversation".

    Question: {question}
    Answer:

  # LLM Generator 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "TiM"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "vector_hash_memory"
  short_term_memory:
    max_dialog: 3
  vector_hash_memory:
    dim: 1024                         # 向量维度（需要与 embedding 模型输出维度一致）
    nbits: 128                        # LSH 哈希位数
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 三元组抽取 + Embedding（与 TiM-distill 相同）
  # ----------------------------------------------------------
  pre_insert:
    action: "tri_embed"
    triple_extraction_prompt: |
      You are a factual knowledge extractor.
      Analyze the dialogue below and extract all subject–predicate–object triples that represent explicitly stated or directly inferable real-world facts about people, organizations, objects, preferences, roles, locations, activities, or states.

      Guidelines:
      - Map "I", "me", "my" to the name of the speaker provided in the dialogue log.
      - Include personal states, plans, or situations if clearly described (e.g., "I'm busy" → (Speaker, is, busy)).
      - Handle colloquialisms and omitted subjects: If a subject is implied but omitted, infer the subject from context.
      - Resolve pronouns to specific entities; if the referent is ambiguous, skip the triple. Never output pronouns as subject or object.
      - Avoid redundancy by consolidating repeated or fragmented details into a single, most specific triple, and ignore non-informative conversational fillers.
      - Use natural-language predicates in active voice. Capture specific nuances like time and location directly in the predicate (e.g., "starts at 5 PM", "lives in Tokyo").
      - Do NOT assume external knowledge; base everything on what is said or immediately implied.

      Output ONLY in this format:

      If one or more facts exist:
      (Subject, Predicate, Object)
      ...

      If no extractable facts:
      None

      Dialogue:
      {dialogue}

  # ----------------------------------------------------------
  # PreRetrieval: Embedding（与 TiM-distill 相同）
  # ----------------------------------------------------------
  pre_retrieval:
    action: "embedding"

  # ----------------------------------------------------------
  # PostInsert: 无蒸馏（基础版与 TiM-distill 的关键区别）
  # 基础版不执行 thoughts 生成和冗余压缩
  # ----------------------------------------------------------
  post_insert:
    action: "none"                    # 关键区别：不执行蒸馏

  # ----------------------------------------------------------
  # PostRetrieval: 无特殊处理
  # ----------------------------------------------------------
  post_retrieval:
    action: "none"
    top_k: 10
