# ============================================================
# PreRetrieval 实验: TiM + 关键词扩展 (V3)
# 记忆体结构: TiM (LSH哈希桶 + 向量检索)
# PreRetrieval 策略: optimize.expand_keywords (关键词扩展)
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10
  service_timeout: 600.0

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置 (统一)
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "TiM_ExpandKeywords"

  # Embedding 配置 (统一)
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置: TiM (vector_memory + IndexLSH)
# ============================================================
services:
  register_memory_service: "vector_memory"
  vector_memory:
    dim: 1024
    index_type: "IndexLSH"
    index_config:
      nbits: 128
      rotate_data: true

# ============================================================
# Operator 配置
# ============================================================
operators:
  # PreInsert: 固定为 TiM 的三元组提取
  pre_insert:
    action: "extract.triple"
    extraction_method: "llm"
    max_triplets: 10
    keep_original: false

  # PostInsert: 固定为 TiM 的蒸馏
  post_insert:
    action: "distillation"
    retrieve_count: 10
    min_merge_count: 5

  # PreRetrieval: 实验变量 - 关键词扩展
  pre_retrieval:
    action: "optimize"
    optimize:
      type: "expand_keywords"

      # 关键词提取配置（与三元组协同）
      max_keywords: 6
      min_keyword_length: 3
      expand_synonyms: true

      # 针对三元组记忆的优化
      extract_entities: true
      entity_types: ["PERSON", "ORG", "GPE", "EVENT", "CONCEPT"]
      expand_related_entities: true

      # 关键词扩展提示
      keyword_extraction_prompt: |
        Extract the most important keywords and entities from this question for retrieving triple-based memory.
        Focus on: subjects, predicates, objects, and key concepts that would appear in (Subject, Predicate, Object) triples.

        Question: {question}

        Output format:
        Keywords: [list of 4-6 key terms]
        Entities: [list of named entities]
        Synonyms: [alternative terms]

      llm_config:
        max_tokens: 200
        temperature: 0.3

  # PostRetrieval: 固定为 TiM 的 rerank
  post_retrieval:
    action: "rerank"
    rerank_type: "semantic"
    top_k: 5
