# ============================================================
# MemoryBank Pipeline 配置
# 论文: MemoryBank: Enhancing Large Language Models with Long-Term Memory
# 特点: 分层记忆 + Ebbinghaus 遗忘 + 多层摘要
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely using exact words from the context whenever possible. If the information is not mentioned in the conversation, respond with "Not mentioned in the conversation".

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "MemoryBank"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "three_tier"           # 三层: STM / MTM / LTM
    tier_names: ["stm", "mtm", "ltm"]
    tier_capacities:
      stm: 50
      mtm: 500
      ltm: -1                         # 无限
    migration_policy: "heat"          # 基于热度迁移
    migration_threshold: 0.7
    embedding_dim: 1024               # bge-m3 模型输出 1024 维向量
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 生成摘要 + 重要性评分
  # MemoryBank 会对每轮对话生成 daily summary
  # ----------------------------------------------------------
  pre_insert:
    action: "transform"
    transform_type: "summarize"
    summarize_prompt: |
      Summarize the key events and information from this conversation.
      Focus on: facts mentioned, preferences expressed, plans discussed.
      Keep the summary concise but informative.

      Conversation:
      {dialogue}

      Summary:

  # ----------------------------------------------------------
  # PostInsert: Ebbinghaus 遗忘 + 层间迁移
  # MemoryBank 使用遗忘曲线管理记忆强度
  # ----------------------------------------------------------
  post_insert:
    action: "forgetting"
    decay_type: "ebbinghaus"          # 艾宾浩斯遗忘曲线
    initial_strength: 1.0
    forgetting_curve: "exponential"
    review_boost: 0.5                 # 被检索时增强
    retention_min: 50                 # 最少保留条数
    archive_before_delete: true

  # ----------------------------------------------------------
  # PreRetrieval: 基础 embedding
  # ----------------------------------------------------------
  pre_retrieval:
    action: "embedding"

  # ----------------------------------------------------------
  # PostRetrieval: 时间加权重排序 + 增强（添加全局画像）
  # MemoryBank 会同时返回相关记忆 + 全局用户画像
  # ----------------------------------------------------------
  post_retrieval:
    action: "rerank"
    rerank_type: "time_weighted"
    time_decay_rate: 0.1
    time_field: "timestamp"
    top_k: 10
    conversation_format_prompt: |
      The following is the user's conversation history and profile.
