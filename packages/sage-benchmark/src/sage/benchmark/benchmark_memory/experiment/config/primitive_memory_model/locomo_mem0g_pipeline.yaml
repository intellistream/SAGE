# ============================================================
# Mem0ᵍ Pipeline 配置 (图记忆版)
# 论文: Mem0: Building Production-Ready AI Agents with Scalable Long-Term Memory
# 变体: Mem0ᵍ - 向量 + 知识图谱 + 实体链接
# 特点: 相比基础版 Mem0，增加了图索引支持，可以通过实体关系进行检索
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  # 第五类问题专用 Prompt（选择题格式，更简洁）
  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置
  # 旧配置（已弃用）：
  # api_key: "token-abc123"
  # base_url: "http://sage2:8000/v1"
  # model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  # max_tokens: 512
  # temperature: 0.3
  # seed: 42

  # 新配置（PanGu Embedded 1B）：
  api_key: "iloveshuhao"
  base_url: "http://172.17.0.1:1040/v1"
  model_name: "pangu_embedded_1b"
  max_tokens: 256
  temperature: 0
  seed: 42
  memory_name: "Mem0g"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# Mem0ᵍ 使用 HybridMemoryService，同时启用向量和图索引
# ============================================================
services:
  register_memory_service: "hybrid_memory"
  hybrid_memory:
    # 关键区别：Mem0ᵍ 同时使用向量、关键词和图索引
    graph_enabled: true               # 启用图索引（与 Mem0 基础版的关键区别）
    entity_extraction: true           # 启用实体抽取
    relation_extraction: true         # 启用关系抽取
    indexes:
    - name: "semantic"
      type: "vector"
      dim: 1024                       # BAAI/bge-m3 输出 1024 维向量
      embedding_model: "BAAI/bge-m3"
    - name: "keyword"
      type: "bm25"
    - name: "entity_graph"
      type: "graph"                   # 图索引用于实体关系检索
    fusion_strategy: "weighted"
    fusion_weights:
      semantic: 0.5                   # 向量检索权重
      keyword: 0.2                    # 关键词检索权重
      entity_graph: 0.3               # 图检索权重（新增）
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 实体和关系抽取
  # Mem0ᵍ 会抽取实体和关系用于构建知识图谱
  # ----------------------------------------------------------
  pre_insert:
    action: "extract.triple"          # 使用三元组抽取（比 entity 更完整）
    triple_extraction_prompt: |
      You are a knowledge graph builder. Extract factual triples from the dialogue.
      Focus on entities (people, organizations, locations) and their relationships.

      Rules:
      1. Output format: (Subject, Predicate, Object) - one triple per line
      2. Resolve ALL pronouns to actual entity names
      3. Extract relationships, attributes, and temporal information
      4. Be concise and factual

      Dialogue:
      {dialogue}

      Triples:

  # ----------------------------------------------------------
  # PostInsert: ADD/UPDATE/DELETE 决策 + 实体链接
  # Mem0ᵍ 的核心：LLM 决定对已有记忆的操作，同时建立实体链接
  # ----------------------------------------------------------
  post_insert:
    action: "distillation"
    distillation_topk: 10
    distillation_threshold:
    distillation_prompt: |
      You are managing a fact database with entity linking. Given a new fact and similar existing facts,
      decide the appropriate action:

      - ADD: The new fact is entirely new information
      - UPDATE: The new fact updates/extends an existing fact (delete old, keep new)
      - DELETE: The new fact contradicts an existing fact (delete old, keep new)
      - NOOP: The new fact is redundant (already covered by existing facts)

      New fact: {new_entry}

      Existing facts:
      {memory_list}

      Respond with JSON:
      {"action": "ADD|UPDATE|DELETE|NOOP", "to_delete": ["fact to remove if any"], "reason": "brief explanation"}

  # ----------------------------------------------------------
  # PreRetrieval: 基础 embedding + 实体识别
  # ----------------------------------------------------------
  pre_retrieval:
    action: "embedding"

  # ----------------------------------------------------------
  # PostRetrieval: 混合检索结果融合
  # Mem0ᵍ 融合向量检索和图检索结果
  # ----------------------------------------------------------
  post_retrieval:
    action: "none"
    top_k: 10
    conversation_format_prompt: |
      The following is relevant context retrieved from memory.

# ============================================================
# Mem0ᵍ 复现说明（图记忆版）
# ============================================================
# 论文核心特性（图版）：
#   1. ADD/UPDATE/DELETE 决策（与基础版相同）
#   2. **图索引支持**：增加实体关系检索（与基础版的关键区别）
#   3. **三重索引**：向量 + BM25 + 知识图谱
#   4. **实体抽取**：识别实体并建立关系链接
#   5. **混合检索**：融合三种检索结果（加权融合）
#
# SAGE 实现方式：
# ┌───────────────────────────────────────────────────────────┐
# │ Pipeline 阶段      │ 对应 Mem0ᵍ 操作        │ 实现组件     │
# ├───────────────────────────────────────────────────────────┤
# │ PreInsert          │ **Triple Extraction**  │ extract.triple│
# │  - 实体识别          │ 识别实体节点            │ NER/LLM      │
# │  - 关系抽取          │ 抽取实体间关系          │ Relation Ex  │
# │  - 三元组生成        │ (Subject, Pred, Obj)   │ LLM Prompt   │
# ├───────────────────────────────────────────────────────────┤
# │ MemoryInsert       │ Hybrid Insert          │ HybridMemory │
# │  - **向量索引**      │ 语义相似度检索          │ Vector Index │
# │  - **关键词索引**    │ BM25 文本匹配          │ BM25 Index   │
# │  - **图索引**        │ 实体关系检索（新增）    │ Graph Index  │
# ├───────────────────────────────────────────────────────────┤
# │ PostInsert         │ ADD/UPDATE/DELETE      │ distillation │
# │  - 检索相似记忆      │ topk=10 相似事实       │ hybrid search│
# │  - LLM 决策          │ 判断操作类型            │ LLM Prompt   │
# │  - 执行操作          │ 更新/删除/保留          │ Service      │
# │  - **实体链接**      │ 建立实体间关系（新增）  │ Entity Link  │
# ├───────────────────────────────────────────────────────────┤
# │ PreRetrieval       │ Query Processing       │ embedding    │
# │  - 查询向量化        │ 用于向量检索            │ BGE-M3       │
# │  - **实体识别**      │ 识别查询中的实体（新增）│ NER          │
# ├───────────────────────────────────────────────────────────┤
# │ MemoryRetrieval    │ **Hybrid Retrieval**   │ HybridMemory │
# │  - **向量检索**      │ 语义相似度 (权重 0.5)  │ Vector Search│
# │  - **关键词检索**    │ BM25 匹配 (权重 0.2)   │ BM25 Search  │
# │  - **图检索**        │ 实体关系 (权重 0.3)    │ Graph Search │
# │  - **结果融合**      │ 加权融合三种结果        │ Weighted Fuse│
# ├───────────────────────────────────────────────────────────┤
# │ PostRetrieval      │ Context Integration    │ none         │
# │  - 基础格式化        │ 拼接为 prompt          │ 默认格式     │
# └───────────────────────────────────────────────────────────┘
#
# 关键配置参数：
#   graph_enabled: true             # 启用图索引（与基础版的核心区别）
#   entity_extraction: true         # 启用实体抽取
#   relation_extraction: true       # 启用关系抽取
#   indexes:                        # 三重索引配置
#     - semantic (vector, 权重 0.5)
#     - keyword (BM25, 权重 0.2)
#     - entity_graph (graph, 权重 0.3)  # 新增
#   fusion_strategy: "weighted"     # 加权融合策略
#   triple_extraction_prompt        # 三元组抽取 prompt
#
# 与 Mem0 基础版的差异：
#   1. **索引类型**：基础版仅 vector+BM25，图版增加 graph 索引
#   2. **PreInsert**：基础版用 extract.entity，图版用 extract.triple（更完整）
#   3. **实体链接**：图版在 PostInsert 时建立实体间关系
#   4. **检索策略**：图版融合三种检索结果，基础版仅两种
#   5. **适用场景**：图版更适合实体密集的对话（人名、地点等）
#   → 优势：能通过实体关系找到间接相关的记忆
#   → 代价：需要额外的实体抽取和图索引维护开销
#
# 实体关系检索示例：
#   查询: "Sarah 的妈妈喜欢什么？"
#   1. 向量检索：找到包含 "Sarah" 和 "妈妈" 的记忆
#   2. 关键词检索：匹配 "喜欢" 关键词
#   3. **图检索**：
#      - 识别实体: Sarah, 妈妈
#      - 遍历关系: Sarah -[has_mom]-> 妈妈 -[likes]-> ?
#      - 找到答案: 妈妈 -[likes]-> 绘画
#   4. 融合结果: 0.5*向量分数 + 0.2*BM25分数 + 0.3*图分数
#
# 与论文的差异：
#   - 论文使用 Neo4j 等专业图数据库，SAGE 使用轻量级 igraph
#   - 论文支持更复杂的实体链接算法，SAGE 使用基于相似度的简化版
#   - 图索引权重 (0.3) 是经验值，论文中可能需要根据任务调整
#
# 运行示例：
#   python packages/sage-benchmark/.../memory_test_pipeline.py \
#     --config .../locomo_mem0g_pipeline.yaml --task_id conv-26
