# ============================================================
# PreRetrieval 实验: MemoryOS + 混合提示 (H3)
# 记忆体结构: MemoryOS (三层分层记忆 + 热度迁移)
# PreRetrieval 策略: hybrid_hints (层级路由 + 热度感知)
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置 (统一)
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "MemoryOS_HybridHints"

  # Embedding 配置 (统一)
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置: MemoryOS (hierarchical_memory)
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "three_tier"
    tier_names: ["stm", "mtm", "lpm"]
    tier_capacities:
      stm: 20
      mtm: 200
      lpm: -1
    migration_policy: "heat"
    heat_threshold: 0.7
    cold_threshold: 0.3
    embedding_dim: 1024

# ============================================================
# Operator 配置
# ============================================================
operators:
  # PreInsert: 固定为 MemoryOS 的重要性评分
  pre_insert:
    action: "score"
    score_type: "importance"

  # PostInsert: 固定为 MemoryOS 的热度迁移
  post_insert:
    action: "migrate"
    migrate_policy: "heat"
    heat_threshold: 0.7
    cold_threshold: 0.3

  # PreRetrieval: 实验变量 - 混合提示 (热度感知的层级路由)
  pre_retrieval:
    action: "hybrid_hints"
    hint_types: ["tier_routing", "heat_awareness", "search_scope"]

    # 层级路由提示（适配 MemoryOS 的 STM/MTM/LPM）
    tier_routing_prompt: |
      Analyze the following question and determine which memory tier(s) should be prioritized for retrieval:
      - STM (Short-Term Memory): Very recent conversation context (last few turns)
      - MTM (Medium-Term Memory): Session-level information, recent segments with high heat
      - LPM (Long-term Persona Memory): Stable facts, preferences, personality traits, knowledge base

      Question: {question}

      Provide routing decision as:
      Primary tier: [stm|mtm|lpm]
      Secondary tier: [stm|mtm|lpm|none]
      Heat preference: [hot|warm|cold|any]
      Justification: [brief reasoning]

    # 热度感知提示（MemoryOS 特色）
    heat_awareness_prompt: |
      For this question, what type of memory freshness is most relevant?
      Question: {question}

      Heat preference:
      - hot: Recently accessed, highly active memories (heat > 0.7)
      - warm: Moderately active memories (heat 0.3-0.7)
      - cold: Rarely accessed but potentially important (heat < 0.3)
      - any: No preference

      Selection: [hot|warm|cold|any]

    # 搜索范围提示
    search_scope_prompt: |
      Determine the optimal search parameters for this question:
      Question: {question}

      Recommended:
      - Search breadth: [narrow|medium|broad]
      - Top-k per tier: [number]
      - Time relevance: [recent|balanced|historical]

    llm_config:
      max_tokens: 256
      temperature: 0.2

  # PostRetrieval: 固定为 MemoryOS 的增强
  post_retrieval:
    action: "augment"
    augment_type: "persona"
