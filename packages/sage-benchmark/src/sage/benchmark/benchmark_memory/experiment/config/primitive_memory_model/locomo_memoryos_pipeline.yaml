# ============================================================
# MemoryOS Pipeline 配置
# 论文: Memory OS of AI Agent
# 特点: 三层 STM/MTM/LPM + Heat Score + Segment 架构
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  # 第五类问题专用 Prompt（选择题格式，更简洁）
  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "MemoryOS"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "three_tier"
    tier_names: ["stm", "mtm", "lpm"]
    tier_capacities:
      stm: 20                         # FIFO 队列
      mtm: 200                        # Segment-Page 结构
      lpm: -1                         # Persona/KB/Traits
    migration_policy: "heat"
    heat_threshold: 0.7
    cold_threshold: 0.3
    embedding_dim: 1024               # BAAI/bge-m3 输出 1024 维向量
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 重要性评分（用于计算 heat）
  # MemoryOS 使用 Fscore 决定归入哪个 segment
  # ----------------------------------------------------------
  pre_insert:
    action: "score"
    score_type: "importance"
    importance_prompt: |
      Rate the importance of this conversation on a scale of 1-10.
      Consider: Does it contain personal facts? Future plans? Preferences?

      Conversation:
      {dialogue}

      Importance score (1-10):
    importance_scale: [1, 10]
    score_field: "importance_score"
    add_to_metadata: true

  # ----------------------------------------------------------
  # PostInsert: 热度迁移
  # MemoryOS 基于 heat score 决定 STM→MTM→LPM 迁移
  # ----------------------------------------------------------
  post_insert:
    action: "migrate"
    migrate_policy: "heat"
    heat_threshold: 0.7               # 高于此值升级
    cold_threshold: 0.3               # 低于此值降级/淘汰
    session_gap: 3600                 # 会话间隔(秒)
    tier_capacities:
      stm: 20
      mtm: 200
    upgrade_transform: "none"
    downgrade_transform: "summarize"

  # ----------------------------------------------------------
  # PreRetrieval: 关键词提取
  # ----------------------------------------------------------
  pre_retrieval:
    action: "optimize"
    optimize_type: "keyword_extract"
    extractor: "spacy"
    spacy_model: "en_core_web_sm"     # spaCy 模型名称
    extract_types: ["NOUN", "PROPN"]
    max_keywords: 10

  # ----------------------------------------------------------
  # PostRetrieval: 多层合并（STM + MTM + LPM）
  # MemoryOS 同时从三层检索并合并
  # ----------------------------------------------------------
  post_retrieval:
    action: "merge"
    merge_type: "multi_query"
    secondary_queries:
    - query_template: "{question}"
      metadata: {tier: "stm"}
    - query_template: "{question}"
      metadata: {tier: "mtm"}
    - query_template: "{question}"
      metadata: {tier: "lpm", type: "persona"}
    conversation_format_prompt: |
      The following is relevant context from different memory tiers.

# ============================================================
# MemoryOS 复现说明
# ============================================================
# 论文核心特性：
#   1. 三层架构：STM (FIFO) → MTM (Segment-Page) → LPM (Persona)
#   2. Heat Score：基于访问频率、交互长度、时间衰减
#   3. 热度迁移：高热记忆升级，低热记忆降级或淘汰
#   4. Segment 聚类：MTM 中按主题将对话分组
#
# SAGE 实现方式：
# ┌─────────────────────────────────────────────────────────┐
# │ Pipeline 阶段      │ 对应 MemoryOS 操作   │ 实现组件     │
# ├─────────────────────────────────────────────────────────┤
# │ PreInsert          │ Importance Scoring   │ score        │
# │  - 重要性评分      │ 用于 Heat 计算       │ LLM Prompt   │
# │  - 元数据标注      │ 添加 importance      │ metadata     │
# ├─────────────────────────────────────────────────────────┤
# │ MemoryInsert       │ Multi-tier Insert    │ Hierarchical │
# │  - STM 追加        │ 先进入短期记忆       │ stm tier     │
# │  - 自动分配层级    │ 被动插入             │ tier_mode    │
# ├─────────────────────────────────────────────────────────┤
# │ PostInsert         │ Heat-based Migration │ migrate      │
# │  - 计算 Heat Score │ Nvisit + Linteract + │ heat policy  │
# │                    │ Rrecency             │              │
# │  - STM→MTM 升级    │ heat > 0.7           │ threshold    │
# │  - MTM→LPM 升级    │ 提取 Persona/KB      │ persona      │
# │  - 低热淘汰        │ heat < 0.3 删除      │ cold_thresh  │
# ├─────────────────────────────────────────────────────────┤
# │ PreRetrieval       │ Keyword Extraction   │ optimize     │
# │  - 名词提取        │ 用于 Fscore 计算     │ spacy        │
# │  - 话题识别        │ Jaccard 相似度       │ NOUN/PROPN   │
# ├─────────────────────────────────────────────────────────┤
# │ MemoryRetrieval    │ Two-stage Search     │ Hierarchical │
# │  - Segment 选择    │ 按 Fscore 选 top-m   │ Fscore       │
# │  - Page 检索       │ Segment 内相似度     │ FAISS        │
# ├─────────────────────────────────────────────────────────┤
# │ PostRetrieval      │ Multi-tier Merge     │ merge        │
# │  - 三层合并        │ STM + MTM + LPM      │ multi_query  │
# │  - Persona 增强    │ 添加用户画像         │ persona      │
# └─────────────────────────────────────────────────────────┘
#
# 关键配置参数：
#   - tier_mode="three_tier": 三层架构
#   - heat_threshold=0.7: 高热升级阈值
#   - cold_threshold=0.3: 低热淘汰阈值
#   - tier_capacities: {stm:20, mtm:200, lpm:-1}
#
# 与论文的差异：
#   1. 论文使用 Fscore (语义+关键词)，SAGE 简化为关键词提取
#   2. SAGE 的 Heat Score 计算简化（只考虑访问次数和时间）
#   3. SAGE 使用 BGE-M3 embedding，论文可能用其他编码器
#
# 运行示例：
#   python packages/sage-benchmark/.../memory_test_pipeline.py \
#     --config .../locomo_memoryos_pipeline.yaml --task_id conv-26
