# ============================================================
# MemoryOS Pipeline 配置
# 论文: Memory OS of AI Agent
# 特点: 三层 STM/MTM/LPM + Heat Score + Segment 架构
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  # 第五类问题专用 Prompt（选择题格式，更简洁）
  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置
  # 配置1（Llama-3.1-8B，用于对比）：
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 256
  temperature: 0
  seed: 42

  # 新配置（PanGu Embedded 1B）：
  # api_key: "iloveshuhao"
  # base_url: "http://172.17.0.1:1040/v1"
  # model_name: "pangu_embedded_1b"
  # max_tokens: 256
  # temperature: 0
  # seed: 42
  memory_name: "MemoryOS"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "three_tier"
    tier_names: ["stm", "mtm", "lpm"]
    tier_capacities:
      stm: 20                         # FIFO 队列（论文 Section 3.3）
      mtm: 200                        # Segment-Page 结构（论文 Section 3.3）
      lpm: -1                         # Persona/KB/Traits（论文 Section 3.3）
    migration_policy: "heat"
    heat_threshold: 5.0               # 论文 τ=5.0 (Algorithm 2)
    cold_threshold: 0.3
    embedding_dim: 1024               # BAAI/bge-m3 输出 1024 维向量
    # MemoryOS 两阶段检索（论文 Algorithm 3 Line 6-13）
    use_two_stage_search: true        # MTM 层使用两阶段检索
    segment_similarity_threshold: 0.1
    page_similarity_threshold: 0.1
    top_k_segments: 5                 # 第一阶段选择 Top-K Segments
    top_k_pages_per_segment: 3        # 第二阶段每个 Segment 选 Top-K Pages
    # Fscore 计算权重（论文 Eq. 3）
    fscore_alpha: 1.0                 # cos(es, ep) 的权重
    fscore_beta: 0.5                  # F_Jaccard(Ks, Kp) 的权重
    fscore_gamma: 0.1                 # 时间衰减因子
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 无需任何前置处理
  # 原因:
  #   1. MemoryOS 论文中 Fscore 计算在 Insert 时进行（由服务层负责）
  #   2. 热度初始值为 0（由服务层初始化）
  #   3. Multi-summary 在 STM→MTM 迁移时生成（PostInsert）
  #   4. Profile/Knowledge 在 MTM→LPM 迁移时提取（PostInsert）
  # ----------------------------------------------------------
  pre_insert:
    action: "none"

  # ----------------------------------------------------------
  # PostInsert: 热度迁移 + Profile提取（按论文要求）
  # 实现论文 Algorithm 1: Storage 和 Algorithm 2: Update
  #
  # STM→MTM (Algorithm 1 Line 6-13):
  #   - FIFO 触发迁移
  #   - 生成 multi_summary（段摘要 + 关键词）
  #   - 计算 Fscore 选择 Segment
  #
  # MTM→LPM (Algorithm 2 Line 15-22):
  #   - 热度阈值 τ=5.0 触发
  #   - LLM 提取 Profile (Basic Info, Personality, Preferences)
  #   - LLM 提取 Knowledge
  #   - 重置已提取 Session 的热度
  # ----------------------------------------------------------
  post_insert:
    action: "migrate"
    migrate_policy: "heat"
    heat_threshold: 5.0                # 论文 τ=5.0
    cold_threshold: 0.3                # 降级阈值（非论文参数）
    session_gap: 3600                  # Session 分隔时间（1小时）
    tier_capacities:
      stm: 20
      mtm: 200
    # STM→MTM 迁移时生成摘要（论文 Eq. 3）
    upgrade_transform: "multi_summary"
    enable_keywords: true              # 提取关键词用于 Fscore
    enable_summary: true               # 生成段摘要
    # MTM→LPM Profile提取（论文 Section 3.3）
    enable_profile_extraction: true
    enable_knowledge_extraction: true
    reset_heat_after_extraction: true

  # ----------------------------------------------------------
  # PreRetrieval: 关键词提取（论文 Algorithm 3 Line 2-3）
  # 用于 MTM 两阶段检索的第一阶段 Segment 选择
  # Fscore = cos(es, ep) + F_Jaccard(Ks, Kp)
  # ----------------------------------------------------------
  pre_retrieval:
    action: "optimize"
    optimize_type: "keyword_extract"
    extractor: "spacy"
    spacy_model: "en_core_web_sm"
    extract_types: ["NOUN", "PROPN", "VERB"]  # 提取名词、专有名词、动词
    max_keywords: 10

  # ----------------------------------------------------------
  # PostRetrieval: 多层合并（论文 Algorithm 3）
  # MemoryOS 同时从三层检索并合并:
  #   - STM: 最新对话（FIFO）
  #   - MTM: 两阶段检索（Segment→Page）
  #   - LPM: Persona/Knowledge（语义检索）
  # ----------------------------------------------------------
  post_retrieval:
    action: "merge"
    merge_type: "multi_query"
    secondary_queries:
    - query_template: "{question}"
      metadata: {tier: "stm"}                    # 检索最新对话
    - query_template: "{question}"
      metadata: {tier: "mtm"}                    # 两阶段检索
    - query_template: "{question}"
      metadata: {tier: "lpm", type: "persona"}   # 检索用户画像
    - query_template: "{question}"
      metadata: {tier: "lpm", type: "knowledge"} # 检索知识库
    conversation_format_prompt: |
      The following is relevant context from different memory tiers.
