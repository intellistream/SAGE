# ============================================================
# LD-Agent Pipeline 配置
# 论文: LD-Agent for Long-term Dialogue
# 特点: STM 缓存 + 事件摘要 LTM + 话题重叠检索
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely using exact words from the context whenever possible. If the information is not mentioned in the conversation, respond with "Not mentioned in the conversation".

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "LD-Agent"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "two_tier"
    tier_names: ["stm", "ltm"]
    tier_capacities:
      stm: 50                         # 当前会话缓存
      ltm: -1                         # 事件摘要库
    migration_policy: "time"
    session_gap: 3600                 # 超过1小时触发迁移
  memory_insert_adapter: "to_refactor"
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 事件摘要生成
  # LD-Agent 会对对话生成事件摘要
  # ----------------------------------------------------------
  pre_insert:
    action: "transform"
    transform_type: "summarize"
    summarize_prompt: |
      Summarize the key events from this dialogue as a brief event description.
      Focus on: What happened? Who was involved? What was decided/planned?

      Dialogue:
      {dialogue}

      Event summary:

  # ----------------------------------------------------------
  # PostInsert: 会话间隔触发迁移
  # LD-Agent 在会话间隔>1小时时触发 STM→LTM 迁移
  # ----------------------------------------------------------
  post_insert:
    action: "migrate"
    migrate_policy: "time"
    session_gap: 3600
    upgrade_transform: "summarize"
    downgrade_transform: "none"

  # ----------------------------------------------------------
  # PreRetrieval: 名词/关键词提取（用于话题重叠）
  # LD-Agent 使用 spaCy 提取名词集合
  # ----------------------------------------------------------
  pre_retrieval:
    action: "optimize"
    optimize_type: "keyword_extract"
    extractor: "spacy"
    extract_types: ["NOUN", "PROPN"]
    max_keywords: 15

  # ----------------------------------------------------------
  # PostRetrieval: 多因子重排序（语义+话题+时间）
  # LD-Agent 使用综合得分排序
  # ----------------------------------------------------------
  post_retrieval:
    action: "rerank"
    rerank_type: "weighted"
    factors:
    - name: "relevance"
      weight: 0.4
      source: "embedding_similarity"
    - name: "recency"
      weight: 0.3
      decay_type: "exponential"
      decay_rate: 0.995
    - name: "topic_overlap"
      weight: 0.3
      source: "keyword_jaccard"
    top_k: 10
    conversation_format_prompt: |
      The following is relevant dialogue history.
