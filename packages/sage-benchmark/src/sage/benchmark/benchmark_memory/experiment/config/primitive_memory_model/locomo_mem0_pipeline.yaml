# ============================================================
# Mem0 Pipeline 配置
# 论文: Mem0: Building Production-Ready AI Agents with Scalable Long-Term Memory
# 特点: 事实存储 + ADD/UPDATE/DELETE 操作 + 全局摘要
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  # 第五类问题专用 Prompt（选择题格式，更简洁）
  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "Mem0"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hybrid_memory"
  hybrid_memory:
    indexes:
    - name: "semantic"
      type: "vector"
      dim: 1024                       # BAAI/bge-m3 输出 1024 维向量
      embedding_model: "BAAI/bge-m3"
    - name: "keyword"
      type: "bm25"
    fusion_strategy: "weighted"
    fusion_weights:
      semantic: 0.7
      keyword: 0.3
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 从对话中提取事实候选
  # Mem0 会提取 salient memories（显著事实）
  # ----------------------------------------------------------
  pre_insert:
    action: "extract"
    extract_type: "entity"
    spacy_model: "en_core_web_sm"     # SpaCy 模型用于 entity/noun 提取
    entity_types: ["PERSON", "ORG", "LOC", "DATE", "EVENT"]
    add_to_metadata: true

  # ----------------------------------------------------------
  # PostInsert: ADD/UPDATE/DELETE 决策
  # Mem0 的核心：LLM 决定对已有记忆的操作
  # ----------------------------------------------------------
  post_insert:
    action: "distillation"
    distillation_topk: 10
    distillation_threshold:
    distillation_prompt: |
      You are managing a fact database. Given a new fact and similar existing facts,
      decide the appropriate action:

      - ADD: The new fact is entirely new information
      - UPDATE: The new fact updates/extends an existing fact (delete old, keep new)
      - DELETE: The new fact contradicts an existing fact (delete old, keep new)
      - NOOP: The new fact is redundant (already covered by existing facts)

      New fact: {new_entry}

      Existing facts:
      {memory_list}

      Respond with JSON:
      {"action": "ADD|UPDATE|DELETE|NOOP", "to_delete": ["fact to remove if any"], "reason": "brief explanation"}

  # ----------------------------------------------------------
  # PreRetrieval: 基础 embedding
  # ----------------------------------------------------------
  pre_retrieval:
    action: "embedding"

  # ----------------------------------------------------------
  # PostRetrieval: 简单格式化（Mem0 基础版较简单）
  # ----------------------------------------------------------
  post_retrieval:
    action: "none"
    conversation_format_prompt: |
      The following are relevant facts from memory.

# ============================================================
# Mem0 复现说明
# ============================================================
# 论文核心特性：
#   1. 事实存储: 提取并存储离散事实
#   2. ADD/UPDATE/DELETE: LLM 决策记忆操作
#   3. 混合检索: Vector + BM25 融合
#   4. 全局摘要: 用户画像和知识库概览
#
# SAGE 实现方式：
# ┌─────────────────────────────────────────────────────────┐
# │ Pipeline 阶段      │ 对应 Mem0 操作        │ 实现组件     │
# ├─────────────────────────────────────────────────────────┤
# │ PreInsert          │ Fact Extraction       │ extract      │
# │  - 实体提取        │ 识别关键实体          │ spacy        │
# │  - 名词提取        │ 候选事实              │ entity_types │
# │  - 元数据标注      │ 实体类型标记          │ metadata     │
# ├─────────────────────────────────────────────────────────┤
# │ MemoryInsert       │ Hybrid Insert         │ HybridMemory │
# │  - 向量索引        │ semantic search       │ FAISS        │
# │  - BM25 索引       │ keyword search        │ BM25         │
# │  - 融合权重        │ 0.7 semantic + 0.3 kw │ weighted     │
# ├─────────────────────────────────────────────────────────┤
# │ PostInsert         │ ADD/UPDATE/DELETE     │ distillation │
# │  - 检索相似事实    │ 查找已有事实          │ topk=10      │
# │  - LLM 决策        │ 判断操作类型          │ LLM Prompt   │
# │  - 执行操作        │ ADD: 新增             │ Service      │
# │                    │ UPDATE: 删旧加新      │              │
# │                    │ DELETE: 删除矛盾      │              │
# │                    │ NOOP: 已存在          │              │
# ├─────────────────────────────────────────────────────────┤
# │ PreRetrieval       │ Query Embedding       │ embedding    │
# │  - 查询向量化      │ 用于混合检索          │ BGE-M3       │
# ├─────────────────────────────────────────────────────────┤
# │ MemoryRetrieval    │ Hybrid Search         │ HybridMemory │
# │  - 向量检索        │ semantic top-k        │ FAISS        │
# │  - BM25 检索       │ keyword top-k         │ BM25         │
# │  - 加权融合        │ RRF / weighted sum    │ fusion       │
# ├─────────────────────────────────────────────────────────┤
# │ PostRetrieval      │ Basic Format          │ none         │
# │  - 基础格式化      │ 拼接事实列表          │ default      │
# └─────────────────────────────────────────────────────────┘
#
# 关键配置参数：
#   - fusion_strategy="weighted": 加权融合策略
#   - fusion_weights: {semantic: 0.7, keyword: 0.3}
#   - distillation_prompt: ADD/UPDATE/DELETE 决策 prompt
#
# 与论文的差异：
#   1. 论文使用 Qdrant 作为向量数据库，SAGE 使用 FAISS
#   2. SAGE 的 distillation_prompt 基于论文逻辑重新设计
#   3. SAGE 支持配置化的融合权重
#
# 运行示例：
#   python packages/sage-benchmark/.../memory_test_pipeline.py \
#     --config .../locomo_mem0_pipeline.yaml --task_id conv-26
