# ============================================================
# MemoryOS Pipeline 配置
# 论文: Memory OS of AI Agent
# 特点: 三层 STM/MTM/LPM + Heat Score + Segment 架构
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely using exact words from the context whenever possible. If the information is not mentioned in the conversation, respond with "Not mentioned in the conversation".

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "MemoryOS"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hierarchical_memory"
  hierarchical_memory:
    tier_mode: "three_tier"
    tier_names: ["stm", "mtm", "lpm"]
    tier_capacities:
      stm: 20                         # FIFO 队列
      mtm: 200                        # Segment-Page 结构
      lpm: -1                         # Persona/KB/Traits
    migration_policy: "heat"
    heat_threshold: 0.7
    cold_threshold: 0.3
  memory_insert_adapter: "to_refactor"
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 重要性评分（用于计算 heat）
  # MemoryOS 使用 Fscore 决定归入哪个 segment
  # ----------------------------------------------------------
  pre_insert:
    action: "score"
    score_type: "importance"
    importance_prompt: |
      Rate the importance of this conversation on a scale of 1-10.
      Consider: Does it contain personal facts? Future plans? Preferences?

      Conversation:
      {dialogue}

      Importance score (1-10):
    importance_scale: [1, 10]
    score_field: "importance_score"
    add_to_metadata: true

  # ----------------------------------------------------------
  # PostInsert: 热度迁移
  # MemoryOS 基于 heat score 决定 STM→MTM→LPM 迁移
  # ----------------------------------------------------------
  post_insert:
    action: "migrate"
    migrate_policy: "heat"
    heat_threshold: 0.7               # 高于此值升级
    cold_threshold: 0.3               # 低于此值降级/淘汰
    session_gap: 3600                 # 会话间隔(秒)
    tier_capacities:
      stm: 20
      mtm: 200
    upgrade_transform: "none"
    downgrade_transform: "summarize"

  # ----------------------------------------------------------
  # PreRetrieval: 关键词提取
  # ----------------------------------------------------------
  pre_retrieval:
    action: "optimize"
    optimize_type: "keyword_extract"
    extractor: "spacy"
    extract_types: ["NOUN", "PROPN"]
    max_keywords: 10

  # ----------------------------------------------------------
  # PostRetrieval: 多层合并（STM + MTM + LPM）
  # MemoryOS 同时从三层检索并合并
  # ----------------------------------------------------------
  post_retrieval:
    action: "merge"
    merge_type: "multi_query"
    secondary_queries:
    - query_template: "{question}"
      metadata: {tier: "stm"}
    - query_template: "{question}"
      metadata: {tier: "mtm"}
    - query_template: "{question}"
      metadata: {tier: "lpm", type: "persona"}
    conversation_format_prompt: |
      The following is relevant context from different memory tiers.
