# ============================================================
# PreRetrieval 实验: Mem0ᵍ + 关键词扩展优化 (G2)
# 记忆体结构: Hybrid Memory with Graph (图记忆版)
# PreRetrieval 策略: optimize.expand_keywords (关键词扩展+实体激活)
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely.

    Question: {question}
    Answer:

  prompt_template_category5: |
    Based on the above context, answer the following question.

    Question: {question}
    Answer:

  # LLM 配置 (统一)
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "Mem0g_ExpandKeywords"

  # Embedding 配置 (统一)
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置: Hybrid Memory with Graph (图结构)
# ============================================================
services:
  register_memory_service: "hybrid_memory"
  hybrid_memory:
    # 启用图索引 (关键配置)
    graph_enabled: true
    entity_extraction: true
    relation_extraction: true

    # 向量+图混合检索配置
    vector_weight: 0.6
    graph_weight: 0.4

    # 图检索参数
    max_depth: 2
    min_edge_weight: 0.1
    entity_similarity_threshold: 0.7

    # PPR (Personalized PageRank) 参数
    ppr_alpha: 0.15
    ppr_max_iter: 100

# ============================================================
# Operator 配置
# ============================================================
operators:
  # PreInsert: 固定为 none
  pre_insert:
    action: "none"

  # PostInsert: 固定为 none
  post_insert:
    action: "none"

  # PreRetrieval: 实验变量 - 关键词扩展优化
  pre_retrieval:
    action: "optimize"
    optimize:
      type: "expand_keywords"

      # 关键词提取配置
      max_keywords: 6
      min_keyword_length: 3
      expand_synonyms: true

      # 实体激活配置 (针对图结构优化)
      extract_entities: true
      entity_types: ["PERSON", "ORG", "GPE", "EVENT", "CONCEPT"]
      expand_related_entities: true

      # 关键词扩展提示
      keyword_extraction_prompt: |
        Extract the most important keywords and entities from this question for memory retrieval.
        Focus on nouns, named entities, and domain-specific terms that would help find relevant stored information.

        Question: {question}

        Output format:
        Keywords: [list of 4-6 key terms]
        Entities: [list of named entities with types]
        Synonyms: [alternative terms for key concepts]

      # 实体扩展提示 (图特化)
      entity_expansion_prompt: |
        Given the extracted entities, suggest related entities that might be connected in a knowledge graph.
        Consider relationships like: person-organization, location-event, concept-subconcept, etc.

        Original entities: {entities}

        Related entities: [list with relationship types]

      llm_config:
        max_tokens: 200
        temperature: 0.3

      # 扩展策略配置
      expansion_strategies:
      - "synonym_expansion"        # 同义词扩展
      - "entity_relation_expansion"    # 实体关系扩展
      - "semantic_neighbor_expansion"    # 语义邻居扩展

  # PostRetrieval: 固定为 none
  post_retrieval:
    action: "none"
