# ============================================================
# Mem0 Pipeline 配置
# 论文: Mem0: Building Production-Ready AI Agents with Scalable Long-Term Memory
# 特点: 事实存储 + ADD/UPDATE/DELETE 操作 + 全局摘要
# ============================================================

runtime:
  dataset: "locomo"
  memory_insert_verbose: false
  memory_test_verbose: true
  test_segments: 10

  prompt_template: |
    Based on the above context, answer the following question concisely using exact words from the context whenever possible. If the information is not mentioned in the conversation, respond with "Not mentioned in the conversation".

    Question: {question}
    Answer:

  # LLM 配置
  api_key: "token-abc123"
  base_url: "http://sage2:8000/v1"
  model_name: "/home/cyb/Llama-3.1-8B-Instruct"
  max_tokens: 512
  temperature: 0.3
  seed: 42
  memory_name: "Mem0"

  # Embedding 配置
  embedding_base_url: "http://localhost:8091/v1"
  embedding_model: "BAAI/bge-m3"

# ============================================================
# 服务配置
# ============================================================
services:
  register_memory_service: "hybrid_memory"
  hybrid_memory:
    indexes:
    - name: "semantic"
      type: "vector"
      dim: 1024                       # BAAI/bge-m3 输出 1024 维向量
      embedding_model: "BAAI/bge-m3"
    - name: "keyword"
      type: "bm25"
    fusion_strategy: "weighted"
    fusion_weights:
      semantic: 0.7
      keyword: 0.3
  memory_retrieval_adapter: "none"

# ============================================================
# Operator 配置
# ============================================================
operators:
  # ----------------------------------------------------------
  # PreInsert: 从对话中提取事实候选
  # Mem0 会提取 salient memories（显著事实）
  # ----------------------------------------------------------
  pre_insert:
    action: "extract"
    extract_type: "entity"
    spacy_model: "en_core_web_sm"     # SpaCy 模型用于 entity/noun 提取
    entity_types: ["PERSON", "ORG", "LOC", "DATE", "EVENT"]
    add_to_metadata: true

  # ----------------------------------------------------------
  # PostInsert: ADD/UPDATE/DELETE 决策
  # Mem0 的核心：LLM 决定对已有记忆的操作
  # ----------------------------------------------------------
  post_insert:
    action: "distillation"
    distillation_topk: 10
    distillation_threshold:
    distillation_prompt: |
      You are managing a fact database. Given a new fact and similar existing facts,
      decide the appropriate action:

      - ADD: The new fact is entirely new information
      - UPDATE: The new fact updates/extends an existing fact (delete old, keep new)
      - DELETE: The new fact contradicts an existing fact (delete old, keep new)
      - NOOP: The new fact is redundant (already covered by existing facts)

      New fact: {new_entry}

      Existing facts:
      {memory_list}

      Respond with JSON:
      {"action": "ADD|UPDATE|DELETE|NOOP", "to_delete": ["fact to remove if any"], "reason": "brief explanation"}

  # ----------------------------------------------------------
  # PreRetrieval: 基础 embedding
  # ----------------------------------------------------------
  pre_retrieval:
    action: "embedding"

  # ----------------------------------------------------------
  # PostRetrieval: 简单格式化（Mem0 基础版较简单）
  # ----------------------------------------------------------
  post_retrieval:
    action: "none"
    conversation_format_prompt: |
      The following are relevant facts from memory.
