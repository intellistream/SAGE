"""
================================================================================
MemoryInsert - è®°å¿†æ’å…¥ç®—å­
================================================================================

[æ¶æ„å®šä½]
Pipeline: PreInsert â†’ MemoryInsert(å½“å‰) â†’ PostInsert â†’ PreRetrieval â†’ PostRetrieval
å‰é©±: PreInsertï¼ˆè´Ÿè´£æ•°æ®é¢„å¤„ç†ï¼Œè®¾ç½® text/embedding/metadataï¼‰
åç»§: PostInsertï¼ˆæ’å…¥åå¤„ç†ï¼Œå¦‚æ‘˜è¦ç”Ÿæˆã€æ—¶é—´è¡°å‡ï¼‰

[æ ¸å¿ƒèŒè´£]
çº¯é€ä¼ æ¨¡å¼ï¼šéå† PreInsert è¾“å‡ºçš„ memory_entriesï¼Œè°ƒç”¨è®°å¿†æœåŠ¡çš„ insert æ–¹æ³•

[è¾“å…¥æ•°æ®ç»“æ„] (ç”± PreInsert ç”Ÿæˆ)
data = {
    "memory_entries": [
        {
            "text": str,                    # å¿…é¡»ï¼šè¦å­˜å‚¨çš„æ–‡æœ¬å†…å®¹
            "embedding": list[float],       # å¯é€‰ï¼šé¢„è®¡ç®—çš„å‘é‡
            "metadata": {                   # å¯é€‰ï¼šå…ƒæ•°æ®
                "timestamp": str,           # æ—¶é—´æˆ³
                "source": str,              # æ¥æº
                "triples": list,            # çŸ¥è¯†ä¸‰å…ƒç»„ï¼ˆtri_embedï¼‰
                "vectors": list,            # å¤šå‘é‡ï¼ˆmulti_embedï¼‰
                "is_summary": bool,         # æ˜¯å¦ä¸ºæ‘˜è¦ï¼ˆsummarizeï¼‰
                "chunk_index": int,         # åˆ†å—ç´¢å¼•ï¼ˆchunk_insertï¼‰
                ...
            },
            "insert_mode": str,             # æ’å…¥æ¨¡å¼: "passive" | "active" | ...
            "insert_params": dict,          # æ’å…¥å‚æ•°ï¼ˆæœåŠ¡ç‰¹å®šï¼‰
        },
        ...
    ],
    ...å…¶ä»–é€ä¼ å­—æ®µ...
}

[è¾“å‡ºæ•°æ®ç»“æ„]
dataï¼ˆåŸæ ·é€ä¼ ï¼‰+ insert_stats = {
    "inserted": int,                        # æˆåŠŸæ’å…¥æ•°é‡
    "failed": int,                          # å¤±è´¥æ•°é‡
    "entry_ids": list[str],                 # æ’å…¥çš„æ¡ç›® ID åˆ—è¡¨
}

[è®¾è®¡åŸåˆ™]
1. å•ä¸€èŒè´£ï¼šåªè´Ÿè´£è°ƒç”¨æœåŠ¡çš„ insert æ–¹æ³•ï¼Œä¸åšæ•°æ®è½¬æ¢
2. çº¯é€ä¼ ï¼šPreInsert å·²ç»Ÿä¸€è®¾ç½® text å­—æ®µï¼ŒMemoryInsert ç›´æ¥ä½¿ç”¨
3. é”™è¯¯å®¹å¿ï¼šå•æ¡æ’å…¥å¤±è´¥ä¸å½±å“å…¶ä»–æ¡ç›®
4. å¯è¿½æº¯ï¼šè¿”å›æ’å…¥ç»Ÿè®¡ä¿¡æ¯ä¾› PostInsert ä½¿ç”¨

[PreInsert Action ä¸æ¡ç›®æ•°é‡å…³ç³»]
ä¸åŒçš„ PreInsert action ä¼šäº§ç”Ÿä¸åŒæ•°é‡çš„ memory_entriesï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action          â”‚ æ¡ç›®æ•°é‡         â”‚ è¯´æ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ none            â”‚ 1 æ¡             â”‚ é€ä¼ åŸå§‹å¯¹è¯                          â”‚
â”‚ transform       â”‚ 1 æ¡             â”‚ æ–‡æœ¬è½¬æ¢åçš„å•æ¡è®°å½•                  â”‚
â”‚ extract         â”‚ N æ¡             â”‚ æå–å¤šä¸ªäº‹å®/å®ä½“ï¼Œæ¯ä¸ªä¸€æ¡           â”‚
â”‚ score           â”‚ 1 æ¡             â”‚ å¸¦é‡è¦æ€§è¯„åˆ†çš„å•æ¡è®°å½•                â”‚
â”‚ multi_embed     â”‚ 1 æ¡             â”‚ å•æ¡æ–‡æœ¬ + å¤šå‘é‡å­˜äº metadata        â”‚
â”‚ scm_embed       â”‚ 1 æ¡             â”‚ SCM è¯­ä¹‰å‹ç¼©åçš„å•æ¡è®°å½•              â”‚
â”‚ tri_embed       â”‚ N æ¡             â”‚ æ¯ä¸ªä¸‰å…ƒç»„ç‹¬ç«‹æˆä¸€æ¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹åœºæ™¯ï¼š
- å•æ¡æ’å…¥ (none/transform/score):
  ç”¨æˆ·è¯´ "æˆ‘å–œæ¬¢åƒè‹¹æœ" â†’ 1 æ¡ memory_entry

- å¤šæ¡æ’å…¥ (extract):
  ç”¨æˆ·è¯´ "æˆ‘å«å¼ ä¸‰ï¼Œä»Šå¹´25å²ï¼Œä½åœ¨åŒ—äº¬"
  â†’ 3 æ¡: ["ç”¨æˆ·åå­—æ˜¯å¼ ä¸‰", "ç”¨æˆ·å¹´é¾„25å²", "ç”¨æˆ·ä½åœ¨åŒ—äº¬"]

- å¤šæ¡æ’å…¥ (tri_embed):
  æå–ä¸‰å…ƒç»„ [(å¼ ä¸‰, å¹´é¾„, 25), (å¼ ä¸‰, å±…ä½åœ°, åŒ—äº¬)]
  â†’ 2 æ¡ï¼Œæ¯æ¡ metadata å«å¯¹åº” triple
"""

from __future__ import annotations

import time
from dataclasses import asdict, dataclass
from typing import Any

from sage.common.core import MapFunction

# ==============================================================================
# æ•°æ®æ¨¡å‹
# ==============================================================================


@dataclass
class InsertStats:
    """æ’å…¥ç»Ÿè®¡æ•°æ®æ¨¡å‹

    Attributes:
        inserted: æˆåŠŸæ’å…¥çš„æ•°é‡
        failed: æ’å…¥å¤±è´¥çš„æ•°é‡
        entry_ids: æˆåŠŸæ’å…¥çš„æ¡ç›® ID åˆ—è¡¨
        entries: æˆåŠŸæ’å…¥çš„å®Œæ•´æ¡ç›®ä¿¡æ¯ï¼ˆåŒ…å« id, text, embedding, metadataï¼‰
        errors: å¤±è´¥æ¡ç›®çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯åˆ—è¡¨
    """

    inserted: int
    failed: int
    entry_ids: list[str]
    entries: list[dict[str, Any]]  # ä¿ç•™å®Œæ•´ä¿¡æ¯ï¼Œé¿å… PostInsert é‡å¤æŸ¥è¯¢
    errors: list[dict[str, Any]]


# ==============================================================================
# MemoryInsert ç±»
# ==============================================================================


class MemoryInsert(MapFunction):
    """è®°å¿†æ’å…¥ç®—å­ - çº¯é€ä¼ æ¨¡å¼ï¼ˆé‡æ„ç‰ˆï¼‰

    èŒè´£ï¼š
    1. éå† PreInsert è¾“å‡ºçš„ memory_entries
    2. è°ƒç”¨è®°å¿†æœåŠ¡çš„ insert æ–¹æ³•
    3. ç»Ÿè®¡æ’å…¥ç»“æœï¼Œé€ä¼ ç»™ PostInsert

    é‡æ„æ”¹è¿›ï¼š
    - å¼•å…¥ InsertStats æ•°æ®ç±»ï¼Œç»Ÿä¸€ç»Ÿè®¡æ ¼å¼
    - å¢å¼ºé”™è¯¯å¤„ç†ï¼Œè®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆentry æ–‡æœ¬ + å¼‚å¸¸æ¶ˆæ¯ï¼‰
    - æ”¯æŒ verbose æ—¥å¿—æ¨¡å¼ï¼Œæ–¹ä¾¿è°ƒè¯•
    - ä»£ç ç²¾ç®€è‡³ < 100 è¡Œï¼ˆä¸»ç±»ï¼‰
    """

    # --------------------------------------------------------------------------
    # åˆå§‹åŒ–
    # --------------------------------------------------------------------------

    def __init__(self, config=None):
        """åˆå§‹åŒ– MemoryInsert

        Args:
            config: RuntimeConfig å¯¹è±¡ï¼Œç”¨äºè·å–æœåŠ¡åç§°å’Œé…ç½®é¡¹
        """
        super().__init__()
        self.config = config
        self.service_name = config.get("services.register_memory_service", "short_term_memory")
        self.verbose = config.get("runtime.memory_insert_verbose", False)

    # --------------------------------------------------------------------------
    # ä¸»æ‰§è¡Œæµç¨‹
    # --------------------------------------------------------------------------

    def execute(self, data: dict[str, Any]) -> dict[str, Any]:
        """æ‰§è¡Œè®°å¿†æ’å…¥

        æµç¨‹ï¼š
        1. éå† memory_entries
        2. é€æ¡è°ƒç”¨ _insert_entry
        3. ç»Ÿè®¡ç»“æœå¹¶è¿”å›

        Args:
            data: ç”± PreInsert è¾“å‡ºçš„æ•°æ®ï¼ŒåŒ…å« memory_entries

        Returns:
            åŸå§‹æ•°æ® + insert_stats ç»Ÿè®¡ä¿¡æ¯
        """
        memory_entries = data.get("memory_entries", [])
        stats = InsertStats(inserted=0, failed=0, entry_ids=[], entries=[], errors=[])

        # ============ DEBUG: æ’å…¥å‰æ‰“å° ============
        # print("\n" + "=" * 80)
        # print(f"ğŸ“¥ [MemoryInsert] å‡†å¤‡æ’å…¥ {len(memory_entries)} æ¡è®°å¿†")
        # print("=" * 80)
        # for idx, entry in enumerate(memory_entries, 1):
        #     text = entry.get("text", "")  # æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬ï¼Œä¸æˆªæ–­
        #     metadata = entry.get("metadata", {})
        #     triples = metadata.get("triples", [])
        #     print(f"\næ¡ç›® #{idx}:")
        #     print(f"  æ–‡æœ¬: {text}")
        #     if triples:
        #         print(f"  ä¸‰å…ƒç»„: {triples}")
        #     # æ˜¾ç¤ºå…¶ä»–å…ƒæ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
        #     if metadata:
        #         other_meta = {k: v for k, v in metadata.items() if k != "triples"}
        #         if other_meta:
        #             print(f"  å…¶ä»–å…ƒæ•°æ®: {other_meta}")
        # print("\n" + "=" * 80)
        # ============ DEBUG END ============

        # è®°å½•æ‰¹æ¬¡æ€»è€—æ—¶
        batch_start = time.perf_counter()

        for entry in memory_entries:
            try:
                entry_id = self._insert_entry(entry)
                stats.inserted += 1
                stats.entry_ids.append(entry_id)

                # ä¿ç•™å®Œæ•´ä¿¡æ¯ä¾› PostInsert ä½¿ç”¨ï¼ˆé¿å…é‡å¤æŸ¥è¯¢æœåŠ¡ï¼‰
                stats.entries.append(
                    {
                        "id": entry_id,
                        "text": entry.get("text", ""),
                        "embedding": entry.get("embedding"),
                        "metadata": entry.get("metadata", {}),
                    }
                )

                if self.verbose:
                    self._log_insert(entry, entry_id)

            except Exception as e:
                stats.failed += 1
                stats.errors.append(
                    {
                        "entry": entry.get("text", "")[:100],
                        "error": str(e),
                    }
                )
                self.logger.warning(f"Insert failed: {e}")

        # è®¡ç®—æ‰¹æ¬¡æ€»è€—æ—¶
        batch_elapsed_ms = (time.perf_counter() - batch_start) * 1000

        # ============ DEBUG: æ’å…¥ç»“æœç»Ÿè®¡ ============
        print("\n" + "=" * 80)
        print("âœ… [MemoryInsert] æ’å…¥å®Œæˆ")
        print("=" * 80)
        print(f"æˆåŠŸæ’å…¥: {stats.inserted} æ¡")
        print(f"æ’å…¥å¤±è´¥: {stats.failed} æ¡")
        print(f"æ€»è€—æ—¶: {batch_elapsed_ms:.2f}ms")
        if stats.errors:
            print("\nå¤±è´¥è¯¦æƒ…:")
            for err in stats.errors[:3]:  # åªæ˜¾ç¤ºå‰3ä¸ªé”™è¯¯
                print(f"  âœ— {err['entry'][:50]}... - {err['error']}")
        print("=" * 80)
        # ============ DEBUG END ============

        # å°†ç»Ÿè®¡ä¿¡æ¯è½¬ä¸ºå­—å…¸å¹¶æ·»åŠ åˆ°æ•°æ®ä¸­
        data["insert_stats"] = asdict(stats)

        # ä½¿ç”¨è¾“å…¥çš„ dialogs æ•°é‡å¹³å‡åˆ†é…æ—¶é—´
        dialog_count = len(data.dialogs) if hasattr(data, "dialogs") else 1
        if dialog_count > 0:
            per_dialog_ms = batch_elapsed_ms / dialog_count
            data.setdefault("stage_timings", {})["memory_insert_ms"] = [
                per_dialog_ms
            ] * dialog_count
        else:
            data.setdefault("stage_timings", {})["memory_insert_ms"] = []

        return data

    # --------------------------------------------------------------------------
    # å•æ¡æ’å…¥
    # --------------------------------------------------------------------------

    def _insert_entry(self, entry: dict[str, Any]) -> str:
        """æ’å…¥å•æ¡è®°å¿†åˆ°æœåŠ¡

        å­—æ®µè¯´æ˜ï¼š
        - text: å¿…é¡»ï¼Œè¦å­˜å‚¨çš„æ–‡æœ¬ï¼ˆç”± PreInsert ç»Ÿä¸€è®¾ç½®ï¼‰
        - embedding: å¯é€‰ï¼Œé¢„è®¡ç®—çš„å‘é‡
        - metadata: å¯é€‰ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€æ¥æºã€ä¸‰å…ƒç»„ç­‰
        - insert_mode: æ’å…¥æ¨¡å¼ï¼Œé»˜è®¤ "passive"
        - insert_params: æœåŠ¡ç‰¹å®šçš„æ’å…¥å‚æ•°

        Args:
            entry: è®°å¿†æ¡ç›®å­—å…¸

        Returns:
            æ’å…¥æˆåŠŸè¿”å›æ¡ç›® ID

        Raises:
            ValueError: å¦‚æœ text å­—æ®µä¸ºç©º
            Exception: æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶çš„å„ç§å¼‚å¸¸
        """
        # 1. éªŒè¯å¿…å¡«å­—æ®µ
        text = entry.get("text", "")
        if not text:
            raise ValueError("Entry text is empty")

        # 2. è°ƒç”¨è®°å¿†æœåŠ¡
        return self.call_service(
            self.service_name,
            method="insert",
            entry=text,
            vector=entry.get("embedding"),
            metadata=entry.get("metadata", {}),
            insert_mode=entry.get("insert_mode", "passive"),
            insert_params=entry.get("insert_params"),
            timeout=10.0,
        )

    # --------------------------------------------------------------------------
    # æ—¥å¿—è¾…åŠ©æ–¹æ³•
    # --------------------------------------------------------------------------

    def _log_insert(self, entry: dict[str, Any], entry_id: str) -> None:
        """è®°å½•æ’å…¥è¯¦æƒ…ï¼ˆä»…åœ¨ verbose æ¨¡å¼ä¸‹ï¼‰

        Args:
            entry: æ’å…¥çš„æ¡ç›®å­—å…¸
            entry_id: æ’å…¥åçš„æ¡ç›® ID
        """
        text = entry.get("text", "")[:50]  # æˆªæ–­æ˜¾ç¤º
        mode = entry.get("insert_mode", "passive")
        self.logger.info(f"Inserted [{entry_id}] (mode={mode}): {text}...")


# ==============================================================================
# é™„å½•ï¼šç‰¹æ®Šæ’å…¥æ¨¡å¼è¯´æ˜
# ==============================================================================
#
# [insert_mode å–å€¼]
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ æ¨¡å¼     â”‚ è¯´æ˜                                                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ passive  â”‚ è¢«åŠ¨æ’å…¥ï¼ˆé»˜è®¤ï¼‰ï¼Œç”±è®°å¿†æœåŠ¡è‡ªè¡Œå†³å®šå­˜å‚¨å±‚çº§                     â”‚
# â”‚ active   â”‚ ä¸»åŠ¨æ’å…¥ï¼Œæ˜ç¡®æŒ‡å®šç›®æ ‡å±‚çº§ï¼ˆå¦‚ LTMï¼‰ï¼Œé€šå¸¸ç”¨äºé«˜ä»·å€¼ä¿¡æ¯         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# [insert_params ç¤ºä¾‹]
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ å‚æ•°ç»„åˆ                            â”‚ ä½¿ç”¨åœºæ™¯                              â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ {"target_tier": "ltm"}              â”‚ æ‘˜è¦æ’å…¥ï¼Œç›´æ¥å­˜å…¥é•¿æœŸè®°å¿†            â”‚
# â”‚ {"target_tier": "ltm", "priority":8}â”‚ é«˜åˆ†è®°å¿†(â‰¥8)ï¼Œä¼˜å…ˆçº§æ’å…¥ LTM          â”‚
# â”‚ {"target_tier": "mtm"}              â”‚ ä¸­ç­‰åˆ†æ•°(5-7)ï¼Œæ’å…¥ä¸­æœŸè®°å¿†           â”‚
# â”‚ None (æ— å‚æ•°)                       â”‚ æ™®é€šæ’å…¥ï¼Œç”±æœåŠ¡å†³å®šå±‚çº§              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# [PreInsert Action ä¸ç‰¹æ®Šæ’å…¥çš„å¯¹åº”å…³ç³»]
#
# 1. transform (summarize) â†’ active + {"target_tier": "ltm"}
#    æ‘˜è¦æ˜¯é«˜åº¦æµ“ç¼©çš„ä¿¡æ¯ï¼Œé€šå¸¸ä¸»åŠ¨æ’å…¥ LTM
#
# 2. score (importance) â†’ æ ¹æ®è¯„åˆ†åŠ¨æ€å†³å®šï¼š
#    - score â‰¥ 8: active + {"target_tier": "ltm", "priority": score}
#    - score 5-7: passive + {"target_tier": "mtm"}
#    - score < 5: passive + æ— ç‰¹æ®Šå‚æ•°ï¼ˆSTMï¼‰
#
# 3. å…¶ä»– action (none, extract, multi_embed, scm_embed, tri_embed):
#    - é»˜è®¤: passive + æ— ç‰¹æ®Šå‚æ•°
#
# [è®°å¿†æœåŠ¡å¦‚ä½•ä½¿ç”¨è¿™äº›å‚æ•°]
# è®°å¿†æœåŠ¡çš„ insert æ–¹æ³•æ¥æ”¶ insert_mode å’Œ insert_paramsï¼Œæ ¹æ®è¿™äº›å‚æ•°
# å†³å®šå°†è®°å¿†å­˜å…¥ STM (çŸ­æœŸ) / MTM (ä¸­æœŸ) / LTM (é•¿æœŸ) å“ªä¸ªå±‚çº§ã€‚
# å…·ä½“å®ç°å–å†³äºå„ä¸ªè®°å¿†æœåŠ¡çš„ç­–ç•¥ã€‚
#
