# C++æ‰©å±•å®‰è£…è¿›åº¦æ˜¾ç¤ºå’Œå¡ä½é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨è¿è¡Œ`./quickstart.sh`å®‰è£…SAGEæ—¶ï¼Œç”¨æˆ·æŠ¥å‘Šä»¥ä¸‹é—®é¢˜ï¼š

1. **ç¬¬ä¸€æ¬¡å®‰è£…æ—¶å¡ä½å¾ˆä¹…**ï¼Œä¸çŸ¥é“æ˜¯å¦å¤±è´¥
1. **æ²¡æœ‰è¿›åº¦æ˜¾ç¤º**ï¼Œæ— æ³•çŸ¥é“æ„å»ºè¿›å±•
1. **æ—¥å¿—æœ€åä¸€è¡Œ**æ˜¾ç¤º"è¿è¡Œ 'sage extensions status' éªŒè¯å®‰è£…"åå°±åœæ­¢ï¼Œä¸ç¡®å®šæ˜¯å®Œæˆè¿˜æ˜¯hangä½

## âœ… å·²å®ç°çš„è§£å†³æ–¹æ¡ˆ

### 1. å®æ—¶è¿›åº¦æ˜¾ç¤º âœ¨

æ„å»ºC++æ‰©å±•æ—¶ä¼šæ˜¾ç¤ºï¼š

- â ‹ åŠ¨ç”»è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆæ—‹è½¬çš„spinnerï¼‰
- ğŸ• æ„å»ºæ—¶é—´è®¡æ•°å™¨ï¼ˆæ ¼å¼ï¼šMM:SSï¼‰
- ğŸ“ æ„å»ºæ—¥å¿—æ–‡ä»¶è·¯å¾„
- ğŸ’¡ æç¤ºä¿¡æ¯ï¼š"æ„å»ºå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ"

**æ•ˆæœç¤ºä¾‹ï¼š**

```
ğŸ§© SAGE C++ æ‰©å±•å®‰è£…å™¨
==================================================

â”â”â” å®‰è£… sage_db â”â”â”
â„¹ï¸ æ„å»º sage_db...
   æ„å»ºæ—¥å¿—: /home/user/SAGE/.sage/logs/extensions/sage_db_build.log
   å®æ—¶æŸ¥çœ‹: tail -f /home/user/SAGE/.sage/logs/extensions/sage_db_build.log

â ‹ æ­£åœ¨æ„å»º sage_db... [03:24]  (æ„å»ºå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)
âœ… sage_db æ„å»ºæˆåŠŸ âœ“
```

### 2. è¾“å‡ºåˆ·æ–°é—®é¢˜ä¿®å¤ ğŸ”§

**é—®é¢˜ï¼š**

- Pythonçš„stdout/stderrå¯èƒ½è¢«ç¼“å†²
- æœ€åçš„æ¶ˆæ¯å¯èƒ½å»¶è¿Ÿæ˜¾ç¤º
- çœ‹èµ·æ¥åƒæ˜¯ç¨‹åºå¡ä½äº†

**è§£å†³ï¼š**

```python
# åœ¨å…³é”®ä½ç½®æ·»åŠ è¾“å‡ºåˆ·æ–°
import sys

sys.stdout.flush()
sys.stderr.flush()
```

**æ”¹è¿›çš„ä½ç½®ï¼š**

- âœ… `_print_install_summary()` - å®‰è£…å®Œæˆæ€»ç»“
- âœ… `_run_build_script()` - æ„å»ºè„šæœ¬æ‰§è¡Œå
- âœ… `status()` - çŠ¶æ€æ£€æŸ¥å‘½ä»¤

### 3. è¿›åº¦çº¿ç¨‹æ¸…ç†ä¼˜åŒ– ğŸ§µ

**é—®é¢˜ï¼š**

- åå°è¿›åº¦æ˜¾ç¤ºçº¿ç¨‹å¯èƒ½æ²¡æœ‰æ­£ç¡®æ¸…ç†
- å¯èƒ½å¯¼è‡´ç¨‹åºä¸é€€å‡º

**è§£å†³ï¼š**

```python
finally:
    # åœæ­¢è¿›åº¦æ˜¾ç¤º
    progress_state["running"] = False
    # ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä½†ä¸è¦æ— é™ç­‰å¾…
    if progress_thread.is_alive():
        progress_thread.join(timeout=2.0)
    typer.echo()  # æ¢è¡Œ

    # ç¡®ä¿è¾“å‡ºè¢«åˆ·æ–°
    import sys
    sys.stdout.flush()
    sys.stderr.flush()
```

### 4. è·¨å¹³å°è¶…æ—¶æœºåˆ¶ ğŸŒ

**é—®é¢˜ï¼š**

- åŸæ¥ä½¿ç”¨`signal.SIGALRM`
- åœ¨Windowsä¸Šä¸å¯ç”¨
- åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸å¯é 

**è§£å†³ï¼š** ä½¿ç”¨`threading + queue`å®ç°è·¨å¹³å°è¶…æ—¶ï¼š

```python
import threading
import queue

result_queue = queue.Queue()


def try_import():
    try:
        __import__(module_name)
        result_queue.put(("success", None))
    except Exception as e:
        result_queue.put(("error", e))


import_thread = threading.Thread(target=try_import, daemon=True)
import_thread.start()

# ç­‰å¾…5ç§’è¶…æ—¶
import_thread.join(timeout=5.0)

if import_thread.is_alive():
    print_warning("å¯¼å…¥è¶…æ—¶")
else:
    status, error = result_queue.get_nowait()
    if status == "success":
        print_success("âœ“")
```

**ä¼˜åŠ¿ï¼š**

- âœ… Linux/macOS/Windowså…¨å¹³å°å…¼å®¹
- âœ… å¤šçº¿ç¨‹ç¯å¢ƒå¯é 
- âœ… ä½¿ç”¨daemonçº¿ç¨‹ï¼Œä¸é˜»æ­¢ç¨‹åºé€€å‡º
- âœ… æ˜¾å¼å¤„ç†è¶…æ—¶å’Œé”™è¯¯

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šè¿›åº¦æ˜¾ç¤ºæ­£å¸¸

```bash
cd /home/shuhao/SAGE
sage extensions install sage_db --force

# åº”è¯¥çœ‹åˆ°ï¼š
# â ‹ æ­£åœ¨æ„å»º sage_db... [00:12]  (æ„å»ºå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)
```

### æµ‹è¯•2ï¼šä¸ä¼šå¡ä½

```bash
# ä½¿ç”¨timeoutç¡®ä¿å‘½ä»¤ä¼šå®Œæˆ
timeout 30 sage extensions status

# åº”è¯¥åœ¨5ç§’å†…å®Œæˆï¼Œæ˜¾ç¤ºæ‰©å±•çŠ¶æ€
```

### æµ‹è¯•3ï¼šè¾“å‡ºç«‹å³åˆ·æ–°

```bash
# å³ä½¿é€šè¿‡ç®¡é“ï¼Œè¾“å‡ºä¹Ÿåº”è¯¥ç«‹å³æ˜¾ç¤º
sage extensions status 2>&1 | cat
```

### æµ‹è¯•4ï¼šå®Œæ•´å®‰è£…æµç¨‹

```bash
./quickstart.sh --dev --yes

# åº”è¯¥çœ‹åˆ°æ¸…æ™°çš„è¿›åº¦æŒ‡ç¤º
# å®‰è£…å®Œæˆåæ¶ˆæ¯ç«‹å³æ˜¾ç¤º
```

## ğŸ“ ç”¨æˆ·ä½¿ç”¨æŒ‡å—

### å®‰è£…æ—¶çš„é¢„æœŸè¡Œä¸º

1. **å¼€å§‹å®‰è£…ï¼š**

   ```
   ğŸ§© å®‰è£…C++æ‰©å±• (sage_db, sage_flow)...
   ğŸ“ è¯¦ç»†æ—¥å¿—: /home/user/SAGE/install.log
   ```

1. **æ„å»ºè¿‡ç¨‹ï¼š**

   ```
   â”â”â” å®‰è£… sage_db â”â”â”
   â„¹ï¸ æ„å»º sage_db...
      æ„å»ºæ—¥å¿—: /path/to/sage_db_build.log
      å®æ—¶æŸ¥çœ‹: tail -f /path/to/sage_db_build.log

   â ‹ æ­£åœ¨æ„å»º sage_db... [02:45]  (æ„å»ºå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)
   ```

1. **å®Œæˆæç¤ºï¼š**

   ```
   âœ… sage_db æ„å»ºæˆåŠŸ âœ“

   å®‰è£…å®Œæˆ
   æˆåŠŸ: 2/2
   âœ… ğŸ‰ æ‰€æœ‰æ‰©å±•å®‰è£…æˆåŠŸï¼

   è¿è¡Œ 'sage extensions status' éªŒè¯å®‰è£…
   ```

### å¦‚æœçœ‹èµ·æ¥å¡ä½äº†

#### æ–¹æ³•1ï¼šæŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼ˆæ¨èï¼‰

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­
tail -f /home/shuhao/SAGE/.sage/logs/extensions/sage_db_build.log
tail -f /home/shuhao/SAGE/.sage/logs/extensions/sage_flow_build.log
```

**å¦‚æœæ—¥å¿—åœ¨æ›´æ–°** = æ­£åœ¨æ„å»ºä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…

#### æ–¹æ³•2ï¼šæ£€æŸ¥è¿›ç¨‹

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºè¿›ç¨‹åœ¨è¿è¡Œ
ps aux | grep -E "(cmake|gcc|g\+\+|build\.sh)"
```

**å¦‚æœæœ‰è¿›ç¨‹** = æ­£åœ¨æ„å»ºä¸­

#### æ–¹æ³•3ï¼šæ£€æŸ¥CPUä½¿ç”¨ç‡

```bash
top
# æˆ–
htop
```

**å¦‚æœCPUä½¿ç”¨ç‡é«˜** = æ­£åœ¨ç¼–è¯‘ä¸­

### é¢„æœŸæ„å»ºæ—¶é—´

æ ¹æ®ç¡¬ä»¶é…ç½®ä¸åŒï¼š

- **å¿«é€Ÿï¼ˆSSD + å¤šæ ¸CPUï¼‰ï¼š** 1-3åˆ†é’Ÿ
- **ä¸­ç­‰ï¼ˆæ™®é€šç¡¬ç›˜ + 4æ ¸ï¼‰ï¼š** 3-8åˆ†é’Ÿ
- **æ…¢é€Ÿï¼ˆæ—§ç¡¬ä»¶ï¼‰ï¼š** 8-15åˆ†é’Ÿ

**æ³¨æ„ï¼š** ç¬¬ä¸€æ¬¡æ„å»ºä¼šä¸‹è½½ä¾èµ–ï¼Œå¯èƒ½æ›´æ…¢

### éªŒè¯å®‰è£…

å®‰è£…å®Œæˆåï¼Œè¿è¡Œï¼š

```bash
sage extensions status
```

åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” SAGE æ‰©å±•çŠ¶æ€æ£€æŸ¥
========================================
âœ… æ•°æ®åº“æ‰©å±• (C++) âœ“
âœ… æµå¤„ç†å¼•æ“æ‰©å±• (C++) âœ“

æ€»è®¡: 2/2 æ‰©å±•å¯ç”¨
```

### æ•…éšœæ’æŸ¥

#### é—®é¢˜1ï¼šçœŸçš„å¡ä½äº†ï¼ˆè¶…è¿‡20åˆ†é’Ÿï¼‰

**åŸå› å¯èƒ½ï¼š**

- ç½‘ç»œé—®é¢˜ï¼ˆä¸‹è½½ä¾èµ–å¤±è´¥ï¼‰
- ç¼–è¯‘é”™è¯¯
- å†…å­˜ä¸è¶³

**è§£å†³æ­¥éª¤ï¼š**

1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š

   ```bash
   cat /home/shuhao/SAGE/.sage/logs/extensions/sage_db_build.log
   ```

1. æ£€æŸ¥æœ€åå‡ è¡Œæ˜¯å¦æœ‰é”™è¯¯

1. å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜ï¼Œé‡æ–°è¿è¡Œï¼š

   ```bash
   sage extensions install all --force
   ```

#### é—®é¢˜2ï¼šæ„å»ºå¤±è´¥

æŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼š

```bash
# æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—
cat /home/shuhao/SAGE/.sage/logs/extensions/sage_db_build.log | tail -100

# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
gcc --version
cmake --version
```

ç¡®ä¿å·²å®‰è£…æ„å»ºå·¥å…·ï¼š

```bash
# Ubuntu/Debian
sudo apt install build-essential cmake

# CentOS/RHEL
sudo yum groupinstall 'Development Tools'
sudo yum install cmake

# macOS
xcode-select --install
brew install cmake
```

#### é—®é¢˜3ï¼šæ‰©å±•å®‰è£…æˆåŠŸä½†éªŒè¯å¤±è´¥

```bash
# å°è¯•æ‰‹åŠ¨å¯¼å…¥æµ‹è¯•
python3 -c "
from sage.middleware.components.sage_db.python import _sage_db
print('sage_dbå¯¼å…¥æˆåŠŸ')
"

python3 -c "
from sage.middleware.components.sage_flow.python import _sage_flow
print('sage_flowå¯¼å…¥æˆåŠŸ')
"
```

å¦‚æœå¯¼å…¥æˆåŠŸï¼Œè¯´æ˜æ‰©å±•å·²æ­£ç¡®å®‰è£…ã€‚

## ğŸ”§ å¼€å‘è€…ä¿¡æ¯

### ç›¸å…³æ–‡ä»¶

- `packages/sage-tools/src/sage/tools/cli/commands/extensions.py` - æ‰©å±•ç®¡ç†å‘½ä»¤
- `tools/install/installation_table/main_installer.sh` - å®‰è£…è„šæœ¬
- `packages/sage-tools/tests/pypi/EXTENSIONS_HANG_FIX.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£

### ä¿®æ”¹å†å²

- **Commit 28b10865** - ä¿®å¤è¾“å‡ºç¼“å†²å’Œè¶…æ—¶æœºåˆ¶
- **æ–°å¢åŠŸèƒ½ï¼š** å®æ—¶è¿›åº¦æ˜¾ç¤ºã€è·¨å¹³å°è¶…æ—¶ã€è¾“å‡ºåˆ·æ–°

### æŠ€æœ¯ç»†èŠ‚

æŸ¥çœ‹å®Œæ•´çš„æŠ€æœ¯åˆ†æå’Œè§£å†³æ–¹æ¡ˆï¼š

```bash
cat packages/sage-tools/tests/pypi/EXTENSIONS_HANG_FIX.md
```

## ğŸ’¡ å°è´´å£«

1. **é¦–æ¬¡å®‰è£…æ—¶é—´è¾ƒé•¿æ˜¯æ­£å¸¸çš„**ï¼Œå› ä¸ºéœ€è¦ï¼š

   - ä¸‹è½½C++ä¾èµ–åº“
   - ç¼–è¯‘ä¸¤ä¸ªæ‰©å±•æ¨¡å—ï¼ˆsage_dbå’Œsage_flowï¼‰
   - å®‰è£…åˆ°Pythonç¯å¢ƒ

1. **åç»­é‡æ–°å®‰è£…ä¼šå¿«å¾—å¤š**ï¼Œå› ä¸ºä¾èµ–å·²ç¼“å­˜

1. **å¦‚æœä¸éœ€è¦C++æ‰©å±•**ï¼Œå¯ä»¥è·³è¿‡å®‰è£…ï¼š

   ```bash
   # åªå®‰è£…PythonåŒ…ï¼Œä¸å®‰è£…C++æ‰©å±•
   ./quickstart.sh --dev --yes --skip-extensions
   ```

1. **æŸ¥çœ‹å®æ—¶æ—¥å¿—éå¸¸æœ‰ç”¨**ï¼š

   ```bash
   # åœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯
   tail -f ~/.sage/logs/extensions/*.log
   ```

## ğŸ¯ æ€»ç»“

âœ… **å·²è§£å†³çš„é—®é¢˜ï¼š**

- æ·»åŠ äº†å®æ—¶è¿›åº¦æ˜¾ç¤º
- ä¿®å¤äº†è¾“å‡ºç¼“å†²é—®é¢˜
- æ”¹è¿›äº†çº¿ç¨‹æ¸…ç†
- å®ç°äº†è·¨å¹³å°è¶…æ—¶æœºåˆ¶

âœ… **ç”¨æˆ·ä½“éªŒæ”¹è¿›ï¼š**

- æ¸…æ™°çŸ¥é“æ„å»ºè¿›åº¦
- æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
- ä¸ä¼šè¯¯ä»¥ä¸ºç¨‹åºå¡ä½
- è·¨å¹³å°å¯é å·¥ä½œ

âœ… **ä¸‹æ¬¡å®‰è£…æ—¶ï¼š**

- ä¼šçœ‹åˆ°å®æ—¶è¿›åº¦
- çŸ¥é“æ„å»ºéœ€è¦æ—¶é—´
- å¯ä»¥æŸ¥çœ‹å®æ—¶æ—¥å¿—
- å®‰è£…å®Œæˆç«‹å³çœ‹åˆ°ç»“æœ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–æäº¤Issueï¼
