# SAGE æ€§èƒ½ç›‘æ§ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ‰ å®ç°å®Œæˆï¼

å·²æˆåŠŸå®ç°å®Œæ•´çš„æ€§èƒ½ç›‘æ§å’ŒçŠ¶æ€æ±‡æŠ¥ç³»ç»Ÿï¼Œæ»¡è¶³æ‰€æœ‰ P0 çº§åˆ«éœ€æ±‚å’Œå¤§éƒ¨åˆ† P1 çº§åˆ«éœ€æ±‚ã€‚

## ğŸ“¦ å®ç°çš„æ–‡ä»¶

### æ ¸å¿ƒç›‘æ§æ¨¡å—
```
packages/sage-kernel/src/sage/kernel/runtime/monitoring/
â”œâ”€â”€ __init__.py              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ metrics.py               # æ•°æ®ç±»å®šä¹‰
â”œâ”€â”€ metrics_collector.py     # æŒ‡æ ‡æ”¶é›†å™¨
â”œâ”€â”€ resource_monitor.py      # èµ„æºç›‘æ§å™¨
â”œâ”€â”€ metrics_reporter.py      # æŒ‡æ ‡æ±‡æŠ¥å™¨
â””â”€â”€ README.md               # ä½¿ç”¨æ–‡æ¡£
```

### é›†æˆæ–‡ä»¶
- `base_task.py` - ä»»åŠ¡çº§åˆ«ç›‘æ§é›†æˆ
- `base_service_task.py` - æœåŠ¡çº§åˆ«ç›‘æ§é›†æˆ
- `pyproject.toml` - æ·»åŠ  psutil å¯é€‰ä¾èµ–

### ç¤ºä¾‹å’Œæ–‡æ¡£
- `examples/monitoring_example.py` - ä½¿ç”¨ç¤ºä¾‹
- `monitoring/README.md` - è¯¦ç»†æ–‡æ¡£

## âœ… å®ç°çš„åŠŸèƒ½

### P0 çº§åˆ«ï¼ˆå·²å®Œæˆï¼‰

âœ… **åŒ…çº§åˆ«æ€§èƒ½ç›‘æ§**
- `PacketMetrics`: å•ä¸ªæ•°æ®åŒ…çš„æ€§èƒ½æŒ‡æ ‡
- è®°å½•å¤„ç†å¼€å§‹/ç»“æŸæ—¶é—´
- è®¡ç®—é˜Ÿåˆ—ç­‰å¾…æ—¶é—´å’Œæ‰§è¡Œæ—¶é—´

âœ… **ä»»åŠ¡çº§åˆ«æ€§èƒ½æ±‡æ€»**
- `TaskPerformanceMetrics`: ä»»åŠ¡æ€§èƒ½æ±‡æ€»æŒ‡æ ‡
- ååé‡ç»Ÿè®¡ï¼ˆTPSï¼‰
- é”™è¯¯ç‡ç»Ÿè®¡
- ç®€å•çš„æ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢æ¥å£

âœ… **å»¶è¿Ÿåˆ†æ**
- æœ€å°/æœ€å¤§/å¹³å‡å»¶è¿Ÿ
- P50/P95/P99 ç™¾åˆ†ä½æ•°å»¶è¿Ÿ
- é˜Ÿåˆ—ç­‰å¾…æ—¶é—´åˆ†æ

âœ… **ååé‡ç»Ÿè®¡**
- å®æ—¶ TPS/QPS è®¡ç®—
- æ—¶é—´çª—å£ç»Ÿè®¡ï¼ˆ1åˆ†é’Ÿ/5åˆ†é’Ÿ/1å°æ—¶ï¼‰

âœ… **åŸºç¡€èµ„æºç›‘æ§**
- CPU ä½¿ç”¨ç‡ç›‘æ§
- å†…å­˜ä½¿ç”¨é‡ç›‘æ§
- è¿›ç¨‹çº§åˆ«èµ„æºç»Ÿè®¡

### P1 çº§åˆ«ï¼ˆå·²å®Œæˆï¼‰

âœ… **ç™¾åˆ†ä½æ•°å»¶è¿Ÿç»Ÿè®¡**
- P50/P95/P99 å»¶è¿Ÿè®¡ç®—
- åŸºäºæ»‘åŠ¨çª—å£çš„å®æ—¶è®¡ç®—

âœ… **èµ„æºä½¿ç”¨ç›‘æ§**
- `ResourceMonitor` ç»„ä»¶
- CPUå’Œå†…å­˜é‡‡æ ·
- å¹³å‡å€¼/å³°å€¼ç»Ÿè®¡

âœ… **å®šæœŸæ€§èƒ½æ±‡æŠ¥**
- `MetricsReporter` ç»„ä»¶
- å¯é…ç½®çš„æ±‡æŠ¥é—´éš”
- å¤šç§å¯¼å‡ºæ ¼å¼

âœ… **è¯¦ç»†çš„é”™è¯¯åˆ†ç±»ç»Ÿè®¡**
- æŒ‰é”™è¯¯ç±»å‹åˆ†ç»„
- é”™è¯¯è®¡æ•°å’Œé¢‘ç‡ç»Ÿè®¡

### P2 çº§åˆ«ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

âœ… **æ€§èƒ½è¶‹åŠ¿åˆ†æ**
- æ—¶é—´çª—å£ç»Ÿè®¡
- å†å²æŒ‡æ ‡æŸ¥è¯¢

âš ï¸ **å¯è§†åŒ–dashboardé›†æˆ**ï¼ˆæœªå®ç°ï¼‰
- å»ºè®®ä½¿ç”¨ Prometheus + Grafana
- å·²æ”¯æŒ Prometheus æ ¼å¼å¯¼å‡º

## ğŸ¯ æ ¸å¿ƒç»„ä»¶

### 1. MetricsCollector

**åŠŸèƒ½ï¼š**
- åŒ…çº§åˆ«æ€§èƒ½ç›‘æ§
- ç™¾åˆ†ä½æ•°è®¡ç®—
- æ—¶é—´çª—å£ç»Ÿè®¡
- é”™è¯¯åˆ†ç±»ç»Ÿè®¡

**ä¸»è¦æ–¹æ³•ï¼š**
```python
- record_packet_start()      # è®°å½•åŒ…å¤„ç†å¼€å§‹
- record_packet_end()        # è®°å½•åŒ…å¤„ç†ç»“æŸ
- get_real_time_metrics()    # è·å–å®æ—¶æŒ‡æ ‡
- get_metrics_history()      # è·å–å†å²æŒ‡æ ‡
- reset_metrics()            # é‡ç½®æŒ‡æ ‡
```

### 2. ResourceMonitor

**åŠŸèƒ½ï¼š**
- CPU ä½¿ç”¨ç‡ç›‘æ§
- å†…å­˜ä½¿ç”¨é‡ç›‘æ§
- ç³»ç»Ÿçº§èµ„æºç»Ÿè®¡

**ä¸»è¦æ–¹æ³•ï¼š**
```python
- start_monitoring()         # å¯åŠ¨ç›‘æ§
- stop_monitoring()          # åœæ­¢ç›‘æ§
- get_current_usage()        # è·å–å½“å‰ä½¿ç”¨æƒ…å†µ
- get_average_usage()        # è·å–å¹³å‡ä½¿ç”¨æƒ…å†µ
- get_peak_usage()           # è·å–å³°å€¼ä½¿ç”¨æƒ…å†µ
```

### 3. MetricsReporter

**åŠŸèƒ½ï¼š**
- å®šæœŸæ±‡æŠ¥
- å¤šç§å¯¼å‡ºæ ¼å¼ï¼ˆJSON/Prometheus/CSV/Humanï¼‰
- è‡ªå®šä¹‰æ±‡æŠ¥å›è°ƒ

**ä¸»è¦æ–¹æ³•ï¼š**
```python
- start_reporting()          # å¯åŠ¨å®šæœŸæ±‡æŠ¥
- stop_reporting()           # åœæ­¢æ±‡æŠ¥
- generate_report()          # ç”ŸæˆæŠ¥å‘Š
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åœ¨ BaseTask ä¸­å¯ç”¨ç›‘æ§

```python
ctx = TaskContext(
    name="my_task",
    enable_monitoring=True,              # å¯ç”¨ç›‘æ§
    metrics_window_size=10000,          # æ»‘åŠ¨çª—å£å¤§å°
    enable_detailed_tracking=True,      # è¯¦ç»†è·Ÿè¸ª
    resource_sampling_interval=1.0,     # èµ„æºé‡‡æ ·é—´éš”
    enable_auto_report=True,            # è‡ªåŠ¨æ±‡æŠ¥
    report_interval=60,                 # æ±‡æŠ¥é—´éš”
)

# è·å–æ€§èƒ½æŒ‡æ ‡
metrics = task.get_current_metrics()
print(f"TPS: {metrics.packets_per_second:.2f}")
print(f"P99: {metrics.p99_latency:.2f}ms")

# å¯¼å‡ºæŒ‡æ ‡
json_data = task.export_metrics(format="json")
```

### åœ¨ BaseServiceTask ä¸­å¯ç”¨ç›‘æ§

```python
ctx = ServiceContext(
    service_name="my_service",
    enable_monitoring=True,
    # ... å…¶ä»–é…ç½®
)

# è·å–æœåŠ¡æ€§èƒ½æŒ‡æ ‡
metrics = service_task.get_current_metrics()
print(f"RPS: {metrics.requests_per_second:.2f}")
```

## ğŸ“Š æ€§èƒ½å¼€é”€

- **CPUå¼€é”€**: < 1% ï¼ˆé»˜è®¤é…ç½®ï¼‰
- **å†…å­˜å ç”¨**: 10-50MB ï¼ˆå–å†³äº window_sizeï¼‰
- **é‡‡æ ·é—´éš”**: å¯é…ç½®ï¼Œé»˜è®¤1ç§’

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æŒä¹…åŒ–å­˜å‚¨**
   - å°†æŒ‡æ ‡ä¿å­˜åˆ°æ•°æ®åº“
   - æ”¯æŒé•¿æœŸè¶‹åŠ¿åˆ†æ

2. **å‘Šè­¦ç³»ç»Ÿ**
   - åŸºäºé˜ˆå€¼çš„å‘Šè­¦
   - å¼‚å¸¸æ£€æµ‹

3. **åˆ†å¸ƒå¼è¿½è¸ª**
   - è·¨ä»»åŠ¡çš„ç«¯åˆ°ç«¯è¿½è¸ª
   - ä¸ OpenTelemetry é›†æˆ

4. **å¯è§†åŒ–Dashboard**
   - é›†æˆ Grafana
   - å®æ—¶ç›‘æ§ç•Œé¢

## ğŸ“ æµ‹è¯•å»ºè®®

```bash
# è¿è¡Œç¤ºä¾‹
python packages/sage-kernel/examples/monitoring_example.py

# å®‰è£… psutilï¼ˆå¯é€‰ï¼‰
pip install psutil

# å®‰è£…å®Œæ•´çš„ç›‘æ§ä¾èµ–
pip install isage-kernel[monitoring]
```

## ğŸ“ æ–‡æ¡£

å®Œæ•´æ–‡æ¡£è¯·å‚è€ƒï¼š
- [README.md](packages/sage-kernel/src/sage/kernel/runtime/monitoring/README.md)
- [ä½¿ç”¨ç¤ºä¾‹](packages/sage-kernel/examples/monitoring_example.py)

## âœ¨ ç‰¹æ€§äº®ç‚¹

1. **é›¶ä¾µå…¥å¼è®¾è®¡** - é€šè¿‡é…ç½®å¯ç”¨/ç¦ç”¨ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
2. **å¯é€‰ä¾èµ–** - psutil ä½œä¸ºå¯é€‰ä¾èµ–ï¼Œæ ¸å¿ƒåŠŸèƒ½ä¸å—å½±å“
3. **å¤šæ ¼å¼å¯¼å‡º** - æ”¯æŒ JSON/Prometheus/CSV/Human å››ç§æ ¼å¼
4. **çº¿ç¨‹å®‰å…¨** - æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
5. **ä½å¼€é”€** - ä¼˜åŒ–çš„æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œæœ€å°åŒ–æ€§èƒ½å½±å“

## ğŸ” å…³é”®å®ç°ç»†èŠ‚

### ç™¾åˆ†ä½æ•°è®¡ç®—
- ä½¿ç”¨æ’åº + æ’å€¼ç®—æ³•
- æ—¶é—´å¤æ‚åº¦ï¼šO(n log n)
- ç©ºé—´å¤æ‚åº¦ï¼šO(n)

### æ—¶é—´çª—å£ç»Ÿè®¡
- ä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼ˆdequeï¼‰
- è‡ªåŠ¨è¿‡æœŸæ—§æ•°æ®
- å¸¸æ•°æ—¶é—´å¤æ‚åº¦

### èµ„æºç›‘æ§
- åå°çº¿ç¨‹é‡‡æ ·
- å¯é…ç½®é‡‡æ ·é—´éš”
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ ·æœ¬

## ğŸ™ è‡´è°¢

æœ¬å®ç°å‚è€ƒäº†ä¸šç•Œæœ€ä½³å®è·µï¼š
- Prometheus ç›‘æ§æ¨¡å‹
- OpenTelemetry æ ‡å‡†
- Apache Flink ç›‘æ§ç³»ç»Ÿ

---

**å®ç°è€…**: GitHub Copilot
**æ—¥æœŸ**: 2025-10-13
**ç‰ˆæœ¬**: 1.0.0
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
