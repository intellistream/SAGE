# ===============================================
# SAGE æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ (Build and Release)
# ===============================================
# ç›®çš„ï¼šæ„å»ºç”Ÿäº§ç¯å¢ƒçš„ wheel åŒ…å¹¶å‘å¸ƒåˆ° PyPI å’Œ GitHub Releases
#
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€åˆ° main åˆ†æ”¯ï¼ˆç¨³å®šç‰ˆæœ¬ï¼‰
# - æ¨é€ v* æ ‡ç­¾ï¼ˆæ­£å¼å‘å¸ƒï¼‰
# - å‘å¸ƒ GitHub Release
#
# ä¸ ci.yml çš„åŒºåˆ«ï¼š
# - æ­¤å·¥ä½œæµä¸“æ³¨äº**æ‰“åŒ…å’Œå‘å¸ƒ**
# - æ„å»ºç”Ÿäº§ç¯å¢ƒçš„ wheel åŒ…
# - å¯ä»¥å‘å¸ƒåˆ° PyPI å’Œ GitHub Releases
# - ä¸è¿è¡Œè¯¦ç»†çš„æµ‹è¯•å¥—ä»¶
#
# æ„å»ºæµç¨‹ï¼š
# 1. æ„å»ºå­åŒ… (sage-common, sage-kernel, sage-middleware, sage-libs)
# 2. æ„å»º meta åŒ… (isage) - ä¾èµ–æ‰€æœ‰å­åŒ…
# 3. è¿è¡ŒåŸºæœ¬æµ‹è¯•éªŒè¯ wheel åŒ…
# 4. å‘å¸ƒåˆ° GitHub Releases å’Œ PyPI (ä»…é™æ ‡ç­¾è§¦å‘)
# ===============================================

name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  PYTHON_VERSION: '3.11'  # ç»Ÿä¸€ä½¿ç”¨çš„ Python ç‰ˆæœ¬
  
jobs:
  # ===================
  # å­åŒ…æ„å»ºä»»åŠ¡
  # ===================
  # åŠŸèƒ½ï¼šå¹¶è¡Œæ„å»ºæ‰€æœ‰ SAGE å­åŒ…çš„ wheel æ–‡ä»¶
  # ç­–ç•¥ï¼šä½¿ç”¨ matrix ç­–ç•¥å¹¶è¡Œæ„å»º 4 ä¸ªå­åŒ…
  # è¾“å‡ºï¼šæ¯ä¸ªå­åŒ…çš„ .whl æ–‡ä»¶ä½œä¸º artifacts
  build-subpackages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [sage-common, sage-kernel, sage-middleware, sage-libs]
    
    outputs:
      version: ${{ steps.version.outputs.version }}  # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­ä»»åŠ¡ä½¿ç”¨
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬è®¡ç®—
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
                
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel
        
    # ä» _version.py è¯»å–ç‰ˆæœ¬å·ï¼Œæˆ–ä½¿ç”¨ git tag
    - name: Get version
      id: version
      run: |
        # ä»_version.pyè¯»å–ç‰ˆæœ¬å·
        VERSION=$(python -c "
        import sys
        sys.path.insert(0, '.')
        from _version import __version__
        print(__version__)
        ")
        
        # å¦‚æœæ˜¯tagè§¦å‘ï¼Œä½¿ç”¨tagç‰ˆæœ¬
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    # æ„å»ºæŒ‡å®šçš„å­åŒ…
    - name: Build package ${{ matrix.package }}
      run: |
        echo "Building ${{ matrix.package }}..."
        cd packages/${{ matrix.package }}
        python -m build --wheel
        
    # ä¸Šä¼ æ„å»ºçš„ wheel æ–‡ä»¶ä½œä¸º artifacts
    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.package }}-wheels
        path: packages/${{ matrix.package }}/dist/*.whl
        retention-days: 30

  # ===================
  # Meta åŒ…æ„å»ºä»»åŠ¡
  # ===================
  # åŠŸèƒ½ï¼šæ„å»ºä¸»è¦çš„ SAGE meta åŒ… (isage)
  # ä¾èµ–ï¼šå¿…é¡»ç­‰å¾…æ‰€æœ‰å­åŒ…æ„å»ºå®Œæˆ
  # ç‰¹æ®Šå¤„ç†ï¼šå‘å¸ƒæ—¶æ›¿æ¢æœ¬åœ°ä¾èµ–ä¸º PyPI åŒ…å
  build-metapackage:
    needs: build-subpackages  # ç­‰å¾…æ‰€æœ‰å­åŒ…æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ needs.build-subpackages.outputs.version }}     # ä»å­åŒ…ä»»åŠ¡è·å–ç‰ˆæœ¬å·
      wheel-name: ${{ steps.build.outputs.wheel-name }}           # è¾“å‡º wheel æ–‡ä»¶å
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
                
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel
        
    # å…³é”®æ­¥éª¤ï¼šå‘å¸ƒæ—¶æ›¿æ¢æœ¬åœ°æ–‡ä»¶ä¾èµ–ä¸º PyPI åŒ…å
    # ä¾‹å¦‚ï¼š'isage-common @ file:./packages/sage-common' â†’ 'isage-common'
    - name: Update dependencies for PyPI release
      if: startsWith(github.ref, 'refs/tags/v')  # ä»…åœ¨æ ‡ç­¾å‘å¸ƒæ—¶æ‰§è¡Œ
      run: |
        # For release builds, replace local file dependencies with PyPI package names
        python -c "
        import re
        
        # Read current pyproject.toml
        with open('pyproject.toml', 'r') as f:
            content = f.read()
        
        print('Original dependencies section:')
        print('=' * 50)
        
        # Show current dependencies section for debugging
        deps_match = re.search(r'dependencies = \[(.*?)\]', content, re.DOTALL)
        if deps_match:
            print(deps_match.group(0))
        
        print('=' * 50)
        
        # Replace local file dependencies with PyPI package names
        # Pattern: 'isage-PACKAGE @ file:./packages/sage-PACKAGE' â†’ 'isage-PACKAGE'
        new_content = re.sub(
            r'\"isage-([a-zA-Z_-]+) @ file:\./packages/sage-[a-zA-Z_-]+\"',
            r'\"isage-\1\"',
            content
        )
        
        # Also handle single quotes
        new_content = re.sub(
            r\"'isage-([a-zA-Z_-]+) @ file:\./packages/sage-[a-zA-Z_-]+'\",
            r\"'isage-\1'\",
            new_content
        )
        
        # Write updated content
        with open('pyproject.toml', 'w') as f:
            f.write(new_content)
        
        print('Updated dependencies section:')
        print('=' * 50)
        
        # Show updated dependencies section for verification
        with open('pyproject.toml', 'r') as f:
            updated_content = f.read()
            
        deps_match = re.search(r'dependencies = \[(.*?)\]', updated_content, re.DOTALL)
        if deps_match:
            print(deps_match.group(0))
            
        print('=' * 50)
        print('âœ… Dependencies updated for PyPI release')
        "
        
    # æ„å»º meta åŒ… wheel
    - name: Build metapackage
      id: build
      run: |
        echo "Building metapackage..."
        python -m build --wheel
        
        # è·å–ç”Ÿæˆçš„wheelæ–‡ä»¶å
        WHEEL_FILE=$(ls dist/*.whl | head -1)
        WHEEL_NAME=$(basename "$WHEEL_FILE")
        
        echo "wheel-name=$WHEEL_NAME" >> $GITHUB_OUTPUT
        echo "Built metapackage wheel: $WHEEL_NAME"
        
    # ä¸Šä¼  meta åŒ… wheel æ–‡ä»¶
    - name: Upload metapackage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: metapackage-wheel
        path: dist/*.whl
        retention-days: 30

  # ===============
  # åŸºæœ¬æµ‹è¯•ä»»åŠ¡
  # ===============
  # åŠŸèƒ½ï¼šéªŒè¯æ„å»ºçš„ wheel åŒ…å¯ä»¥æ­£ç¡®å®‰è£…å’Œå¯¼å…¥
  # ç­–ç•¥ï¼šæµ‹è¯•å¤šä¸ª Python ç‰ˆæœ¬çš„å…¼å®¹æ€§
  # èŒƒå›´ï¼šåŸºæœ¬çš„åŒ…å¯¼å…¥æµ‹è¯•ï¼Œä¸è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
  test:
    needs: [build-subpackages, build-metapackage]  # ç­‰å¾…æ‰€æœ‰åŒ…æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']  # æµ‹è¯•å¤šä¸ª Python ç‰ˆæœ¬
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    # ä¸‹è½½æ‰€æœ‰æ„å»ºçš„ wheel æ–‡ä»¶
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-wheels"
        merge-multiple: true
        path: test_wheels/
        
    # æµ‹è¯•æ¯ä¸ªå­åŒ…çš„åŸºæœ¬å¯¼å…¥åŠŸèƒ½
    - name: Test subpackage wheels
      run: |
        pip install pytest
        
        # Test individual subpackages
        for wheel in test_wheels/*.whl; do
          echo "Testing $(basename $wheel)..."
          pip install "$wheel" --force-reinstall
          
          # Basic import test based on package name
          if [[ $wheel == *"common"* ]]; then
            python -c "import sage.common; print('sage.common imported successfully')" || echo "Import failed (may be expected)"
          elif [[ $wheel == *"kernel"* ]]; then
            python -c "import sage.kernel; print('sage.kernel imported successfully')" || echo "Import failed (may be expected)"
          elif [[ $wheel == *"middleware"* ]]; then
            python -c "import sage.middleware; print('sage.middleware imported successfully')" || echo "Import failed (may be expected)"
          elif [[ $wheel == *"libs"* ]]; then
            python -c "import sage.libs; print('sage.libs imported successfully')" || echo "Import failed (may be expected)"
          fi
        done
        
  # ================
  # å‘å¸ƒä»»åŠ¡
  # ================
  # åŠŸèƒ½ï¼šå‘å¸ƒåˆ° GitHub Releases å’Œ PyPI
  # è§¦å‘ï¼šä»…åœ¨æ¨é€ v* æ ‡ç­¾æ—¶æ‰§è¡Œ
  # åŒ…å«ï¼šæ‰€æœ‰æ„å»ºçš„ wheel æ–‡ä»¶
  release:
    if: startsWith(github.ref, 'refs/tags/v')  # ä»…åœ¨æ ‡ç­¾å‘å¸ƒæ—¶è¿è¡Œ
    needs: [build-subpackages, build-metapackage, test]  # ç­‰å¾…æ„å»ºå’Œæµ‹è¯•å®Œæˆ
    runs-on: ubuntu-latest
    
    steps:
    # ä¸‹è½½æ‰€æœ‰æ„å»ºçš„ artifacts
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: release_files/
        
    # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰€æœ‰ wheel æ–‡ä»¶
    - name: Create Release
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è·å–æ‰€æœ‰wheelæ–‡ä»¶
          const releaseDir = 'release_files';
          const files = fs.readdirSync(releaseDir);
          const wheelFiles = files.filter(f => f.endsWith('.whl'));
          
          // åˆ›å»ºrelease
          const tag = context.ref.replace('refs/tags/', '');
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tag,
            name: `SAGE ${tag}`,
            body: `
          ## SAGE ${tag}
          
          Multi-package release including all SAGE components.
          
          ### ğŸ“¦ Packages
          ${wheelFiles.map(f => `- \`${f}\``).join('\n')}
          
          ### ğŸ“‹ Installation
          \`\`\`bash
          # Install the main metapackage
          pip install ${wheelFiles.find(f => f.startsWith('isage-') && !f.includes('_')) || 'isage'}
          
          # Or install individual components
          pip install ${wheelFiles.filter(f => f.includes('_common')).map(f => f.split('-')[0] + '-common').join(' ')}
          \`\`\`
            `,
            draft: false,
            prerelease: tag.includes('rc') || tag.includes('beta') || tag.includes('alpha')
          });
          
          // ä¸Šä¼ assets
          for (const file of wheelFiles) {
            const filePath = path.join(releaseDir, file);
            const content = fs.readFileSync(filePath);
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: file,
              data: content
            });
            
            console.log(`Uploaded ${file}`);
          }
          
    # å‘å¸ƒåˆ° PyPI (å¦‚æœé…ç½®äº† API Token)
    - name: Publish to PyPI (if configured)
      if: startsWith(github.ref, 'refs/tags/v') && env.PYPI_API_TOKEN != ''
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        pip install twine
        
        # ä¸Šä¼ æ‰€æœ‰wheelæ–‡ä»¶åˆ°PyPIï¼Œä½¿ç”¨éäº¤äº’æ¨¡å¼
        python -m twine upload \
          --username __token__ \
          --password "$PYPI_API_TOKEN" \
          --non-interactive \
          --skip-existing \
          --verbose \
          release_files/*.whl
          
        echo "Published to PyPI successfully"
        
  # ==================
  # æ¸…ç†ä»»åŠ¡
  # ==================
  # åŠŸèƒ½ï¼šæ¸…ç†æ—§çš„ artifactsï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
  # æ‰§è¡Œï¼šæ— è®ºå…¶ä»–ä»»åŠ¡æˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œ
  # ç­–ç•¥ï¼šåˆ é™¤è¶…è¿‡ 30 å¤©çš„ artifacts
  cleanup:
    if: always()  # æ— è®ºå…¶ä»–ä»»åŠ¡æˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
    needs: [build-subpackages, build-metapackage, test, release]
    runs-on: ubuntu-latest
    
    steps:
    # ä½¿ç”¨ GitHub API æ¸…ç†è¶…è¿‡ 30 å¤©çš„æ—§ artifacts
    - name: Clean up old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          // æ¸…ç†è¶…è¿‡30å¤©çš„artifacts
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          for (const artifact of artifacts.data.artifacts) {
            const createdAt = new Date(artifact.created_at);
            if (createdAt < thirtyDaysAgo) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              console.log(`Deleted old artifact: ${artifact.name}`);
            }
          }
