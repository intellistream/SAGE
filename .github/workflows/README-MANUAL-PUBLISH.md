# Manual Publish Workflow è¯´æ˜

## æ¦‚è¿°

ä¸ºäº†é¿å… `main-dev` â†’ `main` çš„ PR è‡ªåŠ¨è§¦å‘ç‰ˆæœ¬å‡çº§å’Œ PyPI å‘å¸ƒï¼Œæˆ‘ä»¬å°†å‘å¸ƒæµç¨‹æ”¹ä¸ºæ‰‹åŠ¨è§¦å‘ã€‚è¿™æ ·å¯ä»¥ï¼š

1. **å‡å°‘ä¸å¿…è¦çš„ç‰ˆæœ¬å‡çº§**ï¼šé¿å…é¢‘ç¹çš„ patch ç‰ˆæœ¬å¢åŠ å¯¼è‡´ç‰ˆæœ¬å·æ··ä¹±
1. **é¿å… rebase å†²çª**ï¼šfeature åˆ†æ”¯ä¸éœ€è¦é¢‘ç¹å¤„ç†å› ç‰ˆæœ¬å‡çº§å¯¼è‡´çš„å†²çª
1. **æ›´å¥½çš„ç‰ˆæœ¬æ§åˆ¶**ï¼šå¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºæ‰‹åŠ¨å†³å®šç‰ˆæœ¬å‡çº§ç±»å‹ï¼ˆpatch/micro/minor/majorï¼‰
1. **ä¸å½±å“ CI/CD**ï¼šä¸» CI æµç¨‹ï¼ˆbuild-test, code-quality, examples-testï¼‰ä»ç„¶æ­£å¸¸è¿è¡Œ

## å·¥ä½œæµå˜æ›´

### 1. `publish-pypi.yml` ä¿®æ”¹

**å˜æ›´å†…å®¹**ï¼š

- âœ… ä¿ç•™ï¼šmain åˆ†æ”¯çš„ push äº‹ä»¶è‡ªåŠ¨è§¦å‘å‘å¸ƒ
- âœ… ä¿ç•™ï¼šmain åˆ†æ”¯çš„ PR merge è‡ªåŠ¨è§¦å‘å‘å¸ƒï¼ˆé main-dev æ¥æºï¼‰
- âŒ ç¦ç”¨ï¼šmain-dev â†’ main çš„ PR è‡ªåŠ¨è§¦å‘å‘å¸ƒ
- âœ… ä¿ç•™ï¼šworkflow_dispatch æ‰‹åŠ¨è§¦å‘

**åˆ¤æ–­é€»è¾‘**ï¼š

```yaml
if: |
  (github.event_name == 'push' && !contains(github.event.head_commit.message, '[version bump]')) ||
  (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.head.ref != 'main-dev') ||
  github.event_name == 'workflow_dispatch'
```

### 2. `manual-publish.yml` æ–°å¢

**åŠŸèƒ½**ï¼šä¸“é—¨ç”¨äºæ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬å‡çº§å’Œ PyPI å‘å¸ƒçš„ç‹¬ç«‹å·¥ä½œæµ

**ç‰¹ç‚¹**ï¼š

- ğŸ¯ çº¯æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
- ğŸ”’ å®Œæ•´çš„è¾“å…¥éªŒè¯ï¼ˆåˆ†æ”¯ã€ä»“åº“ã€ç‰ˆæœ¬ç±»å‹ï¼‰
- ğŸ“¦ æ”¯æŒ TestPyPI å’Œ PyPI å‘å¸ƒ
- ğŸ·ï¸ å¯é€‰æ‹©æ˜¯å¦åˆ›å»º GitHub Release
- âœ… ä¸å½±å“ä¸» CI/CD æµç¨‹çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€

## ä½¿ç”¨æ–¹æ³•

### åœºæ™¯ï¼šmain-dev åˆå¹¶åˆ° main åæ‰‹åŠ¨å‘å¸ƒ

1. **è®¿é—® GitHub Actions é¡µé¢**ï¼š

   ```
   https://github.com/intellistream/SAGE/actions/workflows/manual-publish.yml
   ```

1. **ç‚¹å‡» "Run workflow" æŒ‰é’®**

1. **é€‰æ‹©å‚æ•°**ï¼š

   - **Target branch**: `main` (å¿…é¡»)
   - **Repository**: `pypi` (ç”Ÿäº§ç¯å¢ƒ) æˆ– `testpypi` (æµ‹è¯•ç¯å¢ƒ)
   - **Version bump**:
     - `patch`: 0.1.6.2 â†’ 0.1.6.3ï¼ˆå°ä¿®å¤ï¼‰
     - `micro`: 0.1.6.2 â†’ 0.1.7.0ï¼ˆå°åŠŸèƒ½ï¼‰
     - `minor`: 0.1.6.2 â†’ 0.2.0.0ï¼ˆå¤§åŠŸèƒ½ï¼‰
     - `major`: 0.1.6.2 â†’ 1.0.0.0ï¼ˆé‡å¤§å˜æ›´ï¼‰
     - `none`: ä¸å‡çº§ç‰ˆæœ¬ï¼Œä»…é‡æ–°å‘å¸ƒ
   - **Create release**: `true` (æ¨è) æˆ– `false`

1. **ç‚¹å‡»è¿è¡Œ**

### åœºæ™¯ï¼šåœ¨ main-dev åˆ†æ”¯æµ‹è¯•å‘å¸ƒ

1. **è®¿é—® GitHub Actions é¡µé¢**

1. **é€‰æ‹©å‚æ•°**ï¼š

   - **Target branch**: `main-dev`
   - **Repository**: `testpypi` (å¿…é¡»ï¼Œmain-dev åªèƒ½å‘åˆ° TestPyPI)
   - **Version bump**: æ ¹æ®éœ€è¦é€‰æ‹©
   - **Create release**: `false` (æµ‹è¯•åˆ†æ”¯ä¸éœ€è¦åˆ›å»º Release)

1. **æµ‹è¯•å®‰è£…**ï¼š

   ```bash
   pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ isage
   ```

## éªŒè¯å’Œé™åˆ¶

### è‡ªåŠ¨éªŒè¯è§„åˆ™

å·¥ä½œæµä¼šè‡ªåŠ¨éªŒè¯ä»¥ä¸‹è§„åˆ™ï¼š

1. âœ… **å‘å¸ƒåˆ° PyPI å¿…é¡»ä» main åˆ†æ”¯**

   ```
   repository=pypi â†’ target_branch=main
   ```

1. âœ… **åˆ›å»º Release å¿…é¡»å‡çº§ç‰ˆæœ¬**

   ```
   create_release=true â†’ version_bump â‰  none
   ```

1. âœ… **main-dev åªèƒ½å‘å¸ƒåˆ° TestPyPI**ï¼ˆé€šè¿‡ UI é™åˆ¶ï¼‰

### å¤±è´¥å¤„ç†

å¦‚æœå‘å¸ƒå¤±è´¥ï¼š

- âœ… ä¸å½±å“ä¸» CI/CD æµç¨‹ï¼ˆbuild-test, code-quality, examples-testï¼‰
- âœ… å¯ä»¥ä¿®å¤é—®é¢˜åé‡æ–°æ‰‹åŠ¨è§¦å‘
- âœ… å¦‚æœç‰ˆæœ¬å·²å‡çº§ä½†å‘å¸ƒå¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨ `version_bump=none` é‡æ–°å‘å¸ƒ

## ä¸» CI/CD æµç¨‹

ä»¥ä¸‹å·¥ä½œæµ**ä¸å—å½±å“**ï¼Œä»ç„¶æ­£å¸¸è¿è¡Œï¼š

| å·¥ä½œæµ                 | è§¦å‘æ¡ä»¶                 | ä½œç”¨                  |
| ---------------------- | ------------------------ | --------------------- |
| `build-test.yml`       | PR/Push to main/main-dev | æ„å»ºå’Œæµ‹è¯•ä»£ç         |
| `code-quality.yml`     | PR/Push to main/main-dev | ä»£ç è´¨é‡æ£€æŸ¥          |
| `examples-test.yml`    | PR/Push to main/main-dev | ç¤ºä¾‹ä»£ç æµ‹è¯•          |
| `sync-main-to-dev.yml` | Push to main             | åŒæ­¥ main åˆ° main-dev |

è¿™äº›å·¥ä½œæµçš„æˆåŠŸ/å¤±è´¥çŠ¶æ€**å®Œå…¨ç‹¬ç«‹**äºå‘å¸ƒæµç¨‹ã€‚

## æ¨èå·¥ä½œæµ

### æ—¥å¸¸å¼€å‘ï¼ˆmain-devï¼‰

```
Feature Branch â†’ PR to main-dev â†’ CI é€šè¿‡ â†’ Merge
                                  â†“
                            ä¸è§¦å‘ç‰ˆæœ¬å‡çº§
                            ä¸è§¦å‘ PyPI å‘å¸ƒ
                            âœ… CI/CD æ­£å¸¸è¿è¡Œ
```

### æ­£å¼å‘å¸ƒï¼ˆmainï¼‰

```
main-dev â†’ PR to main â†’ CI é€šè¿‡ â†’ Merge
                         â†“
                    ä¸è‡ªåŠ¨å‘å¸ƒ âœ…
                         â†“
              æ‰‹åŠ¨è§¦å‘ manual-publish.yml
                         â†“
              é€‰æ‹©ç‰ˆæœ¬ç±»å‹ + å‘å¸ƒåˆ° PyPI
                         â†“
                   åˆ›å»º GitHub Release
```

### æµ‹è¯•å‘å¸ƒï¼ˆmain-devï¼‰

```
åœ¨ main-dev å¼€å‘å®Œæˆ â†’ æ‰‹åŠ¨è§¦å‘ manual-publish.yml
                       â†“
                é€‰æ‹© main-dev + testpypi
                       â†“
                  éªŒè¯å®‰è£…å’ŒåŠŸèƒ½
                       â†“
            ç¡®è®¤æ— è¯¯ååˆå¹¶åˆ° main â†’ æ­£å¼å‘å¸ƒ
```

## ç‰ˆæœ¬å·è§„èŒƒ

éµå¾ª `major.minor.micro.patch` å››æ®µå¼ç‰ˆæœ¬å·ï¼š

- **major**: é‡å¤§ä¸å…¼å®¹å˜æ›´
- **minor**: å‘åå…¼å®¹çš„å¤§åŠŸèƒ½æ›´æ–°
- **micro**: å‘åå…¼å®¹çš„å°åŠŸèƒ½æ›´æ–°
- **patch**: å‘åå…¼å®¹çš„ bug ä¿®å¤

ç¤ºä¾‹ï¼š

```
0.1.6.2 â†’ 0.1.6.3  (patch: ä¿®å¤ bug)
0.1.6.2 â†’ 0.1.7.0  (micro: å°åŠŸèƒ½)
0.1.6.2 â†’ 0.2.0.0  (minor: å¤§åŠŸèƒ½)
0.1.6.2 â†’ 1.0.0.0  (major: é‡å¤§å˜æ›´)
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ main-dev â†’ main çš„ PR ä¸è‡ªåŠ¨å‘å¸ƒäº†ï¼Ÿ

A: ä¸ºäº†é¿å…é¢‘ç¹çš„ç‰ˆæœ¬å‡çº§å¯¼è‡´ï¼š

- ç‰ˆæœ¬å·å¢é•¿è¿‡å¿«ï¼ˆæ¯æ¬¡ merge éƒ½ +0.0.0.1ï¼‰
- Feature åˆ†æ”¯éœ€è¦é¢‘ç¹ rebase å¤„ç†ç‰ˆæœ¬å†²çª
- éš¾ä»¥æ§åˆ¶æ­£å¼å‘å¸ƒçš„æ—¶æœº

### Q: å¦‚ä½•åˆ¤æ–­ä½•æ—¶åº”è¯¥å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Ÿ

A: å»ºè®®åœ¨ä»¥ä¸‹æƒ…å†µæ‰‹åŠ¨å‘å¸ƒï¼š

- ä¿®å¤äº†é‡è¦ bug
- å®Œæˆäº†æ–°åŠŸèƒ½å¼€å‘
- ç§¯ç´¯äº†å¤šä¸ª main-dev çš„ merge
- éœ€è¦è®©ç”¨æˆ·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

### Q: å‘å¸ƒå¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

A:

1. æ£€æŸ¥å¤±è´¥åŸå› ï¼ˆæŸ¥çœ‹ workflow æ—¥å¿—ï¼‰
1. ä¿®å¤é—®é¢˜ï¼ˆå¦‚æƒé™ã€API token ç­‰ï¼‰
1. å¦‚æœç‰ˆæœ¬å·²å‡çº§ä½†å‘å¸ƒå¤±è´¥ï¼š
   - é€‰æ‹© `version_bump=none` é‡æ–°å‘å¸ƒå½“å‰ç‰ˆæœ¬
1. å¦‚æœç‰ˆæœ¬å‡çº§å¤±è´¥ï¼š
   - é‡æ–°è¿è¡Œï¼Œé€‰æ‹©ç›¸åŒçš„ version_bump

### Q: ä¸» CI ä¼šå—å½±å“å—ï¼Ÿ

A: **ä¸ä¼š**ã€‚ä»¥ä¸‹å·¥ä½œæµå®Œå…¨ç‹¬ç«‹ï¼š

- build-test.yml
- code-quality.yml
- examples-test.yml

å®ƒä»¬çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€ä¸å—å‘å¸ƒå·¥ä½œæµå½±å“ã€‚

### Q: å¯ä»¥åœ¨ main-dev ç›´æ¥å‘å¸ƒåˆ° PyPI å—ï¼Ÿ

A: **ä¸å¯ä»¥**ã€‚å·¥ä½œæµä¼šéªŒè¯ï¼š

- å‘å¸ƒåˆ° PyPI å¿…é¡»ä» main åˆ†æ”¯
- main-dev åªèƒ½å‘å¸ƒåˆ° TestPyPIï¼ˆç”¨äºæµ‹è¯•ï¼‰

## ç›¸å…³æ–‡ä»¶

- `.github/workflows/publish-pypi.yml` - è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµï¼ˆå·²ä¿®æ”¹ï¼‰
- `.github/workflows/manual-publish.yml` - æ‰‹åŠ¨å‘å¸ƒå·¥ä½œæµï¼ˆæ–°å¢ï¼‰
- `.github/workflows/build-test.yml` - ä¸» CI å·¥ä½œæµï¼ˆä¸å—å½±å“ï¼‰
- `.github/workflows/code-quality.yml` - ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆä¸å—å½±å“ï¼‰
- `.github/workflows/examples-test.yml` - ç¤ºä¾‹æµ‹è¯•ï¼ˆä¸å—å½±å“ï¼‰
