# SAGE PyPI Publishing via sage-pypi-publisher
#
# This workflow uses the independent sage-pypi-publisher tool to publish packages.
# Repository: https://github.com/intellistream/sage-pypi-publisher

name: "Publish to PyPI"

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Target repository'
        required: false
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch   # 0.2.0 -> 0.2.1
          - minor   # 0.2.0 -> 0.3.0
          - major   # 0.2.0 -> 1.0.0
      packages:
        description: 'Packages to publish (comma-separated, or "all")'
        required: false
        default: 'all'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout SAGE
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install sage-pypi-publisher
        run: |
          pip install --upgrade pip
          pip install git+https://github.com/intellistream/sage-pypi-publisher.git@main

      - name: Configure PyPI credentials
        run: |
          mkdir -p ~/.pypirc
          if [ "${{ inputs.repository }}" = "pypi" ]; then
            cat > ~/.pypirc << EOF
          [distutils]
          index-servers =
              pypi

          [pypi]
          username = __token__
          password = ${{ secrets.PYPI_API_TOKEN }}
          EOF
          else
            cat > ~/.pypirc << EOF
          [distutils]
          index-servers =
              testpypi

          [testpypi]
          repository = https://test.pypi.org/legacy/
          username = __token__
          password = ${{ secrets.TEST_PYPI_API_TOKEN }}
          EOF
          fi

      - name: Publish packages
        run: |
          PACKAGES="${{ inputs.packages }}"
          BUMP="${{ inputs.version_bump }}"
          REPO="${{ inputs.repository }}"

          if [ "$PACKAGES" = "all" ]; then
            # Publish all SAGE packages
            for pkg in sage-common sage-llm-core sage-llm-gateway sage-kernel sage-libs sage-middleware sage-platform sage-cli sage-tools sage; do
              echo "ðŸ“¦ Publishing $pkg..."
              sage-pypi-publisher publish "$pkg" \
                --auto-bump "$BUMP" \
                --repository "$REPO" \
                --no-dry-run
            done
          else
            # Publish specified packages
            IFS=',' read -ra PKG_LIST <<< "$PACKAGES"
            for pkg in "${PKG_LIST[@]}"; do
              pkg=$(echo "$pkg" | xargs)  # trim whitespace
              echo "ðŸ“¦ Publishing $pkg..."
              sage-pypi-publisher publish "$pkg" \
                --auto-bump "$BUMP" \
                --repository "$REPO" \
                --no-dry-run
            done
          fi

      - name: Summary
        run: |
          echo "## ðŸ“¦ Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump**: ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages**: ${{ inputs.packages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.repository }}" = "pypi" ]; then
            echo "### ðŸŽ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
            echo "Users can now install with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install isage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ§ª Published to TestPyPI" >> $GITHUB_STEP_SUMMARY
            echo "Test installation with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ isage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
