name: Publish to PyPI

on:
  # å®Œå…¨ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œæ”¹ä¸ºæ‰‹åŠ¨è§¦å‘
  # åŽŸå› : main-dev â†’ main PR merge åŽä¼šè§¦å‘ push äº‹ä»¶ï¼Œæ— æ³•å¯é è¿‡æ»¤
  # è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ workflow_dispatch æ‰‹åŠ¨æŽ§åˆ¶å‘å¸ƒæ—¶æœº
  # push:
  #   branches:
  #     - main

  # pull_request:
  #   types: [closed]
  #   branches:
  #     - main

  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      repository:
        description: 'Target repository (testpypi or pypi)'
        required: false
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'  # é»˜è®¤æ”¹ä¸º noneï¼Œéœ€è¦æ‰‹åŠ¨é€‰æ‹©
        type: choice
        options:
          - none    # Keep current version (default for main-dev testing)
          - auto    # Based on branch
          - patch   # 0.1.6.2 -> 0.1.6.3
          - micro   # 0.1.6.2 -> 0.1.7.0
          - minor   # 0.1.6.2 -> 0.2.0.0
          - major   # 0.1.6.2 -> 1.0.0.0

jobs:
  publish:
    runs-on: ubuntu-latest
    # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œæ— éœ€å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
    # if æ¡ä»¶å·²ç§»é™¤ï¼Œworkflow_dispatch æ€»æ˜¯æ‰§è¡Œ

    steps:
      - name: Determine target branch
        id: branch
        run: |
          # workflow_dispatch åªèƒ½ä»Žå½“å‰åˆ†æ”¯è§¦å‘
          # å»ºè®®ä»Ž main åˆ†æ”¯è§¦å‘ä»¥å‘å¸ƒåˆ° PyPI
          # ä»Ž main-dev è§¦å‘åªç”¨äºŽæµ‹è¯•ï¼Œä¼šå‘å¸ƒåˆ° TestPyPI
          echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "::notice::Publishing from branch: ${{ github.ref_name }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.ref }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          submodules: 'recursive'  # åˆå§‹åŒ–æ‰€æœ‰ submodulesï¼ˆåŒ…æ‹¬ C++ æ‰©å±•ï¼‰

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twine build wheel setuptools
          # Install sage-tools for version management
          # isage-common is now a required dependency and will be installed automatically
          pip install -e packages/sage-tools

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump and repository
        id: config
        run: |
          # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å‚æ•°
          VERSION_BUMP="${{ inputs.version_bump }}"
          REPOSITORY="${{ inputs.repository }}"

          # å¦‚æžœæ˜¯ autoï¼Œæ ¹æ®å½“å‰åˆ†æ”¯è½¬æ¢ä¸ºå®žé™…ç±»åž‹
          if [ "$VERSION_BUMP" = "auto" ]; then
            if [ "${{ github.ref_name }}" = "main" ]; then
              VERSION_BUMP="patch"
            else
              VERSION_BUMP="patch"  # main-dev ä¹Ÿé»˜è®¤ patch
            fi
          fi

          echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT
          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT
          echo "::notice::Branch: ${{ github.ref_name }}, Version bump: $VERSION_BUMP, Repository: $REPOSITORY"

      - name: Bump version
        if: steps.config.outputs.version_bump != 'none'
        id: bump_version
        run: |
          # Get current version from any package's _version.py
          CURRENT_VERSION=$(python -c "import sys; sys.path.insert(0, 'packages/sage/src'); from sage._version import __version__; print(__version__)")
          echo "Current version: $CURRENT_VERSION"

          # Parse version parts
          IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
          major="${version_parts[0]}"
          minor="${version_parts[1]}"
          micro="${version_parts[2]}"
          patch="${version_parts[3]:-0}"

          # Bump based on config
          case "${{ steps.config.outputs.version_bump }}" in
            patch)
              patch=$((patch + 1))
              ;;
            micro)
              micro=$((micro + 1))
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              micro=0
              patch=0
              ;;
            major)
              major=$((major + 1))
              minor=0
              micro=0
              patch=0
              ;;
          esac

          # Create new version
          NEW_VERSION="${major}.${minor}.${micro}.${patch}"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update version using sage-dev
          sage-dev package version set "$NEW_VERSION"

          # Commit version bump (without [skip ci] to allow CI badges to update)
          # Use [version bump] marker to prevent workflow from re-triggering itself
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION [version bump]"

          # Pull latest changes with rebase to avoid conflicts
          BRANCH="${{ steps.branch.outputs.ref }}"
          git pull --rebase origin $BRANCH

          # Push with retry logic
          max_retries=3
          retry_count=0
          until git push origin $BRANCH; do
            retry_count=$((retry_count + 1))
            if [ $retry_count -ge $max_retries ]; then
              echo "Failed to push after $max_retries attempts"
              exit 1
            fi
            echo "Push failed, retrying (attempt $retry_count/$max_retries)..."
            sleep 2
            git pull --rebase origin $BRANCH
          done

      - name: Build and publish packages
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ steps.config.outputs.repository == 'pypi' && secrets.PYPI_API_TOKEN || secrets.TEST_PYPI_API_TOKEN }}
          TWINE_REPOSITORY: ${{ steps.config.outputs.repository }}
        run: |
          # Configure repository URL
          if [ "${{ steps.config.outputs.repository }}" = "testpypi" ]; then
            export TWINE_REPOSITORY_URL="https://test.pypi.org/legacy/"
          fi

          # Build and publish all packages
          sage-dev package pypi publish-sage --no-dry-run -r ${{ steps.config.outputs.repository }}

      # æ³¨æ„: sage-middleware çš„é¢„ç¼–è¯‘ wheels å·²ç§»é™¤
      # åŽŸå› : C++ æ‰©å±•éœ€è¦ git submodulesï¼Œåœ¨ CI çŽ¯å¢ƒä¸­æž„å»ºå¤æ‚
      # ç”¨æˆ·å°†ä»Žæºç å®‰è£…ï¼Œæœ¬åœ°ç¼–è¯‘ï¼ˆå¦‚æžœéœ€è¦ï¼‰
      # æœªæ¥å¯ä»¥è€ƒè™‘ä½¿ç”¨ GitHub Actions çš„ matrix ç­–ç•¥åˆ†å¹³å°æž„å»º

      - name: Create GitHub Release
        if: steps.config.outputs.repository == 'pypi' && steps.config.outputs.version_bump != 'none'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: Release v${{ steps.bump_version.outputs.new_version }}
          body: |
            ## SAGE v${{ steps.bump_version.outputs.new_version }}

            **Released from**: `${{ github.ref_name }}` branch
            **Commit**: ${{ github.sha }}

            ### Published Packages
            - isage-common
            - isage-kernel
            - isage-libs
            - isage-middleware
            - isage-platform
            - isage-cli
            - isage-apps
            - isage-benchmark
            - isage-studio
            - isage-tools
            - isage (meta-package)

            ### Installation
            \`\`\`bash
            pip install isage==${{ steps.bump_version.outputs.new_version }}
            \`\`\`

            ### PyPI Links
            - [isage on PyPI](https://pypi.org/project/isage/${{ steps.bump_version.outputs.new_version }}/)

            ### Changes
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ“¦ Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.branch.outputs.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ steps.config.outputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump**: ${{ steps.config.outputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.config.outputs.version_bump }}" != "none" ]; then
            echo "- **New Version**: ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Packages**: 11 packages published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.config.outputs.repository }}" = "pypi" ]; then
            echo "### ðŸŽ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
            echo "Users can now install with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install isage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ§ª Published to TestPyPI" >> $GITHUB_STEP_SUMMARY
            echo "Test installation with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ isage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
