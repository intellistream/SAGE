name: Development CI

on:
  push:
    branches: [ main-dev, refactor/* ]
  pull_request:
    branches: [ main-dev ]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€PRæˆ–åˆ†æ”¯åªè¿è¡Œæœ€æ–°çš„CIï¼Œå–æ¶ˆä¹‹å‰çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# å…¬å…±ç¯å¢ƒå˜é‡ï¼ˆé¿å…é‡å¤å®šä¹‰ï¼‰

env:
  # å…¬å…±ç¯å¢ƒå˜é‡
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  # æ§åˆ¶æ˜¯å¦ç¼–è¯‘C++æ‰©å±•ï¼ˆè®¾ä¸ºfalseå¯åŠ é€ŸCIï¼‰
  SAGE_SKIP_CPP_EXTENSIONS: true

jobs:
  # å¿«é€Ÿæ£€æŸ¥ï¼šä»£ç è´¨é‡å’ŒåŸºç¡€æµ‹è¯•
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 5
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
        which python
        which pip
      timeout-minutes: 2
        
    - name: Install System Dependencies (C++ Extensions)
      run: |
        if [ "$SAGE_SKIP_CPP_EXTENSIONS" = "true" ]; then
          echo "ğŸš€ è·³è¿‡C++æ‰©å±•ç¼–è¯‘ä¾èµ–å®‰è£…ï¼ˆåŠ é€ŸCIæ¨¡å¼ï¼‰"
          echo "ğŸ“‹ åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œä»¥ä¸‹æ¨¡å—å°†ä½¿ç”¨Pythonå›é€€å®ç°ï¼š"
          echo "   â€¢ sage-middleware/components/sage_db â†’ çº¯Pythonå‘é‡æ•°æ®åº“"
          exit 0
        fi
        
        echo "ğŸ“¦ æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…ç³»ç»Ÿä¾èµ–..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼–è¯‘C++æ‰©å±•
        needs_cpp=false
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦ç¼–è¯‘çš„C++æ¨¡å—
        if [ -f "packages/sage-middleware/src/sage/middleware/components/sage_db/CMakeLists.txt" ]; then
          needs_cpp=true
          echo "ğŸ” æ£€æµ‹åˆ°C++æ‰©å±•æ¨¡å—ï¼Œéœ€è¦å®‰è£…ç¼–è¯‘å·¥å…·"
        fi
        
        if [ "$needs_cpp" = true ]; then
          echo "ğŸ“¦ å®‰è£…C++ç¼–è¯‘ä¾èµ–..."
          
          # æ›´æ–°åŒ…åˆ—è¡¨
          echo "ğŸ“¥ æ›´æ–°åŒ…åˆ—è¡¨..."
          sudo apt-get update -qq
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config || {
            echo "âš ï¸ ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œï¼ˆC++æ‰©å±•å¯èƒ½ä¸å¯ç”¨ï¼‰"
          }
        else
          echo "âœ… æ— éœ€å®‰è£…C++ç¼–è¯‘ä¾èµ–ï¼Œè·³è¿‡"
        fi
      timeout-minutes: 15
      continue-on-error: true  # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
      
    - name: Install SAGE
      id: install-deps
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive
        PIP_NO_INPUT: 1
        PIP_DISABLE_PIP_VERSION_CHECK: 1
        # å¹¶è¡Œå®‰è£…ä¼˜åŒ–
        PIP_PARALLEL_BUILDS: 4
        MAKEFLAGS: "-j4"
      run: |
        echo "ğŸš€ ä½¿ç”¨quickstart.sh --devæ¨¡å¼å®‰è£…SAGE..."
        echo "â„¹ï¸ è¿™å°†å®‰è£…å®Œæ•´çš„å¼€å‘å·¥å…·å’ŒCLI"
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "ğŸ“Š ç¯å¢ƒä¿¡æ¯:"
        echo "- Python: $(python --version)"
        echo "- Pythonè·¯å¾„: $(which python)"
        echo "- Pipç‰ˆæœ¬: $(pip --version)"
        
        # ä½¿ç”¨quickstart.sh devæ¨¡å¼å®‰è£…
        chmod +x ./quickstart.sh
        ./quickstart.sh --dev --pip --yes
        
        echo "âœ… SAGEå¼€å‘ç¯å¢ƒå®‰è£…å®Œæˆ"
      timeout-minutes: 60
        
    - name: Verify SAGE Installation
      run: |
        echo "=== éªŒè¯SAGEå®‰è£… ==="
        echo "=== Import Tests ==="
        python -c "import sage; print('âœ… SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('âœ… sage.common import successful')"
        python -c "import sage.kernel; print('âœ… sage.kernel import successful')"
        python -c "import sage.middleware; print('âœ… sage.middleware import successful')" || echo "âš ï¸ sage.middleware import failed (may not be installed in minimal mode)"
        python -c "import sage.libs; print('âœ… sage.libs import successful')" || echo "âš ï¸ sage.libs import failed (may not be installed in minimal mode)"
        
        echo "=== CLI Test ==="
        # åˆ·æ–°shellç¯å¢ƒä»¥ç¡®ä¿æ–°å®‰è£…çš„å…¥å£ç‚¹å¯ç”¨
        hash -r
        
        # æ£€æŸ¥sageå‘½ä»¤æ˜¯å¦åœ¨PATHä¸­
        if command -v sage >/dev/null 2>&1; then
          echo "âœ… SAGE CLI found in PATH: $(which sage)"
          timeout 30s sage --help > /dev/null && echo "âœ… SAGE CLI help working" || echo "âŒ SAGE CLI help failed or timeout"
          timeout 30s sage version && echo "âœ… SAGE version command working" || echo "âŒ SAGE version command failed or timeout"
        else
          echo "âŒ SAGE CLI not found in PATH"
          echo "ğŸ” è¯Šæ–­ä¿¡æ¯:"
          echo "- PATH: $PATH"
          echo "- æ£€æŸ¥å·²å®‰è£…çš„åŒ…å’Œå…¥å£ç‚¹:"
          python -c "
          try:
              import pkg_resources
              found = False
              for ep in pkg_resources.iter_entry_points('console_scripts'):
                  if ep.name == 'sage':
                      print(f'Found sage entry point: {ep}')
                      found = True
              if not found:
                  print('âŒ No sage entry point found')
          except Exception as e:
              print(f'Error checking entry points: {e}')
          "
          echo "- å°è¯•ç›´æ¥è¿è¡ŒCLIæ¨¡å—:"
          timeout 30s python -m sage.tools.cli.main --help >/dev/null && echo "âœ… CLI module works directly" || echo "âŒ CLI module failed or timeout"
          
          # åœ¨CIç¯å¢ƒä¸­ï¼Œå¦‚æœsageå‘½ä»¤ä¸å¯ç”¨ä½†æ¨¡å—å¯ç”¨ï¼Œè¿™ä»ç„¶ç®—ä½œæˆåŠŸ
          if python -c "import sage.tools.cli.main" 2>/dev/null; then
            echo "âœ… CLIæ¨¡å—å¯ç”¨ï¼Œè¿™åœ¨CIç¯å¢ƒä¸­æ˜¯å¯æ¥å—çš„"
          else
            echo "âŒ CLIæ¨¡å—å®Œå…¨ä¸å¯ç”¨"
            exit 1
          fi
        fi
    
    - name: Run Basic Import Tests
      id: basic-tests
      run: |
        echo "Running quick smoke tests..."
        python -c "import sage; print('SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('sage.common import successful')"
        # æ·»åŠ æ›´å¤šåŸºç¡€å¯¼å…¥æµ‹è¯•
        echo "Basic import tests passed âœ…"
    
    - name: Run Issues Manager Tests
      run: |
        echo "Running issues manager automated tests..."
        # æ£€æŸ¥sageå‘½ä»¤æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨pythonæ¨¡å—æ–¹å¼
        if command -v sage >/dev/null 2>&1; then
          SAGE_CMD="sage"
          echo "âœ… ä½¿ç”¨PATHä¸­çš„sageå‘½ä»¤"
        else
          SAGE_CMD="python -m sage.tools.cli.main"
          echo "âš ï¸ sageå‘½ä»¤ä¸åœ¨PATHä¸­ï¼Œä½¿ç”¨æ¨¡å—æ–¹å¼: $SAGE_CMD"
        fi
        
        # è¿è¡ŒIssues Manageræµ‹è¯•ï¼Œå¹¶æ­£ç¡®å¤„ç†é€€å‡ºç 
        echo "ğŸ”§ è¿è¡Œ Issues Manager æµ‹è¯•..."
        if timeout 60s $SAGE_CMD dev test --issues-manager; then
          echo "âœ… Issues Manager æµ‹è¯•é€šè¿‡"
          exit_code=0
        else
          exit_code=$?
          echo "âŒ Issues Manager æµ‹è¯•å¤±è´¥"
          
          # åœ¨CIç¯å¢ƒä¸­ï¼ŒæŸäº›æµ‹è¯•å¤±è´¥æ˜¯å¯ä»¥æ¥å—çš„ï¼ˆå¦‚GitHubè¿æ¥æµ‹è¯•ï¼‰
          # ä½†æˆ‘ä»¬åº”è¯¥æ˜ç¡®æŠ¥å‘Šå¤±è´¥è€Œä¸æ˜¯éšè—å®ƒ
          if [[ "$CI" == "true" ]]; then
            echo "âš ï¸ åœ¨CIç¯å¢ƒä¸­ï¼ŒæŸäº›Issues Manageræµ‹è¯•å¯èƒ½å› ä¸ºç¼ºå°‘å¤–éƒ¨ä¾èµ–è€Œå¤±è´¥"
            echo "ğŸ’¡ æ‰§è¡ŒåŸºç¡€éªŒè¯ä»¥ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨..."
            
            # åŸºç¡€éªŒè¯ï¼šæ£€æŸ¥æ¨¡å—å¯¼å…¥
            if python -c "import sage.tools.dev.issues; print('âœ… Issuesç®¡ç†æ¨¡å—å¯¼å…¥æˆåŠŸ')"; then
              echo "âœ… åŸºç¡€Issuesç®¡ç†åŠŸèƒ½å¯ç”¨"
              exit_code=0
            else
              echo "âŒ è¿åŸºç¡€Issuesç®¡ç†æ¨¡å—éƒ½æ— æ³•å¯¼å…¥"
              exit_code=1
            fi
          fi
        fi
        
        if [ $exit_code -eq 0 ]; then
          echo "Issues manager tests completed âœ…"
        else
          echo "Issues manager tests failed âŒ"
          exit $exit_code
        fi
    
    - name: Run Enhanced SAGE Tests
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€éªŒè¯æµ‹è¯•..."
        
        # åœ¨quick-check jobä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨pipå®‰è£…ï¼Œä¸ä½¿ç”¨conda
        echo "ğŸ”§ éªŒè¯SAGEå®‰è£…..."
        python --version
        pip --version
        
        # è¿è¡Œè¯Šæ–­æ£€æŸ¥
        echo "ğŸ” ç³»ç»Ÿè¯Šæ–­..."
        if command -v sage >/dev/null 2>&1; then
          SAGE_CMD="sage"
          echo "âœ… ä½¿ç”¨PATHä¸­çš„sageå‘½ä»¤"
        else
          SAGE_CMD="python -m sage.tools.cli.main"
          echo "âš ï¸ sageå‘½ä»¤ä¸åœ¨PATHä¸­ï¼Œä½¿ç”¨æ¨¡å—æ–¹å¼: $SAGE_CMD"
        fi
        
        # è¿è¡ŒåŸºç¡€è¯Šæ–­ï¼ˆå¦‚æœæ”¯æŒï¼‰
        if timeout 60s $SAGE_CMD dev test --diagnose 2>/dev/null; then
          echo "âœ… ç³»ç»Ÿè¯Šæ–­é€šè¿‡"
        else
          echo "â„¹ï¸ è¯Šæ–­å‘½ä»¤ä¸æ”¯æŒæˆ–å¤±è´¥ï¼Œè¿è¡ŒåŸºç¡€æ£€æŸ¥"
          python -c "import sage; import sage.common; print('âœ… åŸºç¡€æ¨¡å—å¯¼å…¥æˆåŠŸ')"
        fi
        
        echo "âœ… åŸºç¡€éªŒè¯å®Œæˆ"
      timeout-minutes: 10
        
    - name: Report Quick Check Failure
      if: failure()
      run: |
        echo "âŒ Quick Check Failed - Collecting Diagnostic Information"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "ğŸ“‹ Quick Check Environment Information:"
        echo "- Date: $(date)"
        echo "- Python: $(python --version)"
        echo "- Pip: $(pip --version)"
        echo "- Working Directory: $(pwd)"
        echo ""
        
        echo "ğŸ“¦ Installation Status:"
        if [ -d "packages/sage-common" ]; then
          echo "âœ… sage-common directory exists"
          pip show isage-common || echo "âŒ sage-common not installed"
        else
          echo "âŒ sage-common directory missing"
        fi
        
        if [ -d "packages/sage" ]; then
          echo "âœ… sage directory exists"
          pip show isage || echo "âŒ sage not installed"
        else
          echo "âŒ sage directory missing"
        fi
        echo ""
        
        echo "ğŸ Python Import Status:"
        python -c "import sage; print('âœ… SAGE import works')" || echo "âŒ SAGE import failed"
        python -c "import sage.common; print('âœ… sage.common import works')" || echo "âŒ sage.common import failed"
        echo ""
        
        echo "ğŸ“¦ Installed Packages:"
        pip list | grep -E "(sage|black|flake8|isort)" || echo "No relevant packages found"
        echo ""
        
        echo "ğŸ’¾ System Resources:"
        echo "- Available disk space: $(df -h . | tail -1 | awk '{print $4}' || echo 'Unknown')"
        echo "- Memory usage: $(free -h | grep Mem || echo 'Unknown')"
        echo ""
        
        echo "ğŸŒ Network Status:"
        timeout 5 curl -s https://pypi.org > /dev/null && echo "âœ… PyPI reachable" || echo "âŒ PyPI unreachable"
        echo ""
        
        echo "ğŸ“ Directory Structure:"
        ls -la packages/ || echo "Cannot list packages directory"
        echo ""
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ End of quick check failure diagnostic report"

  # å®Œæ•´æµ‹è¯•ï¼ˆä»…åœ¨å¿«é€Ÿæ£€æŸ¥é€šè¿‡åè¿è¡Œï¼‰
  full-test:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: quick-check
    timeout-minutes: 60
    if: >
      needs.quick-check.result == 'success' &&
      (
        (github.event_name == 'pull_request' && github.base_ref == 'main-dev') ||
        (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/refactor/')) ||
        github.event_name == 'workflow_dispatch'
      )
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/pyproject.toml'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
      timeout-minutes: 2
      
    - name: Install System Dependencies (C++ Extensions)
      run: |
        echo "ğŸ“¦ æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…C++ç¼–è¯‘ä¾èµ–..."
        # ä¸»CIä¿ç•™ç¼–è¯‘èƒ½åŠ›ï¼Œä½†ä¼˜åŒ–å®‰è£…è¿‡ç¨‹
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config || {
          echo "âš ï¸ ç¼–è¯‘ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œï¼ˆC++æ‰©å±•å¯èƒ½ä¸å¯ç”¨ï¼‰"
        }
      timeout-minutes: 15
      continue-on-error: true
        
    - name: Install SAGE (Test Mode)
      id: install-sage
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive
        PIP_NO_INPUT: 1
        PIP_DISABLE_PIP_VERSION_CHECK: 1
        # å¹¶è¡Œå®‰è£…ä¼˜åŒ–
        PIP_PARALLEL_BUILDS: 4
        MAKEFLAGS: "-j4"
      run: |
        echo "ğŸš€ Starting SAGE installation..."
        echo "ğŸ“‹ Environment Information:"
        echo "- Date: $(date)"
        echo "- Python: $(python --version)"
        echo "- Pip: $(pip --version)"
        echo "- Available disk space: $(df -h . | tail -1 | awk '{print $4}')"
        echo "- Memory: $(free -h | grep Mem | awk '{print $2 " total, " $7 " available"}')"
        echo "- CPU cores: $(nproc)"
        echo ""
        
        # è®¾ç½®é”™è¯¯æ•è·
        set -e
        trap 'exit_code=$?; echo "âŒ Installation failed with exit code $exit_code"; exit $exit_code' ERR
        
        echo "ğŸ”§ Making quickstart.sh executable..."
        chmod +x ./quickstart.sh
        
        echo "ğŸ¯ Starting SAGE installation with detailed logging..."
        if ! ./quickstart.sh --dev --pip --yes; then
          echo "âŒ SAGE installation failed!"
          exit 1
        fi
        
        echo "âœ… SAGE installation completed successfully"
      timeout-minutes: 30  # è°ƒæ•´ä¸º30åˆ†é’Ÿï¼Œä¸ä¸»åˆ†æ”¯ä¿æŒä¸€è‡´
      
    - name: Report Installation Failure
      if: failure() && (steps.install-sage.outcome == 'failure' || steps.install-sage.conclusion == 'failure')
      shell: bash -l {0}
      run: |
        echo "âŒ SAGE Installation Failed - Collecting Diagnostic Information"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "ğŸ“‹ System Information:"
        echo "- Date: $(date)"
        echo "- Hostname: $(hostname)"
        echo "- User: $(whoami)"
        echo "- Working Directory: $(pwd)"
        echo "- Shell: $SHELL"
        echo ""
        
        echo "ğŸ Python Environment:"
        python --version || echo "Python not available"
        pip --version || echo "Pip not available"
        which python || echo "Python executable not found"
        which pip || echo "Pip executable not found"
        echo ""
        
        echo " System Resources:"
        echo "- Available disk space: $(df -h . | tail -1 | awk '{print $4}' || echo 'Unknown')"
        echo "- Memory usage: $(free -h | grep Mem || echo 'Unknown')"
        echo "- CPU cores: $(nproc || echo 'Unknown')"
        echo "- Load average: $(uptime || echo 'Unknown')"
        echo ""
        
        echo "ğŸ“ Directory Contents:"
        ls -la . || echo "Cannot list directory"
        echo ""
        
        echo "ğŸ“„ Installation Log (last 100 lines):"
        if [ -f "install.log" ]; then
          echo "Found install.log:"
          tail -100 install.log || echo "Cannot read install.log"
        else
          echo "install.log not found"
        fi
        echo ""
        
        echo "ğŸ” Package Installation Status:"
        echo "Checking SAGE packages:"
        for pkg in packages/sage-common packages/sage-kernel packages/sage-middleware packages/sage-libs packages/sage; do
          if [ -d "$pkg" ]; then
            echo "âœ… $pkg directory exists"
            if [ -f "$pkg/pyproject.toml" ]; then
              echo "   - Has pyproject.toml"
            fi
            if [ -f "$pkg/setup.py" ]; then
              echo "   - Has setup.py"
            fi
          else
            echo "âŒ $pkg directory missing"
          fi
        done
        echo ""
        
        echo "ğŸ“¦ Installed Python Packages:"
        pip list | head -20 || echo "Cannot list pip packages"
        echo ""
        
        echo "ğŸŒ Network Connectivity:"
        echo "Testing PyPI connectivity:"
        timeout 10 curl -s https://pypi.org > /dev/null && echo "âœ… PyPI reachable" || echo "âŒ PyPI unreachable"
        timeout 10 curl -s https://anaconda.org > /dev/null && echo "âœ… Anaconda.org reachable" || echo "âŒ Anaconda.org unreachable"
        echo ""
        
        echo "ğŸ”§ Process Information:"
        echo "Running processes:"
        ps aux | grep -E "(python|pip|conda)" | head -10 || echo "No relevant processes found"
        echo ""
        
        echo "ğŸ“ Environment Variables:"
        echo "Relevant environment variables:"
        env | grep -E "(PYTHON|PIP|CONDA|SAGE)" | sort || echo "No relevant environment variables"
        echo ""
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ End of diagnostic report"
        echo "ğŸ’¡ Please review the above information to diagnose the installation failure"
        
    - name: Run Test Suite
      id: run-tests
      shell: bash -l {0}
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ (ä½¿ç”¨å¢å¼ºçš„ sage dev test å‘½ä»¤):"
        
        # æ£€æŸ¥sageç¯å¢ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨conda runï¼Œå¦åˆ™ä½¿ç”¨å½“å‰ç¯å¢ƒ
        echo "ğŸ”§ æ£€æŸ¥sage condaç¯å¢ƒ..."
        if conda env list | grep -q "^sage "; then
          echo "âœ… æ‰¾åˆ°sageç¯å¢ƒï¼Œä½¿ç”¨conda run"
          CONDA_RUN_PREFIX="conda run -n sage"
          echo "Pythonè·¯å¾„: $(conda run -n sage which python)"
          echo "Pythonç‰ˆæœ¬: $(conda run -n sage python --version)"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°sageç¯å¢ƒï¼Œä½¿ç”¨å½“å‰ç¯å¢ƒ"
          CONDA_RUN_PREFIX=""
          echo "Pythonè·¯å¾„: $(which python)"
          echo "Pythonç‰ˆæœ¬: $(python --version)"
        fi
        
        # æ£€æŸ¥sageå‘½ä»¤æ˜¯å¦å¯ç”¨
        if $CONDA_RUN_PREFIX sage --help >/dev/null 2>&1; then
          SAGE_CMD="$CONDA_RUN_PREFIX sage"
          echo "âœ… ä½¿ç”¨sageå‘½ä»¤: $SAGE_CMD"
        elif $CONDA_RUN_PREFIX python -m sage.tools.cli.main --help >/dev/null 2>&1; then
          SAGE_CMD="$CONDA_RUN_PREFIX python -m sage.tools.cli.main"
          echo "âœ… ä½¿ç”¨æ¨¡å—æ–¹å¼: $SAGE_CMD"
        else
          echo "âŒ æ— æ³•æ‰¾åˆ°sageå‘½ä»¤ï¼Œå°è¯•åŸºç¡€Pythonæµ‹è¯•"
          $CONDA_RUN_PREFIX python -c "import sage; print('âœ… SAGEå¯¼å…¥æˆåŠŸ')"
          echo "âš ï¸ è·³è¿‡é«˜çº§æµ‹è¯•ï¼Œåªè¿è¡ŒåŸºç¡€éªŒè¯"
          exit 0
        fi
        
        # è¿è¡Œè¯Šæ–­
        echo "ğŸ” ç³»ç»Ÿè¯Šæ–­..."
        if $SAGE_CMD dev test --diagnose 2>/dev/null; then
          echo "âœ… ç³»ç»Ÿè¯Šæ–­é€šè¿‡"
        else
          echo "âš ï¸ ç³»ç»Ÿè¯Šæ–­å¤±è´¥æˆ–ä¸æ”¯æŒï¼Œæ‰§è¡ŒåŸºç¡€å¯¼å…¥æ£€æŸ¥"
          $CONDA_RUN_PREFIX python -c "import sage; import sage.common; print('âœ… åŸºç¡€æ¨¡å—å¯¼å…¥æˆåŠŸ')"
        fi
        
        # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
        echo "ğŸ§ª è¿è¡Œå¢å¼ºç‰ˆ SAGE æµ‹è¯•å¥—ä»¶..."
        
        # åªè¿è¡Œä¸€æ¬¡æµ‹è¯•å¥—ä»¶ï¼Œä½¿ç”¨å¿«é€Ÿé…ç½®ï¼ˆé¿å…é‡å¤è¿è¡Œç›¸åŒæµ‹è¯•ï¼‰
        echo "ğŸš€ è¿è¡Œæ ¸å¿ƒæµ‹è¯•å¥—ä»¶..."
        if $SAGE_CMD dev test --test-type quick --jobs 4 --timeout 300 --report "/tmp/test_report.md" 2>/dev/null; then
          echo "âœ… æ ¸å¿ƒæµ‹è¯•å¥—ä»¶é€šè¿‡"
        else
          echo "âš ï¸ æ ¸å¿ƒæµ‹è¯•å¥—ä»¶å¤±è´¥æˆ–ä¸æ”¯æŒï¼Œå°è¯•åŸºç¡€æµ‹è¯•"
          # å¦‚æœé«˜çº§æµ‹è¯•å¤±è´¥ï¼Œå°è¯•è¿è¡ŒåŸºç¡€æµ‹è¯•
          if $SAGE_CMD dev test --diagnose 2>/dev/null; then
            echo "âœ… åŸºç¡€è¯Šæ–­æµ‹è¯•é€šè¿‡"
          else
            echo "âš ï¸ æµ‹è¯•å‘½ä»¤ä¸æ”¯æŒï¼Œè·³è¿‡"
          fi
        fi
        
        # è¿è¡Œ Issues Manager æµ‹è¯•
        echo "ğŸ”§ è¿è¡Œ Issues Manager æµ‹è¯•..."
        if $SAGE_CMD dev test --issues-manager 2>/dev/null; then
          echo "âœ… Issues Manager æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ Issues Manager æµ‹è¯•å¤±è´¥æˆ–ä¸æ”¯æŒï¼Œè·³è¿‡"
        fi
        
        # è¿è¡Œ Examples æµ‹è¯•
        echo "ğŸ“š è¿è¡Œ Examples æµ‹è¯•..."
        
        # æ£€æŸ¥å¹¶å®‰è£… Examples æµ‹è¯•æ‰€éœ€çš„ CLI ä¾èµ–
        echo "ğŸ” æ£€æŸ¥ Examples æµ‹è¯•ä¾èµ–..."
        if ! python -c "import typer, rich" 2>/dev/null; then
          echo "ğŸ“¦ å®‰è£… Examples æµ‹è¯•æ‰€éœ€çš„ CLI ä¾èµ–..."
          pip install -e packages/sage-tools[cli] || echo "âš ï¸ CLI ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡ Examples æµ‹è¯•"
        else
          echo "âœ… Examples æµ‹è¯•ä¾èµ–å·²æ»¡è¶³"
        fi
        
        chmod +x ./tools/tests/run_examples_tests.sh
        if ./tools/tests/run_examples_tests.sh --category tutorials --timeout 30; then
          echo "âœ… Examples æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ Examples æµ‹è¯•å¤±è´¥æˆ–ä¸æ”¯æŒï¼Œè·³è¿‡"
        fi
        
        echo "âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶å®Œæˆ"
      timeout-minutes: 30
      
    - name: Report Test Failure
      if: failure() && (steps.run-tests.outcome == 'failure' || steps.run-tests.conclusion == 'failure')
      shell: bash -l {0}
      run: |
        echo "âŒ Test Suite Failed - Collecting Diagnostic Information"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "ğŸ“‹ Test Environment Information:"
        echo "- Date: $(date)"
        echo "- Working Directory: $(pwd)"
        echo ""
        
        echo "ğŸ Python Environment Status:"
        # æ£€æŸ¥æ˜¯å¦æœ‰sageç¯å¢ƒ
        if conda env list | grep -q "^sage "; then
          echo "âœ… sage condaç¯å¢ƒå­˜åœ¨"
          conda run -n sage python --version || echo "âŒ æ— æ³•åœ¨sageç¯å¢ƒä¸­è¿è¡ŒPython"
          conda run -n sage pip --version || echo "âŒ æ— æ³•åœ¨sageç¯å¢ƒä¸­è¿è¡Œpip"
        else
          echo "âš ï¸ sage condaç¯å¢ƒä¸å­˜åœ¨ï¼Œä½¿ç”¨å½“å‰ç¯å¢ƒ"
          python --version || echo "âŒ Pythonä¸å¯ç”¨"
          pip --version || echo "âŒ Pipä¸å¯ç”¨"
        fi
        echo ""
        
        echo "ğŸ“¦ SAGE Package Status:"
        echo "Testing SAGE imports:"
        if conda env list | grep -q "^sage "; then
          conda run -n sage python -c "import sage; print('âœ… SAGE version:', sage.__version__)" || echo "âŒ SAGE import failed"
          conda run -n sage python -c "import sage.common; print('âœ… sage.common imported')" || echo "âŒ sage.common import failed"
          conda run -n sage python -c "import sage.kernel; print('âœ… sage.kernel imported')" || echo "âŒ sage.kernel import failed"
          conda run -n sage python -c "import sage.libs; print('âœ… sage.libs imported')" || echo "âŒ sage.libs import failed"
          conda run -n sage python -c "import sage.middleware; print('âœ… sage.middleware imported')" || echo "âŒ sage.middleware import failed"
        else
          python -c "import sage; print('âœ… SAGE version:', sage.__version__)" || echo "âŒ SAGE import failed"
          python -c "import sage.common; print('âœ… sage.common imported')" || echo "âŒ sage.common import failed"
          python -c "import sage.kernel; print('âœ… sage.kernel imported')" || echo "âŒ sage.kernel import failed"
          python -c "import sage.libs; print('âœ… sage.libs imported')" || echo "âŒ sage.libs import failed"
          python -c "import sage.middleware; print('âœ… sage.middleware imported')" || echo "âŒ sage.middleware import failed"
        fi
        echo ""
        
        echo "ğŸ–¥ï¸ CLI Status:"
        if conda env list | grep -q "^sage "; then
          conda run -n sage sage --help > /dev/null && echo "âœ… SAGE CLI working" || echo "âŒ SAGE CLI failed"
          conda run -n sage sage version && echo "âœ… SAGE version command working" || echo "âŒ SAGE version command failed"
        else
          sage --help > /dev/null && echo "âœ… SAGE CLI working" || echo "âŒ SAGE CLI failed"
          sage version && echo "âœ… SAGE version command working" || echo "âŒ SAGE version command failed"
        fi
        echo ""
        
        echo "ğŸ“„ Test Logs and Reports:"
        if [ -f "/tmp/test_report.md" ]; then
          echo "Found test report:"
          cat "/tmp/test_report.md" || echo "Cannot read test report"
        elif [ -f "ci_test_report.txt" ]; then
          echo "Found fallback test report:"
          cat ci_test_report.txt || echo "Cannot read test report"
        else
          echo "Test report not found"
        fi
        echo ""
        
        echo "ğŸ“ Test Directory Contents:"
        if [ -d "tools/tests" ]; then
          echo "tools/tests directory contents:"
          ls -la tools/tests/ || echo "Cannot list test directory"
        else
          echo "tools/tests directory not found"
        fi
        echo ""
        
        echo "ğŸ” Recent Test Outputs:"
        echo "Searching for recent test files..."
        find . -name "*.log" -o -name "*test*" -o -name "pytest*" 2>/dev/null | head -10 || echo "No test files found"
        echo ""
        
        echo "ğŸ’¾ System Resources:"
        echo "- Memory usage: $(free -h | grep Mem || echo 'Unknown')"
        echo "- Disk space: $(df -h . | tail -1 | awk '{print $4}' || echo 'Unknown')"
        echo ""
        
        echo "ğŸ“¦ Installed Packages:"
        pip list | grep -E "(sage|pytest)" || echo "No SAGE or pytest packages found"
        echo ""
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ End of test failure diagnostic report"
        echo "ğŸ’¡ Please review the above information to diagnose the test failure"

  # æé†’ä¿¡æ¯ï¼ˆæ€»æ˜¯è¿è¡Œï¼‰
  info:
    name: CI Summary Report
    runs-on: ubuntu-latest
    if: always()
    needs: [quick-check, full-test]
    
    steps:
    - name: CI Summary
      run: |
        echo "ğŸ CI Pipeline Summary"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Pipeline completed at: $(date)"
        echo ""
        
        # æ£€æŸ¥å„ä¸ªä½œä¸šçš„çŠ¶æ€
        echo "ğŸ“Š Job Status Summary:"
        echo "- Quick Check: ${{ needs.quick-check.result }}"
        echo "- Full Test: ${{ needs.full-test.result }}"
        echo ""
        
        # æ ¹æ®ç»“æœæä¾›å»ºè®®
        if [[ "${{ needs.quick-check.result }}" == "failure" ]]; then
          echo "âŒ Quick Check failed:"
          echo "ğŸ’¡ This usually indicates basic setup or dependency issues"
          echo "ğŸ’¡ Check the 'Report Quick Check Failure' step for detailed diagnostics"
          echo ""
        fi
        
        if [[ "${{ needs.full-test.result }}" == "failure" ]]; then
          echo "âŒ Full Test failed:"
          echo "ğŸ’¡ This could be due to installation timeout or complex dependencies"
          echo "ğŸ’¡ Check the 'Report Installation Failure' or 'Report Test Failure' steps"
          echo ""
        fi
        
        if [[ "${{ needs.quick-check.result }}" == "success" && "${{ needs.full-test.result }}" == "success" ]]; then
          echo "âœ… All tests passed successfully!"
          echo "ğŸ‰ SAGE is ready for deployment"
        fi
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
  