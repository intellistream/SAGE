name: Development CI

on:
  push:
    branches: [ main-dev, refactor/* ]
  pull_request:
    branches: [ main-dev ]
  workflow_dispatch:

# å…¬å…±ç¯å¢ƒå˜é‡ï¼ˆé¿å…é‡å¤å®šä¹‰ï¼‰
env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com

jobs:
  test:
    name: Development Test
    runs-on: self-hosted
    timeout-minutes: 30  # å‡å°‘è¶…æ—¶æ—¶é—´ï¼Œå¼€å‘ç¯å¢ƒåº”è¯¥æ›´å¿«
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
        which python
        which pip
      timeout-minutes: 2
        
    - name: Setup pip and prepare environment
      run: |
        echo "ğŸ“¦ å‡†å¤‡Pythonç¯å¢ƒ..."
        echo "ğŸ“¦ å‡çº§pip..."
        pip install --upgrade pip --no-cache-dir
        echo "ğŸ“Š ç¯å¢ƒçŠ¶æ€:"
        echo "- Python: $(python --version)"
        echo "- Pip: $(pip --version)" 
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      timeout-minutes: 5
        
    - name: Cache System Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          /tmp/apt-cache
        key: ${{ runner.os }}-system-deps-${{ hashFiles('.github/workflows/dev-ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-system-deps-
          
    - name: Install System Dependencies
      run: |
        echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
        
        # åˆ›å»ºç”¨æˆ·å¯å†™çš„ç¼“å­˜ç›®å½•
        mkdir -p /tmp/apt-cache
        
        # æ›´æ–°åŒ…åˆ—è¡¨ï¼ˆä¼˜åŒ–CIæ€§èƒ½ï¼‰
        echo "ğŸ“¥ æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo apt-get update -qq
        
        # æ£€æŸ¥åŒ…æ˜¯å¦å·²å®‰è£…
        missing_packages=""
        for pkg in build-essential cmake pkg-config; do
          if ! dpkg -l | grep -q "^ii.*$pkg "; then
            missing_packages="$missing_packages $pkg"
          fi
        done
        
        if [ -n "$missing_packages" ]; then
          echo "ğŸ“¦ å®‰è£…ç¼ºå¤±çš„åŒ…:$missing_packages"
          sudo apt-get install -y $missing_packages
        else
          echo "âœ… æ‰€æœ‰ç³»ç»Ÿä¾èµ–å·²å®‰è£…"
        fi
      timeout-minutes: 10

    - name: Install SAGE (Test Mode)
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive
        PIP_NO_INPUT: 1
        PIP_DISABLE_PIP_VERSION_CHECK: 1
        # å¹¶è¡Œå®‰è£…ä¼˜åŒ–
        PIP_PARALLEL_BUILDS: 4
        MAKEFLAGS: "-j4"
      run: |
        echo "ğŸš€ CIæ¨¡å¼ï¼šé€šè¿‡quickstart.sh --minimal --pipå®‰è£…SAGE"
        echo "â„¹ï¸ ä½¿ç”¨pipæ¨¡å¼é¿å…condaä¾èµ–"
        echo "â° é¢„è®¡å®‰è£…æ—¶é—´: 5-10åˆ†é’Ÿ"
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "ğŸ“Š ç¯å¢ƒä¿¡æ¯:"
        echo "- Python: $(python --version)"
        echo "- Pythonè·¯å¾„: $(which python)"
        echo "- Pipç‰ˆæœ¬: $(pip --version)"
        echo "- ç½‘ç»œçŠ¶æ€: $(ping -c 1 pypi.org >/dev/null 2>&1 && echo "âœ… å¯è¾¾" || echo "âŒ ä¸å¯è¾¾")"
        
        echo "ğŸ¯ å¼€å§‹é€šè¿‡quickstart.shå®‰è£…..."
        chmod +x ./quickstart.sh
        ./quickstart.sh --minimal --pip --yes
        
        echo "âœ… quickstart.shå®‰è£…å®Œæˆ"
      timeout-minutes: 15
        
    - name: Basic Import Tests
      env:
        # PYTHONNOUSERSITE: 1  # æ³¨é‡Šæ‰ä»¥æé«˜runneræµ‹è¯•é€Ÿåº¦
        PIP_NO_INPUT: 1
      run: |
        echo "=== Import Tests ==="
        python -c "import sage; print('âœ… SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('âœ… sage.common import successful')"
        python -c "import sage.kernel; print('âœ… sage.kernel import successful')"
        python -c "import sage.libs; print('âœ… sage.libs import successful')"
        python -c "import sage.middleware; print('âœ… sage.middleware import successful')"
        echo "=== CLI Test ==="
        # æ³¨æ„ï¼šSAGEä½¿ç”¨Typeræ¡†æ¶ï¼Œå‘½ä»¤ç»“æ„ä¸º "sage <command>"ï¼Œä¸æ˜¯ä¼ ç»Ÿçš„ "sage --option"
        sage --help > /dev/null && echo "âœ… SAGE CLI help working"
        sage version && echo "âœ… SAGE version command working (ä½¿ç”¨ 'sage version' ä¸æ˜¯ 'sage --version')"

    - name: Extended Tests
      env:
        # PYTHONNOUSERSITE: 1  # æ³¨é‡Šæ‰ä»¥æé«˜runneræµ‹è¯•é€Ÿåº¦
        PIP_NO_INPUT: 1
      run: |
        echo "=== åŸºç¡€æ¨¡å—å¯¼å…¥æµ‹è¯• ==="
        
        # æµ‹è¯•åŸºç¡€å¯¼å…¥
        python -c "import sage.common; print('âœ… sage.common å¯¼å…¥æˆåŠŸ')" || echo "âŒ sage.common å¯¼å…¥å¤±è´¥"
        python -c "import sage.common.utils; print('âœ… sage.common.utils å¯¼å…¥æˆåŠŸ')" || echo "âŒ sage.common.utils å¯¼å…¥å¤±è´¥"
        
        # æµ‹è¯•å¯ç”¨çš„åŠŸèƒ½æ¨¡å—
        echo "=== åŠŸèƒ½æ¨¡å—æµ‹è¯• ==="
        python -c "from sage.common.utils.logging.custom_logger import CustomLogger;  print('âœ… Logger working') "
        python -c "import sage.common.utils.system; print('âœ… System utils working')" || echo "â„¹ï¸ System utils module structure different"
        
        # æµ‹è¯•å…¶ä»–å·²å®‰è£…çš„åŒ…
        python -c "import sage.kernel; print('âœ… sage.kernel å¯ç”¨')" || echo "â„¹ï¸ sage.kernel ä¸å¯ç”¨"
        python -c "import sage.middleware; print('âœ… sage.middleware å¯ç”¨')" || echo "â„¹ï¸ sage.middleware ä¸å¯ç”¨"
        python -c "import sage.libs; print('âœ… sage.libs å¯ç”¨')" || echo "â„¹ï¸ sage.libs ä¸å¯ç”¨"

    - name: Run Pytest Suite
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "=== Pytest æµ‹è¯•å¥—ä»¶ ==="
        
        # å®‰è£… pytest ç›¸å…³ä¾èµ–
        pip install pytest pytest-cov pytest-mock pytest-asyncio --no-cache-dir
        
        # æŸ¥æ‰¾å¹¶è¿è¡Œå¯ç”¨çš„æµ‹è¯•
        if [ -d "packages/sage-common/tests" ]; then
          echo "ğŸ§ª è¿è¡Œ sage-common æµ‹è¯•..."
          python -m pytest packages/sage-common/tests/ -v --tb=short --timeout=60 || echo "âš ï¸ sage-common æµ‹è¯•æœ‰é—®é¢˜"
        fi
        
        if [ -d "tools/tests" ]; then
          echo "ğŸ§ª è¿è¡Œå·¥å…·æµ‹è¯•..."
          python -m pytest tools/tests/ -v --tb=short --timeout=60 || echo "âš ï¸ å·¥å…·æµ‹è¯•æœ‰é—®é¢˜"
        fi
        
        # è¿è¡Œå¿«é€Ÿé›†æˆæµ‹è¯•
        echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
        cd tools/tests
        if [ -f "test_issues_manager.sh" ]; then
          bash test_issues_manager.sh --quick || echo "âš ï¸ Issues manager æµ‹è¯•æœ‰é—®é¢˜"
        fi
        
        echo "âœ… Pytest æµ‹è¯•å¥—ä»¶å®Œæˆ"
      timeout-minutes: 10
        
    - name: Full System Test
      env:
        # PYTHONNOUSERSITE: 1  # æ³¨é‡Šæ‰ä»¥æé«˜runneræµ‹è¯•é€Ÿåº¦
        PIP_NO_INPUT: 1
      run: |
        echo "=== Full Import Test ==="
        python -c "
        import sys
        print('Python executable:', sys.executable)
        print('Python version:', sys.version)
        
        # æµ‹è¯•å®Œæ•´å¯¼å…¥
        try:
            import sage
            print('âœ… sage:', sage.__version__)
            
            # å¯¼å…¥å„ä¸ªå­æ¨¡å—ï¼ˆä½¿ç”¨å®¹é”™æœºåˆ¶ï¼‰
            modules_status = []
            for module_name in ['common', 'kernel', 'libs', 'middleware']:
                try:
                    module = __import__(f'sage.{module_name}', fromlist=[module_name])
                    modules_status.append(f'âœ… sage.{module_name}')
                except ImportError as e:
                    modules_status.append(f'âš ï¸  sage.{module_name} (æœªå®‰è£…æˆ–ä¸å¯ç”¨)')
            
            print('æ¨¡å—çŠ¶æ€:', ', '.join(modules_status))
            
            # æµ‹è¯•CLIå·¥å…· - SAGEä½¿ç”¨Typeræ¡†æ¶ï¼Œå‘½ä»¤ç»“æ„ä¸åŒ
            import subprocess
            
            # å…ˆæµ‹è¯•åŸºæœ¬çš„helpå‘½ä»¤
            help_result = subprocess.run(['sage', '--help'], capture_output=True, text=True)
            if help_result.returncode != 0:
                print('âŒ SAGE CLI not installed or not working')
                print('Error:', help_result.stderr)
            else:
                print('âœ… SAGE CLI installed and working')
                
                # æµ‹è¯•versionå­å‘½ä»¤ï¼ˆæ³¨æ„ï¼šä¸æ˜¯--versioné€‰é¡¹ï¼‰
                version_result = subprocess.run(['sage', 'version'], capture_output=True, text=True)
                if version_result.returncode == 0:
                    print('âœ… SAGE version command successful:', version_result.stdout.strip())
                else:
                    print('âš ï¸  SAGE version command failed:')
                    print('STDOUT:', version_result.stdout)
                    print('STDERR:', version_result.stderr)
                    
                    # å°è¯•å…¶ä»–ç‰ˆæœ¬æŸ¥è¯¢æ–¹å¼
                    print('â„¹ï¸  æ³¨æ„: SAGEä½¿ç”¨ sage version å‘½ä»¤ï¼Œä¸æ˜¯ sage --version é€‰é¡¹')
            
        except Exception as e:
            print('âŒ Import test failed:', str(e))
            sys.exit(1)
        "
        
    - name: Run Basic Pytest Suite
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "ğŸ§ª Running development pytest suite..."
        
        # å®‰è£…æµ‹è¯•ä¾èµ–
        echo "ğŸ“¦ Installing test dependencies..."
        pip install pytest pytest-cov pytest-mock pytest-asyncio pytest-xdist pytest-timeout || echo "âš ï¸ Some test dependencies failed to install"
        
        # è¿è¡ŒIssues Manageræµ‹è¯•
        echo "ğŸ”§ Testing issues manager..."
        cd tools/tests
        if [ -f test_issues_manager.sh ]; then
          bash test_issues_manager.sh --quick || echo "âš ï¸ Issues manager tests had issues"
          echo "âœ… Issues manager tests completed"
        else
          echo "â„¹ï¸ Issues manager test script not found"
        fi
        cd ../..
        
        # è¿è¡Œå¿«é€Ÿpytestæµ‹è¯•
        echo "ğŸ”¬ Running quick pytest suite..."
        cd tools/tests
        if [ -f run_tests.py ]; then
        echo "ğŸ§ª Running Development Tests:"
        sage dev test --test-type unit --verbose || echo "â„¹ï¸ Some unit tests didn't pass"          if [ -f dev_test_report.txt ]; then
            echo "ğŸ“Š Quick Test Summary:"
            tail -10 dev_test_report.txt
          fi
        else
          echo "â„¹ï¸ Test runner not found, running direct pytest..."
          # ç›´æ¥è¿è¡Œpyteståœ¨packagesç›®å½•
          cd ../../packages
          for package in sage-common sage-kernel sage-libs sage-middleware; do
            if [ -d "$package/tests" ]; then
              echo "ğŸ§ª Testing $package..."
              cd "$package"
              python -m pytest tests/ -v --tb=short -x --timeout=30 2>/dev/null || echo "âš ï¸ $package tests had issues"
              cd ..
            else
              echo "â„¹ï¸ No tests directory in $package"
            fi
          done
        fi
        
        echo "âœ… Development test suite completed"
