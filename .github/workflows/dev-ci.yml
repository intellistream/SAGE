name: Development CI

on:
  push:
    branches: [ main-dev, refactor/* ]
  pull_request:
    branches: [ main-dev ]
  workflow_dispatch:

# å…¬å…±ç¯å¢ƒå˜é‡ï¼ˆé¿å…é‡å¤å®šä¹‰ï¼‰
env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  # æ§åˆ¶æ˜¯å¦ç¼–è¯‘C++æ‰©å±•ï¼ˆè®¾ä¸ºfalseå¯åŠ é€ŸCIï¼‰
  SAGE_SKIP_CPP_EXTENSIONS: true

jobs:
  test:
    name: Development Test
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å‡å°‘è¶…æ—¶æ—¶é—´ï¼Œå¼€å‘ç¯å¢ƒåº”è¯¥æ›´å¿«
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
        which python
        which pip
      timeout-minutes: 2
        
    - name: Setup pip and prepare environment
      run: |
        echo "ğŸ“¦ å‡†å¤‡Pythonç¯å¢ƒ..."
        echo "ğŸ“¦ å‡çº§pip..."
        pip install --upgrade pip --no-cache-dir
        echo "ğŸ“Š ç¯å¢ƒçŠ¶æ€:"
        echo "- Python: $(python --version)"
        echo "- Pip: $(pip --version)" 
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      timeout-minutes: 5
        
    - name: Cache System Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          /tmp/apt-cache
        key: ${{ runner.os }}-system-deps-${{ hashFiles('.github/workflows/dev-ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-system-deps-
          
    - name: Install System Dependencies (C++ Extensions)
      run: |
        if [ "$SAGE_SKIP_CPP_EXTENSIONS" = "true" ]; then
          echo "ğŸš€ è·³è¿‡C++æ‰©å±•ç¼–è¯‘ä¾èµ–å®‰è£…ï¼ˆåŠ é€ŸCIæ¨¡å¼ï¼‰"
          echo "ğŸ“‹ åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œä»¥ä¸‹æ¨¡å—å°†ä½¿ç”¨Pythonå›é€€å®ç°ï¼š"
          echo "   â€¢ sage-kernel/enterprise/sage_queue â†’ Pythoné˜Ÿåˆ—å®ç°"
          echo "   â€¢ sage-middleware/components/sage_db â†’ çº¯Pythonå‘é‡æ•°æ®åº“"
          exit 0
        fi
        
        echo "ğŸ“¦ æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…ç³»ç»Ÿä¾èµ–..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼–è¯‘C++æ‰©å±•
        needs_cpp=false
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦ç¼–è¯‘çš„C++æ¨¡å—
        if [ -f "packages/sage-kernel/src/sage/kernel/enterprise/sage_queue/CMakeLists.txt" ] || \
           [ -f "packages/sage-middleware/src/sage/middleware/components/sage_db/CMakeLists.txt" ]; then
          needs_cpp=true
          echo "ğŸ” æ£€æµ‹åˆ°C++æ‰©å±•æ¨¡å—ï¼Œéœ€è¦å®‰è£…ç¼–è¯‘å·¥å…·"
        fi
        
        if [ "$needs_cpp" = true ]; then
          echo "ğŸ“¦ å®‰è£…C++ç¼–è¯‘ä¾èµ–..."
          
          # æ›´æ–°åŒ…åˆ—è¡¨
          echo "ğŸ“¥ æ›´æ–°åŒ…åˆ—è¡¨..."
          sudo apt-get update -qq
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config || {
            echo "âš ï¸ ç³»ç»Ÿä¾èµ–å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œï¼ˆC++æ‰©å±•å¯èƒ½ä¸å¯ç”¨ï¼‰"
          }
        else
          echo "âœ… æ— éœ€å®‰è£…C++ç¼–è¯‘ä¾èµ–ï¼Œè·³è¿‡"
        fi
      timeout-minutes: 15
      continue-on-error: true  # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

    - name: Install SAGE (Test Mode)
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive
        PIP_NO_INPUT: 1
        PIP_DISABLE_PIP_VERSION_CHECK: 1
        # å¹¶è¡Œå®‰è£…ä¼˜åŒ–
        PIP_PARALLEL_BUILDS: 4
        MAKEFLAGS: "-j4"
      run: |
        echo "ğŸš€ CIæ¨¡å¼ï¼šé€šè¿‡quickstart.sh --dev --pipå®‰è£…SAGE"
        echo "â„¹ï¸ ä½¿ç”¨devæ¨¡å¼åŒ…å«å®Œæ•´å¼€å‘å·¥å…·å’ŒCLI"
        echo "â° é¢„è®¡å®‰è£…æ—¶é—´: 8-15åˆ†é’Ÿ"
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "ğŸ“Š ç¯å¢ƒä¿¡æ¯:"
        echo "- Python: $(python --version)"
        echo "- Pythonè·¯å¾„: $(which python)"
        echo "- Pipç‰ˆæœ¬: $(pip --version)"
        echo "- ç½‘ç»œçŠ¶æ€: $(ping -c 1 pypi.org >/dev/null 2>&1 && echo "âœ… å¯è¾¾" || echo "âŒ ä¸å¯è¾¾")"
        
        echo "ğŸ¯ å¼€å§‹é€šè¿‡quickstart.sh devæ¨¡å¼å®‰è£…..."
        chmod +x ./quickstart.sh
        ./quickstart.sh --dev --pip --yes
        
        echo "âœ… quickstart.sh devæ¨¡å¼å®‰è£…å®Œæˆ"
      timeout-minutes: 20

    - name: Code Quality Checks
      run: |
        echo "ğŸ” Running code quality checks..."
        black --check --diff packages/ || echo "âš ï¸ Code formatting issues found"
        isort --check-only --diff packages/ || echo "âš ï¸ Import sorting issues found"
        flake8 packages/ --count --select=E9,F63,F7,F82 --show-source --statistics
      timeout-minutes: 2

    - name: Run Examples Tests
      working-directory: ${{ github.workspace }}
      run: |
        echo "Running examples tests..."
        echo "ğŸ—‚ï¸ Current working directory: $(pwd)"
        echo "ğŸ“ Examples directory exists: $([ -d "examples" ] && echo "âœ… Yes" || echo "âŒ No")"
        if [ -d "examples" ]; then
          echo "ğŸ“Š Examples directory contents:"
          ls -la examples/ | head -10
          echo "ğŸ“Š Total example files found:"
          find examples/ -name "*.py" | wc -l
        fi
        
        echo "ğŸ§ª Testing path discovery from Python:"
        python3 -c "
        from tools.tests.test_examples import find_project_root, ExampleAnalyzer
        try:
            root = find_project_root()
            print(f'âœ… Project root found: {root}')
            analyzer = ExampleAnalyzer()
            examples = analyzer.discover_examples()
            print(f'ğŸ“‹ Found {len(examples)} examples')
        except Exception as e:
            print(f'âŒ Error: {e}')
            import traceback
            traceback.print_exc()
        "
        
        # ç¡®ä¿æµ‹è¯•è„šæœ¬å¯æ‰§è¡Œ
        chmod +x ./tools/tests/run_examples_tests.sh
        
        # è¿è¡Œexamplesæµ‹è¯•
        echo "ğŸ§ª è¿è¡ŒExamplesæµ‹è¯•å¥—ä»¶..."
        if ./tools/tests/run_examples_tests.sh; then
          echo "âœ… Examplesæµ‹è¯•é€šè¿‡"
          exit_code=0
        else
          exit_code=$?
          echo "âŒ Examplesæµ‹è¯•å¤±è´¥"
          
          # åœ¨CIç¯å¢ƒä¸­ï¼ŒæŸäº›ç¤ºä¾‹å¯èƒ½å› ä¸ºç¼ºå°‘APIå¯†é’¥æˆ–å¤–éƒ¨æœåŠ¡è€Œå¤±è´¥
          if [[ "$CI" == "true" ]]; then
            echo "âš ï¸ åœ¨CIç¯å¢ƒä¸­ï¼ŒæŸäº›Exampleså¯èƒ½å› ä¸ºç¼ºå°‘å¤–éƒ¨ä¾èµ–è€Œå¤±è´¥"
            echo "ğŸ’¡ æ‰§è¡ŒåŸºç¡€éªŒè¯ä»¥ç¡®ä¿æ ¸å¿ƒç¤ºä¾‹å¯ç”¨..."
            
            # åŸºç¡€éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦èƒ½å‘ç°ç¤ºä¾‹æ–‡ä»¶
            if python3 tools/tests/test_examples.py analyze 2>/dev/null; then
              echo "âœ… åŸºç¡€Exampleså‘ç°åŠŸèƒ½å¯ç”¨"
              exit_code=0
            else
              echo "âŒ è¿åŸºç¡€Exampleså‘ç°åŠŸèƒ½éƒ½æ— æ³•ä½¿ç”¨"
              exit_code=1
            fi
          fi
        fi
        
        if [ $exit_code -eq 0 ]; then
          echo "Examples tests completed âœ…"
        else
          echo "Examples tests failed âŒ"
          exit $exit_code
        fi

    - name: Basic Import Tests
      env:
        # PYTHONNOUSERSITE: 1  # æ³¨é‡Šæ‰ä»¥æé«˜runneræµ‹è¯•é€Ÿåº¦
        PIP_NO_INPUT: 1
      run: |
        echo "=== Import Tests ==="
        python -c "import sage; print('âœ… SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('âœ… sage.common import successful')"
        python -c "import sage.kernel; print('âœ… sage.kernel import successful')"
        python -c "import sage.libs; print('âœ… sage.libs import successful')"
        python -c "import sage.middleware; print('âœ… sage.middleware import successful')"
        echo "=== CLI Test ==="
        # æ£€æŸ¥sageå‘½ä»¤æ˜¯å¦åœ¨PATHä¸­
        if command -v sage >/dev/null 2>&1; then
          echo "âœ… SAGE CLI found in PATH"
          sage --help > /dev/null && echo "âœ… SAGE CLI help working"
          sage version && echo "âœ… SAGE version command working"
        else
          echo "âŒ SAGE CLI not found in PATH"
          echo "æ£€æŸ¥å·²å®‰è£…çš„åŒ…å’Œå…¥å£ç‚¹:"
          python -c "import pkg_resources; [print(f'Found sage entry point: {ep}') for ep in pkg_resources.iter_entry_points('console_scripts') if ep.name == 'sage']"
          echo "æ£€æŸ¥pythonæ¨¡å—è·¯å¾„:"
          python -c "import sys; print('\n'.join(sys.path))"
          echo "å°è¯•ç›´æ¥è¿è¡ŒCLIæ¨¡å—:"
          python -m sage.tools.cli.main --help && echo "âœ… CLI module works directly"
        fi

    - name: Extended Import & CLI Tests
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "=== æ‰©å±•å¯¼å…¥å’ŒCLIæµ‹è¯• ==="
        
        # ä½¿ç”¨æ–°çš„è¯Šæ–­åŠŸèƒ½è¿›è¡Œå®Œæ•´å¯¼å…¥æµ‹è¯•
        sage dev test --diagnose
        
        # CLIåŠŸèƒ½æµ‹è¯•
        echo "=== CLIåŠŸèƒ½æµ‹è¯• ==="
        if command -v sage >/dev/null 2>&1; then
          echo "âœ… SAGE CLI found in PATH"
          sage --help > /dev/null && echo "âœ… SAGE CLI help working"
          sage version && echo "âœ… SAGE version command working"
        else
          echo "âŒ SAGE CLI not found in PATH"
        fi
        
        echo "âœ… æ‰©å±•æµ‹è¯•å®Œæˆ"
