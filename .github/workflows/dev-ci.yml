name: "Development CI"

on:
  push:
    branches: [main-dev]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README*'
  pull_request:
    branches: [main-dev]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  SAGE_VERBOSE_BUILD: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  # ğŸ”„ ç¼“å­˜ç­–ç•¥è¯´æ˜ï¼š
  # - ç¼“å­˜C++æ‰©å±•çš„æ„å»ºäº§ç‰©(.soæ–‡ä»¶å’Œbuildç›®å½•)
  # - ç¼“å­˜é”®åŸºäºæºä»£ç ã€å­æ¨¡å—çŠ¶æ€å’Œæ„å»ºé…ç½®çš„hashå€¼
  # - æ¯ä¸ªjobç‹¬ç«‹æ¢å¤ç¼“å­˜ï¼Œé¿å…jobé—´ä¾èµ–
  # - editable installæ¯æ¬¡é‡æ–°æ‰§è¡Œï¼Œç¡®ä¿æ­£ç¡®é“¾æ¥
  # - ä½¿ç”¨SAGE_SKIP_CPP_BUILDç¯å¢ƒå˜é‡è·³è¿‡å·²ç¼“å­˜çš„æ„å»º

jobs:
  build-sage:
    name: Build and Install SAGE
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºä»£ç å†…å®¹ï¼‰..."
          
          # Pythonå’ŒC++æºç hash
          SAGE_CODE_HASH=$(find packages/ \( -name "*.py" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "CMakeLists.txt" -o -name "pyproject.toml" \) -type f | sort | xargs md5sum | md5sum | cut -d' ' -f1)
          echo "ğŸ“„ SAGEä»£ç hash: ${SAGE_CODE_HASH}"
          
          # å­æ¨¡å—çŠ¶æ€ï¼ˆC++æ‰©å±•ä¾èµ–ï¼‰
          SUBMODULE_HASH=$(git submodule status | md5sum | cut -d' ' -f1)
          echo "ğŸ“¦ å­æ¨¡å—hash: ${SUBMODULE_HASH}"
          
          # æ„å»ºè„šæœ¬å’ŒCIé…ç½®
          BUILD_CONFIG_HASH=$(cat quickstart.sh .github/workflows/dev-ci.yml | md5sum | cut -d' ' -f1)
          echo "âš™ï¸ æ„å»ºé…ç½®hash: ${BUILD_CONFIG_HASH}"
          
          # ç»„åˆç”Ÿæˆæœ€ç»ˆç¼“å­˜é”®
          CACHE_KEY="sage-v2-${{ runner.os }}-py311-${SAGE_CODE_HASH}-${SUBMODULE_HASH}-${BUILD_CONFIG_HASH}"
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ æœ€ç»ˆç¼“å­˜é”®: ${CACHE_KEY}"

      - name: Cache C++ Extensions
        id: cache-extensions
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            packages/sage-middleware/src/sage/middleware/components/sage_db/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_db/build
            packages/sage-middleware/src/sage/middleware/components/sage_db/install
            packages/sage-middleware/src/sage/middleware/components/sage_flow/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_flow/build
            packages/sage-middleware/src/sage/middleware/components/sage_flow/install
          key: ${{ steps.cache-key.outputs.cache-key }}
          restore-keys: |
            sage-v2-${{ runner.os }}-py311-

      - name: Cache Status Report
        run: |
          if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… ç¼“å­˜å‘½ä¸­ï¼C++æ‰©å±•æ„å»ºäº§ç‰©å·²æ¢å¤"
            echo "ğŸ” æ£€æŸ¥ç¼“å­˜çš„æ‰©å±•æ–‡ä»¶ï¼š"
            find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f || echo "âš ï¸ æœªæ‰¾åˆ°.soæ–‡ä»¶"
          else
            echo "â„¹ï¸ ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦æ„å»ºC++æ‰©å±•"
          fi

      - name: Install System Dependencies
        run: |
          echo "ğŸ”§ ç³»ç»Ÿä¾èµ–å°†ç”±quickstart.shç»Ÿä¸€ç®¡ç†..."
          echo "è·³è¿‡å•ç‹¬çš„ç³»ç»Ÿä¾èµ–å®‰è£…æ­¥éª¤"

      - name: Initialize Submodules
        run: |
          echo "ğŸ” åˆå§‹åŒ–å­æ¨¡å—ï¼ˆC++æ‰©å±•ä¾èµ–ï¼‰..."
          git submodule update --init --recursive
          echo "âœ… å­æ¨¡å—åˆå§‹åŒ–å®Œæˆ"
          
          # éªŒè¯å…³é”®å­æ¨¡å—
          echo "ğŸ” éªŒè¯å…³é”®å­æ¨¡å—ï¼š"
          if [ -d "packages/sage-middleware/src/sage/middleware/components/sage_db" ]; then
            echo "âœ… sage_db å­æ¨¡å—å­˜åœ¨"
            ls -la packages/sage-middleware/src/sage/middleware/components/sage_db/ | head -10
          else
            echo "âŒ sage_db å­æ¨¡å—ç¼ºå¤±"
          fi

      - name: Install SAGE
        run: |
          if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
            echo "ğŸš€ å®‰è£…SAGEï¼ˆä½¿ç”¨ç¼“å­˜çš„C++æ‰©å±•ï¼‰..."
            # ç¼“å­˜å‘½ä¸­æ—¶ï¼Œè·³è¿‡C++æ‰©å±•æ„å»ºï¼ŒåªåšPythonåŒ…å®‰è£…
            export SAGE_SKIP_CPP_BUILD=1
          else
            echo "ğŸš€ å®‰è£…SAGEï¼ˆå®Œæ•´æ„å»ºï¼ŒåŒ…æ‹¬C++æ‰©å±•ï¼‰..."
          fi
          
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --pip --yes
          
          # éªŒè¯å®‰è£…æˆåŠŸ
          echo "ğŸ” éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; import sage.common; print('âœ… SAGEæ ¸å¿ƒæ¨¡å—å¯¼å…¥æˆåŠŸ')"
          
          if command -v sage >/dev/null 2>&1; then
            echo "âœ… sage CLIå·¥å…·å¯ç”¨"
          else
            echo "âŒ sage CLIå·¥å…·ä¸å¯ç”¨"
            exit 1
          fi
          
          # éªŒè¯æ‰©å±•æ„å»ºç»“æœ
          echo "ğŸ” éªŒè¯æ‰©å±•æ„å»ºç»“æœ..."
          if find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f | grep -q "\.so"; then
            echo "âœ… æ‰¾åˆ°.soæ–‡ä»¶:"
            find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f
          else
            echo "âš ï¸ æœªæ‰¾åˆ°.soæ–‡ä»¶ï¼Œæ‰©å±•æ„å»ºå¯èƒ½å¤±è´¥ï¼ˆä½†ä¸é˜»æ–­æµç¨‹ï¼‰"
          fi
          
          echo "âœ… SAGEå®‰è£…éªŒè¯å®Œæˆ"
        timeout-minutes: 20

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"

      - name: Verify C++ Extensions Status
        run: |
          echo "ğŸ§© æ£€æŸ¥C++æ‰©å±•çŠ¶æ€..."
          
          # æ£€æŸ¥.soæ–‡ä»¶
          echo "ğŸ“ æ£€æŸ¥ç¼–è¯‘æ–‡ä»¶:"
          if find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f | grep -q "\.so"; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘çš„æ‰©å±•æ–‡ä»¶:"
            find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f
          else
            echo "âŒ æœªæ‰¾åˆ°.soæ–‡ä»¶"
          fi
          
          # æ£€æŸ¥æ‰©å±•åŠŸèƒ½çŠ¶æ€ï¼ˆä¸å¼ºåˆ¶æ„å»ºï¼‰
          echo "ğŸ” æ£€æŸ¥æ‰©å±•åŠŸèƒ½çŠ¶æ€:"
          python -c "
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§: {total}/{len(available)}')
              for ext, status in available.items():
                  print(f'  {ext}: {\"âœ…\" if status else \"âŒ\"}')
              
              if total > 0:
                  print(f'âœ… æœ‰{total}ä¸ªæ‰©å±•å¯ç”¨')
              else:
                  print('â„¹ï¸ æ‰©å±•æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½')
          except ImportError as e:
              print(f'âš ï¸ æ‰©å±•çŠ¶æ€æ£€æŸ¥å¤±è´¥: {e}')
          "
          
          echo "â„¹ï¸ æ‰©å±•çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œç»§ç»­å…¶ä»–æµ‹è¯•"

  quick-check:
    name: SAGE Self-Check
    runs-on: ubuntu-latest
    needs: build-sage
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºä»£ç å†…å®¹ï¼‰..."
          
          # Pythonå’ŒC++æºç hash
          SAGE_CODE_HASH=$(find packages/ \( -name "*.py" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "CMakeLists.txt" -o -name "pyproject.toml" \) -type f | sort | xargs md5sum | md5sum | cut -d' ' -f1)
          echo "ğŸ“„ SAGEä»£ç hash: ${SAGE_CODE_HASH}"
          
          # å­æ¨¡å—çŠ¶æ€
          SUBMODULE_HASH=$(git submodule status | md5sum | cut -d' ' -f1)
          echo "ğŸ“¦ å­æ¨¡å—hash: ${SUBMODULE_HASH}"
          
          # æ„å»ºè„šæœ¬å’ŒCIé…ç½®
          BUILD_CONFIG_HASH=$(cat quickstart.sh .github/workflows/dev-ci.yml | md5sum | cut -d' ' -f1)
          echo "âš™ï¸ æ„å»ºé…ç½®hash: ${BUILD_CONFIG_HASH}"
          
          # ç»„åˆç”Ÿæˆæœ€ç»ˆç¼“å­˜é”®
          CACHE_KEY="sage-v2-${{ runner.os }}-py311-${SAGE_CODE_HASH}-${SUBMODULE_HASH}-${BUILD_CONFIG_HASH}"
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ æœ€ç»ˆç¼“å­˜é”®: ${CACHE_KEY}"

      - name: Cache C++ Extensions
        id: cache-extensions
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            packages/sage-middleware/src/sage/middleware/components/sage_db/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_db/build
            packages/sage-middleware/src/sage/middleware/components/sage_db/install
            packages/sage-middleware/src/sage/middleware/components/sage_flow/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_flow/build
            packages/sage-middleware/src/sage/middleware/components/sage_flow/install
          key: ${{ steps.cache-key.outputs.cache-key }}
          restore-keys: |
            sage-v2-${{ runner.os }}-py311-

      - name: Initialize Submodules
        run: |
          echo "ğŸ” åˆå§‹åŒ–å­æ¨¡å—ï¼ˆC++æ‰©å±•ä¾èµ–ï¼‰..."
          git submodule update --init --recursive
          echo "âœ… å­æ¨¡å—åˆå§‹åŒ–å®Œæˆ"

      - name: Install SAGE
        run: |
          if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
            echo "ğŸš€ å®‰è£…SAGEï¼ˆä½¿ç”¨ç¼“å­˜çš„C++æ‰©å±•ï¼‰..."
            export SAGE_SKIP_CPP_BUILD=1
          else
            echo "ğŸš€ å®‰è£…SAGEï¼ˆå®Œæ•´æ„å»ºï¼‰..."
          fi
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --pip --yes
          echo "âœ… SAGEå®‰è£…å®Œæˆ"

      - name: Run Basic Tests
        run: |
          echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python -c "import sage; import sage.common; print('âœ… åŸºç¡€å¯¼å…¥æµ‹è¯•é€šè¿‡')"
          
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… CLIæµ‹è¯•é€šè¿‡"
          fi

      - name: Run SAGE Unit Tests
        run: |
          echo "ğŸ§ª è¿è¡ŒSAGEå•å…ƒæµ‹è¯•..."
          # å®‰è£…æµ‹è¯•ä¾èµ–
          pip install pytest pytest-cov pytest-xdist
          
          # è¿è¡Œå„ä¸ªåŒ…çš„æµ‹è¯•
          test_packages=("sage-common" "sage-kernel" "sage-tools" "sage-libs" "sage-middleware")
          failed_tests=0
          
          for package in "${test_packages[@]}"; do
            if [ -d "packages/$package/tests" ]; then
              echo "ğŸ§ª æµ‹è¯• $package..."
              if python -m pytest "packages/$package/tests/" -v --tb=short --maxfail=3; then
                echo "âœ… $package æµ‹è¯•é€šè¿‡"
              else
                echo "âŒ $package æµ‹è¯•å¤±è´¥"
                failed_tests=$((failed_tests + 1))
              fi
            else
              echo "âš ï¸ $package æ²¡æœ‰testsç›®å½•ï¼Œè·³è¿‡"
            fi
          done
          
          # æŠ¥å‘Šæµ‹è¯•ç»“æœ
          if [ $failed_tests -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
          else
            echo "âš ï¸ $failed_tests ä¸ªåŒ…çš„æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          fi
        timeout-minutes: 15

  examples-test:
    name: Examples Test
    runs-on: ubuntu-latest
    needs: build-sage
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºä»£ç å†…å®¹ï¼‰..."
          
          # Pythonå’ŒC++æºç hash
          SAGE_CODE_HASH=$(find packages/ \( -name "*.py" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "CMakeLists.txt" -o -name "pyproject.toml" \) -type f | sort | xargs md5sum | md5sum | cut -d' ' -f1)
          echo "ğŸ“„ SAGEä»£ç hash: ${SAGE_CODE_HASH}"
          
          # å­æ¨¡å—çŠ¶æ€
          SUBMODULE_HASH=$(git submodule status | md5sum | cut -d' ' -f1)
          echo "ğŸ“¦ å­æ¨¡å—hash: ${SUBMODULE_HASH}"
          
          # æ„å»ºè„šæœ¬å’ŒCIé…ç½®
          BUILD_CONFIG_HASH=$(cat quickstart.sh .github/workflows/dev-ci.yml | md5sum | cut -d' ' -f1)
          echo "âš™ï¸ æ„å»ºé…ç½®hash: ${BUILD_CONFIG_HASH}"
          
          # ç»„åˆç”Ÿæˆæœ€ç»ˆç¼“å­˜é”®
          CACHE_KEY="sage-v2-${{ runner.os }}-py311-${SAGE_CODE_HASH}-${SUBMODULE_HASH}-${BUILD_CONFIG_HASH}"
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ æœ€ç»ˆç¼“å­˜é”®: ${CACHE_KEY}"

      - name: Cache C++ Extensions
        id: cache-extensions
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            packages/sage-middleware/src/sage/middleware/components/sage_db/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_db/build
            packages/sage-middleware/src/sage/middleware/components/sage_db/install
            packages/sage-middleware/src/sage/middleware/components/sage_flow/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_flow/build
            packages/sage-middleware/src/sage/middleware/components/sage_flow/install
          key: ${{ steps.cache-key.outputs.cache-key }}
          restore-keys: |
            sage-v2-${{ runner.os }}-py311-

      - name: Initialize Submodules
        run: |
          echo "ğŸ” åˆå§‹åŒ–å­æ¨¡å—ï¼ˆC++æ‰©å±•ä¾èµ–ï¼‰..."
          git submodule update --init --recursive
          echo "âœ… å­æ¨¡å—åˆå§‹åŒ–å®Œæˆ"

      - name: Install SAGE
        run: |
          if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
            echo "ğŸš€ å®‰è£…SAGEï¼ˆä½¿ç”¨ç¼“å­˜çš„C++æ‰©å±•ï¼‰..."
            export SAGE_SKIP_CPP_BUILD=1
          else
            echo "ğŸš€ å®‰è£…SAGEï¼ˆå®Œæ•´æ„å»ºï¼‰..."
          fi
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --pip --yes
          echo "âœ… SAGEå®‰è£…å®Œæˆ"

      - name: Run Examples Tests
        run: |
          echo "ğŸŒŸ è¿è¡ŒExamplesæµ‹è¯•..."
          chmod +x ./tools/tests/run_examples_tests.sh
          ./tools/tests/run_examples_tests.sh --timeout 300
  
  deployment-ready:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [build-sage, quick-check, examples-test]
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-dev')) ||
      (github.event_name == 'pull_request' && github.base_ref == 'main-dev')
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cache Key
        id: cache-key
        run: |
          echo "ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºä»£ç å†…å®¹ï¼‰..."
          
          # Pythonå’ŒC++æºç hash
          SAGE_CODE_HASH=$(find packages/ \( -name "*.py" -o -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "CMakeLists.txt" -o -name "pyproject.toml" \) -type f | sort | xargs md5sum | md5sum | cut -d' ' -f1)
          echo "ğŸ“„ SAGEä»£ç hash: ${SAGE_CODE_HASH}"
          
          # å­æ¨¡å—çŠ¶æ€
          SUBMODULE_HASH=$(git submodule status | md5sum | cut -d' ' -f1)
          echo "ğŸ“¦ å­æ¨¡å—hash: ${SUBMODULE_HASH}"
          
          # æ„å»ºè„šæœ¬å’ŒCIé…ç½®
          BUILD_CONFIG_HASH=$(cat quickstart.sh .github/workflows/dev-ci.yml | md5sum | cut -d' ' -f1)
          echo "âš™ï¸ æ„å»ºé…ç½®hash: ${BUILD_CONFIG_HASH}"
          
          # ç»„åˆç”Ÿæˆæœ€ç»ˆç¼“å­˜é”®
          CACHE_KEY="sage-v2-${{ runner.os }}-py311-${SAGE_CODE_HASH}-${SUBMODULE_HASH}-${BUILD_CONFIG_HASH}"
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ æœ€ç»ˆç¼“å­˜é”®: ${CACHE_KEY}"

      - name: Cache C++ Extensions
        id: cache-extensions
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            packages/sage-middleware/src/sage/middleware/components/sage_db/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_db/build
            packages/sage-middleware/src/sage/middleware/components/sage_db/install
            packages/sage-middleware/src/sage/middleware/components/sage_flow/python/*.so
            packages/sage-middleware/src/sage/middleware/components/sage_flow/build
            packages/sage-middleware/src/sage/middleware/components/sage_flow/install
          key: ${{ steps.cache-key.outputs.cache-key }}
          restore-keys: |
            sage-v2-${{ runner.os }}-py311-

      - name: Initialize Submodules
        run: |
          echo "ğŸ” åˆå§‹åŒ–å­æ¨¡å—ï¼ˆC++æ‰©å±•ä¾èµ–ï¼‰..."
          git submodule update --init --recursive
          echo "âœ… å­æ¨¡å—åˆå§‹åŒ–å®Œæˆ"

      - name: Install SAGE
        run: |
          if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
            echo "ğŸš€ å®‰è£…SAGEï¼ˆä½¿ç”¨ç¼“å­˜çš„C++æ‰©å±•ï¼‰..."
            export SAGE_SKIP_CPP_BUILD=1
          else
            echo "ğŸš€ å®‰è£…SAGEï¼ˆå®Œæ•´æ„å»ºï¼‰..."
          fi
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --pip --yes
          echo "âœ… SAGEå®‰è£…å®Œæˆ"

      - name: Validate PyPI Release Readiness
        run: |
          echo "ğŸ” éªŒè¯SAGEä»£ç çš„PyPIå‘å¸ƒå‡†å¤‡çŠ¶æ€..."
          if sage dev pypi validate; then
            echo "âœ… PyPIå‘å¸ƒå‡†å¤‡éªŒè¯å®Œæˆ"
          else
            echo "âŒ PyPIå‘å¸ƒå‡†å¤‡éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: Check Package Build Status
        run: |
          echo "ğŸ—ï¸ æ£€æŸ¥SAGEåŒ…çš„æ„å»ºçŠ¶æ€..."
          if sage dev pypi check; then
            echo "âœ… åŒ…æ„å»ºçŠ¶æ€æ£€æŸ¥å®Œæˆ"
          else
            echo "âŒ åŒ…æ„å»ºçŠ¶æ€æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

      - name: Build SAGE Packages
        run: |
          echo "ğŸ“¦ æ„å»ºSAGE wheelåŒ…..."
          if sage dev pypi build; then
            echo "âœ… åŒ…æ„å»ºå®Œæˆ"
            
            # æ˜¾ç¤ºæ„å»ºçš„æ–‡ä»¶
            echo "ğŸ“‹ æ„å»ºçš„åŒ…æ–‡ä»¶:"
            find packages/sage/dist/ -name "*.whl" -o -name "*.tar.gz" | sort
          else
            echo "âŒ åŒ…æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Test Package Installation
        run: |
          echo "ğŸ§ª æµ‹è¯•åŒ…å®‰è£…..."
          
          # åˆ›å»ºä¸´æ—¶ç¯å¢ƒæµ‹è¯•å®‰è£…
          python -m venv /tmp/test_env
          source /tmp/test_env/bin/activate
          
          # æŸ¥æ‰¾æ„å»ºçš„wheelæ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾æ„å»ºçš„wheelæ–‡ä»¶..."
          find . -name "*.whl" -type f | head -10
          
          # å®‰è£…æ ¸å¿ƒåŒ…è¿›è¡Œæµ‹è¯•
          echo "ğŸ“¦ æµ‹è¯•å®‰è£…æ ¸å¿ƒåŒ…..."
          if ls packages/sage/dist/isage-*.whl 1> /dev/null 2>&1; then
            pip install packages/sage/dist/isage-*.whl
            python -c "import sage; print('âœ… sageæ ¸å¿ƒåŒ…å®‰è£…æˆåŠŸ')"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ ¸å¿ƒåŒ…wheelæ–‡ä»¶"
          fi
          
          # æµ‹è¯•å·¥å…·åŒ…å®‰è£…
          if ls packages/sage-tools/dist/isage_tools-*.whl 1> /dev/null 2>&1; then
            pip install packages/sage-tools/dist/isage_tools-*.whl # â¬…ï¸ ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
            python -c "import sage.tools; print('âœ… sage-toolsåŒ…å®‰è£…æˆåŠŸ')"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å·¥å…·åŒ…wheelæ–‡ä»¶"
          fi
          
          deactivate
          echo "âœ… åŒ…å®‰è£…æµ‹è¯•å®Œæˆ"

      - name: Deployment Status Summary
        run: |
          echo "ğŸš€ éƒ¨ç½²å°±ç»ªæ£€æŸ¥æ€»ç»“"
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
          echo "âœ… PyPIå‘å¸ƒéªŒè¯é€šè¿‡"
          echo "âœ… åŒ…æ„å»ºæˆåŠŸ"
          echo "âœ… åŒ…å®‰è£…æµ‹è¯•é€šè¿‡"
          echo "âœ… ä¸»åˆ†æ”¯æ¨é€"
          echo "ğŸ‰ SAGEå·²å‡†å¤‡å¥½éƒ¨ç½²åˆ°PyPI"      

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [build-sage, quick-check, examples-test, deployment-ready]

    steps:
      - name: Summary Report
        run: |
          echo "ğŸ å¼€å‘CIç®¡é“å®Œæˆ"
          echo "ğŸ“Š ä½œä¸šçŠ¶æ€:"
          echo "- Build: ${{ needs.build-sage.result }}"
          echo "- Quick Check: ${{ needs.quick-check.result }}"
          echo "- Examples: ${{ needs.examples-test.result }}"
          echo "- Deployment Ready: ${{ needs.deployment-ready.result }}"
          
          if [[ "${{ needs.build-sage.result }}" == "success" && "${{ needs.quick-check.result }}" == "success" ]]; then
            echo "âœ… æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ æ ¸å¿ƒåŠŸèƒ½å­˜åœ¨é—®é¢˜"
          fi
          
          if [[ "${{ needs.deployment-ready.result }}" == "success" ]]; then
            echo "ğŸš€ éƒ¨ç½²å‡†å¤‡å®Œæˆ"
          elif [[ "${{ needs.deployment-ready.result }}" == "skipped" ]]; then
            echo "â­ï¸ éƒ¨ç½²æ£€æŸ¥å·²è·³è¿‡ï¼ˆéä¸»åˆ†æ”¯æ¨é€ï¼‰"
          else
            echo "âŒ éƒ¨ç½²å‡†å¤‡å¤±è´¥"
          fi