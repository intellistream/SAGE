name: Development CI

on:
  push:
    branches: [ main-dev, refactor/* ]
  pull_request:
    branches: [ main-dev ]
  workflow_dispatch:

# ÂÖ¨ÂÖ±ÁéØÂ¢ÉÂèòÈáèÔºàÈÅøÂÖçÈáçÂ§çÂÆö‰πâÔºâ
env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com

jobs:
  test:
    name: Development Test
    runs-on: self-hosted
    timeout-minutes: 30  # ÂáèÂ∞ëË∂ÖÊó∂Êó∂Èó¥ÔºåÂºÄÂèëÁéØÂ¢ÉÂ∫îËØ•Êõ¥Âø´
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
        which python
        which pip
      timeout-minutes: 2
        
    - name: Setup pip and prepare environment
      run: |
        echo "üì¶ ÂáÜÂ§áPythonÁéØÂ¢É..."
        echo "üì¶ ÂçáÁ∫ßpip..."
        pip install --upgrade pip --no-cache-dir
        echo "üìä ÁéØÂ¢ÉÁä∂ÊÄÅ:"
        echo "- Python: $(python --version)"
        echo "- Pip: $(pip --version)" 
        echo "‚úÖ ÁéØÂ¢ÉÂáÜÂ§áÂÆåÊàê"
      timeout-minutes: 5
        
    - name: Cache System Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          /tmp/apt-cache
        key: ${{ runner.os }}-system-deps-${{ hashFiles('.github/workflows/dev-ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-system-deps-
          
    - name: Install System Dependencies
      run: |
        echo "üì¶ ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ..."
        
        # ÂàõÂª∫Áî®Êà∑ÂèØÂÜôÁöÑÁºìÂ≠òÁõÆÂΩï
        mkdir -p /tmp/apt-cache
        
        # Êõ¥Êñ∞ÂåÖÂàóË°®Ôºà‰ºòÂåñCIÊÄßËÉΩÔºâ
        echo "üì• Êõ¥Êñ∞ÂåÖÂàóË°®..."
        sudo apt-get update -qq
        
        # Ê£ÄÊü•ÂåÖÊòØÂê¶Â∑≤ÂÆâË£Ö
        missing_packages=""
        for pkg in build-essential cmake pkg-config; do
          if ! dpkg -l | grep -q "^ii.*$pkg "; then
            missing_packages="$missing_packages $pkg"
          fi
        done
        
        if [ -n "$missing_packages" ]; then
          echo "üì¶ ÂÆâË£ÖÁº∫Â§±ÁöÑÂåÖ:$missing_packages"
          sudo apt-get install -y $missing_packages
        else
          echo "‚úÖ ÊâÄÊúâÁ≥ªÁªü‰æùËµñÂ∑≤ÂÆâË£Ö"
        fi
      timeout-minutes: 10

    - name: Install SAGE (Test Mode)
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive
        PIP_NO_INPUT: 1
        PIP_DISABLE_PIP_VERSION_CHECK: 1
        # Âπ∂Ë°åÂÆâË£Ö‰ºòÂåñ
        PIP_PARALLEL_BUILDS: 4
        MAKEFLAGS: "-j4"
      run: |
        echo "üöÄ CIÊ®°ÂºèÔºöÈÄöËøáquickstart.sh --dev --pipÂÆâË£ÖSAGE"
        echo "‚ÑπÔ∏è ‰ΩøÁî®devÊ®°ÂºèÂåÖÂê´ÂÆåÊï¥ÂºÄÂèëÂ∑•ÂÖ∑ÂíåCLI"
        echo "‚è∞ È¢ÑËÆ°ÂÆâË£ÖÊó∂Èó¥: 8-15ÂàÜÈíü"
        
        # ÊòæÁ§∫ÁéØÂ¢É‰ø°ÊÅØ
        echo "üìä ÁéØÂ¢É‰ø°ÊÅØ:"
        echo "- Python: $(python --version)"
        echo "- PythonË∑ØÂæÑ: $(which python)"
        echo "- PipÁâàÊú¨: $(pip --version)"
        echo "- ÁΩëÁªúÁä∂ÊÄÅ: $(ping -c 1 pypi.org >/dev/null 2>&1 && echo "‚úÖ ÂèØËææ" || echo "‚ùå ‰∏çÂèØËææ")"
        
        echo "üéØ ÂºÄÂßãÈÄöËøáquickstart.sh devÊ®°ÂºèÂÆâË£Ö..."
        chmod +x ./quickstart.sh
        ./quickstart.sh --dev --pip --yes
        
        echo "‚úÖ quickstart.sh devÊ®°ÂºèÂÆâË£ÖÂÆåÊàê"
      timeout-minutes: 20
        
    - name: Basic Import Tests
      env:
        # PYTHONNOUSERSITE: 1  # Ê≥®ÈáäÊéâ‰ª•ÊèêÈ´òrunnerÊµãËØïÈÄüÂ∫¶
        PIP_NO_INPUT: 1
      run: |
        echo "=== Import Tests ==="
        python -c "import sage; print('‚úÖ SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('‚úÖ sage.common import successful')"
        python -c "import sage.kernel; print('‚úÖ sage.kernel import successful')"
        python -c "import sage.libs; print('‚úÖ sage.libs import successful')"
        python -c "import sage.middleware; print('‚úÖ sage.middleware import successful')"
        echo "=== CLI Test ==="
        # Ê£ÄÊü•sageÂëΩ‰ª§ÊòØÂê¶Âú®PATH‰∏≠
        if command -v sage >/dev/null 2>&1; then
          echo "‚úÖ SAGE CLI found in PATH"
          sage --help > /dev/null && echo "‚úÖ SAGE CLI help working"
          sage version && echo "‚úÖ SAGE version command working"
        else
          echo "‚ùå SAGE CLI not found in PATH"
          echo "Ê£ÄÊü•Â∑≤ÂÆâË£ÖÁöÑÂåÖÂíåÂÖ•Âè£ÁÇπ:"
          python -c "import pkg_resources; [print(f'Found sage entry point: {ep}') for ep in pkg_resources.iter_entry_points('console_scripts') if ep.name == 'sage']"
          echo "Ê£ÄÊü•pythonÊ®°ÂùóË∑ØÂæÑ:"
          python -c "import sys; print('\n'.join(sys.path))"
          echo "Â∞ùËØïÁõ¥Êé•ËøêË°åCLIÊ®°Âùó:"
          python -m sage.tools.cli.main --help && echo "‚úÖ CLI module works directly"
        fi

    - name: Extended Tests
      env:
        # PYTHONNOUSERSITE: 1  # Ê≥®ÈáäÊéâ‰ª•ÊèêÈ´òrunnerÊµãËØïÈÄüÂ∫¶
        PIP_NO_INPUT: 1
      run: |
        echo "=== Âü∫Á°ÄÊ®°ÂùóÂØºÂÖ•ÊµãËØï ==="
        
        # ÊµãËØïÂü∫Á°ÄÂØºÂÖ•
        python -c "import sage.common; print('‚úÖ sage.common ÂØºÂÖ•ÊàêÂäü')" || echo "‚ùå sage.common ÂØºÂÖ•Â§±Ë¥•"
        python -c "import sage.common.utils; print('‚úÖ sage.common.utils ÂØºÂÖ•ÊàêÂäü')" || echo "‚ùå sage.common.utils ÂØºÂÖ•Â§±Ë¥•"
        
        # ÊµãËØïÂèØÁî®ÁöÑÂäüËÉΩÊ®°Âùó
        echo "=== ÂäüËÉΩÊ®°ÂùóÊµãËØï ==="
        python -c "from sage.common.utils.logging.custom_logger import CustomLogger;  print('‚úÖ Logger working') "
        python -c "import sage.common.utils.system; print('‚úÖ System utils working')" || echo "‚ÑπÔ∏è System utils module structure different"
        
        # ÊµãËØïÂÖ∂‰ªñÂ∑≤ÂÆâË£ÖÁöÑÂåÖ
        python -c "import sage.kernel; print('‚úÖ sage.kernel ÂèØÁî®')" || echo "‚ÑπÔ∏è sage.kernel ‰∏çÂèØÁî®"
        python -c "import sage.middleware; print('‚úÖ sage.middleware ÂèØÁî®')" || echo "‚ÑπÔ∏è sage.middleware ‰∏çÂèØÁî®"
        python -c "import sage.libs; print('‚úÖ sage.libs ÂèØÁî®')" || echo "‚ÑπÔ∏è sage.libs ‰∏çÂèØÁî®"

    - name: Run Pytest Suite
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "=== Pytest ÊµãËØïÂ•ó‰ª∂ ==="
        
        # ÂÆâË£Ö pytest Áõ∏ÂÖ≥‰æùËµñ
        pip install pytest pytest-cov pytest-mock pytest-asyncio --no-cache-dir
        
        # Êü•ÊâæÂπ∂ËøêË°åÂèØÁî®ÁöÑÊµãËØï
        if [ -d "packages/sage-common/tests" ]; then
          echo "üß™ ËøêË°å sage-common ÊµãËØï..."
          python -m pytest packages/sage-common/tests/ -v --tb=short --timeout=60 || echo "‚ö†Ô∏è sage-common ÊµãËØïÊúâÈóÆÈ¢ò"
        fi
        
        if [ -d "tools/tests" ]; then
          echo "üß™ ËøêË°åÂ∑•ÂÖ∑ÊµãËØï..."
          python -m pytest tools/tests/ -v --tb=short --timeout=60 || echo "‚ö†Ô∏è Â∑•ÂÖ∑ÊµãËØïÊúâÈóÆÈ¢ò"
        fi
        
        # ËøêË°åÂø´ÈÄüÈõÜÊàêÊµãËØï
        echo "üîó ËøêË°åÈõÜÊàêÊµãËØï..."
        cd tools/tests
        if [ -f "test_issues_manager.sh" ]; then
          bash test_issues_manager.sh --quick || echo "‚ö†Ô∏è Issues manager ÊµãËØïÊúâÈóÆÈ¢ò"
        fi
        
        echo "‚úÖ Pytest ÊµãËØïÂ•ó‰ª∂ÂÆåÊàê"
      timeout-minutes: 10
        
    - name: Full System Test
      env:
        # PYTHONNOUSERSITE: 1  # Ê≥®ÈáäÊéâ‰ª•ÊèêÈ´òrunnerÊµãËØïÈÄüÂ∫¶
        PIP_NO_INPUT: 1
      run: |
        echo "=== Full Import Test ==="
        python -c "
        import sys
        print('Python executable:', sys.executable)
        print('Python version:', sys.version)
        
        # ÊµãËØïÂÆåÊï¥ÂØºÂÖ•
        try:
            import sage
            print('‚úÖ sage:', sage.__version__)
            
            # ÂØºÂÖ•ÂêÑ‰∏™Â≠êÊ®°ÂùóÔºà‰ΩøÁî®ÂÆπÈîôÊú∫Âà∂Ôºâ
            modules_status = []
            for module_name in ['common', 'kernel', 'libs', 'middleware']:
                try:
                    module = __import__(f'sage.{module_name}', fromlist=[module_name])
                    modules_status.append(f'‚úÖ sage.{module_name}')
                except ImportError as e:
                    modules_status.append(f'‚ö†Ô∏è  sage.{module_name} (Êú™ÂÆâË£ÖÊàñ‰∏çÂèØÁî®)')
            
            print('Ê®°ÂùóÁä∂ÊÄÅ:', ', '.join(modules_status))
            
            # ÊµãËØïCLIÂ∑•ÂÖ∑ - SAGE‰ΩøÁî®TyperÊ°ÜÊû∂ÔºåÂëΩ‰ª§ÁªìÊûÑ‰∏çÂêå
            import subprocess
            
            # ÂÖàÊµãËØïÂü∫Êú¨ÁöÑhelpÂëΩ‰ª§
            help_result = subprocess.run(['sage', '--help'], capture_output=True, text=True)
            if help_result.returncode != 0:
                print('‚ùå SAGE CLI not installed or not working')
                print('Error:', help_result.stderr)
            else:
                print('‚úÖ SAGE CLI installed and working')
                
                # ÊµãËØïversionÂ≠êÂëΩ‰ª§ÔºàÊ≥®ÊÑèÔºö‰∏çÊòØ--versionÈÄâÈ°πÔºâ
                version_result = subprocess.run(['sage', 'version'], capture_output=True, text=True)
                if version_result.returncode == 0:
                    print('‚úÖ SAGE version command successful:', version_result.stdout.strip())
                else:
                    print('‚ö†Ô∏è  SAGE version command failed:')
                    print('STDOUT:', version_result.stdout)
                    print('STDERR:', version_result.stderr)
                    
                    # Â∞ùËØïÂÖ∂‰ªñÁâàÊú¨Êü•ËØ¢ÊñπÂºè
                    print('‚ÑπÔ∏è  Ê≥®ÊÑè: SAGE‰ΩøÁî® sage version ÂëΩ‰ª§Ôºå‰∏çÊòØ sage --version ÈÄâÈ°π')
            
        except Exception as e:
            print('‚ùå Import test failed:', str(e))
            sys.exit(1)
        "
        
    - name: Run Basic Pytest Suite
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "üß™ Running development pytest suite..."
        
        # ÂÆâË£ÖÊµãËØï‰æùËµñ
        echo "üì¶ Installing test dependencies..."
        pip install pytest pytest-cov pytest-mock pytest-asyncio pytest-xdist pytest-timeout || echo "‚ö†Ô∏è Some test dependencies failed to install"
        
        # ËøêË°åIssues ManagerÊµãËØï
        echo "üîß Testing issues manager..."
        cd tools/tests
        if [ -f test_issues_manager.sh ]; then
          bash test_issues_manager.sh --quick || echo "‚ö†Ô∏è Issues manager tests had issues"
          echo "‚úÖ Issues manager tests completed"
        else
          echo "‚ÑπÔ∏è Issues manager test script not found"
        fi
        cd ../..
        
        # ËøêË°åÂø´ÈÄüpytestÊµãËØï
        echo "üî¨ Running quick pytest suite..."
        cd tools/tests
        if [ -f run_tests.py ]; then
          echo "üß™ Running Development Tests:"
          # ‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏ÄÊµãËØïÂëΩ‰ª§
          if command -v sage >/dev/null 2>&1; then
            echo "üìã Running unit tests..."
            sage dev test --test-type unit --verbose || echo "‚ö†Ô∏è Some unit tests didn't pass"
            echo "üìã Running integration tests..."
            sage dev test --test-type integration --verbose || echo "‚ö†Ô∏è Some integration tests didn't pass"
          else
            echo "‚ùå SAGE CLI not available, running direct pytest..."
            python run_tests.py --test-mode quick || echo "‚ö†Ô∏è Direct pytest had issues"
          fi
          if [ -f dev_test_report.txt ]; then
            echo "üìä Quick Test Summary:"
            tail -10 dev_test_report.txt
          fi
        else
          echo "‚ÑπÔ∏è Test runner not found, running direct pytest..."
          # Áõ¥Êé•ËøêË°åpytestÂú®packagesÁõÆÂΩï
          cd ../../packages
          for package in sage-common sage-kernel sage-libs sage-middleware; do
            if [ -d "$package/tests" ]; then
              echo "üß™ Testing $package..."
              cd "$package"
              python -m pytest tests/ -v --tb=short -x --timeout=30 2>/dev/null || echo "‚ö†Ô∏è $package tests had issues"
              cd ..
            else
              echo "‚ÑπÔ∏è No tests directory in $package"
            fi
          done
        fi
        
        echo "‚úÖ Development test suite completed"
