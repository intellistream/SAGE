name: "CI"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified-prod

jobs:
  build-and-test:
    name: Build and Test SAGE
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          echo "🔧 系统依赖将由quickstart.sh统一管理..."
          echo "跳过单独的系统依赖安装步骤"

      - name: Initialize Submodules
        run: |
          echo "🔁 初始化子模块（C++扩展依赖）..."
          git submodule update --init --recursive
          echo "✅ 子模块初始化完成"
          
          # 验证关键子模块
          echo "🔍 验证关键子模块："
          if [ -d "packages/sage-middleware/src/sage/middleware/components/sage_db" ]; then
            echo "✅ sage_db 子模块存在"
            ls -la packages/sage-middleware/src/sage/middleware/components/sage_db/ | head -10
          else
            echo "❌ sage_db 子模块缺失"
          fi
          
          if [ -d "packages/sage-middleware/src/sage/middleware/components/sage_flow" ]; then
            echo "✅ sage_flow 子模块存在"
            ls -la packages/sage-middleware/src/sage/middleware/components/sage_flow/ | head -10
          else
            echo "❌ sage_flow 子模块缺失"
          fi

      - name: Install SAGE
        run: |
          echo "🚀 安装SAGE生产版本（标准模式，包含C++扩展）..."
          chmod +x ./quickstart.sh
          ./quickstart.sh --standard --pip --yes
        timeout-minutes: 25

      - name: Verify C++ Extensions
        run: |
          echo "🧩 验证C++扩展安装状态..."
          
          # 检查.so文件
          echo "📁 检查编译文件:"
          if find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f | grep -q "\.so"; then
            echo "✅ 找到C++扩展文件:"
            find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f
          else
            echo "❌ 未找到.so文件"
          fi
          
          # 检查扩展功能可用性
          echo "🔍 检查扩展功能:"
          python -c "
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'🧩 扩展可用性: {total}/{len(available)}')
              for ext, status in available.items():
                  print(f'  {ext}: {\"✅\" if status else \"❌\"}')
              
              if total > 0:
                  print(f'✅ {total}个扩展可用，继续测试')
              else:
                  print('⚠️ 暂无可用扩展，但不影响基础功能测试')
          except ImportError as e:
              print(f'⚠️ 扩展检查模块不可用: {e}')
          "

      - name: Verify Installation
        run: |
          echo "✅ 验证SAGE安装..."
          python -c "import sage; print('✅ SAGE imported')"
          python -c "import sage.common; print('✅ sage.common imported')"
          
          # 验证扩展状态
          python -c "
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'🧩 扩展可用性: {total}/{len(available)}')
          except ImportError:
              print('⚠️ 扩展兼容性模块不可用，跳过检查')
          "

      - name: Run Core Tests
        run: |
          echo "🧪 运行核心测试..."
          python -c "import sage; import sage.common; print('✅ 核心导入测试通过')"
          
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "✅ CLI测试通过"
          fi

      - name: Run Examples Smoke Test
        run: |
          echo "🌟 运行Examples冒烟测试..."
          # 安装测试所需的dev依赖（包含pytest）
          pip install -e packages/sage-tools[dev]
          
          # 运行快速冒烟测试（5分钟超时）
          if [ -f "./tools/tests/run_examples_tests.sh" ]; then
            chmod +x ./tools/tests/run_examples_tests.sh
            timeout 300s ./tools/tests/run_examples_tests.sh --quick || {
              echo "⚠️ Examples测试超时或失败，但不阻断主要流程"
              exit 0
            }
          else
            echo "ℹ️ Examples测试脚本不存在，跳过"
          fi