# ==========================================
# SAGE æŒç»­é›†æˆ/æŒç»­éƒ¨ç½² (CI/CD) å·¥ä½œæµ
# ==========================================
# ç›®çš„ï¼šéªŒè¯ä»£ç è´¨é‡ã€è¿è¡Œæµ‹è¯•å¥—ä»¶ã€ç¡®ä¿ä»£ç å¯æ­£å¸¸å®‰è£…å’Œè¿è¡Œ
# 
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€åˆ° main-dev åˆ†æ”¯ï¼ˆå¼€å‘åˆ†æ”¯ï¼‰
# - æ¨é€åˆ° refactor/* åˆ†æ”¯ï¼ˆé‡æ„åˆ†æ”¯ï¼‰  
# - åˆ›å»ºåˆ° main åˆ†æ”¯çš„ Pull Request
# - æ‰‹åŠ¨è§¦å‘
#
# ä¸ build-release.yml çš„åŒºåˆ«ï¼š
# - æ­¤å·¥ä½œæµä¸“æ³¨äº**æµ‹è¯•å’ŒéªŒè¯**
# - ä½¿ç”¨å¼€å‘æ¨¡å¼å®‰è£… (pip install -e)
# - ä¸æ„å»ºç”Ÿäº§ç¯å¢ƒçš„ wheel åŒ…
# - ä¸å‘å¸ƒåˆ° PyPI
# ==========================================

name: SAGE CI/CD

on:
  push:
    branches: [ main-dev, refactor/* ]
  pull_request:
    branches: [ main ]  # åªåœ¨PRåˆ°mainåˆ†æ”¯æ—¶è¿è¡ŒCI
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # =================
  # ä¸»è¦æµ‹è¯•ä»»åŠ¡
  # =================
  # åŠŸèƒ½ï¼šå®‰è£… SAGE å¹¶è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
  # ç¯å¢ƒï¼šUbuntu Latest + Python 3.x
  # ç‰¹ç‚¹ï¼šä½¿ç”¨å¼€å‘æ¨¡å¼å®‰è£…ï¼Œè¿è¡Œ pytest æµ‹è¯•
  test:
    name: Test & Build
    runs-on: ubuntu-latest  # ä½¿ç”¨ ubuntu-latest runner
    timeout-minutes: 60     # æ€»ä½“è¶…æ—¶æ—¶é—´
    
    env:
      CI: true          # æ ‡è¯†è¿™æ˜¯CIç¯å¢ƒ
      # å„ç§AIæœåŠ¡çš„APIå¯†é’¥ï¼ˆç”¨äºæµ‹è¯•å¤–éƒ¨æœåŠ¡é›†æˆï¼‰
      HF_TOKEN: ${{ secrets.HF_TOKEN }}                       # HuggingFace API Token
      SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }} # ç¡…äº‘APIå¯†é’¥
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}           # OpenAI APIå¯†é’¥
      JINA_API_KEY: ${{ secrets.JINA_API_KEY }}               # Jina AI APIå¯†é’¥
      ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}         # é˜¿é‡Œäº‘APIå¯†é’¥
      VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}               # vLLM APIå¯†é’¥
      HF_ENDPOINT: https://hf-mirror.com                       # HuggingFaceé•œåƒç«¯ç‚¹
    
    steps:
    # é…ç½® Git å’Œè®¤è¯
    - name: Configure Git and Authentication
      run: |
        git config --global http.version HTTP/1.1
        git config --global http.postBuffer 1048576000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global core.compression 0
        echo "Git configuration completed"
        
    # é…ç½® GitHub è®¤è¯ (è§£å†³ç§æœ‰ä»“åº“è®¿é—®é—®é¢˜)
    - name: Setup GitHub Authentication
      run: |
        echo "Setting up GitHub authentication for private repo access..."
        git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        
    # ä½¿ç”¨ token è¿›è¡Œ checkout (è§£å†³ç§æœ‰ä»“åº“è®¿é—®é—®é¢˜)
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    # è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
      timeout-minutes: 5
      
    # è®¾ç½® Miniconda (install.py éœ€è¦condaå¯ç”¨)
    - name: Setup Miniconda for install.py
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
        use-mamba: true
        auto-activate-base: false
      timeout-minutes: 10
        
    # å®‰è£…ç³»ç»Ÿä¾èµ– (ä½¿ç”¨æœ¬åœ°ç¼“å­˜)
    - name: Install System Dependencies
      run: |
        # åªåœ¨éœ€è¦æ—¶æ›´æ–°åŒ…åˆ—è¡¨
        if [ ! -f /tmp/apt_updated_today ]; then
          sudo apt-get update
          touch /tmp/apt_updated_today
        fi
        sudo apt-get install -y build-essential cmake pkg-config
      timeout-minutes: 10
        
    # å®‰è£… SAGE (ä½¿ç”¨æ­£ç¡®çš„å­åŒ…å®‰è£…é¡ºåº) - ä¸“ä¸ºCIè®¾è®¡
    - name: Install SAGE (Step by Step)
      shell: bash -l {0}
      env:
        CI: true
        PIP_CACHE_DIR: /tmp/pip-cache
      run: |
        echo "Installing SAGE packages in correct order for CI..."
        echo "Step 1: Install sage-common (base utilities)"
        pip install -e packages/sage-common
        
        echo "Step 2: Install sage-kernel (core computation)"
        pip install -e packages/sage-kernel
        
        echo "Step 3: Install sage-middleware (API services)"
        pip install -e packages/sage-middleware
        
        echo "Step 4: Install sage-libs (applications and examples)"
        pip install -e packages/sage-libs
        
        echo "Step 5: Install main SAGE package (includes sage module)"
        pip install -e .
        
        echo "âœ… SAGE installation completed"
        python -c "import sage; print(f'SAGE v{sage.__version__} installed successfully')"
      timeout-minutes: 15
        
    # å®‰è£…æµ‹è¯•ä¾èµ–
    - name: Install Test Dependencies
      run: |
        pip install pytest pytest-timeout pytest-cov
      timeout-minutes: 5
      
    # è°ƒè¯•ç¯å¢ƒå˜é‡ (å‚è€ƒ lighter_test.yml)
    - name: Debug environment variables
      run: |
        env | grep -E 'CI|HF_TOKEN|SILICONCLOUD_API_KEY|OPENAI_API_KEY|JINA_API_KEY|ALIBABA_API_KEY|VLLM_API_KEY'
        
    # è¿è¡ŒåŸºç¡€æµ‹è¯• (ä½¿ç”¨ minimal å®‰è£…çš„åŠŸèƒ½)
    - name: Basic Import Tests
      run: |
        echo "=== Python Path Debug ==="
        python -c "import sys; print('\\n'.join(sys.path))"
        echo "=== Installed Packages ==="
        pip list | grep -i sage
        echo "=== Import Tests ==="
        python -c "import sage; print('âœ… SAGE core import successful')"
        python -c "import sage.utils; print('âœ… SAGE utils import successful')" || echo "âš ï¸ sage.utils import failed (may be expected)"
        python -c "from sage.utils.queue_adapter import get_queue_backend_info; print('âœ… Queue adapter import successful')" || echo "âš ï¸ Queue adapter import failed (may be expected)"
        
    # è¿è¡Œ pytest (minimal æ¨¡å¼çš„æµ‹è¯•)
    - name: Run Test Suite (Minimal Mode)
      run: |
        echo "Running tests for minimal installation..."
        echo "Debug API Key: $ALIBABA_API_KEY"
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        export PYTHONWARNINGS="ignore:DeprecationWarning"
        
        # è¿è¡Œæ‰€æœ‰sageæ–‡ä»¶å¤¹ä¸‹çš„æµ‹è¯•ï¼Œæ’é™¤ä¾èµ–C++æ‰©å±•çš„æµ‹è¯•
        pytest -v sage
      timeout-minutes: 20
        
  # ======================
  # Docker é›†æˆæµ‹è¯•æé†’ä»»åŠ¡ 
  # ======================
  # åŠŸèƒ½ï¼šæé†’å¼€å‘è€…è¿›è¡Œ Docker ç¯å¢ƒä¸‹çš„å®Œæ•´æµ‹è¯•
  # åŸå› ï¼šCI ç¯å¢ƒæ— æ³•æµ‹è¯• C++ æ‰©å±•ç»„ä»¶ (sage_db, sage_queue)
  # è¿è¡Œå™¨ï¼šself-hosted (éœ€è¦ Docker æ”¯æŒ)
  docker-integration-reminder:
    name: Docker Integration Test Reminder
    runs-on: self-hosted
    timeout-minutes: 5
    
    steps:
    - name: Docker Integration Test Instructions
      run: |
        echo "=========================================="
        echo "ğŸ³ DOCKER INTEGRATION TESTING REQUIRED"
        echo "=========================================="
        echo ""
        echo "âš ï¸  This CI only tests core Python functionality."
        echo "âš ï¸  C++ extensions (sage_db, sage_queue) require Docker testing."
        echo ""
        echo "To run full integration tests locally:"
        echo ""
        echo "1. Build and test sage_db:"
        echo "   cd sage_ext/sage_db && ./build.sh clean"
        echo ""
        echo "2. Build and test sage_queue:"
        echo "   cd sage_ext/sage_queue && ./build.sh clean"
        echo ""
        echo "3. Run full Docker integration test:"
        echo "   python install.py --full"
        echo ""
        echo "4. Run comprehensive test suite:"
        echo "   python -m pytest tests/ --full-integration"
        echo ""
        echo "ğŸ“‹ Required before merging:"
        echo "   âœ… All C++ extensions build successfully"
        echo "   âœ… Docker integration tests pass"
        echo "   âœ… Full test suite passes with C++ backends"
        echo ""
        echo "=========================================="
        
  # ================
  # ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
  # ================
  # åŠŸèƒ½ï¼šè¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ã€ç±»å‹æ£€æŸ¥ç­‰è´¨é‡å·¥å…·
  # è¿è¡Œå™¨ï¼šself-hosted (æ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦)
  lint:
    name: Code Quality
    runs-on: self-hosted  # ä½¿ç”¨ self-hosted runner
    timeout-minutes: 15
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
      timeout-minutes: 5
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
      timeout-minutes: 3
        
    - name: Install Linting Tools
      run: |
        pip install flake8 black isort
      timeout-minutes: 5
        
    - name: Run Code Quality Checks
      run: |
        echo "Checking code formatting..."
        black --check --diff sage/ || echo "âŒ Code formatting issues found"
        echo "Checking import sorting..."
        isort --check-only --diff sage/ || echo "âŒ Import sorting issues found"
        echo "Running linter..."
        flake8 sage/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âŒ Critical linting errors found"
      timeout-minutes: 5
