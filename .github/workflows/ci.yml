name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€PRåªè¿è¡Œæœ€æ–°çš„CIï¼Œå–æ¶ˆä¹‹å‰çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # å…¬å…±ç¯å¢ƒå˜é‡
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com

jobs:
  # å¿«é€Ÿæ£€æŸ¥ï¼šä»£ç è´¨é‡å’ŒåŸºç¡€æµ‹è¯•
  quick-check:
    name: Quick Check
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 5
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
      timeout-minutes: 5
      
    - name: Install Basic Dependencies
      run: |
        pip install --upgrade pip
        pip install flake8 black isort
        pip install -e packages/sage-common/ --no-deps
      timeout-minutes: 8
        
    - name: Code Quality Checks
      run: |
        echo "ğŸ” Running code quality checks..."
        black --check --diff packages/ || echo "âš ï¸ Code formatting issues found"
        isort --check-only --diff packages/ || echo "âš ï¸ Import sorting issues found"
        flake8 packages/ --count --select=E9,F63,F7,F82 --show-source --statistics
      timeout-minutes: 2
        
    - name: Basic Import Tests
      run: |
        echo "ğŸ§ª Testing basic imports..."
        python -c "import sage_common; print('âœ… sage-common import successful')"
      timeout-minutes: 2

  # å®Œæ•´æµ‹è¯•ï¼ˆä»…åœ¨å¿«é€Ÿæ£€æŸ¥é€šè¿‡åè¿è¡Œï¼‰
  full-test:
    name: Full Test Suite
    runs-on: self-hosted
    needs: quick-check
    timeout-minutes: 60
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
      timeout-minutes: 5
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
        use-mamba: true
        auto-activate-base: false
      timeout-minutes: 10
        
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
      timeout-minutes: 10
        
    - name: Install SAGE (Minimal Mode)
      run: |
        chmod +x quickstart.sh
        ./quickstart.sh --minimal
      timeout-minutes: 25
        
    - name: Run Test Suite
      run: |
        echo "ğŸ§ª Running minimal test suite..."
        python -c "import sage; print('âœ… SAGE import successful, version:', sage.__version__)"
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šæµ‹è¯•
      timeout-minutes: 10

  # æé†’ä¿¡æ¯ï¼ˆæ€»æ˜¯è¿è¡Œï¼‰
  info:
    name: Additional Tests Info
    runs-on: self-hosted
    if: always()
    
    steps:
    - name: Docker Integration Test Instructions
      run: |
        echo "=========================================="
        echo "ğŸ“‹ Additional Manual Tests Required:"
        echo ""
        echo "1. Docker Integration Test:"
        echo "   cd /home/shuhao/SAGE"
        echo "   docker build -t sage-test ."
        echo "   docker run --rm sage-test"
        echo ""
        echo "2. Full Installation Test:"
        echo "   ./quickstart.sh --standard"
        echo ""
        echo "ğŸ“‹ Required before merging:"
        echo "   âœ… Docker integration tests pass"
        echo "   âœ… Full installation works correctly"
        echo "=========================================="
