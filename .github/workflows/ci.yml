name: "CI"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified-prod

jobs:
  build-and-test:
    name: Build and Test SAGE
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true
          submodules: 'recursive'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Create .env File from Secrets
        run: |
          echo "ğŸ” ä» GitHub Secrets åˆ›å»º .env æ–‡ä»¶..."
          cat > .env << EOF
          # CI Environment Configuration (Auto-generated from GitHub Secrets)
          # This file is created during CI/CD and should not be committed to git
          
          # ==================================================
          # LLM Service API Keys
          # ==================================================
          
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
          OPENAI_MODEL_NAME=qwen-turbo-2025-02-11
          
          SILICONCLOUD_API_KEY=${{ secrets.SILICONCLOUD_API_KEY }}
          JINA_API_KEY=${{ secrets.JINA_API_KEY }}
          ALIBABA_API_KEY=${{ secrets.ALIBABA_API_KEY }}
          
          # vLLM configuration for local/self-hosted services
          VLLM_API_KEY=${{ secrets.VLLM_API_KEY }}
          VLLM_BASE_URL=http://localhost:8000/v1
          VLLM_MODEL_NAME=meta-llama/Llama-2-13b-chat-hf
          
          WEB_SEARCH_API_KEY=${{ secrets.WEB_SEARCH_API_KEY }}
          
          # ==================================================
          # GitHub Token for Repository Access
          # ==================================================
          
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}
          
          # ==================================================
          # Hugging Face Configuration
          # ==================================================
          
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          HF_ENDPOINT=https://hf-mirror.com
          
          # ==================================================
          # CI/CD Settings
          # ==================================================
          
          SAGE_DEBUG=false
          SAGE_SKIP_CPP_EXTENSIONS=false
          SAGE_LOG_LEVEL=INFO
          SAGE_TEST_MODE=true
          SAGE_EXAMPLES_MODE=test
          EOF
          
          echo "âœ… .env æ–‡ä»¶åˆ›å»ºå®Œæˆ"
          echo "ğŸ“‹ éªŒè¯ .env æ–‡ä»¶å†…å®¹ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰:"
          cat .env | grep -E "^[A-Z_]+=.+" | sed 's/=.*/=***/' || echo "âš ï¸ .env æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®"

      - name: Install System Dependencies
        run: |
          echo "ğŸ”§ å®‰è£…C++æ‰©å±•æ„å»ºæ‰€éœ€çš„ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libopenblas-dev \
            liblapack-dev \
            git
          
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
          echo "ğŸ“‹ éªŒè¯å…³é”®å·¥å…·ï¼š"
          gcc --version | head -1
          g++ --version | head -1
          cmake --version | head -1
          make --version | head -1

      - name: Verify Submodules
        run: |
          echo "ï¿½ éªŒè¯Gitå­æ¨¡å—..."
          git submodule status
          
          # éªŒè¯å…³é”®å­æ¨¡å—
          echo ""
          echo "ï¿½ éªŒè¯å…³é”®å­æ¨¡å—ç›®å½•ï¼š"
          for submodule in \
            "packages/sage-middleware/src/sage/middleware/components/sage_db/sageDB" \
            "packages/sage-middleware/src/sage/middleware/components/sage_flow/sageFlow" \
            "packages/sage-middleware/src/sage/middleware/components/sage_tsdb/sageTSDB"; do
            if [ -d "$submodule" ]; then
              echo "âœ… $submodule å­˜åœ¨"
              ls -la "$submodule" | head -5
            else
              echo "âŒ $submodule ç¼ºå¤±"
            fi
            echo ""
          done

      - name: Install SAGE
        run: |
          echo "ğŸš€ å®‰è£…SAGEï¼ˆæ ‡å‡†æ¨¡å¼ï¼ŒåŒ…å«C++æ‰©å±•ï¼‰..."
          echo "ğŸ“ ç¯å¢ƒå˜é‡è®¾ç½®ï¼š"
          echo "  CI=true"
          echo "  PATH=$PATH"
          
          # ç¡®ä¿PATHåŒ…å«ç”¨æˆ·å®‰è£…çš„è„šæœ¬
          export PATH="$HOME/.local/bin:$PATH"
          
          chmod +x ./quickstart.sh
          
          # åœ¨CIç¯å¢ƒä¸­ï¼Œquickstart.shä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ç³»ç»Ÿä¾èµ–
          # ç„¶åè°ƒç”¨ 'sage extensions install all' æ¥æ„å»ºC++æ‰©å±•
          echo ""
          echo "å¼€å§‹å®‰è£…ï¼ˆå°†æ„å»ºC++æ‰©å±•ï¼‰..."
          ./quickstart.sh --standard --pip --yes
          
          echo ""
          echo "âœ… å®‰è£…è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "ğŸ“‹ æ£€æŸ¥å®‰è£…æ—¥å¿—ä¸­çš„æ‰©å±•æ„å»ºä¿¡æ¯ï¼š"
          if [ -f "install.log" ]; then
            echo "æŸ¥æ‰¾C++æ‰©å±•æ„å»ºç›¸å…³æ—¥å¿—..."
            grep -A 5 "å®‰è£…C++æ‰©å±•" install.log || echo "æœªæ‰¾åˆ°æ‰©å±•æ„å»ºæ—¥å¿—"
            echo ""
            grep -A 5 "extensions install" install.log || echo "æœªæ‰¾åˆ°extensions installå‘½ä»¤æ—¥å¿—"
          fi
        timeout-minutes: 25

      - name: Verify C++ Extensions
        run: |
          echo "ğŸ§© éªŒè¯C++æ‰©å±•å®‰è£…çŠ¶æ€..."
          
          # æ£€æŸ¥å­æ¨¡å—ç›®å½•ç»“æ„
          echo ""
          echo "ï¿½ æ£€æŸ¥å­æ¨¡å—ç›®å½•ç»“æ„ï¼š"
          for component in sage_db sage_flow; do
            component_dir="packages/sage-middleware/src/sage/middleware/components/${component}"
            if [ -d "$component_dir" ]; then
              echo "âœ… $component ç›®å½•å­˜åœ¨"
              # æ£€æŸ¥æ˜¯å¦æœ‰å­æ¨¡å—ç›®å½•
              if [ "$component" = "sage_db" ] && [ -d "${component_dir}/sageDB" ]; then
                echo "  âœ… sageDB å­æ¨¡å—å·²åˆå§‹åŒ–"
                ls -la "${component_dir}/sageDB" | head -5
              elif [ "$component" = "sage_flow" ] && [ -d "${component_dir}/sageFlow" ]; then
                echo "  âœ… sageFlow å­æ¨¡å—å·²åˆå§‹åŒ–"
                ls -la "${component_dir}/sageFlow" | head -5
              else
                echo "  âŒ å­æ¨¡å—ç›®å½•æœªæ‰¾åˆ°"
              fi
            else
              echo "âŒ $component ç›®å½•ä¸å­˜åœ¨"
            fi
          done
          
          # æ£€æŸ¥.soæ–‡ä»¶
          echo ""
          echo "ğŸ“ æ£€æŸ¥å·²ç¼–è¯‘çš„.soæ–‡ä»¶:"
          so_files=$(find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f 2>/dev/null || true)
          if [ -n "$so_files" ]; then
            echo "âœ… æ‰¾åˆ°C++æ‰©å±•æ–‡ä»¶:"
            echo "$so_files"
            
            # æ£€æŸ¥æ¯ä¸ª.soæ–‡ä»¶çš„ä¾èµ–
            echo ""
            echo "ğŸ”— æ£€æŸ¥.soæ–‡ä»¶ä¾èµ–:"
            for so in $so_files; do
              echo "  æ–‡ä»¶: $so"
              ldd "$so" 2>&1 | head -10 || echo "    æ— æ³•æ£€æŸ¥ä¾èµ–"
            done
          else
            echo "âŒ æœªæ‰¾åˆ°.soæ–‡ä»¶"
            echo "ğŸ” å¯èƒ½çš„æ„å»ºæ—¥å¿—ä½ç½®ï¼š"
            find . -name "CMakeError.log" -o -name "make_output.log" 2>/dev/null | head -5 || true
          fi
          
          # æ£€æŸ¥æ‰©å±•åŠŸèƒ½å¯ç”¨æ€§
          echo ""
          echo "ğŸ” æµ‹è¯•æ‰©å±•Pythonå¯¼å…¥:"
          python -c "
          import sys
          print(f'Python ç‰ˆæœ¬: {sys.version}')
          print(f'Python è·¯å¾„: {sys.executable}')
          print()
          
          # å°è¯•å¯¼å…¥æ‰©å±•
          extensions_status = {}
          
          # æµ‹è¯• sage_db
          try:
              from sage.middleware.components.sage_db.python import sage_db
              print('âœ… sage_db Python wrapper å¯¼å…¥æˆåŠŸ')
              try:
                  from sage.middleware.components.sage_db.python import _sage_db
                  print('âœ… _sage_db C++ extension å¯¼å…¥æˆåŠŸ')
                  extensions_status['sage_db'] = True
              except ImportError as e:
                  print(f'âŒ _sage_db C++ extension å¯¼å…¥å¤±è´¥: {e}')
                  extensions_status['sage_db'] = False
          except Exception as e:
              print(f'âŒ sage_db å¯¼å…¥å¤±è´¥: {e}')
              extensions_status['sage_db'] = False
          
          print()
          
          # æµ‹è¯• sage_flow
          try:
              from sage.middleware.components.sage_flow.python import sage_flow
              print('âœ… sage_flow Python wrapper å¯¼å…¥æˆåŠŸ')
              try:
                  from sage.middleware.components.sage_flow.python import _sage_flow
                  print('âœ… _sage_flow C++ extension å¯¼å…¥æˆåŠŸ')
                  extensions_status['sage_flow'] = True
              except ImportError as e:
                  print(f'âŒ _sage_flow C++ extension å¯¼å…¥å¤±è´¥: {e}')
                  extensions_status['sage_flow'] = False
          except Exception as e:
              print(f'âŒ sage_flow å¯¼å…¥å¤±è´¥: {e}')
              extensions_status['sage_flow'] = False
          
          print()
          
          # ä½¿ç”¨å…¼å®¹æ€§æ£€æŸ¥
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§æ€»ç»“: {total}/{len(available)}')
              for ext, status in available.items():
                  symbol = 'âœ…' if status else 'âŒ'
                  print(f'  {symbol} {ext}: {\"å¯ç”¨\" if status else \"ä¸å¯ç”¨\"}')
              
              if total == 0:
                  print()
                  print('âš ï¸ è­¦å‘Š: æ²¡æœ‰C++æ‰©å±•å¯ç”¨')
                  print('è¿™å°†å¯¼è‡´æŸäº›æµ‹è¯•å¤±è´¥')
                  sys.exit(1)
              else:
                  print()
                  print(f'âœ… {total}ä¸ªæ‰©å±•å¯ç”¨ï¼Œç»§ç»­æµ‹è¯•')
          except ImportError as e:
              print(f'âŒ æ‰©å±•æ£€æŸ¥æ¨¡å—ä¸å¯ç”¨: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"
          
          # éªŒè¯æ‰©å±•çŠ¶æ€
          python -c "
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§: {total}/{len(available)}')
          except ImportError:
              print('âš ï¸ æ‰©å±•å…¼å®¹æ€§æ¨¡å—ä¸å¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥')
          "

      - name: Run Architecture Compliance Check
        run: |
          echo "ğŸ—ï¸ è¿è¡Œæ¶æ„åˆè§„æ€§æ£€æŸ¥..."
          
          # åœ¨ PR ä¸­ä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ“ PR æ¨¡å¼ï¼šæ£€æŸ¥å˜æ›´æ–‡ä»¶"
            python tools/architecture_checker.py \
              --changed-only \
              --diff "origin/${{ github.base_ref }}" \
              --strict || {
                echo ""
                echo "âŒ æ¶æ„åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼"
                echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
                echo "æ–‡æ¡£: docs/PACKAGE_ARCHITECTURE.md"
                exit 1
              }
          else
            echo "ğŸ“¦ Push æ¨¡å¼ï¼šå¿«é€Ÿæ£€æŸ¥ï¼ˆä»…æ‰«æå¯¼å…¥è¯­å¥ï¼‰"
            # åœ¨ push æ—¶åšå¿«é€Ÿæ£€æŸ¥ï¼Œé¿å…é˜»å¡
            python tools/architecture_checker.py --changed-only --diff HEAD~5 || {
              echo ""
              echo "âš ï¸  å‘ç°æ¶æ„é—®é¢˜ï¼Œä½†ä¸é˜»å¡ CI"
              echo "è¯·å°½å¿«ä¿®å¤: docs/PACKAGE_ARCHITECTURE.md"
            }
          fi
          
          echo ""
          echo "âœ… æ¶æ„æ£€æŸ¥å®Œæˆ"

      - name: Run Core Tests
        run: |
          echo "ğŸ§ª è¿è¡Œæ ¸å¿ƒæµ‹è¯•..."
          python -c "import sage; import sage.common; print('âœ… æ ¸å¿ƒå¯¼å…¥æµ‹è¯•é€šè¿‡')"
          
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… CLIæµ‹è¯•é€šè¿‡"
          fi

      - name: Run Unit Tests with Coverage
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡..."
          # å®‰è£…æµ‹è¯•ä¾èµ–
          pip install pytest pytest-cov pytest-timeout
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
          pytest -v \
            --cov=packages \
            --cov-report=xml:coverage.xml \
            --cov-report=term \
            --cov-report=html:htmlcov \
            --timeout=300 \
            -m "not slow" || {
              echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ”¶é›†è¦†ç›–ç‡æ•°æ®"
              exit 0
            }

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-sage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Run Examples Smoke Test
        run: |
          echo "ğŸŒŸ è¿è¡ŒExampleså†’çƒŸæµ‹è¯•..."
          # å®‰è£…æµ‹è¯•æ‰€éœ€çš„devä¾èµ–ï¼ˆåŒ…å«pytestï¼‰
          pip install -e packages/sage-tools[dev]
          
          # è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰
          if [ -f "./tools/tests/run_examples_tests.sh" ]; then
            chmod +x ./tools/tests/run_examples_tests.sh
            timeout 300s ./tools/tests/run_examples_tests.sh --quick || {
              echo "âš ï¸ Examplesæµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥ï¼Œä½†ä¸é˜»æ–­ä¸»è¦æµç¨‹"
              exit 0
            }
          else
            echo "â„¹ï¸ Examplesæµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi