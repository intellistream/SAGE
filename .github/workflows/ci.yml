name: "CI"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified-prod

jobs:
  build-and-test:
    name: Build and Test SAGE
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          echo "ğŸ”§ ç³»ç»Ÿä¾èµ–å°†ç”±quickstart.shç»Ÿä¸€ç®¡ç†..."
          echo "è·³è¿‡å•ç‹¬çš„ç³»ç»Ÿä¾èµ–å®‰è£…æ­¥éª¤"

      - name: Install SAGE
        run: |
          echo "ğŸš€ å®‰è£…SAGEç”Ÿäº§ç‰ˆæœ¬ï¼ˆæ ‡å‡†æ¨¡å¼ï¼ŒåŒ…å«C++æ‰©å±•ï¼‰..."
          chmod +x ./quickstart.sh
          ./quickstart.sh --standard --pip --yes
        timeout-minutes: 25

      - name: Verify C++ Extensions
        run: |
          echo "éªŒè¯C++æ‰©å±•å®‰è£…..."
          
          # éªŒè¯æ„å»ºç»“æœ
          if find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f | grep -q "\.so"; then
            echo "âœ… æ‰¾åˆ°C++æ‰©å±•æ–‡ä»¶:"
            find packages/sage-middleware/src/sage/middleware/components/ -name "*.so" -type f
          else
            echo "âŒ æœªæ‰¾åˆ°.soæ–‡ä»¶ï¼Œæ‰©å±•å¯èƒ½æœªæ­£ç¡®æ„å»º"
          fi

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"
          
          # éªŒè¯æ‰©å±•çŠ¶æ€
          python -c "
          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§: {total}/{len(available)}')
          except ImportError:
              print('âš ï¸ æ‰©å±•å…¼å®¹æ€§æ¨¡å—ä¸å¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥')
          "

      - name: Run Core Tests
        run: |
          echo "ğŸ§ª è¿è¡Œæ ¸å¿ƒæµ‹è¯•..."
          python -c "import sage; import sage.common; print('âœ… æ ¸å¿ƒå¯¼å…¥æµ‹è¯•é€šè¿‡')"
          
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… CLIæµ‹è¯•é€šè¿‡"
          fi

      - name: Run Examples Smoke Test
        run: |
          echo "ğŸŒŸ è¿è¡ŒExampleså†’çƒŸæµ‹è¯•..."
          pip install -e packages/sage-tools[cli]
          
          # è¿è¡Œå¿«é€Ÿå†’çƒŸæµ‹è¯•ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰
          if [ -f "./tools/tests/run_examples_tests.sh" ]; then
            chmod +x ./tools/tests/run_examples_tests.sh
            timeout 300s ./tools/tests/run_examples_tests.sh --quick || {
              echo "âš ï¸ Examplesæµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥ï¼Œä½†ä¸é˜»æ–­ä¸»è¦æµç¨‹"
              exit 0
            }
          else
            echo "â„¹ï¸ Examplesæµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

  deployment-ready:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment Status
        run: |
          echo "ğŸš€ éƒ¨ç½²å°±ç»ªæ£€æŸ¥"
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
          echo "âœ… ä¸»åˆ†æ”¯æ¨é€"
          echo "ğŸ‰ SAGEå·²å‡†å¤‡å¥½éƒ¨ç½²"