# .github/workflows/ci.yml
name: CI â€” Reuse setup.sh & Run Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & Test SAGE
    runs-on: self-hosted
    timeout-minutes: 60

    env:
      CI: true          # <<< here
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
      ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Miniconda (with mamba)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          python-version: 3.11
          auto-activate-base: false

      - name: Reuse setup.sh to provision environment
        shell: bash
        run: |
          set -euxo pipefail          
          
          # 1) turn off any interactive 'pause' in setup.sh
          pause() { :; }

          # 2) ensure the script is executable
          chmod +x ./setup.sh

          # 3) source it (defines minimal_setup, etc.)
          source ./setup.sh

          # 4) run your minimal_setup to install deps, create & install sage env
          minimal_setup

      - name: Activate 'sage' env & Install test deps
        shell: bash
        run: |
          # load conda into shell
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate sage

          # ensure pytest is installed
          mamba install -y pytest pytest-cov
          mamba clean --all -y

      - name: Run Pytest
        shell: bash
        run: |
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate sage
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          export PYTHONWARNINGS="ignore:DeprecationWarning"
          pytest -v --maxfail=1 --disable-warnings
