name: SAGE CI/CD

on:
  push:
    branches: [ main, develop, refactor/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test & Build
    runs-on: self-hosted  # 使用 self-hosted runner
    timeout-minutes: 60
    
    steps:
    # 配置 Git 和认证
    - name: Configure Git and Authentication
      run: |
        git config --global http.version HTTP/1.1
        git config --global http.postBuffer 1048576000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global core.compression 0
        echo "Git configuration completed"
        
    # 配置 GitHub 认证 (解决私有仓库访问问题)
    - name: Setup GitHub Authentication
      run: |
        echo "Setting up GitHub authentication for private repo access..."
        git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        
    # 使用 token 进行 checkout (解决私有仓库访问问题)
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
        timeout: 300  # 5分钟超时
      timeout-minutes: 8
      
    # 设置 Python 环境
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
      timeout-minutes: 5
        
    # 安装系统依赖 (使用本地缓存)
    - name: Install System Dependencies
      run: |
        # 只在需要时更新包列表
        if [ ! -f /tmp/apt_updated_today ]; then
          sudo apt-get update
          touch /tmp/apt_updated_today
        fi
        sudo apt-get install -y build-essential cmake pkg-config
      timeout-minutes: 10
        
    # 安装 SAGE (minimal 模式)
    - name: Install SAGE Dependencies
      env:
        PIP_CACHE_DIR: /tmp/pip-cache
      run: |
        # 先安装依赖
        pip install --upgrade pip setuptools wheel
        pip install -r installation/env_setup/requirements.txt
      timeout-minutes: 10
        
    - name: Install SAGE Package
      env:
        CI: true
        SAGE_MINIMAL_INSTALL: true
        PIP_CACHE_DIR: /tmp/pip-cache
      run: |
        # 使用开发模式安装，避免打包步骤
        pip install -e . --no-deps
      timeout-minutes: 5
        
    # 运行基础测试
    - name: Run Basic Tests
      run: |
        python -c "import sage; print('✅ SAGE import successful')"
      timeout-minutes: 2
        
    # 运行 pytest
    - name: Run Test Suite
      run: |
        pip install pytest pytest-timeout pytest-cov
        pytest sage/cli/tests/ sage/lib/tests/ --tb=short --timeout=300 -v
      timeout-minutes: 20
        
  # 简化的代码质量检查
  lint:
    name: Code Quality
    runs-on: self-hosted  # 使用 self-hosted runner
    timeout-minutes: 15
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
      timeout-minutes: 5
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
      timeout-minutes: 3
        
    - name: Install Linting Tools
      run: |
        pip install flake8 black isort
      timeout-minutes: 5
        
    - name: Run Code Quality Checks
      run: |
        echo "Checking code formatting..."
        black --check --diff sage/ || echo "❌ Code formatting issues found"
        echo "Checking import sorting..."
        isort --check-only --diff sage/ || echo "❌ Import sorting issues found"
        echo "Running linter..."
        flake8 sage/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "❌ Critical linting errors found"
      timeout-minutes: 5
