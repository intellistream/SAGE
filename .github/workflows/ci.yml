name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€PRåªè¿è¡Œæœ€æ–°çš„CIï¼Œå–æ¶ˆä¹‹å‰çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # å…¬å…±ç¯å¢ƒå˜é‡
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com

jobs:
  # å¿«é€Ÿæ£€æŸ¥ï¼šä»£ç è´¨é‡å’ŒåŸºç¡€æµ‹è¯•
  quick-check:
    name: Quick Check
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 5
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
        which python
        which pip
      timeout-minutes: 2
      
    - name: Clear pip cache and install dependencies
      run: |
        echo "ğŸ§¹ Clearing pip cache..."
        pip cache purge || echo "No cache to clear"
        echo "ğŸ“¦ Upgrading pip..."
        pip install --upgrade pip --no-cache-dir
        echo "ğŸ“¦ Installing basic dependencies..."
        pip install flake8 black isort --no-cache-dir
        echo "ğŸ“¦ Installing sage-common..."
        pip install -e packages/sage-common/ --no-deps --no-cache-dir
        echo "âœ… Dependencies installed successfully"
      timeout-minutes: 10
        
    - name: Code Quality Checks
      run: |
        echo "ğŸ” Running code quality checks..."
        black --check --diff packages/ || echo "âš ï¸ Code formatting issues found"
        isort --check-only --diff packages/ || echo "âš ï¸ Import sorting issues found"
        flake8 packages/ --count --select=E9,F63,F7,F82 --show-source --statistics
      timeout-minutes: 2
        
    - name: Run Basic Import Tests
      run: |
        echo "Running quick smoke tests..."
        python -c "import sage; print('SAGE core import successful, version:', sage.__version__)"
        python -c "import sage.common; print('sage.common import successful')"
        # æ·»åŠ æ›´å¤šåŸºç¡€å¯¼å…¥æµ‹è¯•
        echo "Basic import tests passed âœ…"
    
    - name: Run Issues Manager Tests
      run: |
        echo "Running issues_manager.sh automated tests..."
        cd tools/tests
        bash test_issues_manager.sh --quick
        echo "Issues manager tests passed âœ…"

  # å®Œæ•´æµ‹è¯•ï¼ˆä»…åœ¨å¿«é€Ÿæ£€æŸ¥é€šè¿‡åè¿è¡Œï¼‰
  full-test:
    name: Full Test Suite
    runs-on: self-hosted
    needs: quick-check
    timeout-minutes: 60
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
        clean: true
      timeout-minutes: 8
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'
      timeout-minutes: 10
      continue-on-error: false
      
    - name: Verify Python Installation
      run: |
        python --version
        pip --version
      timeout-minutes: 2
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
        use-mamba: true
        auto-activate-base: false
      timeout-minutes: 10
        
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
      timeout-minutes: 10
        
    - name: Install SAGE (Test Mode)
      shell: bash -l {0}
      env:
        CI: true
        DEBIAN_FRONTEND: noninteractive  # é¿å…aptäº¤äº’
        # PYTHONNOUSERSITE: 1  # æ³¨é‡Šæ‰ä»¥æé«˜runneræµ‹è¯•é€Ÿåº¦
        PIP_NO_INPUT: 1  # ç¦ç”¨pipäº¤äº’
        PIP_DISABLE_PIP_VERSION_CHECK: 1  # ç¦ç”¨pipç‰ˆæœ¬æ£€æŸ¥
        SAGE_ENV_NAME: sage  # è®¾ç½®é»˜è®¤ç¯å¢ƒå
        CONDA_ALWAYS_YES: true  # è‡ªåŠ¨åŒæ„condaæ“ä½œ
      run: |
        echo "Installing SAGE using quickstart.sh --minimal"
        conda --version
        chmod +x ./quickstart.sh
        ./quickstart.sh --minimal
      timeout-minutes: 25
        
    - name: Run Test Suite
      shell: bash -l {0}
      env:
        PIP_NO_INPUT: 1
      run: |
        echo "ğŸ§ª Running comprehensive test suite..."
        # æ¿€æ´»condaç¯å¢ƒè¿›è¡Œæµ‹è¯•
        conda activate sage
        
        # å®‰è£…æµ‹è¯•ä¾èµ–
        echo "ğŸ“¦ Installing test dependencies..."
        pip install pytest pytest-cov pytest-mock pytest-asyncio pytest-xdist pytest-timeout
        
        # åŸºç¡€å¯¼å…¥æµ‹è¯•
        echo "ğŸ” Running basic import tests..."
        python -c "import sage; print('âœ… SAGE import successful, version:', sage.__version__)"
        python -c "import sage.common; print('âœ… sage.common import successful')"
        python -c "import sage.kernel; print('âœ… sage.kernel import successful')"  
        python -c "import sage.libs; print('âœ… sage.libs import successful')"
        python -c "import sage.middleware; print('âœ… sage.middleware import successful')"
        
        # CLIæµ‹è¯•
        echo "ğŸ–¥ï¸ Testing CLI functionality..."
        sage --help > /dev/null && echo "âœ… SAGE CLI working"
        sage version && echo "âœ… SAGE version command working"
        
        # Issues Manageræµ‹è¯•
        echo "ğŸ”§ Running issues manager tests..."
        cd tools/tests
        if [ -f test_issues_manager.sh ]; then
          bash test_issues_manager.sh --quick
          echo "âœ… Issues manager tests passed"
        else
          echo "âš ï¸ Issues manager test script not found"
        fi
        cd ../..
        
        # è¿è¡Œpytestæµ‹è¯•å¥—ä»¶
        echo "ğŸ§ª Running pytest suite..."
        cd tools/tests
        if [ -f run_tests.py ]; then
          echo "ğŸ“Š Running unit tests..."
          python run_tests.py --quick --unit --jobs 2 --timeout 120 --summary || echo "âš ï¸ Some unit tests failed"
          
          echo "ğŸ”— Running integration tests..."
          python run_tests.py --quick --integration --jobs 1 --timeout 180 --summary || echo "âš ï¸ Some integration tests failed"
          
          echo "ğŸ“‹ Generating test report..."
          python run_tests.py --quick --unit --report ci_test_report.txt --summary
          
          if [ -f ci_test_report.txt ]; then
            echo "ğŸ“Š Test Report Summary:"
            tail -15 ci_test_report.txt
          fi
        else
          echo "âš ï¸ Test runner not found, skipping pytest suite"
        fi
        
        echo "âœ… Test suite completed"
      timeout-minutes: 20

  # æé†’ä¿¡æ¯ï¼ˆæ€»æ˜¯è¿è¡Œï¼‰
  info:
    name: Additional Tests Info
    runs-on: self-hosted
    if: always()
    
    steps:
    - name: CI Complete
      run: |
        exit 0
    
  