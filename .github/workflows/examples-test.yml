name: Examples Test

on:
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
    paths:
      - 'examples/**'
      - 'packages/**/*.py'
  push:
    branches: [main, main-dev]
    paths:
      - 'examples/**'
      - 'packages/**/*.py'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
  HF_ENDPOINT: https://hf-mirror.com
  SAGE_EXAMPLES_MODE: test

jobs:
  examples-test:
    name: Test Examples
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true
          submodules: 'recursive'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Create .env File from Secrets
        run: |
          echo "ðŸ” ä»Ž GitHub Secrets åˆ›å»º .env æ–‡ä»¶..."
          cat > .env << EOF
          # CI Environment Configuration for Examples Testing

          # LLM Service API Keys
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
          OPENAI_MODEL_NAME=qwen-turbo-2025-02-11

          SILICONCLOUD_API_KEY=${{ secrets.SILICONCLOUD_API_KEY }}
          JINA_API_KEY=${{ secrets.JINA_API_KEY }}
          ALIBABA_API_KEY=${{ secrets.ALIBABA_API_KEY }}

          VLLM_API_KEY=${{ secrets.VLLM_API_KEY }}
          VLLM_BASE_URL=http://localhost:8000/v1

          WEB_SEARCH_API_KEY=${{ secrets.WEB_SEARCH_API_KEY }}

          # GitHub Token
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}

          # Hugging Face
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          HF_ENDPOINT=https://hf-mirror.com

          # Examples Test Mode
          SAGE_DEBUG=false
          SAGE_LOG_LEVEL=INFO
          SAGE_TEST_MODE=true
          SAGE_EXAMPLES_MODE=test
          EOF

          echo "âœ… .env æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: Install System Dependencies
        run: |
          echo "ðŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            git

          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install SAGE
        run: |
          echo "ðŸš€ å®‰è£… SAGE..."

          export PATH="$HOME/.local/bin:$PATH"
          chmod +x ./quickstart.sh

          # ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ˆexamples æµ‹è¯•éœ€è¦ sage-dev å‘½ä»¤å’Œæµ‹è¯•å·¥å…·ï¼‰
          ./quickstart.sh --dev --yes --no-sync-submodules

          echo "âœ… SAGE å®‰è£…å®Œæˆ"
        timeout-minutes: 20

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."

          # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­ï¼ˆCI çŽ¯å¢ƒä½¿ç”¨ --user å®‰è£…ï¼‰
          export PATH="$HOME/.local/bin:$PATH"

          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"
          python -c "import sage.cli; print('âœ… sage.cli imported')"

          # éªŒè¯ CLI å‘½ä»¤
          echo "éªŒè¯å‘½ä»¤å¯ç”¨æ€§..."
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… sage å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage å‘½ä»¤ä¸å¯ç”¨"
          fi

          if command -v sage-dev >/dev/null 2>&1; then
            sage-dev --help > /dev/null && echo "âœ… sage-dev å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage-dev å‘½ä»¤ä¸å¯ç”¨"
          fi

      - name: Install Examples Test Dependencies
        run: |
          echo "ðŸ“¦ å®‰è£… Examples æµ‹è¯•ä¾èµ–..."

          # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­ï¼ˆCI çŽ¯å¢ƒä½¿ç”¨ --user å®‰è£…ï¼‰
          export PATH="$HOME/.local/bin:$PATH"

          # quickstart.sh å·²ç»å®‰è£…äº† SAGEï¼Œè¿™é‡Œåªéœ€å®‰è£…é¢å¤–çš„æµ‹è¯•å·¥å…·
          pip install pytest pytest-timeout pytest-benchmark

          # å®‰è£… examples å¯èƒ½éœ€è¦çš„é¢å¤–ä¾èµ–
          if [ -f "examples/requirements.txt" ]; then
            pip install -r examples/requirements.txt
          fi

          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run Examples Tests
        run: |
          echo "ðŸŒŸ è¿è¡Œ Examples å®Œæ•´æµ‹è¯•..."
          echo ""

          # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­ï¼ˆCI çŽ¯å¢ƒä½¿ç”¨ --user å®‰è£…ï¼‰
          export PATH="$HOME/.local/bin:$PATH"

          # éªŒè¯ sage-dev å‘½ä»¤å¯ç”¨
          if ! command -v sage-dev >/dev/null 2>&1; then
            echo "âŒ sage-dev å‘½ä»¤ä¸å¯ç”¨"
            echo "PATH: $PATH"
            echo "~/.local/bin å†…å®¹:"
            ls -la ~/.local/bin/ | grep sage || echo "æ²¡æœ‰ sage ç›¸å…³å‘½ä»¤"
            exit 1
          fi

          # ä½¿ç”¨ sage-dev CLI å‘½ä»¤è¿è¡Œæµ‹è¯•ï¼ˆæ›¿ä»£æ—§çš„ shell è„šæœ¬ï¼‰
          sage-dev examples test || {
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Examples æµ‹è¯•å¤±è´¥ï¼"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸ’¡ å¸¸è§é—®é¢˜æŽ’æŸ¥ï¼š"
            echo "1. æ£€æŸ¥å¤±è´¥çš„ example æ–‡ä»¶"
            echo "2. æŸ¥çœ‹æ˜¯å¦æœ‰å¯¼å…¥é”™è¯¯"
            echo "3. ç¡®è®¤ API keys é…ç½®æ­£ç¡®"
            echo "4. æœ¬åœ°è¿è¡Œ: sage-dev examples test"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          }

          echo ""
          echo "âœ… æ‰€æœ‰ Examples æµ‹è¯•é€šè¿‡ï¼"

      - name: Generate Examples Test Report
        if: always()
        run: |
          echo "ðŸ“Š ç”Ÿæˆ Examples æµ‹è¯•æŠ¥å‘Š..."

          # ç»Ÿè®¡ examples æ•°é‡
          TOTAL_EXAMPLES=$(find examples -name "*.py" -type f | wc -l)
          TUTORIAL_COUNT=$(find examples/tutorials -name "*.py" -type f 2>/dev/null | wc -l || echo 0)
          APP_COUNT=$(find examples/apps -name "*.py" -type f 2>/dev/null | wc -l || echo 0)

          echo "ðŸ“¦ Examples ç»Ÿè®¡:"
          echo "  æ€»æ•°: $TOTAL_EXAMPLES"
          echo "  æ•™ç¨‹: $TUTORIAL_COUNT"
          echo "  åº”ç”¨: $APP_COUNT"

          # æ£€æŸ¥æ˜¯å¦æœ‰ README
          if [ -f "examples/README.md" ]; then
            echo "  âœ… README.md å­˜åœ¨"
          else
            echo "  âš ï¸  README.md ç¼ºå¤±"
          fi

          echo ""
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŒŸ Examples æµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æµ‹è¯•é€šè¿‡** - æ‰€æœ‰ Examples è¿è¡Œæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # ç»Ÿè®¡ä¿¡æ¯
            TOTAL=$(find examples -name "*.py" -type f | wc -l)
            echo "ðŸ“Š æµ‹è¯•ç»Ÿè®¡:" >> $GITHUB_STEP_SUMMARY
            echo "- æ€» Examples æ•°: $TOTAL" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•å¤±è´¥** - éƒ¨åˆ† Examples è¿è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ æŽ’æŸ¥å»ºè®®" >> $GITHUB_STEP_SUMMARY
            echo "1. æ£€æŸ¥å¤±è´¥çš„ example æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "2. æœ¬åœ°è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯" >> $GITHUB_STEP_SUMMARY
            echo "3. ç¡®è®¤æ‰€æœ‰ä¾èµ–å·²å®‰è£…" >> $GITHUB_STEP_SUMMARY
          fi
