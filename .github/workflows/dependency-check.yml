name: Dependency Integrity Check

# ä¸“é—¨ç”¨äºæ£€æµ‹å®‰è£…è¿‡ç¨‹ä¸­çš„ä¾èµ–æ±¡æŸ“é—®é¢˜
# ç¡®ä¿ä¸ä¼šä» PyPI ä¸‹è½½æœ¬åœ°åŒ…

on:
  pull_request:
    branches: [main, main-dev]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'tools/install/**'
      - '.github/workflows/dependency-check.yml'
  push:
    branches: [main, main-dev]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'tools/install/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-local-dependencies:
    name: Check Local Package Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆC++ æ‰©å±•æ„å»ºéœ€è¦ï¼‰..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            libopenblas-dev \
            liblapack-dev \
            gfortran

      - name: Install Base Tools
        run: |
          pip install --upgrade pip setuptools wheel
          # è®¾ç½® CMake å‚æ•°ç¦ç”¨ LibAMMï¼ˆCI ç¯å¢ƒæ²¡æœ‰ CUDAï¼‰
          echo "CMAKE_ARGS=-DENABLE_LIBAMM=OFF" >> $GITHUB_ENV

      - name: Run Installation with Monitoring
        id: install
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."

          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p .sage/logs

          # è¿è¡Œå®‰è£…è„šæœ¬ (ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ ¼å¼)
          # quickstart.sh ä½¿ç”¨ --dev è€Œä¸æ˜¯ --mode dev
          if ./quickstart.sh --dev --yes 2>&1 | tee .sage/logs/ci_install.log; then
            echo "âœ… å®‰è£…æˆåŠŸ"
            install_status="success"
          else
            echo "âŒ å®‰è£…å¤±è´¥"
            install_status="failed"
          fi

          echo "install_status=$install_status" >> $GITHUB_OUTPUT

      - name: ğŸ” Analyze Installation Logs
        id: analyze
        run: |
          echo "ğŸ” åˆ†æå®‰è£…æ—¥å¿—ï¼Œæ£€æµ‹ä¾èµ–å®Œæ•´æ€§..."

          # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f .sage/logs/install.log ]; then
            echo "âš ï¸  ä¸»æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ CI æ—¥å¿—"
            # å¦‚æœä¸»æ—¥å¿—ä¸å­˜åœ¨ï¼Œä½¿ç”¨ CI æ—¥å¿—
            if [ -f .sage/logs/ci_install.log ]; then
              cp .sage/logs/ci_install.log .sage/logs/install.log
            else
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ—¥å¿—æ–‡ä»¶"
              check_result="fail"
              echo "check_result=$check_result" >> $GITHUB_OUTPUT
              exit 0  # ä¸è¦å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
            fi
          fi

          # è¿è¡Œç›‘æ§è„šæœ¬
          if bash tools/install/installation_table/pip_install_monitor.sh analyze .sage/logs/install.log; then
            echo "âœ… ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
            check_result="pass"
          else
            echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"
            check_result="fail"
          fi

          echo "check_result=$check_result" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate Dependency Report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆä¾èµ–æŠ¥å‘Š..."

          # ç¡®å®šä½¿ç”¨å“ªä¸ªæ—¥å¿—æ–‡ä»¶
          LOG_FILE=".sage/logs/install.log"
          if [ ! -f "$LOG_FILE" ] && [ -f ".sage/logs/ci_install.log" ]; then
            LOG_FILE=".sage/logs/ci_install.log"
          fi

          cat > .sage/dependency-report.md <<EOF
          # ğŸ” ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **åˆ†æ”¯**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}

          ## å®‰è£…çŠ¶æ€

          - å®‰è£…ç»“æœ: ${{ steps.install.outputs.install_status }}
          - ä¾èµ–æ£€æŸ¥: ${{ steps.analyze.outputs.check_result }}

          ## å·²å®‰è£…çš„ SAGE åŒ…

          \`\`\`
          $(pip list | grep -i sage || echo "æœªæ‰¾åˆ° SAGE åŒ…")
          \`\`\`

          ## å®‰è£…ä½ç½®æ£€æŸ¥

          \`\`\`
          $(pip show isage isage-common isage-middleware 2>/dev/null || echo "éƒ¨åˆ†åŒ…æœªå®‰è£…")
          \`\`\`

          ## æ£€æµ‹åˆ°çš„é—®é¢˜

          EOF

          # æ·»åŠ é—®é¢˜è¯¦æƒ…
          if [ "${{ steps.analyze.outputs.check_result }}" = "fail" ]; then
            echo "ä»å®‰è£…æ—¥å¿—ä¸­æ£€æµ‹åˆ°ä»¥ä¸‹é—®é¢˜ï¼š" >> .sage/dependency-report.md
            echo "" >> .sage/dependency-report.md
            echo '```' >> .sage/dependency-report.md
            if [ -f "$LOG_FILE" ]; then
              grep -E "(Downloading|Collecting).*(isage|sage)" "$LOG_FILE" | head -n 20 >> .sage/dependency-report.md || echo "æœªæ‰¾åˆ°ä¸‹è½½è®°å½•" >> .sage/dependency-report.md
            else
              echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼š$LOG_FILE" >> .sage/dependency-report.md
            fi
            echo '```' >> .sage/dependency-report.md
          else
            echo "âœ… æœªæ£€æµ‹åˆ°ä¾èµ–æ±¡æŸ“é—®é¢˜" >> .sage/dependency-report.md
          fi

          # æ˜¾ç¤ºæŠ¥å‘Š
          cat .sage/dependency-report.md

      - name: Upload Installation Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-logs
          path: |
            .sage/logs/
            .sage/dependency-report.md
          retention-days: 30

      - name: âŒ Fail if Dependencies Polluted
        if: steps.analyze.outputs.check_result == 'fail' && steps.install.outputs.install_status == 'success'
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "æ£€æµ‹åˆ°ä» PyPI ä¸‹è½½äº†æœ¬åœ°åŒ…ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„é…ç½®é”™è¯¯ï¼"
          echo ""
          echo "ğŸ”§ å¯èƒ½çš„ä¿®å¤æ–¹æ³•ï¼š"
          echo "  1. æ£€æŸ¥ packages/*/pyproject.toml ä¸­çš„ dependencies"
          echo "  2. ç§»é™¤ä¸å¿…è¦çš„æœ¬åœ°åŒ…ä¾èµ–å£°æ˜"
          echo "  3. ç¡®ä¿åªå£°æ˜ç›´æ¥ä½¿ç”¨çš„ä¾èµ–"
          echo "  4. æŸ¥çœ‹ä¸Šä¼ çš„æ—¥å¿—æ–‡ä»¶äº†è§£è¯¦æƒ…"
          echo ""
          echo "ğŸ“ ç›¸å…³æ–‡æ¡£ï¼š"
          echo "  - .sage/BUG_FIX_REPORT.md"
          echo "  - tools/install/installation_table/pip_install_monitor.sh"
          echo ""
          exit 1

      - name: âš ï¸ Warning if Check Skipped
        if: steps.analyze.outputs.check_result == 'fail' && steps.install.outputs.install_status != 'success'
        run: |
          echo ""
          echo "âš ï¸  ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œä½†å¯èƒ½æ˜¯ç”±äºå®‰è£…å¤±è´¥æˆ–æ—¥å¿—ç¼ºå¤±"
          echo ""
          echo "å®‰è£…çŠ¶æ€: ${{ steps.install.outputs.install_status }}"
          echo "æ£€æŸ¥ç»“æœ: ${{ steps.analyze.outputs.check_result }}"
          echo ""
          echo "è¯·æ£€æŸ¥ä¸Šä¼ çš„æ—¥å¿—æ–‡ä»¶äº†è§£è¯¦æƒ…"
          echo ""
          # ä¸å¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
          exit 0

  check-dependency-declarations:
    name: Analyze Dependency Declarations
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check pyproject.toml Files
        run: |
          echo "ğŸ” æ£€æŸ¥æ‰€æœ‰ pyproject.toml æ–‡ä»¶çš„ä¾èµ–å£°æ˜..."
          echo ""

          # æ£€æŸ¥æ¯ä¸ªåŒ…çš„ä¾èµ–å£°æ˜
          for toml in packages/*/pyproject.toml; do
            if [ -f "$toml" ]; then
              package=$(basename $(dirname "$toml"))
              echo "ğŸ“¦ æ£€æŸ¥ $package..."

              # æå– dependencies éƒ¨åˆ†
              if grep -A 20 "^dependencies = \[" "$toml" | grep -E "isage-" | head -n 10; then
                echo ""
              else
                echo "  ï¼ˆæ—  isage-* ä¾èµ–ï¼‰"
                echo ""
              fi
            fi
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¡ æé†’ï¼š"
          echo "  - åŒ…åº”è¯¥åªå£°æ˜å®ƒç›´æ¥ä½¿ç”¨çš„ä¾èµ–"
          echo "  - é¿å…å£°æ˜ä¼ é€’æ€§ä¾èµ–"
          echo "  - sage-tools åªéœ€è¦ sage-commonï¼ˆä¸éœ€è¦ kernel/middleware/libsï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
