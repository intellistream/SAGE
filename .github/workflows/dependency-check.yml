name: Dependency Integrity Check

# ä¸“é—¨ç”¨äºæ£€æµ‹å®‰è£…è¿‡ç¨‹ä¸­çš„ä¾èµ–æ±¡æŸ“é—®é¢˜
# ç¡®ä¿ä¸ä¼šä» PyPI ä¸‹è½½æœ¬åœ°åŒ…

on:
  pull_request:
    branches: [main, main-dev]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'tools/install/**'
      - '.github/workflows/dependency-check.yml'
  push:
    branches: [main, main-dev]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'tools/install/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-local-dependencies:
    name: Check Local Package Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Base Tools
        run: |
          pip install --upgrade pip setuptools wheel

      - name: Run Installation with Monitoring
        id: install
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."

          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p .sage/logs

          # è¿è¡Œå®‰è£…è„šæœ¬
          if ./quickstart.sh --mode dev --yes --no-submodule-sync 2>&1 | tee .sage/logs/ci_install.log; then
            echo "âœ… å®‰è£…æˆåŠŸ"
            install_status="success"
          else
            echo "âŒ å®‰è£…å¤±è´¥"
            install_status="failed"
          fi

          echo "install_status=$install_status" >> $GITHUB_OUTPUT

      - name: ğŸ” Analyze Installation Logs
        id: analyze
        run: |
          echo "ğŸ” åˆ†æå®‰è£…æ—¥å¿—ï¼Œæ£€æµ‹ä¾èµ–å®Œæ•´æ€§..."

          # è¿è¡Œç›‘æ§è„šæœ¬
          if bash tools/install/installation_table/pip_install_monitor.sh analyze .sage/logs/install.log; then
            echo "âœ… ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
            check_result="pass"
          else
            echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"
            check_result="fail"
          fi

          echo "check_result=$check_result" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate Dependency Report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆä¾èµ–æŠ¥å‘Š..."

          cat > .sage/dependency-report.md <<'EOF'
          # ğŸ” ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **åˆ†æ”¯**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}

          ## å®‰è£…çŠ¶æ€

          - å®‰è£…ç»“æœ: ${{ steps.install.outputs.install_status }}
          - ä¾èµ–æ£€æŸ¥: ${{ steps.analyze.outputs.check_result }}

          ## å·²å®‰è£…çš„ SAGE åŒ…

          ```
          $(pip list | grep -i sage || echo "æœªæ‰¾åˆ° SAGE åŒ…")
          ```

          ## å®‰è£…ä½ç½®æ£€æŸ¥

          ```
          $(pip show isage isage-common isage-middleware 2>/dev/null || echo "éƒ¨åˆ†åŒ…æœªå®‰è£…")
          ```

          ## æ£€æµ‹åˆ°çš„é—®é¢˜

          EOF

          # æ·»åŠ é—®é¢˜è¯¦æƒ…
          if [ "${{ steps.analyze.outputs.check_result }}" = "fail" ]; then
            echo "ä»å®‰è£…æ—¥å¿—ä¸­æ£€æµ‹åˆ°ä»¥ä¸‹é—®é¢˜ï¼š" >> .sage/dependency-report.md
            echo "" >> .sage/dependency-report.md
            echo '```' >> .sage/dependency-report.md
            grep -E "(Downloading|Collecting).*(isage|sage)" .sage/logs/install.log | head -n 20 >> .sage/dependency-report.md || true
            echo '```' >> .sage/dependency-report.md
          else
            echo "âœ… æœªæ£€æµ‹åˆ°ä¾èµ–æ±¡æŸ“é—®é¢˜" >> .sage/dependency-report.md
          fi

          # æ˜¾ç¤ºæŠ¥å‘Š
          cat .sage/dependency-report.md

      - name: Upload Installation Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-logs
          path: |
            .sage/logs/
            .sage/dependency-report.md
          retention-days: 30

      - name: âŒ Fail if Dependencies Polluted
        if: steps.analyze.outputs.check_result == 'fail'
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "æ£€æµ‹åˆ°ä» PyPI ä¸‹è½½äº†æœ¬åœ°åŒ…ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„é…ç½®é”™è¯¯ï¼"
          echo ""
          echo "ğŸ”§ å¯èƒ½çš„ä¿®å¤æ–¹æ³•ï¼š"
          echo "  1. æ£€æŸ¥ packages/*/pyproject.toml ä¸­çš„ dependencies"
          echo "  2. ç§»é™¤ä¸å¿…è¦çš„æœ¬åœ°åŒ…ä¾èµ–å£°æ˜"
          echo "  3. ç¡®ä¿åªå£°æ˜ç›´æ¥ä½¿ç”¨çš„ä¾èµ–"
          echo "  4. æŸ¥çœ‹ä¸Šä¼ çš„æ—¥å¿—æ–‡ä»¶äº†è§£è¯¦æƒ…"
          echo ""
          echo "ğŸ“ ç›¸å…³æ–‡æ¡£ï¼š"
          echo "  - .sage/BUG_FIX_REPORT.md"
          echo "  - tools/install/installation_table/pip_install_monitor.sh"
          echo ""
          exit 1

  check-dependency-declarations:
    name: Analyze Dependency Declarations
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check pyproject.toml Files
        run: |
          echo "ğŸ” æ£€æŸ¥æ‰€æœ‰ pyproject.toml æ–‡ä»¶çš„ä¾èµ–å£°æ˜..."
          echo ""

          # æ£€æŸ¥æ¯ä¸ªåŒ…çš„ä¾èµ–å£°æ˜
          for toml in packages/*/pyproject.toml; do
            if [ -f "$toml" ]; then
              package=$(basename $(dirname "$toml"))
              echo "ğŸ“¦ æ£€æŸ¥ $package..."

              # æå– dependencies éƒ¨åˆ†
              if grep -A 20 "^dependencies = \[" "$toml" | grep -E "isage-" | head -n 10; then
                echo ""
              else
                echo "  ï¼ˆæ—  isage-* ä¾èµ–ï¼‰"
                echo ""
              fi
            fi
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¡ æé†’ï¼š"
          echo "  - åŒ…åº”è¯¥åªå£°æ˜å®ƒç›´æ¥ä½¿ç”¨çš„ä¾èµ–"
          echo "  - é¿å…å£°æ˜ä¼ é€’æ€§ä¾èµ–"
          echo "  - sage-tools åªéœ€è¦ sage-commonï¼ˆä¸éœ€è¦ kernel/middleware/libsï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
