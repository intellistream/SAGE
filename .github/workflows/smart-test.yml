# ========================================
# ğŸš« WORKFLOW DISABLED TO SAVE COSTS ğŸš«
# ========================================
# æ­¤å·¥ä½œæµå·²è¢«ç¦ç”¨ä»¥é¿å…è‡ªåŠ¨è§¦å‘æµ‹è¯•ï¼ŒèŠ‚çœè´¹ç”¨
# å¦‚éœ€è¿è¡Œæµ‹è¯•ï¼Œè¯·æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
# This workflow has been disabled to avoid automatic test triggers and save costs
# To run tests, please trigger the workflow manually
# ========================================

name: Smart Testing with AI (DISABLED)

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
  # pull_request:     # å·²ç¦ç”¨è‡ªåŠ¨è§¦å‘
  #   branches: [ main, develop ]
  #   types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  smart-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºdiffåˆ†æ
        
    - name: Checkout target branch
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
        
    - name: Install SAGE package
      run: |
        pip install -e .
        
    - name: Build C extensions
      run: |
        cd sage/utils/mmap_queue
        if [ -f "build.sh" ]; then
          bash build.sh
        elif [ -f "Makefile" ]; then
          make
        fi
        
    - name: Run Smart Test Analysis
      id: smart_test
      run: |
        echo "Running smart test analysis..."
        
        # åˆ›å»ºè¾“å‡ºæ–‡ä»¶
        OUTPUT_FILE="smart_test_output.md"
        
        # è¿è¡Œæ™ºèƒ½æµ‹è¯•
        python scripts/test_runner.py --diff \
          --base-branch=${{ github.base_ref }} \
          --pr-branch=${{ github.head_ref }} \
          --output-format=markdown > "$OUTPUT_FILE" 2>&1
        
        # æ£€æŸ¥æµ‹è¯•æ˜¯å¦æˆåŠŸ
        if [ $? -eq 0 ]; then
          echo "smart_test_status=success" >> $GITHUB_OUTPUT
        else
          echo "smart_test_status=failure" >> $GITHUB_OUTPUT
        fi
        
        # è®¾ç½®è¾“å‡ºæ–‡ä»¶è·¯å¾„
        echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
        
        # è¯»å–è¾“å‡ºå†…å®¹ï¼ˆé™åˆ¶é•¿åº¦ä»¥é¿å…GitHub APIé™åˆ¶ï¼‰
        if [ -f "$OUTPUT_FILE" ]; then
          # é™åˆ¶è¾“å‡ºé•¿åº¦ä¸º60000å­—ç¬¦ï¼ˆGitHubè¯„è®ºé™åˆ¶ï¼‰
          OUTPUT_CONTENT=$(head -c 60000 "$OUTPUT_FILE")
          echo "SMART_TEST_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi
        
    - name: Run Full Test Suite (if smart test indicates)
      if: steps.smart_test.outputs.smart_test_status == 'success'
      run: |
        echo "Running recommended test suite..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿è¡Œå®Œæ•´æµ‹è¯•
        if grep -q "RUN_FULL_TESTS=true" smart_test_output.md; then
          echo "Smart test recommends running full test suite"
          pytest --cov=sage --cov-report=xml --cov-report=html -v
        else
          echo "Smart test indicates selective testing is sufficient"
          # è¿è¡Œæ™ºèƒ½æ¨èçš„ç‰¹å®šæµ‹è¯•
          if [ -f "recommended_tests.txt" ]; then
            pytest --cov=sage --cov-report=xml -v $(cat recommended_tests.txt)
          fi
        fi
        
    - name: Upload Coverage Reports
      if: always()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: Comment PR with Smart Test Results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // å‡†å¤‡è¯„è®ºå†…å®¹
          let commentBody = `## ğŸ¤– Smart Test Analysis Results\n\n`;
          
          // æ·»åŠ æµ‹è¯•çŠ¶æ€
          const testStatus = '${{ steps.smart_test.outputs.smart_test_status }}';
          if (testStatus === 'success') {
            commentBody += `âœ… **Status**: Smart test analysis completed successfully\n\n`;
          } else {
            commentBody += `âŒ **Status**: Smart test analysis encountered issues\n\n`;
          }
          
          // æ·»åŠ è¾“å‡ºå†…å®¹
          try {
            const output = process.env.SMART_TEST_OUTPUT;
            if (output) {
              commentBody += `### ğŸ“Š Analysis Report\n\n`;
              commentBody += '```\n' + output + '\n```\n\n';
            }
          } catch (error) {
            commentBody += `âš ï¸ Could not read test output: ${error.message}\n\n`;
          }
          
          // æ·»åŠ å»ºè®®
          commentBody += `### ğŸ’¡ Recommendations\n\n`;
          commentBody += `- Review the analysis results above\n`;
          commentBody += `- Check if any critical components were modified\n`;
          commentBody += `- Consider running additional tests if suggested\n\n`;
          
          // æ·»åŠ å…ƒä¿¡æ¯
          commentBody += `---\n`;
          commentBody += `*Generated by SAGE Smart Test Runner*\n`;
          commentBody += `*Commit: ${context.sha.substring(0, 7)}*\n`;
          commentBody += `*Base branch: ${{ github.base_ref }}*\n`;
          
          // æŸ¥æ‰¾ç°æœ‰è¯„è®º
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Smart Test Analysis Results')
          );
          
          if (botComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }
          
    - name: Set Check Status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const testStatus = '${{ steps.smart_test.outputs.smart_test_status }}';
          
          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'Smart Test Analysis',
            head_sha: context.sha,
            status: 'completed',
            conclusion: testStatus === 'success' ? 'success' : 'failure',
            output: {
              title: testStatus === 'success' ? 
                'Smart test analysis passed' : 
                'Smart test analysis failed',
              summary: testStatus === 'success' ? 
                'All smart test checks passed successfully.' : 
                'Smart test analysis encountered issues. Please check the details.',
            }
          });
          
    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: smart-test-results
        path: |
          smart_test_output.md
          recommended_tests.txt
          coverage.xml
          htmlcov/
        retention-days: 30
