name: Examples Test

on:
  push:
    branches: [main, main-dev]
    paths:
      - 'packages/*/examples/**'
      - '.github/workflows/ci-examples-test.yml'
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/*/examples/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  SAGE_TEST_MODE: true
  SAGE_EXAMPLES_MODE: test
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  HF_ENDPOINT: https://hf-mirror.com

jobs:
  test-examples:
    name: Test Examples (Test Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Skip version bump commits
    if: ${{ !contains(github.event.head_commit.message, '[version bump]') }}

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Create .env File (Test Mode)
        run: |
          echo "ğŸ” åˆ›å»ºæµ‹è¯•æ¨¡å¼ .env æ–‡ä»¶..."
          # Use dummy API key for test mode - not a real secret  # pragma: allowlist secret
          DUMMY_KEY="sk-test-dummy-key-for-validation-only"
          cat > .env << EOF
          # CI Examples Test Environment (Test Mode - No Real API Calls)

          # Test Mode Flags
          SAGE_TEST_MODE=true
          SAGE_EXAMPLES_MODE=test

          # API Keys (not required in test mode, but set for validation)
          OPENAI_API_KEY=$DUMMY_KEY
          OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
          OPENAI_MODEL_NAME=qwen-turbo-2025-02-11

          # Hugging Face
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          HF_ENDPOINT=https://hf-mirror.com

          # CI/CD Settings
          SAGE_DEBUG=false
          SAGE_LOG_LEVEL=INFO
          EOF

          echo "âœ… æµ‹è¯•æ¨¡å¼ .env æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: Install System Dependencies
        run: |
          echo "ğŸ”§ å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libopenblas-dev \
            liblapack-dev
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install SAGE (Dev Mode)
        run: |
          echo "ğŸš€ å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."
          export PATH="$HOME/.local/bin:$PATH"

          # ä½¿ç”¨ CI å®‰è£…åŒ…è£…å™¨
          chmod +x ./tools/install/core/ci_install_wrapper.sh
          chmod +x ./quickstart.sh

          # å®‰è£…æ ¸å¿ƒåŒ…ï¼ˆexamples éœ€è¦ï¼‰
          ./tools/install/core/ci_install_wrapper.sh --dev --yes

          echo "âœ… SAGE å®‰è£…å®Œæˆ"
        timeout-minutes: 20

      - name: Install Independent Libs (for Examples)
        run: |
          echo "ğŸ“¦ å®‰è£…ç‹¬ç«‹åº“ï¼ˆexamples ä¾èµ–ï¼‰..."
          export PATH="$HOME/.local/bin:$PATH"

          # å®‰è£… isage-agenticï¼ˆbasic_agent.py éœ€è¦ï¼‰
          pip install --user isage-agentic

          echo "âœ… ç‹¬ç«‹åº“å®‰è£…å®Œæˆ"

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"
          python -c "import sage.kernel; print('âœ… sage.kernel imported')"
          python -c "import sage.libs; print('âœ… sage.libs imported')"

          # éªŒè¯ç‹¬ç«‹åº“
          python -c "import sage_libs.sage_agentic; print('âœ… sage_libs.sage_agentic imported')" || echo "âš ï¸  sage_agentic not available"

      - name: Discover Testable Examples
        id: discover
        run: |
          echo "ğŸ” å‘ç°æ”¯æŒæµ‹è¯•æ¨¡å¼çš„ examples..."

          # æŸ¥æ‰¾æ‰€æœ‰æ”¯æŒ SAGE_TEST_MODE æˆ– SAGE_EXAMPLES_MODE çš„æ–‡ä»¶
          # ä½¿ç”¨ || true é˜²æ­¢ grep æ²¡æœ‰åŒ¹é…æ—¶è¿”å› exit code 1
          examples=$(grep -r "SAGE_TEST_MODE\|SAGE_EXAMPLES_MODE" packages/*/examples --include="*.py" -l 2>/dev/null | sort || true)

          if [ -z "$examples" ]; then
            echo "âš ï¸  æœªå‘ç°æ”¯æŒæµ‹è¯•æ¨¡å¼çš„ examples"
            echo "count=0" >> $GITHUB_OUTPUT
            echo "" > /tmp/testable_examples.txt
            exit 0
          fi

          echo "å‘ç°çš„ examples:"
          echo "$examples" | while read -r file; do
            echo "  â€¢ $file"
          done

          # ç»Ÿè®¡æ•°é‡
          count=$(echo "$examples" | wc -l)
          echo ""
          echo "ğŸ“Š æ€»è®¡: $count ä¸ªæ”¯æŒæµ‹è¯•æ¨¡å¼çš„ examples"

          # ä¿å­˜åˆ°è¾“å‡º
          echo "count=$count" >> $GITHUB_OUTPUT

          # ä¿å­˜æ–‡ä»¶åˆ—è¡¨åˆ°ä¸´æ—¶æ–‡ä»¶
          echo "$examples" > /tmp/testable_examples.txt

      - name: Test Examples
        run: |
          echo "ğŸ§ª è¿è¡Œ examples æµ‹è¯•ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰..."
          echo ""

          # è®¾ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
          export SAGE_TEST_MODE=true
          export SAGE_EXAMPLES_MODE=test
          export PATH="$HOME/.local/bin:$PATH"

          # è¯»å– examples åˆ—è¡¨
          if [ ! -f /tmp/testable_examples.txt ]; then
            echo "âš ï¸  æœªå‘ç° testable examples åˆ—è¡¨æ–‡ä»¶"
            exit 0
          fi

          examples=$(cat /tmp/testable_examples.txt)

          if [ -z "$examples" ]; then
            echo "âš ï¸  æ²¡æœ‰éœ€è¦æµ‹è¯•çš„ examples"
            exit 0
          fi

          # è®¡æ•°å™¨ - æ˜¾å¼åˆå§‹åŒ–ä¸º 0
          passed=0
          failed=0
          skipped=0

          # åˆ›å»ºç»“æœç›®å½•
          mkdir -p .sage/examples-test-results

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "å¼€å§‹æµ‹è¯• examples"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # ä½¿ç”¨ while read è€Œä¸æ˜¯ forï¼Œé¿å…ç©ºè¡Œé—®é¢˜
          while IFS= read -r example; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$example" ] && continue

            echo "ğŸ“ æµ‹è¯•: $example"

            # è¿è¡Œ exampleï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
            if timeout 30 python "$example" > ".sage/examples-test-results/$(basename "$example").log" 2>&1; then
              echo "  âœ… PASS"
              passed=$((passed + 1))
            else
              exit_code=$?
              if [ $exit_code -eq 124 ]; then
                echo "  â±ï¸  TIMEOUT (30s)"
                failed=$((failed + 1))
              else
                echo "  âŒ FAIL (exit code: $exit_code)"
                failed=$((failed + 1))

                # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
                echo "  é”™è¯¯æ—¥å¿—:"
                tail -n 10 ".sage/examples-test-results/$(basename "$example").log" | sed 's/^/    /'
              fi
            fi
            echo ""
          done < /tmp/testable_examples.txt

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æµ‹è¯•ç»“æœæ±‡æ€»"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… é€šè¿‡: $passed"
          echo "âŒ å¤±è´¥: $failed"
          echo "â­ï¸  è·³è¿‡: $skipped"
          echo ""

          total=$((passed + failed + skipped))
          echo "ğŸ“Š æ€»è®¡: $total ä¸ª examples"
          echo ""

          # å¦‚æœæœ‰å¤±è´¥ï¼Œé€€å‡ºç éé›¶
          if [ $failed -gt 0 ]; then
            echo "âŒ éƒ¨åˆ† examples æµ‹è¯•å¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ examples æµ‹è¯•é€šè¿‡ï¼"
            exit 0
          fi

      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: examples-test-logs-py${{ matrix.python-version }}
          path: .sage/examples-test-results/
          retention-days: 7

      - name: Generate Test Report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."

          cat > .sage/examples-test-results/REPORT.md << 'EOF'
          # Examples Test Report

          ## Test Environment
          - Python Version: ${{ matrix.python-version }}
          - Test Mode: SAGE_TEST_MODE=true
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Test Results

          See individual log files for details.

          ## Notes
          - Examples run in test mode (no real API calls)
          - Tests validate configuration loading and module imports
          - Timeout: 30 seconds per example
          EOF

          echo "âœ… æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: Summary
        if: always()
        run: |
          echo "## Examples Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version**: ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Mode**: SAGE_TEST_MODE=true (no real API calls)" >> $GITHUB_STEP_SUMMARY
          echo "- **Examples Tested**: ${{ steps.discover.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY
