name: "Development CI (Simplified)"

on:
  push:
    branches: [main-dev]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README*'
  pull_request:
    branches: [main-dev]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified

jobs:
  build-sage:
    name: Build and Install SAGE
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cache Key
        id: cache-key
        run: |
          HASH=$(find packages/ -name "*.py" -o -name "pyproject.toml" | sort | xargs md5sum | md5sum | cut -d' ' -f1)
          CACHE_KEY="sage-simplified-${{ env.CACHE_VERSION }}-${{ runner.os }}-py311-${HASH}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "ğŸ”‘ Generated cache key: ${CACHE_KEY}"

      - name: Cache SAGE Installation
        id: cache-sage
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            sage-simplified-${{ env.CACHE_VERSION }}-${{ runner.os }}-py311-

      - name: Install System Dependencies
        if: steps.cache-sage.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ”§ å®‰è£…C++ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config
        timeout-minutes: 10

      - name: Install SAGE
        if: steps.cache-sage.outputs.cache-hit != 'true'
        run: |
          echo "ğŸš€ å®‰è£…SAGEï¼ˆä½¿ç”¨æ”¹è¿›çš„å®‰è£…ç³»ç»Ÿï¼‰..."
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --pip --yes
        timeout-minutes: 20

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"
          
          # éªŒè¯æ‰©å±•ï¼ˆä½¿ç”¨æˆ‘ä»¬çš„æ–°å…¼å®¹æ€§æ£€æµ‹ï¼‰
          python -c "
          from sage.middleware.components.extensions_compat import check_extensions_availability
          available = check_extensions_availability()
          print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§: {sum(available.values())}/{len(available)}')
          for ext, status in available.items():
              print(f'  {ext}: {\"âœ…\" if status else \"âŒ\"}')"

  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    needs: build-sage
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore SAGE Installation
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ needs.build-sage.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Run Basic Tests
        run: |
          echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python -c "import sage; import sage.common; print('âœ… åŸºç¡€å¯¼å…¥æµ‹è¯•é€šè¿‡')"
          
          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… CLIæµ‹è¯•é€šè¿‡"
          fi

  examples-test:
    name: Examples Test
    runs-on: ubuntu-latest
    needs: build-sage
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore SAGE Installation
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ needs.build-sage.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Install Test Dependencies
        run: |
          pip install -e packages/sage-tools[cli]

      - name: Run Examples Tests
        run: |
          echo "ğŸŒŸ è¿è¡ŒExamplesæµ‹è¯•..."
          chmod +x ./tools/tests/run_examples_tests.sh
          ./tools/tests/run_examples_tests.sh --timeout 300

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [build-sage, quick-check, examples-test]

    steps:
      - name: Summary Report
        run: |
          echo "ğŸ ç®€åŒ–CIç®¡é“å®Œæˆ"
          echo "ğŸ“Š ä½œä¸šçŠ¶æ€:"
          echo "- Build: ${{ needs.build-sage.result }}"
          echo "- Quick Check: ${{ needs.quick-check.result }}"
          echo "- Examples: ${{ needs.examples-test.result }}"
          
          if [[ "${{ needs.build-sage.result }}" == "success" && "${{ needs.quick-check.result }}" == "success" ]]; then
            echo "âœ… æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ æ ¸å¿ƒåŠŸèƒ½å­˜åœ¨é—®é¢˜"
          fi