name: "Architecture Compliance Check"

on:
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, main-dev]
  workflow_dispatch:

jobs:
  architecture-check:
    name: Check Architecture Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²æ¥è¿›è¡Œ diff
          
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Run Architecture Compliance Check
        run: |
          echo "ðŸ” å¼€å§‹æž¶æž„åˆè§„æ€§æ£€æŸ¥..."
          echo ""
          echo "ðŸ“‹ å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ðŸ“‹ åŸºå‡†åˆ†æ”¯: ${{ github.base_ref || 'main' }}"
          echo ""
          
          # ç¡®å®šæ£€æŸ¥æ¨¡å¼
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ðŸ”„ PR æ¨¡å¼ï¼šä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶"
            python tools/architecture_checker.py \
              --changed-only \
              --diff "origin/${{ github.base_ref }}" \
              --strict
          else
            echo "ðŸ“¦ Push æ¨¡å¼ï¼šæ£€æŸ¥å…¨éƒ¨æ–‡ä»¶"
            python tools/architecture_checker.py --strict
          fi
          
      - name: Architecture Check Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ æž¶æž„åˆè§„æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $? -eq 0 ]; then
            echo "âœ… **æ£€æŸ¥é€šè¿‡** - ä»£ç ç¬¦åˆ SAGE æž¶æž„è®¾è®¡è§„èŒƒ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ£€æŸ¥å¤±è´¥** - å‘çŽ°æž¶æž„è¿è§„é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶å‚è€ƒä»¥ä¸‹æ–‡æ¡£ä¿®å¤é—®é¢˜ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- [SAGE åŒ…æž¶æž„æ–‡æ¡£](../docs/PACKAGE_ARCHITECTURE.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [ä¾èµ–è§„åˆ™è¯´æ˜Ž](../docs/PACKAGE_ARCHITECTURE.md#-ä¾èµ–è§„åˆ™)" >> $GITHUB_STEP_SUMMARY
          fi
