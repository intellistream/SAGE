name: Sync main to main-dev

on:
  push:
    branches:
      - main
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# Permissions for the workflow
permissions:
  contents: write  # Allow pushing to repository
  pull-requests: read  # Allow reading PR information

jobs:
  sync:
    runs-on: ubuntu-latest
    # è·³è¿‡ä»¥ä¸‹æƒ…å†µ:
    # 1. ç‰ˆæœ¬å‡çº§ commit (ä¼šåœ¨æ‰‹åŠ¨å‘å¸ƒæ—¶åŒæ­¥)
    # 2. ä»Ž main-dev merge æ¥çš„ PR (é¿å…å¾ªçŽ¯)
    # 3. å·²ç»åŒ…å« [skip ci] æˆ– [sync] æ ‡è®°çš„ commit
    if: |
      !contains(github.event.head_commit.message, '[version bump]') &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[sync]') &&
      !startsWith(github.event.head_commit.message, 'Main dev (#')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿ rebase
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync main to main-dev (fast-forward merge)
        run: |
          echo "ðŸ”„ Starting sync from main to main-dev..."

          # Fetch latest main-dev
          git fetch origin main-dev

          # Checkout main-dev
          git checkout main-dev

          # æ£€æŸ¥ main-dev æ˜¯å¦å·²ç»åŒ…å« main çš„æ‰€æœ‰ commits
          BEHIND=$(git rev-list --count main-dev..main)
          AHEAD=$(git rev-list --count main..main-dev)

          echo "main-dev is $BEHIND commits behind main"
          echo "main-dev is $AHEAD commits ahead of main"

          if [ "$BEHIND" -eq 0 ]; then
            echo "âœ… main-dev is already up to date with main"
            exit 0
          fi

          # ä½¿ç”¨ rebase è€Œä¸æ˜¯ mergeï¼Œä¿æŒçº¿æ€§åŽ†å²
          echo "ðŸ“ Rebasing main-dev onto main..."
          if git rebase main; then
            echo "âœ… Rebase successful"
          else
            echo "âš ï¸ Rebase has conflicts, attempting auto-resolution..."

            # å¯¹äºŽ _version.py æ–‡ä»¶ï¼Œä½¿ç”¨ main çš„ç‰ˆæœ¬ï¼ˆå› ä¸º main æ˜¯æ­£å¼ç‰ˆæœ¬ï¼‰
            git status --porcelain | grep '^UU' | awk '{print $2}' | while read file; do
              if [[ "$file" == *"_version.py" ]]; then
                echo "  ðŸ“Œ Resolving $file: using main version"
                git checkout --ours "$file"  # ours = main (rebase çš„ç›®æ ‡)
                git add "$file"
              fi
            done

            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªè§£å†³çš„å†²çª
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "âŒ Unresolved conflicts remain:"
              git diff --name-only --diff-filter=U
              echo ""
              echo "Aborting rebase and switching to merge strategy..."
              git rebase --abort

              # å°è¯•ä½¿ç”¨ merge ç­–ç•¥
              if git merge main -m "chore: sync main to main-dev [sync]"; then
                echo "âœ… Merge successful"
              else
                echo "âŒ Both rebase and merge failed. Manual intervention required."
                exit 1
              fi
            else
              # æ‰€æœ‰å†²çªå·²è§£å†³ï¼Œç»§ç»­ rebase
              git rebase --continue || true
            fi
          fi

          # æŽ¨é€åˆ°è¿œç¨‹
          echo "ðŸš€ Pushing to main-dev..."
          git push origin main-dev --force-with-lease

          echo "âœ… Sync completed successfully"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Successfully synced main to main-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Target branch**: main-dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "main-dev is now up to date with main! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Failed to sync main to main-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Automatic sync failed due to conflicts.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Resolution Steps:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git checkout main-dev" >> $GITHUB_STEP_SUMMARY
          echo "git fetch origin main" >> $GITHUB_STEP_SUMMARY
          echo "git rebase origin/main  # æˆ–ä½¿ç”¨ git merge origin/main" >> $GITHUB_STEP_SUMMARY
          echo "# è§£å†³å†²çªåŽ:" >> $GITHUB_STEP_SUMMARY
          echo "git add ." >> $GITHUB_STEP_SUMMARY
          echo "git rebase --continue  # æˆ– git commit (å¦‚æžœä½¿ç”¨ merge)" >> $GITHUB_STEP_SUMMARY
          echo "git push origin main-dev --force-with-lease" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Fix (ä½¿ç”¨ main çš„ç‰ˆæœ¬è¦†ç›–):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git checkout main-dev" >> $GITHUB_STEP_SUMMARY
          echo "git reset --hard origin/main" >> $GITHUB_STEP_SUMMARY
          echo "git push origin main-dev --force" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
