name: Sync main to main-dev

on:
  push:
    branches:
      - main
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# Permissions for the workflow
permissions:
  contents: write  # Allow pushing to repository
  pull-requests: read  # Allow reading PR information

jobs:
  sync:
    runs-on: ubuntu-latest
    # è·³è¿‡ä»¥ä¸‹æƒ…å†µ:
    # 1. ç‰ˆæœ¬å‡çº§ commitï¼ˆä¼šåœ¨æ‰‹åŠ¨å‘å¸ƒæ—¶å¤„ç†ï¼‰
    # 2. å·²ç»åŒ…å« [skip ci] æˆ– [sync] æ ‡è®°çš„ commit
    #
    # æ³¨æ„: ä¸å†è·³è¿‡ "Main dev (#" commitï¼
    # åŽŸå› : main-dev PR merge åˆ° main åŽï¼Œéœ€è¦å°† main çš„çŠ¶æ€åŒæ­¥å›ž main-dev
    # workflow å†…éƒ¨ä¼šæ£€æŸ¥æ˜¯å¦å·²åŒæ­¥ï¼Œå¦‚æžœå·²åŒæ­¥ä¼šè‡ªåŠ¨è·³è¿‡
    if: |
      !contains(github.event.head_commit.message, '[version bump]') &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[sync]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿ rebase
          token: ${{ secrets.PAT_TOKEN }}
          submodules: 'recursive'  # åŒæ­¥ submodules

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync submodules main to main-dev
        id: sync_submodules
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "## ðŸ”„ Syncing Submodules from main to main-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Submodule | Status | Changes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Initialize counters using files to avoid subshell issues
          echo "0" > /tmp/success_count.txt
          echo "0" > /tmp/uptodate_count.txt
          echo "0" > /tmp/failed_count.txt
          rm -f /tmp/failed_submodules.txt
          touch /tmp/failed_submodules.txt

          # Get submodule list into an array (avoid pipe subshell)
          mapfile -t SUBMODULES < <(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')

          for submodule_path in "${SUBMODULES[@]}"; do
            if [ ! -d "$submodule_path" ]; then
              continue
            fi

            echo "Processing: $submodule_path"

            cd "$submodule_path"

            # Configure authentication for this submodule
            remote_url=$(git remote get-url origin)
            auth_url=$(echo "$remote_url" | sed "s|https://github.com/|https://x-access-token:${PAT_TOKEN}@github.com/|")
            git remote set-url origin "$auth_url"

            # Fetch all branches
            git fetch origin --prune

            # Check if main and main-dev branches exist
            has_main=$(git ls-remote --heads origin main | wc -l)
            has_main_dev=$(git ls-remote --heads origin main-dev | wc -l)

            if [ "$has_main" -eq 0 ] || [ "$has_main_dev" -eq 0 ]; then
              echo "| $submodule_path | â­ï¸ Skipped | Missing main or main-dev branch |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/uptodate_count.txt) + 1)) > /tmp/uptodate_count.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            # Check if main-dev is behind main
            BEHIND=$(git rev-list --count origin/main-dev..origin/main 2>/dev/null || echo "0")

            if [ "$BEHIND" -eq 0 ]; then
              echo "| $submodule_path | âœ… Up to date | No changes |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/uptodate_count.txt) + 1)) > /tmp/uptodate_count.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            echo "  main-dev is $BEHIND commits behind main, syncing..."

            # Checkout main-dev
            git checkout main-dev 2>/dev/null || git checkout -b main-dev origin/main-dev
            git pull origin main-dev --ff-only 2>/dev/null || true

            # Try fast-forward merge first
            if git merge origin/main --ff-only 2>/dev/null; then
              echo "  Fast-forward merge successful"
            else
              # Try regular merge
              if git merge origin/main -m "chore: sync main to main-dev [sync]" 2>/dev/null; then
                echo "  Merge successful"
              else
                echo "| $submodule_path | âŒ Failed | Merge conflict |" >> $GITHUB_STEP_SUMMARY
                git merge --abort 2>/dev/null || true
                echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
                echo "$submodule_path" >> /tmp/failed_submodules.txt
                git remote set-url origin "$remote_url"
                cd - > /dev/null
                continue
              fi
            fi

            # Push changes
            if git push origin main-dev 2>/dev/null; then
              echo "| $submodule_path | âœ… Synced | $BEHIND commits merged |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/success_count.txt) + 1)) > /tmp/success_count.txt
            else
              echo "| $submodule_path | âŒ Failed | Push failed |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
              echo "$submodule_path" >> /tmp/failed_submodules.txt
            fi

            # Restore original URL
            git remote set-url origin "$remote_url"
            cd - > /dev/null
          done

          # Read counters from files
          SUCCESS_COUNT=$(cat /tmp/success_count.txt)
          UPTODATE_COUNT=$(cat /tmp/uptodate_count.txt)
          FAILED_COUNT=$(cat /tmp/failed_count.txt)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Submodule Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Successfully synced: $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  Already up to date: $UPTODATE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY

          # Set outputs
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "âš ï¸  Some submodules failed to sync. Check the summary above."
          fi

      - name: Sync main to main-dev (fast-forward merge)
        run: |
          echo "ðŸ”„ Starting sync from main to main-dev..."

          # Fetch latest main-dev
          git fetch origin main-dev

          # Checkout main-dev
          git checkout main-dev

          # æ£€æŸ¥ main-dev æ˜¯å¦å·²ç»åŒ…å« main çš„æ‰€æœ‰ commits
          BEHIND=$(git rev-list --count main-dev..main)
          AHEAD=$(git rev-list --count main..main-dev)

          echo "main-dev is $BEHIND commits behind main"
          echo "main-dev is $AHEAD commits ahead of main"

          if [ "$BEHIND" -eq 0 ]; then
            echo "âœ… main-dev is already up to date with main"
            exit 0
          fi

          # ä½¿ç”¨ rebase è€Œä¸æ˜¯ mergeï¼Œä¿æŒçº¿æ€§åŽ†å²
          echo "ðŸ“ Rebasing main-dev onto main..."
          if git rebase main; then
            echo "âœ… Rebase successful"
          else
            echo "âš ï¸ Rebase has conflicts, attempting auto-resolution..."

            # å¯¹äºŽ _version.py æ–‡ä»¶ï¼Œä½¿ç”¨ main çš„ç‰ˆæœ¬ï¼ˆå› ä¸º main æ˜¯æ­£å¼ç‰ˆæœ¬ï¼‰
            git status --porcelain | grep '^UU' | awk '{print $2}' | while read file; do
              if [[ "$file" == *"_version.py" ]]; then
                echo "  ðŸ“Œ Resolving $file: using main version"
                git checkout --ours "$file"  # ours = main (rebase çš„ç›®æ ‡)
                git add "$file"
              fi
            done

            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªè§£å†³çš„å†²çª
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "âŒ Unresolved conflicts remain:"
              git diff --name-only --diff-filter=U
              echo ""
              echo "Aborting rebase and switching to merge strategy..."
              git rebase --abort

              # å°è¯•ä½¿ç”¨ merge ç­–ç•¥
              if git merge main -m "chore: sync main to main-dev [sync]"; then
                echo "âœ… Merge successful"
              else
                echo "âŒ Both rebase and merge failed. Manual intervention required."
                exit 1
              fi
            else
              # æ‰€æœ‰å†²çªå·²è§£å†³ï¼Œç»§ç»­ rebase
              git rebase --continue || true
            fi
          fi

          # æŽ¨é€åˆ°è¿œç¨‹
          echo "ðŸš€ Pushing to main-dev..."
          git push origin main-dev --force-with-lease

          echo "âœ… Sync completed successfully"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Successfully synced main to main-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Target branch**: main-dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "main-dev is now up to date with main! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Failed to sync main to main-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Automatic sync failed due to conflicts.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Resolution Steps:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git checkout main-dev" >> $GITHUB_STEP_SUMMARY
          echo "git fetch origin main" >> $GITHUB_STEP_SUMMARY
          echo "git rebase origin/main  # æˆ–ä½¿ç”¨ git merge origin/main" >> $GITHUB_STEP_SUMMARY
          echo "# è§£å†³å†²çªåŽ:" >> $GITHUB_STEP_SUMMARY
          echo "git add ." >> $GITHUB_STEP_SUMMARY
          echo "git rebase --continue  # æˆ– git commit (å¦‚æžœä½¿ç”¨ merge)" >> $GITHUB_STEP_SUMMARY
          echo "git push origin main-dev --force-with-lease" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Fix (ä½¿ç”¨ main çš„ç‰ˆæœ¬è¦†ç›–):" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git checkout main-dev" >> $GITHUB_STEP_SUMMARY
          echo "git reset --hard origin/main" >> $GITHUB_STEP_SUMMARY
          echo "git push origin main-dev --force" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
