name: Build and Test

on:
  push:
    branches: [main, main-dev]
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified-prod

jobs:
  build-and-test:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Skip version bump commits to avoid unnecessary CI runs
    if: ${{ !contains(github.event.head_commit.message, '[version bump]') }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true
          submodules: 'recursive'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Create .env File from Secrets
        run: |
          echo "ğŸ” ä» GitHub Secrets åˆ›å»º .env æ–‡ä»¶..."
          cat > .env << EOF
          # CI Environment Configuration (Auto-generated from GitHub Secrets)

          # LLM Service API Keys
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
          OPENAI_MODEL_NAME=qwen-turbo-2025-02-11

          SILICONCLOUD_API_KEY=${{ secrets.SILICONCLOUD_API_KEY }}
          JINA_API_KEY=${{ secrets.JINA_API_KEY }}
          ALIBABA_API_KEY=${{ secrets.ALIBABA_API_KEY }}

          VLLM_API_KEY=${{ secrets.VLLM_API_KEY }}
          VLLM_BASE_URL=http://localhost:8000/v1
          VLLM_MODEL_NAME=meta-llama/Llama-2-13b-chat-hf

          WEB_SEARCH_API_KEY=${{ secrets.WEB_SEARCH_API_KEY }}

          # GitHub Token
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}

          # Hugging Face
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          HF_ENDPOINT=https://hf-mirror.com

          # CI/CD Settings
          SAGE_DEBUG=false
          SAGE_SKIP_CPP_EXTENSIONS=false
          SAGE_LOG_LEVEL=INFO
          SAGE_TEST_MODE=true
          SAGE_EXAMPLES_MODE=test
          EOF

          echo "âœ… .env æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: Install System Dependencies
        run: |
          echo "ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libopenblas-dev \
            liblapack-dev \
            git

          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Verify Submodules
        run: |
          echo "ğŸ” éªŒè¯Gitå­æ¨¡å—..."
          git submodule status

          echo ""
          echo "ğŸ” éªŒè¯å…³é”®å­æ¨¡å—ç›®å½•ï¼š"
          all_ok=true
          for submodule in \
            "packages/sage-middleware/src/sage/middleware/components/sage_db/sageDB" \
            "packages/sage-middleware/src/sage/middleware/components/sage_flow/sageFlow" \
            "packages/sage-middleware/src/sage/middleware/components/sage_tsdb/sageTSDB"; do
            if [ -d "$submodule" ]; then
              # Check if directory is not empty
              if [ -n "$(ls -A "$submodule" 2>/dev/null)" ]; then
                echo "âœ… $submodule å­˜åœ¨ä¸”å·²åˆå§‹åŒ–"
              else
                echo "âš ï¸  $submodule å­˜åœ¨ä½†ä¸ºç©ºï¼ˆæœªåˆå§‹åŒ–ï¼‰"
                all_ok=false
              fi
            else
              echo "âŒ $submodule ç¼ºå¤±"
              all_ok=false
            fi
          done

          if [ "$all_ok" = "false" ]; then
            echo ""
            echo "âš ï¸  æŸäº›å­æ¨¡å—æœªæ­£ç¡®åˆå§‹åŒ–"
            echo "ğŸ’¡ C++æ‰©å±•æ„å»ºå¯èƒ½ä¼šè·³è¿‡ç›¸å…³ç»„ä»¶"
          fi

      - name: Install SAGE
        run: |
          echo "ğŸš€ å®‰è£…SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼Œå¯ç¼–è¾‘å®‰è£… + C++æ‰©å±•ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"
          chmod +x ./quickstart.sh

          echo "å¼€å§‹å®‰è£…..."
          # ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼Œè¿™æ ·ä¼šè¿›è¡Œå¯ç¼–è¾‘å®‰è£…ï¼ˆpip install -eï¼‰ï¼Œ.soæ–‡ä»¶ä¼šåœ¨æºç ç›®å½•ä¸­
          ./quickstart.sh --dev --yes

          echo "âœ… å®‰è£…å®Œæˆ"
        timeout-minutes: 25

      - name: Verify C++ Extensions
        run: |
          echo "ğŸ§© éªŒè¯C++æ‰©å±•å®‰è£…çŠ¶æ€..."

          # æ£€æŸ¥.soæ–‡ä»¶ï¼ˆåœ¨æºç ç›®å½•ä¸­ï¼Œå› ä¸ºæ˜¯å¼€å‘æ¨¡å¼å¯ç¼–è¾‘å®‰è£…ï¼‰
          echo "ğŸ“ æ£€æŸ¥å·²ç¼–è¯‘çš„.soæ–‡ä»¶:"
          so_files=$(find packages/sage-middleware/src/sage/middleware/components/ \( -name "_sage_*.so" -o -name "*.cpython-*.so" \) -type f 2>/dev/null || true)

          if [ -n "$so_files" ]; then
            echo "âœ… æ‰¾åˆ°C++æ‰©å±•æ–‡ä»¶:"
            echo "$so_files" | while read -r file; do
              echo "  - $file ($(stat -c%s "$file" 2>/dev/null || stat -f%z "$file") bytes)"
            done
          else
            echo "âš ï¸  æœªæ‰¾åˆ°.soæ–‡ä»¶ï¼Œæ£€æŸ¥è¯¦ç»†ç›®å½•ç»“æ„..."
            echo ""
            echo "ğŸ” æ£€æŸ¥æ‰©å±•ç»„ä»¶ç›®å½•ç»“æ„:"
            for component in sage_flow sage_db sage_tsdb; do
              component_dir="packages/sage-middleware/src/sage/middleware/components/$component"
              if [ -d "$component_dir" ]; then
                echo ""
                echo "ğŸ“¦ $component:"
                echo "  ğŸ“‚ é¡¶çº§ç›®å½•å†…å®¹:"
                ls -la "$component_dir/" 2>/dev/null | head -20 || echo "  âŒ æ— æ³•åˆ—å‡ºç›®å½•"

                if [ -d "$component_dir/python" ]; then
                  echo "  ğŸ“‚ python/ ç›®å½•å†…å®¹:"
                  ls -la "$component_dir/python/" 2>/dev/null || echo "  âŒ æ— æ³•åˆ—å‡ºpython/ç›®å½•"
                else
                  echo "  âŒ python/ ç›®å½•ä¸å­˜åœ¨"
                fi

                # Check for submodules
                submodule_path=$(find "$component_dir" -maxdepth 1 -type d -iname "sage${component#sage_}" 2>/dev/null | head -1 || true)
                if [ -n "$submodule_path" ]; then
                  echo "  ğŸ“‚ å­æ¨¡å—: $(basename $submodule_path)"
                  if [ -z "$(ls -A "$submodule_path" 2>/dev/null)" ]; then
                    echo "    âš ï¸  å­æ¨¡å—ç›®å½•ä¸ºç©ºï¼ˆå¯èƒ½æœªåˆå§‹åŒ–ï¼‰"
                  else
                    echo "    âœ… å­æ¨¡å—å·²åˆå§‹åŒ–"
                  fi
                fi

                # Check for build artifacts
                if [ -d "$component_dir/build" ]; then
                  echo "  ğŸ“‚ build/ ç›®å½•å­˜åœ¨"
                  find "$component_dir/build" -name "*.so" -type f 2>/dev/null | head -3 | sed 's/^/    /' || true
                fi
              fi
            done
          fi

          # æµ‹è¯•æ‰©å±•å¯¼å…¥
          echo ""


          echo "ğŸ” æµ‹è¯•æ‰©å±•Pythonå¯¼å…¥:"
          python -c "
          import sys
          import warnings
          import os

          # å¿½ç•¥æ‰©å±•ä¸å¯ç”¨çš„è­¦å‘Šï¼Œåªå…³æ³¨å®é™…å¯¼å…¥é”™è¯¯
          warnings.filterwarnings('ignore', category=UserWarning)

          print('Python ç¯å¢ƒä¿¡æ¯:')
          print(f'  å¯æ‰§è¡Œæ–‡ä»¶: {sys.executable}')
          print(f'  å·¥ä½œç›®å½•: {os.getcwd()}')
          print(f'  sys.path å‰3é¡¹:')
          for path in sys.path[:3]:
              print(f'    - {path}')

          try:
              from sage.middleware.components.extensions_compat import check_extensions_availability
              available = check_extensions_availability()
              total = sum(available.values())
              print()
              print(f'ğŸ§© æ‰©å±•å¯ç”¨æ€§: {total}/{len(available)}')
              for ext, status in available.items():
                  symbol = 'âœ…' if status else 'âŒ'
                  print(f'  {symbol} {ext}: {\"å¯ç”¨\" if status else \"ä¸å¯ç”¨\"}')

              # å¦‚æœä»»ä½•æ‰©å±•ä¸å¯ç”¨ï¼Œå°è¯•æä¾›è¯Šæ–­ä¿¡æ¯
              if total < len(available):
                  print()
                  print('ğŸ” è¯Šæ–­ä¿¡æ¯:')
                  for ext, status in available.items():
                      if not status:
                          module_name = f'sage.middleware.components.{ext}.python._{ext}'
                          print(f'  å°è¯•ç›´æ¥å¯¼å…¥ {module_name}:')
                          try:
                              __import__(module_name)
                              print(f'    âœ… æ¨¡å—å¯¼å…¥æˆåŠŸï¼ˆä½†æ‰©å±•æ£€æŸ¥å¤±è´¥ï¼Ÿï¼‰')
                          except Exception as import_error:
                              print(f'    âŒ å¯¼å…¥å¤±è´¥: {import_error}')

              # C++æ‰©å±•åœ¨å¼€å‘æ¨¡å¼ä¸­åº”è¯¥èƒ½å¤ŸæˆåŠŸæ„å»º
              # ä½†å¦‚æœå­æ¨¡å—æœªåˆå§‹åŒ–ï¼ŒæŸäº›æ‰©å±•å¯èƒ½ä¸å¯ç”¨
              if total == 0:
                  print()
                  print('âŒ é”™è¯¯: æ²¡æœ‰C++æ‰©å±•å¯ç”¨')
                  print('ğŸ’¡ è¿™è¡¨æ˜C++æ‰©å±•æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š')
                  print('   1. å­æ¨¡å—æ˜¯å¦å·²åˆå§‹åŒ– (git submodule status)')
                  print('   2. æ„å»ºä¾èµ–æ˜¯å¦å·²å®‰è£… (cmake, build-essential)')
                  print('   3. ä¸Šæ–¹çš„æ„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯')
                  sys.exit(1)
              else:
                  print()
                  print(f'âœ… {total}ä¸ªæ‰©å±•æˆåŠŸæ„å»ºå¹¶å¯ç”¨')
                  if total < len(available):
                      print(f'âš ï¸  è­¦å‘Š: {len(available) - total}ä¸ªæ‰©å±•ä¸å¯ç”¨ï¼ˆå¯èƒ½æ˜¯å­æ¨¡å—æœªåˆå§‹åŒ–ï¼‰')
                      print('   è¿™ä¸ä¼šå¯¼è‡´æ„å»ºå¤±è´¥ï¼Œä½†æŸäº›åŠŸèƒ½å¯èƒ½å—é™')
          except ImportError as e:
              print(f'âŒ æ‰©å±•æ£€æŸ¥æ¨¡å—ä¸å¯ç”¨: {e}')
              print('âš ï¸ è¿™å¯èƒ½è¡¨ç¤ºSAGEæœªæ­£ç¡®å®‰è£…')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"

          # éªŒè¯CLI
          if command -v sage-dev >/dev/null 2>&1; then
            sage-dev --help > /dev/null && echo "âœ… sage-dev CLIå¯ç”¨"
          else
            echo "âŒ sage-dev CLIä¸å¯ç”¨"
            exit 1
          fi

      - name: Run Unit Tests with Coverage
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡..."
          echo "ä½¿ç”¨ sage-dev project test --coverage å‘½ä»¤"

          # ä½¿ç”¨ sage-dev è¿è¡Œæµ‹è¯•ï¼ˆæ’é™¤æ…¢é€Ÿæµ‹è¯•ï¼‰
          # æ³¨æ„ï¼šä¸å†ä½¿ç”¨ || exit 0ï¼Œæµ‹è¯•å¤±è´¥æ—¶CIåº”è¯¥å¤±è´¥
          sage-dev project test --coverage \
            --coverage-report term,xml,html \
            --jobs 4 \
            --timeout 300 \
            --continue-on-error || {
              echo "âŒ æµ‹è¯•å¤±è´¥"
              exit 1
            }

          # å°†è¦†ç›–ç‡æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ä»¥ä¾¿ä¸Šä¼ 
          if [ -f ".sage/coverage/coverage.xml" ]; then
            cp .sage/coverage/coverage.xml ./coverage.xml
            echo "âœ… è¦†ç›–ç‡XMLæ–‡ä»¶å·²å¤åˆ¶åˆ°æ ¹ç›®å½•"
          else
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è¦†ç›–ç‡XMLæ–‡ä»¶"
          fi

          if [ -d ".sage/coverage/htmlcov" ]; then
            cp -r .sage/coverage/htmlcov ./htmlcov
            echo "âœ… è¦†ç›–ç‡HTMLæŠ¥å‘Šå·²å¤åˆ¶åˆ°æ ¹ç›®å½•"
          else
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è¦†ç›–ç‡HTMLç›®å½•"
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-sage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
            .sage/logs/
          retention-days: 30

      - name: Upload Test Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .sage/logs/
            .sage/reports/
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æ„å»ºæˆåŠŸ** - æ‰€æœ‰æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY

            # æ˜¾ç¤ºè¦†ç›–ç‡æ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "coverage.xml" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ“Š æµ‹è¯•è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
              echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯¦è§ Artifacts" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **æ„å»ºå¤±è´¥** - è¯·æŸ¥çœ‹æ—¥å¿—å’Œæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æµ‹è¯•æ—¥å¿—å·²ä¸Šä¼ åˆ° Artifactsï¼Œè¯·ä¸‹è½½æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
