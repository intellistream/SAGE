# SAGE Studio Docker éƒ¨ç½²
#
# è¿™ä¸ª workflow æž„å»º Docker é•œåƒå¹¶éƒ¨ç½²åˆ° self-hosted runner
#
# æž¶æž„:
#   GitHub Actions (ubuntu-latest) â†’ æž„å»ºé•œåƒ â†’ æŽ¨é€åˆ° GHCR
#   Self-hosted Runner (A100) â†’ æ‹‰å–é•œåƒ â†’ å¯åŠ¨å®¹å™¨
#   cloudflared (Host systemd) â†’ è½¬å‘è¯·æ±‚åˆ°å®¹å™¨

name: Deploy SAGE Studio (Docker)

on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'è·³è¿‡æž„å»ºï¼Œä»…éƒ¨ç½²å·²æœ‰é•œåƒ'
        type: boolean
        default: false
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤ latestï¼‰'
        default: 'latest'

  push:
    branches:
      - main
      - feature/studio_deployment
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'
      - 'docker/studio/**'
      - '.github/workflows/deploy-studio-docker.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: intellistream/sage-studio

jobs:
  # Job 1: æž„å»º Docker é•œåƒï¼ˆåœ¨ GitHub hosted runner ä¸Šï¼‰
  build:
    if: ${{ github.event.inputs.skip_build != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=
            type=ref,event=branch

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/studio/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ä¸åŒ…å« GPU å±‚ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ NVIDIA runtime
          build-args: |
            CUDA_VERSION=12.1.0
            UBUNTU_VERSION=22.04

      - name: Image summary
        run: |
          echo "## ðŸ³ Docker é•œåƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å±žæ€§ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| é•œåƒ | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ‡ç­¾ | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # Job 2: éƒ¨ç½²åˆ° self-hosted runner
  deploy:
    needs: [build]
    if: always() && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')
    runs-on: [self-hosted, A100]
    timeout-minutes: 30

    env:
      IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}

    steps:
      - name: Checkout (for docker-compose.yml)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker/studio

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Stop existing container
        continue-on-error: true
        run: |
          echo "ðŸ›‘ åœæ­¢çŽ°æœ‰å®¹å™¨..."
          docker stop sage-studio 2>/dev/null || true
          docker rm sage-studio 2>/dev/null || true

      - name: Pull latest image
        run: |
          echo "ðŸ“¥ æ‹‰å–é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Start container
        run: |
          echo "ðŸš€ å¯åŠ¨å®¹å™¨..."

          docker run -d \
            --name sage-studio \
            --restart unless-stopped \
            --gpus all \
            -p 5173:5173 \
            -p 8888:8888 \
            -v sage-models:/root/.cache/huggingface \
            -v sage-data:/root/.sage \
            -v sage-local-share:/root/.local/share/sage \
            -v sage-local-state:/root/.local/state/sage \
            -e HF_ENDPOINT=https://hf-mirror.com \
            -e SAGE_STUDIO_LLM_MODEL=Qwen/Qwen2.5-7B-Instruct \
            -e SAGE_STUDIO_LLM_GPU_MEMORY=0.9 \
            -e SAGE_LLM_STARTUP_TIMEOUT=600 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          echo "âœ… å®¹å™¨å·²å¯åŠ¨"

      - name: Wait for service
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."

          MAX_WAIT=120
          for i in $(seq 1 $MAX_WAIT); do
            if curl -sf http://localhost:5173 > /dev/null 2>&1; then
              echo "âœ… Studio æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi

            if [ $((i % 30)) -eq 0 ]; then
              echo "â³ ç­‰å¾…ä¸­... ($i/$MAX_WAIT ç§’)"
              echo "   å®¹å™¨çŠ¶æ€:"
              docker ps --filter name=sage-studio --format "table {{.Status}}\t{{.Ports}}"
              echo "   æœ€è¿‘æ—¥å¿—:"
              docker logs --tail 10 sage-studio 2>&1 || true
            fi

            sleep 1
          done

          # æœ€ç»ˆæ£€æŸ¥
          if ! curl -sf http://localhost:5173 > /dev/null 2>&1; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            echo ""
            echo "=== å®¹å™¨æ—¥å¿— ==="
            docker logs --tail 100 sage-studio
            exit 1
          fi

      - name: Health check
        run: |
          echo "ðŸ” å¥åº·æ£€æŸ¥..."
          echo ""

          # æ£€æŸ¥å„æœåŠ¡
          echo "| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |"
          echo "|------|------|------|"

          if curl -sf http://localhost:5173 > /dev/null 2>&1; then
            echo "| Studio å‰ç«¯ | 5173 | âœ… æ­£å¸¸ |"
          else
            echo "| Studio å‰ç«¯ | 5173 | âŒ å¼‚å¸¸ |"
          fi

          if curl -sf http://localhost:8888/health > /dev/null 2>&1; then
            echo "| Gateway | 8888 | âœ… æ­£å¸¸ |"
          else
            echo "| Gateway | 8888 | âš ï¸ å¯åŠ¨ä¸­ |"
          fi

          # GPU çŠ¶æ€
          echo ""
          echo "=== GPU çŠ¶æ€ ==="
          docker exec sage-studio nvidia-smi --query-gpu=name,memory.used,memory.free --format=csv 2>/dev/null || echo "GPU ä¿¡æ¯ä¸å¯ç”¨"

      - name: Verify Cloudflare Tunnel
        continue-on-error: true
        run: |
          echo "ðŸŒ æ£€æŸ¥ Cloudflare Tunnel..."

          if systemctl is-active --quiet cloudflared; then
            echo "âœ… cloudflared ç³»ç»ŸæœåŠ¡è¿è¡Œä¸­"
          else
            echo "âš ï¸ cloudflared æœªè¿è¡Œ"
          fi

          # æµ‹è¯•å…¬ç½‘è®¿é—®
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://studio.sage.org.ai 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… https://studio.sage.org.ai å¯è®¿é—®"
          else
            echo "âš ï¸ å…¬ç½‘è®¿é—®è¿”å›ž HTTP $HTTP_CODE"
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ SAGE Studio éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–¹å¼ | åœ°å€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ Cloudflare Tunnel | https://studio.sage.org.ai |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ  æœ¬åœ° | http://localhost:5173 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ å®¹å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker ps --filter name=sage-studio --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æŸ¥çœ‹æ—¥å¿—: \`docker logs -f sage-studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- é‡å¯: \`docker restart sage-studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- åœæ­¢: \`docker stop sage-studio\`" >> $GITHUB_STEP_SUMMARY
