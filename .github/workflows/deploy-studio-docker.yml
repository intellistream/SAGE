# SAGE Studio Docker éƒ¨ç½²ï¼ˆæœ¬åœ°æ„å»ºæ¨¡å¼ï¼‰
#
# åœ¨ self-hosted runner ä¸Šç›´æ¥æ„å»ºå’Œè¿è¡Œï¼Œä¸æ¨é€åˆ° registry
#
# æ¶æ„:
#   Self-hosted Runner (A100) â†’ æœ¬åœ°æ„å»ºé•œåƒ â†’ æœ¬åœ°è¿è¡Œå®¹å™¨
#   cloudflared (Host systemd) â†’ è½¬å‘è¯·æ±‚åˆ°å®¹å™¨

name: Deploy SAGE Studio (Docker)

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        type: boolean
        default: false

  push:
    branches:
      - main
      - feature/studio_deployment
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'
      - 'docker/studio/**'
      - '.github/workflows/deploy-studio-docker.yml'

jobs:
  deploy:
    runs-on: [self-hosted, A100]
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check Docker
        run: |
          echo "ğŸ³ æ£€æŸ¥ Docker ç¯å¢ƒ..."
          docker --version
          docker info --format '{{.Driver}}'

          # æ£€æŸ¥ NVIDIA Container Toolkit
          if docker run --rm --gpus all nvidia/cuda:12.1.0-base-ubuntu22.04 nvidia-smi > /dev/null 2>&1; then
            echo "âœ… NVIDIA Container Toolkit æ­£å¸¸"
          else
            echo "âŒ NVIDIA Container Toolkit ä¸å¯ç”¨"
            exit 1
          fi

      - name: Stop existing container
        continue-on-error: true
        run: |
          echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
          docker stop sage-studio 2>/dev/null || true
          docker rm sage-studio 2>/dev/null || true

      - name: Build Docker image
        run: |
          echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."

          BUILD_ARGS=""
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "âš ï¸ å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆ--no-cacheï¼‰"
            BUILD_ARGS="--no-cache"
          fi

          docker build \
            $BUILD_ARGS \
            -t sage-studio:latest \
            -t sage-studio:${{ github.sha }} \
            -f docker/studio/Dockerfile \
            .

          echo "âœ… é•œåƒæ„å»ºå®Œæˆ"
          docker images sage-studio

      - name: Start container
        run: |
          echo "ğŸš€ å¯åŠ¨å®¹å™¨..."

          docker run -d \
            --name sage-studio \
            --restart unless-stopped \
            --gpus all \
            -p 5173:5173 \
            -p 8888:8888 \
            -v sage-models:/root/.cache/huggingface \
            -v sage-data:/root/.sage \
            -v sage-local-share:/root/.local/share/sage \
            -v sage-local-state:/root/.local/state/sage \
            -e HF_ENDPOINT=https://hf-mirror.com \
            -e SAGE_STUDIO_LLM_MODEL=Qwen/Qwen2.5-7B-Instruct \
            -e SAGE_STUDIO_LLM_GPU_MEMORY=0.9 \
            -e SAGE_LLM_STARTUP_TIMEOUT=600 \
            sage-studio:latest

          echo "âœ… å®¹å™¨å·²å¯åŠ¨"
          docker ps --filter name=sage-studio

      - name: Wait for service
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."

          MAX_WAIT=180
          for i in $(seq 1 $MAX_WAIT); do
            if curl -sf http://localhost:5173 > /dev/null 2>&1; then
              echo "âœ… Studio æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi

            if [ $((i % 30)) -eq 0 ]; then
              echo "â³ ç­‰å¾…ä¸­... ($i/$MAX_WAIT ç§’)"
              echo "   å®¹å™¨çŠ¶æ€:"
              docker ps --filter name=sage-studio --format "table {{.Status}}\t{{.Ports}}"
              echo "   æœ€è¿‘æ—¥å¿—:"
              docker logs --tail 10 sage-studio 2>&1 || true
            fi

            sleep 1
          done

          # æœ€ç»ˆæ£€æŸ¥
          if ! curl -sf http://localhost:5173 > /dev/null 2>&1; then
            echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
            echo ""
            echo "=== å®¹å™¨æ—¥å¿— ==="
            docker logs --tail 100 sage-studio
            exit 1
          fi

      - name: Health check
        run: |
          echo "ğŸ” å¥åº·æ£€æŸ¥..."
          echo ""

          # æ£€æŸ¥å„æœåŠ¡
          echo "| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |"
          echo "|------|------|------|"

          if curl -sf http://localhost:5173 > /dev/null 2>&1; then
            echo "| Studio å‰ç«¯ | 5173 | âœ… æ­£å¸¸ |"
          else
            echo "| Studio å‰ç«¯ | 5173 | âŒ å¼‚å¸¸ |"
          fi

          if curl -sf http://localhost:8888/health > /dev/null 2>&1; then
            echo "| Gateway | 8888 | âœ… æ­£å¸¸ |"
          else
            echo "| Gateway | 8888 | âš ï¸ å¯åŠ¨ä¸­ |"
          fi

          # GPU çŠ¶æ€
          echo ""
          echo "=== GPU çŠ¶æ€ ==="
          docker exec sage-studio nvidia-smi --query-gpu=name,memory.used,memory.free --format=csv 2>/dev/null || echo "GPU ä¿¡æ¯ä¸å¯ç”¨"

      - name: Verify Cloudflare Tunnel
        continue-on-error: true
        run: |
          echo "ğŸŒ æ£€æŸ¥ Cloudflare Tunnel..."

          if systemctl is-active --quiet cloudflared; then
            echo "âœ… cloudflared ç³»ç»ŸæœåŠ¡è¿è¡Œä¸­"
          else
            echo "âš ï¸ cloudflared æœªè¿è¡Œ"
          fi

          # æµ‹è¯•å…¬ç½‘è®¿é—®
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://studio.sage.org.ai 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… https://studio.sage.org.ai å¯è®¿é—®"
          else
            echo "âš ï¸ å…¬ç½‘è®¿é—®è¿”å› HTTP $HTTP_CODE"
          fi

      - name: Deployment summary
        run: |
          echo "## ğŸ‰ SAGE Studio éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–¹å¼ | åœ°å€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ Cloudflare Tunnel | https://studio.sage.org.ai |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ  æœ¬åœ° | http://localhost:5173 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ³ å®¹å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker ps --filter name=sage-studio --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æŸ¥çœ‹æ—¥å¿—: \`docker logs -f sage-studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- é‡å¯: \`docker restart sage-studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- åœæ­¢: \`docker stop sage-studio\`" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup old images
        continue-on-error: true
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          # ä¿ç•™æœ€æ–°çš„ 2 ä¸ªç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä»–çš„
          docker images sage-studio --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | \
            tail -n +3 | \
            awk '{print $1}' | \
            xargs -r docker rmi 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"
