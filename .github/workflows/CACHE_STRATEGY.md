# Dev-CI ç¼“å­˜ç­–ç•¥æ–‡æ¡£

## é—®é¢˜èƒŒæ™¯

### åŸå§‹é—®é¢˜
- `dev-ci.yml` æ²¡æœ‰ç¼“å­˜æœºåˆ¶ï¼Œå¯¼è‡´4ä¸ªjobï¼ˆbuild-sage, quick-check, examples-test, deployment-readyï¼‰éƒ½éœ€è¦å®Œæ•´å®‰è£…SAGE
- æ¯æ¬¡å®‰è£…åŒ…æ‹¬ç¼–è¯‘C++æ‰©å±•ï¼ˆsage_db, sage_flowï¼‰ï¼Œè€—æ—¶10-15åˆ†é’Ÿ
- æ€»CIæ—¶é—´ï¼šæ¯ä¸ªjob 15-20åˆ†é’Ÿ Ã— 4 = 60-80åˆ†é’Ÿ

### ä¹‹å‰å°è¯•çš„æ–¹æ¡ˆåŠé—®é¢˜
æ›¾ç»å®ç°è¿‡ç¼“å­˜æœºåˆ¶ï¼Œä½†åæ¥ç§»é™¤äº†ï¼ŒåŸå› ï¼š
- **å­æ¨¡å—å†²çª**ï¼šç¼“å­˜æ¢å¤çš„ç›®å½•ä¸ `git submodule update --init` å†²çª
- **è·¯å¾„é—®é¢˜**ï¼šC++æ‰©å±•åœ¨ç¼“å­˜æœºåˆ¶ä¸‹è¿æ¥è·¯å¾„ä¸æ­£ç¡®
- é”™è¯¯ä¿¡æ¯ï¼š`fatal: destination path '...sage_db' already exists and is not an empty directory`

## æ–°è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
ä½¿ç”¨**ç‹¬ç«‹ç¼“å­˜ç›®å½•** + **æ‰‹åŠ¨æ¢å¤**æœºåˆ¶ï¼Œé¿å…ä¸å­æ¨¡å—å†²çª

### å…³é”®æ”¹è¿›

#### 1. æ‰§è¡Œé¡ºåºè°ƒæ•´
```yaml
1. Checkout Repository
2. Setup Python
3. Initialize Submodules  â† å…ˆåˆå§‹åŒ–å­æ¨¡å—
4. Generate Cache Key
5. Cache C++ Build Artifacts  â† ä½¿ç”¨ç‹¬ç«‹ç›®å½•
6. Restore Cached Build Artifacts  â† æ‰‹åŠ¨æ¢å¤
7. Install SAGE
```

#### 2. ç‹¬ç«‹ç¼“å­˜ç›®å½•
ä¸ç›´æ¥ç¼“å­˜å­æ¨¡å—ç›®å½•ï¼Œè€Œæ˜¯ä½¿ç”¨ `.sage-build-cache/`:
```yaml
path: |
  ~/.cache/pip
  .sage-build-cache/  # ç‹¬ç«‹ç¼“å­˜ç›®å½•
```

ç¼“å­˜ç»“æ„ï¼š
```
.sage-build-cache/
â”œâ”€â”€ sage_db/
â”‚   â”œâ”€â”€ build/       # CMakeæ„å»ºäº§ç‰©
â”‚   â”œâ”€â”€ install/     # å®‰è£…æ–‡ä»¶
â”‚   â””â”€â”€ python/      # .soæ–‡ä»¶
â””â”€â”€ sage_flow/
    â”œâ”€â”€ build/
    â”œâ”€â”€ install/
    â””â”€â”€ python/
```

#### 3. æ‰‹åŠ¨æ¢å¤æœºåˆ¶
```bash
if [ "${{ steps.cache-extensions.outputs.cache-hit }}" == "true" ]; then
  # ä»ç‹¬ç«‹ç¼“å­˜ç›®å½•å¤åˆ¶åˆ°å­æ¨¡å—ç›®å½•
  cp -r .sage-build-cache/sage_db/build/* \
    packages/sage-middleware/.../sage_db/build/
  cp -r .sage-build-cache/sage_db/install/* \
    packages/sage-middleware/.../sage_db/install/
  cp .sage-build-cache/sage_db/python/*.so \
    packages/sage-middleware/.../sage_db/python/
fi
```

#### 4. æ‰‹åŠ¨ä¿å­˜æœºåˆ¶
```bash
if [ "${{ steps.cache-extensions.outputs.cache-hit }}" != "true" ]; then
  # ä»å­æ¨¡å—ç›®å½•å¤åˆ¶åˆ°ç¼“å­˜ç›®å½•
  mkdir -p .sage-build-cache/sage_db
  cp -r packages/sage-middleware/.../sage_db/build \
    .sage-build-cache/sage_db/
  # ... ä¿å­˜å…¶ä»–æ–‡ä»¶
fi
```

### ç¼“å­˜é”®ç­–ç•¥

#### ç¼“å­˜é”®ç»„æˆ
```bash
sage-v3-Linux-py311-${SAGE_CODE_HASH}-${SUBMODULE_HASH}-${BUILD_CONFIG_HASH}
```

- `sage-v3`: ç‰ˆæœ¬æ ‡è¯†ï¼ˆv3è¡¨ç¤ºæ–°ç­–ç•¥ï¼‰
- `Linux`: æ“ä½œç³»ç»Ÿ
- `py311`: Pythonç‰ˆæœ¬
- `SAGE_CODE_HASH`: Pythonå’ŒC++æºç çš„hash
- `SUBMODULE_HASH`: å­æ¨¡å—çŠ¶æ€hash
- `BUILD_CONFIG_HASH`: quickstart.shå’ŒCIé…ç½®hash

#### æ¸è¿›å¼å›é€€
```yaml
restore-keys: |
  sage-v3-Linux-py311-
```
å…è®¸éƒ¨åˆ†åŒ¹é…çš„ç¼“å­˜é”®ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡

### ç¼“å­˜å¤±æ•ˆæœºåˆ¶

è‡ªåŠ¨å¤±æ•ˆè§¦å‘æ¡ä»¶ï¼š
1. **ä»£ç å˜æ›´**ï¼šPythonæˆ–C++æºæ–‡ä»¶ä¿®æ”¹
2. **å­æ¨¡å—æ›´æ–°**ï¼šå­æ¨¡å—commitå˜åŒ–
3. **æ„å»ºé…ç½®å˜æ›´**ï¼šquickstart.shæˆ–CIé…ç½®ä¿®æ”¹
4. **ä¾èµ–å˜æ›´**ï¼špyproject.tomlä¿®æ”¹

## ä¼˜åŠ¿

### 1. é¿å…å†²çª
- âœ… å­æ¨¡å—å…ˆåˆå§‹åŒ–ï¼Œå†æ¢å¤ç¼“å­˜
- âœ… ç¼“å­˜å†…å®¹ä¸å­æ¨¡å—ç›®å½•å®Œå…¨åˆ†ç¦»
- âœ… ä¸ä¼šå‡ºç°"directory already exists"é”™è¯¯

### 2. èŠ‚çœæ—¶é—´
- âœ… ç¼“å­˜å‘½ä¸­æ—¶è·³è¿‡C++æ‰©å±•æ„å»ºï¼ˆ10-15åˆ†é’Ÿï¼‰
- âœ… æ¯ä¸ªjobç‹¬ç«‹ç¼“å­˜ï¼Œå¹¶è¡Œæ‰§è¡Œ
- âœ… é¢„æœŸCIæ—¶é—´å‡å°‘ï¼š60-80åˆ†é’Ÿ â†’ 30-40åˆ†é’Ÿ

### 3. å¯é æ€§
- âœ… ç¼“å­˜åŸºäºå†…å®¹hashï¼Œç¡®ä¿ä¸€è‡´æ€§
- âœ… editable installæ¯æ¬¡é‡æ–°æ‰§è¡Œï¼Œç¡®ä¿æ­£ç¡®é“¾æ¥
- âœ… æ”¯æŒæ¸è¿›å¼å›é€€ï¼Œæé«˜å‘½ä¸­ç‡

### 4. å¯ç»´æŠ¤æ€§
- âœ… æ¯ä¸ªjobä½¿ç”¨ç›¸åŒçš„ç¼“å­˜ç­–ç•¥ï¼Œæ˜“äºç»´æŠ¤
- âœ… ç¼“å­˜é”®è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†ç‰ˆæœ¬å·
- âœ… æ¸…æ™°çš„ç¼“å­˜çŠ¶æ€æŠ¥å‘Š

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
æ¯æ¬¡è¿è¡Œä¼šæ˜¾ç¤ºï¼š
```
ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŸºäºä»£ç å†…å®¹ï¼‰...
ğŸ“„ SAGEä»£ç hash: abc123...
ğŸ“¦ å­æ¨¡å—hash: def456...
âš™ï¸ æ„å»ºé…ç½®hash: ghi789...
ğŸ”‘ æœ€ç»ˆç¼“å­˜é”®: sage-v3-Linux-py311-...
âœ… ç¼“å­˜å‘½ä¸­ï¼æ¢å¤C++æ‰©å±•æ„å»ºäº§ç‰©...
```

### ç¼“å­˜æœªå‘½ä¸­çš„åŸå› 
å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œæ£€æŸ¥å“ªä¸ªhashå‘ç”Ÿäº†å˜åŒ–ï¼š
- SAGEä»£ç hashå˜åŒ– â†’ Pythonæˆ–C++æºæ–‡ä»¶è¢«ä¿®æ”¹
- å­æ¨¡å—hashå˜åŒ– â†’ å­æ¨¡å—commitæ›´æ–°
- æ„å»ºé…ç½®hashå˜åŒ– â†’ quickstart.shæˆ–CIé…ç½®ä¿®æ”¹

### å¼ºåˆ¶é‡å»ºç¼“å­˜
å¦‚æœéœ€è¦å¼ºåˆ¶é‡å»ºç¼“å­˜ï¼š
1. ä¿®æ”¹ `sage-v3` ä¸º `sage-v4`ï¼ˆæ‰€æœ‰4ä¸ªjobï¼‰
2. æäº¤å¹¶æ¨é€
3. æ–°çš„ç¼“å­˜é”®ä¼šå¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ï¼Œè§¦å‘é‡å»º

## æœªæ¥æ”¹è¿›ç©ºé—´

### å¯èƒ½çš„ä¼˜åŒ–
1. **å…±äº«ç¼“å­˜**ï¼šè€ƒè™‘åœ¨jobsé—´å…±äº«artifactsï¼Œè€Œä¸æ˜¯æ¯ä¸ªjobç‹¬ç«‹ç¼“å­˜
2. **å¢é‡æ„å»º**ï¼šåªé‡å»ºä¿®æ”¹çš„æ‰©å±•
3. **ç¼“å­˜æ¸…ç†**ï¼šå®šæœŸæ¸…ç†æ—§çš„ç¼“å­˜ç‰ˆæœ¬

### å¾…è§‚å¯Ÿçš„æŒ‡æ ‡
1. ç¼“å­˜å‘½ä¸­ç‡
2. å®é™…èŠ‚çœçš„æ—¶é—´
3. ç¼“å­˜å¤§å°å’Œå­˜å‚¨æˆæœ¬
4. C++æ‰©å±•é“¾æ¥çš„ç¨³å®šæ€§

## ç›¸å…³Issue

- #866: dev-ci.ymlå®‰è£…å¤šæ¬¡ï¼Œæ”¹å›ç”¨cacheè¯•è¯•
- ç›¸å…³Commit: 9c1e0d05ï¼ˆç§»é™¤ç¼“å­˜ï¼‰ã€f9926cadï¼ˆä¹‹å‰çš„ç¼“å­˜å®ç°ï¼‰

## æ›´æ–°æ—¥å¿—

- 2025-10-01: å®ç°v3ç¼“å­˜ç­–ç•¥ï¼Œä½¿ç”¨ç‹¬ç«‹ç¼“å­˜ç›®å½•è§£å†³å­æ¨¡å—å†²çª
- ä¹‹å‰: ç§»é™¤äº†v2ç¼“å­˜ç­–ç•¥ï¼Œå› ä¸ºå­æ¨¡å—å†²çªé—®é¢˜
