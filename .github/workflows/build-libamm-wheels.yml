name: Build LibAMM Wheels

on:
  workflow_dispatch:  # 手动触发
    inputs:
      python_versions:
        description: 'Python versions to build (comma-separated)'
        required: false
        default: '3.9,3.10,3.11,3.12'
      upload_to_release:
        description: 'Upload wheels to GitHub Release'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
      - main-dev
    paths:
      - 'packages/sage-libs/src/sage/libs/libamm/**'
      - 'packages/sage-libs/CMakeLists.txt'
      - '.github/workflows/build-libamm-wheels.yml'
  release:
    types: [published]

env:
  TORCH_VERSION: '2.5.0'  # PyTorch 版本

jobs:
  build-wheels:
    name: Build LibAMM wheel (py${{ matrix.python-version }})
    runs-on: [self-hosted, linux, x64, high-memory]  # 使用高内存的 self-hosted runner

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check system resources
        run: |
          echo "=== System Resources ==="
          free -h
          df -h
          echo "=== CPU Info ==="
          lscpu | grep -E "^CPU\(s\)|^Model name"
          echo "=== Memory threshold check ==="
          AVAILABLE_MEM=$(free -g | awk '/^Mem:/{print $7}')
          if [ "$AVAILABLE_MEM" -lt 12 ]; then
            echo "⚠️  Warning: Only ${AVAILABLE_MEM}GB available memory"
            echo "   LibAMM compilation requires at least 12GB free memory"
            echo "   Build may fail due to OOM"
          else
            echo "✅ ${AVAILABLE_MEM}GB available memory - sufficient for LibAMM build"
          fi

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build scikit-build-core pybind11 numpy

      - name: Install PyTorch CPU version
        run: |
          # 安装 CPU 版本的 PyTorch（编译 LibAMM 时不需要 CUDA）
          pip install torch==${{ env.TORCH_VERSION }} --index-url https://download.pytorch.org/whl/cpu

          # 验证安装
          python -c "import torch; print(f'PyTorch {torch.__version__} installed')"

      - name: Build LibAMM wheel
        env:
          BUILD_LIBAMM: '1'  # 启用 LibAMM 编译
          CMAKE_BUILD_PARALLEL_LEVEL: '2'  # 限制并行编译避免 OOM
        run: |
          echo "=== Building LibAMM wheel ==="
          cd packages/sage-libs

          # 构建 wheel
          python -m build --wheel --no-isolation

          # 显示生成的 wheel 信息
          echo "=== Generated wheel ==="
          ls -lh dist/

          # 重命名 wheel 以包含 LibAMM 标识
          cd dist
          for wheel in *.whl; do
            # 从 isage_libs-*.whl 重命名为 isage_libs_amm-*.whl
            new_name=$(echo "$wheel" | sed 's/isage_libs-/isage_libs_amm-/')
            mv "$wheel" "$new_name"
            echo "Renamed: $wheel -> $new_name"
          done

          ls -lh

      - name: Test wheel installation
        run: |
          echo "=== Testing wheel installation ==="

          # 创建临时虚拟环境测试
          python -m venv test_env
          source test_env/bin/activate

          # 安装依赖
          pip install torch==${{ env.TORCH_VERSION }} --index-url https://download.pytorch.org/whl/cpu
          pip install numpy

          # 安装生成的 wheel
          pip install packages/sage-libs/dist/*.whl

          # 测试 import
          python -c "
          from sage.libs.libamm.python import PyAMM
          print('✅ LibAMM successfully imported!')
          print('✅ Wheel is functional')
          "

          deactivate
          rm -rf test_env

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: libamm-wheel-py${{ matrix.python-version }}
          path: packages/sage-libs/dist/*.whl
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.upload_to_release == 'true')
        uses: softprops/action-gh-release@v1
        with:
          files: packages/sage-libs/dist/*.whl
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Build notification
    needs: build-wheels
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-wheels.result }}" == "success" ]; then
            echo "✅ All LibAMM wheels built successfully!"
            echo "Download artifacts from: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "❌ LibAMM wheel build failed"
            exit 1
          fi
