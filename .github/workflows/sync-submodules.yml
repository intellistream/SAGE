name: Auto-Sync Submodules

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-sync-submodules:
    name: Auto-Sync Submodules to main
    runs-on: ubuntu-latest
    # Skip version bump commits to avoid unnecessary runs, otherwise sync on any push to main or manual trigger
    if: |
      (github.event_name == 'push' &&
       !contains(github.event.head_commit.message, '[version bump]')) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check and sync submodules
        id: sync
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "## üîÑ Syncing Submodules from main-dev to main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Submodule | Status | Changes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Initialize counters using files to avoid subshell issues
          echo "0" > /tmp/success_count.txt
          echo "0" > /tmp/uptodate_count.txt
          echo "0" > /tmp/failed_count.txt
          rm -f /tmp/failed_submodules.txt /tmp/warnings.txt
          touch /tmp/failed_submodules.txt /tmp/warnings.txt

          # Get submodule list into an array (avoid pipe subshell)
          mapfile -t SUBMODULES < <(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')

          for submodule_path in "${SUBMODULES[@]}"; do
            if [ ! -d "$submodule_path" ]; then
              continue
            fi

            echo "Processing: $submodule_path"

            cd "$submodule_path"

            # Configure authentication for this submodule
            remote_url=$(git remote get-url origin)
            auth_url=$(echo "$remote_url" | sed "s|https://github.com/|https://x-access-token:${PAT_TOKEN}@github.com/|")
            git remote set-url origin "$auth_url"

            # Fetch latest from both branches
            if ! git fetch origin main main-dev 2>&1; then
              echo "| $submodule_path | ‚ùå Failed | Failed to fetch |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
              echo "$submodule_path" >> /tmp/failed_submodules.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            # Check if there are changes to merge
            AHEAD=$(git rev-list --count origin/main..origin/main-dev 2>/dev/null || echo "0")
            BEHIND=$(git rev-list --count origin/main-dev..origin/main 2>/dev/null || echo "0")

            # Case 1: main-dev is up to date with main
            if [ "$AHEAD" -eq 0 ] && [ "$BEHIND" -eq 0 ]; then
              echo "| $submodule_path | ‚úÖ Up to date | No changes |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/uptodate_count.txt) + 1)) > /tmp/uptodate_count.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            # Case 2: main-dev is behind main (needs to sync main ‚Üí main-dev first)
            if [ "$AHEAD" -eq 0 ] && [ "$BEHIND" -gt 0 ]; then
              echo "| $submodule_path | ‚ö†Ô∏è Behind | main-dev is $BEHIND commits behind main |" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è $submodule_path: main-dev is $BEHIND commits behind main, skipping sync" >> /tmp/warnings.txt
              echo $(($(cat /tmp/uptodate_count.txt) + 1)) > /tmp/uptodate_count.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            # Case 3: main-dev has new commits (may also be behind)
            if [ "$BEHIND" -gt 0 ]; then
              echo "| $submodule_path | ‚ö†Ô∏è Diverged | main-dev: +$AHEAD, main: +$BEHIND |" >> $GITHUB_STEP_SUMMARY
            fi

            # Checkout main branch
            if ! git checkout main 2>&1; then
              echo "| $submodule_path | ‚ùå Failed | Cannot checkout main |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
              echo "$submodule_path" >> /tmp/failed_submodules.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            if ! git pull origin main 2>&1; then
              echo "| $submodule_path | ‚ùå Failed | Cannot pull main |" >> $GITHUB_STEP_SUMMARY
              echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
              echo "$submodule_path" >> /tmp/failed_submodules.txt
              git remote set-url origin "$remote_url"
              cd - > /dev/null
              continue
            fi

            # Merge main-dev into main
            if git merge origin/main-dev --no-edit -m "chore: sync main-dev to main for SAGE release" 2>&1; then
              # Push to remote
              if git push origin main 2>&1; then
                echo "| $submodule_path | ‚úÖ Synced | $AHEAD commits merged |" >> $GITHUB_STEP_SUMMARY
                echo $(($(cat /tmp/success_count.txt) + 1)) > /tmp/success_count.txt
              else
                echo "| $submodule_path | ‚ùå Failed | Push failed |" >> $GITHUB_STEP_SUMMARY
                echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
                echo "$submodule_path" >> /tmp/failed_submodules.txt
              fi
            else
              echo "| $submodule_path | ‚ùå Conflict | Merge conflict detected |" >> $GITHUB_STEP_SUMMARY
              git merge --abort 2>/dev/null
              echo $(($(cat /tmp/failed_count.txt) + 1)) > /tmp/failed_count.txt
              echo "$submodule_path" >> /tmp/failed_submodules.txt
            fi

            # Restore original URL
            git remote set-url origin "$remote_url"
            cd - > /dev/null
          done

          # Read counters from files
          SUCCESS_COUNT=$(cat /tmp/success_count.txt)
          UPTODATE_COUNT=$(cat /tmp/uptodate_count.txt)
          FAILED_COUNT=$(cat /tmp/failed_count.txt)
          FAILED_SUBMODULES=$(cat /tmp/failed_submodules.txt | tr '\n' ' ')
          WARNINGS=$(cat /tmp/warnings.txt)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Successfully synced: $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ÑπÔ∏è  Already up to date: $UPTODATE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failed: $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ -n "$WARNINGS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ö†Ô∏è Warnings" >> $GITHUB_STEP_SUMMARY
            echo "$WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Submodules where main-dev is behind main were skipped." >> $GITHUB_STEP_SUMMARY
            echo "Please sync main ‚Üí main-dev in those submodules first." >> $GITHUB_STEP_SUMMARY
          fi

          # Set outputs
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "failed_submodules=$FAILED_SUBMODULES" >> $GITHUB_OUTPUT

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Update SAGE submodule pointers
        if: steps.sync.outputs.success_count > 0
        run: |
          # Checkout main branch of SAGE
          git checkout main
          git pull origin main

          # Update all submodules to their latest main branch commits
          git submodule foreach 'git checkout main && git pull origin main'

          # Update submodule references
          git add .

          # Check if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "chore: update submodule pointers to main branch after sync"
            git push origin main
            echo "‚úÖ Updated SAGE main branch with new submodule pointers" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è  No submodule pointer updates needed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR - Success
        if: steps.sync.outputs.has_failures == 'false' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const successCount = '${{ steps.sync.outputs.success_count }}';

            // Find the most recent merged PR from main-dev to main
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              base: 'main',
              head: `${context.repo.owner}:main-dev`,
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });

            if (prs.length === 0 || !prs[0].merged_at) {
              console.log('No merged PR found, skipping comment');
              return;
            }

            const comment = `## ‚úÖ Submodules Auto-Synced Successfully

            All submodules have been automatically synced from \`main-dev\` to \`main\` after the merge.

            **Summary:**
            - ‚úÖ ${successCount} submodule(s) synced
            - üìù SAGE main branch updated with new submodule pointers

            **All submodules are now aligned with the main branch! üéâ**

            <details>
            <summary>What happened automatically?</summary>

            1. Each submodule's \`main-dev\` branch was merged into its \`main\` branch
            2. SAGE's \`main\` branch was updated to point to the new submodule commits
            3. All changes were pushed automatically

            This ensures all submodules stay synchronized with the main repository.
            </details>
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prs[0].number,
              body: comment
            });

      - name: Comment on PR - Failure
        if: steps.sync.outputs.has_failures == 'true' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const failed = '${{ steps.sync.outputs.failed_submodules }}';
            const successCount = '${{ steps.sync.outputs.success_count }}';
            const failedCount = '${{ steps.sync.outputs.failed_count }}';

            // Find the most recent merged PR from main-dev to main
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              base: 'main',
              head: `${context.repo.owner}:main-dev`,
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });

            if (prs.length === 0 || !prs[0].merged_at) {
              console.log('No merged PR found, skipping comment');
              return;
            }

            const comment = `## ‚ö†Ô∏è Submodule Sync Partially Failed

            **Summary:**
            - ‚úÖ ${successCount} submodule(s) synced successfully
            - ‚ùå ${failedCount} submodule(s) failed

            **Failed submodules:**${failed}

            ### üîß Manual Action Required

            Please resolve the issues with the failed submodules manually:

            \`\`\`bash
            cd <submodule-path>
            git checkout main
            git pull origin main
            git merge origin/main-dev
            # Resolve any conflicts
            git commit
            git push origin main
            \`\`\`

            Then re-run this workflow manually from the Actions tab.

            See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prs[0].number,
              body: comment
            });

      - name: Fail if submodules sync failed
        if: steps.sync.outputs.has_failures == 'true'
        run: |
          echo "‚ùå Some submodules failed to sync"
          echo "Failed submodules: ${{ steps.sync.outputs.failed_submodules }}"
          exit 1
