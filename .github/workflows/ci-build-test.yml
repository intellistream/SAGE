name: Build and Test

on:
  push:
    branches: [main, main-dev]
    paths:
      - 'packages/**'
      - 'tools/**'
      - 'pyproject.toml'
      - '.github/workflows/ci-build-test.yml'
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/**'
      - 'tools/**'
      - 'pyproject.toml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
  ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
  HF_ENDPOINT: https://hf-mirror.com
  CACHE_VERSION: v2-simplified-prod

jobs:
  build-and-test:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 278 ä¸ªæµ‹è¯•éœ€è¦æ›´å¤šæ—¶é—´
    # Skip version bump commits to avoid unnecessary CI runs
    if: ${{ !contains(github.event.head_commit.message, '[version bump]') }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Detect LLM endpoint (prefer local)
        run: |
          # CI fallback only: DashScope is explicit fallback for CI environment
          # Local development should NOT use this; always prefer local endpoints
          DEFAULT_BASE="https://dashscope.aliyuncs.com/compatible-mode/v1"
          SELECTED_BASE="$DEFAULT_BASE"
          for port in 8888 8901; do
            if curl -s "http://localhost:${port}/v1/models" > /dev/null 2>&1; then
              SELECTED_BASE="http://localhost:${port}/v1"
              break
            fi
          done
          echo "OPENAI_BASE_URL=$SELECTED_BASE" >> $GITHUB_ENV

      - name: Create .env File from Secrets
        run: |
          echo "ðŸ” ä»Ž GitHub Secrets åˆ›å»º .env æ–‡ä»¶..."
          cat > .env << EOF
          # CI Environment Configuration (Auto-generated from GitHub Secrets)

          # LLM Service API Keys
          OPENAI_API_KEY=${{ secrets.ALIBABA_API_KEY }}
          OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}
          OPENAI_MODEL_NAME=qwen-turbo-2025-02-11

          SILICONCLOUD_API_KEY=${{ secrets.SILICONCLOUD_API_KEY }}
          JINA_API_KEY=${{ secrets.JINA_API_KEY }}
          ALIBABA_API_KEY=${{ secrets.ALIBABA_API_KEY }}

          VLLM_API_KEY=${{ secrets.VLLM_API_KEY }}
          VLLM_BASE_URL=http://localhost:8000/v1
          VLLM_MODEL_NAME=meta-llama/Llama-2-13b-chat-hf

          WEB_SEARCH_API_KEY=${{ secrets.WEB_SEARCH_API_KEY }}

          # GitHub Token
          GIT_TOKEN=${{ secrets.GIT_TOKEN }}

          # Hugging Face
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          HF_ENDPOINT=https://hf-mirror.com

          # CI/CD Settings
          SAGE_DEBUG=false
          SAGE_SKIP_CPP_EXTENSIONS=false
          SAGE_LOG_LEVEL=INFO
          SAGE_TEST_MODE=true
          EOF

          echo "âœ… .env æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: Install System Dependencies
        run: |
          echo "ðŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libopenblas-dev \
            liblapack-dev \
            git

          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install SAGE
        run: |
          echo "ðŸš€ å®‰è£…SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼Œå¯ç¼–è¾‘å®‰è£… + C++æ‰©å±•ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"

          # ä½¿ç”¨ CI å®‰è£…åŒ…è£…å™¨ï¼Œç¡®ä¿ä¸Žæœ¬åœ°å®‰è£…æ–¹å¼ä¸€è‡´
          chmod +x ./tools/install/core/ci_install_wrapper.sh
          chmod +x ./quickstart.sh

          echo "å¼€å§‹å®‰è£…..."
          # ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼Œè¿™æ ·ä¼šè¿›è¡Œå¯ç¼–è¾‘å®‰è£…ï¼ˆpip install -eï¼‰ï¼Œ.soæ–‡ä»¶ä¼šåœ¨æºç ç›®å½•ä¸­
          ./tools/install/core/ci_install_wrapper.sh --dev --yes

          echo "âœ… å®‰è£…å®Œæˆ"
        timeout-minutes: 25

      - name: Install Optional Dependencies
        run: |
          echo "ðŸ“¦ å®‰è£…å¯é€‰ä¾èµ–ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰..."
          export PATH="$HOME/.local/bin:$PATH"

          # å®‰è£…å¯é€‰çš„ç®—æ³•åº“ï¼ˆæµ‹è¯•éœ€è¦ï¼‰
          pip install --no-cache-dir \
            isage-agentic \
            isage-finetune \
            isage-rag \
            isage-eval \
            isage-privacy \
            isage-safety

          echo "âœ… å¯é€‰ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Verify PyPI Packages
        run: |
          echo "ðŸ“¦ éªŒè¯ç‹¬ç«‹ PyPI åŒ…å®‰è£…çŠ¶æ€..."

          # è¿™äº›ç»„ä»¶å·²ç‹¬ç«‹ä¸º PyPI åŒ…ï¼Œä¸å†ä½œä¸º C++ æ‰©å±•ç¼–è¯‘
          declare -a packages=(
            "isage-vdb:sagevdb:SageVDB å‘é‡æ•°æ®åº“"
            "isage-flow:sage_flow:SageFlow æµå¤„ç†å¼•æ“Ž"
            "isage-tsdb:sage_tsdb:SageTSDB æ—¶åºæ•°æ®åº“"
            "isage-refiner:sage_refiner:SageRefiner ä¸Šä¸‹æ–‡åŽ‹ç¼©"
          )

          available=0
          total=${#packages[@]}

          echo ""
          echo "ðŸ” æ£€æŸ¥ç‹¬ç«‹åŒ…å®‰è£…çŠ¶æ€:"
          for pkg_info in "${packages[@]}"; do
            IFS=':' read -r pip_name module_name display_name <<< "$pkg_info"

            # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ•èŽ·è¾“å‡ºï¼Œé¿å…ç®¡é“å¯¼è‡´çš„å­shellé—®é¢˜
            if python -c "import ${module_name}" 2>/dev/null; then
              version=$(python -c "import ${module_name}; print(getattr(${module_name}, '__version__', 'unknown'))" 2>/dev/null || echo "unknown")
              echo "  âœ… ${display_name} (${pip_name}): ${version}"
              available=$((available + 1))
            else
              echo "  âš ï¸  ${display_name} (${pip_name}): ä¸å¯ç”¨"
              echo "     å®‰è£…å‘½ä»¤: pip install ${pip_name}"
            fi
          done

          echo ""
          echo "ðŸ“Š æ€»ç»“: ${available}/${total} ä¸ªåŒ…å¯ç”¨"

          if [ $available -eq 0 ]; then
            echo ""
            echo "âŒ é”™è¯¯: æ²¡æœ‰ç‹¬ç«‹åŒ…å¯ç”¨"
            echo "ðŸ’¡ è¿™äº›åŒ…åº”è¯¥åœ¨å®‰è£…è¿‡ç¨‹ä¸­è‡ªåŠ¨å®‰è£…"
            echo "   è¯·æ£€æŸ¥ quickstart.sh æˆ–å®‰è£…è„šæœ¬çš„è¾“å‡º"
            exit 1
          elif [ $available -lt $total ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Š: éƒ¨åˆ†åŒ…ä¸å¯ç”¨ ($((total - available))/${total})"
            echo "   æŸäº›é«˜çº§åŠŸèƒ½å¯èƒ½å—é™ï¼Œä½†ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½"
            echo "   è¿™æ˜¯é¢„æœŸè¡Œä¸º - è¿™äº›åŒ…æ˜¯å¯é€‰ä¾èµ–"
          else
            echo ""
            echo "âœ… æ‰€æœ‰ç‹¬ç«‹åŒ…å·²æ­£ç¡®å®‰è£…"
          fi

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯SAGEå®‰è£…..."
          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.common; print('âœ… sage.common imported')"

          # éªŒè¯CLI
          if command -v sage-dev >/dev/null 2>&1; then
            sage-dev --help > /dev/null && echo "âœ… sage-dev CLIå¯ç”¨"
          else
            echo "âŒ sage-dev CLIä¸å¯ç”¨"
            exit 1
          fi

      - name: Set up Directories
        run: |
          echo "ðŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æž„..."
          mkdir -p .sage/reports
          mkdir -p .sage/logs
          echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"

      # Note: sage-studio has been moved to an independent repository
      # (https://github.com/intellistream/sage-studio)
      # Frontend checks are no longer part of the main SAGE CI pipeline

      - name: Run installation validation suite
        run: |
          echo "ðŸ” Running installation verification suite..."
          bash tools/install/tests/verify_installation.sh

      - name: Run Unit Tests with Coverage
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–çŽ‡..."
          echo "ä½¿ç”¨ sage-dev project test --coverage å‘½ä»¤"

          # ä½¿ç”¨ sage-dev è¿è¡Œæµ‹è¯•ï¼ˆæŽ’é™¤æ…¢é€Ÿæµ‹è¯•ï¼‰
          # æ³¨æ„ï¼šä¸å†ä½¿ç”¨ || exit 0ï¼Œæµ‹è¯•å¤±è´¥æ—¶CIåº”è¯¥å¤±è´¥
          sage-dev project test --coverage \
            --coverage-report term,xml,html \
            --jobs 4 \
            --timeout 300 \
            --continue-on-error || {
              echo "âŒ æµ‹è¯•å¤±è´¥"
              exit 1
            }

          # å°†è¦†ç›–çŽ‡æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ä»¥ä¾¿ä¸Šä¼ 
          if [ -f ".sage/coverage/coverage.xml" ]; then
            cp .sage/coverage/coverage.xml ./coverage.xml
            echo "âœ… è¦†ç›–çŽ‡XMLæ–‡ä»¶å·²å¤åˆ¶åˆ°æ ¹ç›®å½•"
          else
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è¦†ç›–çŽ‡XMLæ–‡ä»¶"
          fi

          # å¤åˆ¶HTMLæŠ¥å‘Š
          if [ -d ".sage/coverage/htmlcov" ]; then
            mkdir -p coverage_html
            cp -r .sage/coverage/htmlcov/* coverage_html/
            echo "âœ… HTMLè¦†ç›–çŽ‡æŠ¥å‘Šå·²å¤åˆ¶"
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: intellistream/SAGE
          files: ./coverage.xml
          flags: unittests
          name: codecov-sage
          fail_ci_if_error: false
          verbose: true

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            coverage_html/
            .sage/logs/
          retention-days: 30

      - name: Upload Test Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .sage/logs/
            .sage/reports/
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ æž„å»ºå’Œæµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºæˆåŠŸ** - æ‰€æœ‰æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY

            # æ˜¾ç¤ºè¦†ç›–çŽ‡æ‘˜è¦ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -f "coverage.xml" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡" >> $GITHUB_STEP_SUMMARY
              echo "è¦†ç›–çŽ‡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯¦è§ Artifacts" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **æž„å»ºå¤±è´¥** - è¯·æŸ¥çœ‹æ—¥å¿—å’Œæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æµ‹è¯•æ—¥å¿—å·²ä¸Šä¼ åˆ° Artifactsï¼Œè¯·ä¸‹è½½æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
