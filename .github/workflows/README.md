# SAGE GitHub Actions å·¥ä½œæµæ–‡æ¡£

æœ¬ç›®å½•åŒ…å« SAGE é¡¹ç›®çš„æ‰€æœ‰ GitHub Actions å·¥ä½œæµé…ç½®ã€‚è¿™äº›å·¥ä½œæµè´Ÿè´£æŒç»­é›†æˆã€æ„å»ºå‘å¸ƒã€ä»£ç è´¨é‡æ£€æŸ¥å’Œåˆ†æ”¯ç®¡ç†ã€‚

## ğŸ“‹ å·¥ä½œæµæ¦‚è§ˆ

| å·¥ä½œæµåç§° | æ–‡ä»¶å | è§¦å‘æ¡ä»¶ | ä¸»è¦åŠŸèƒ½ | çŠ¶æ€ |
|-----------|--------|----------|----------|------|
| **SAGE CI/CD** | `ci.yml` | `main-dev`, `refactor/*`, PR to `main` | æµ‹è¯•å’ŒéªŒè¯ | âœ… æ´»è·ƒ |
| **Build and Release** | `build-release.yml` | `main`, `main-dev`, `v*` tags | æ„å»ºå’Œå‘å¸ƒ | âœ… æ´»è·ƒ |
| **Branch Protection** | `only-main-dev.yml` | PR to `main` | åˆ†æ”¯ä¿æŠ¤ | âœ… æ´»è·ƒ |
| **TODO to Issue** | `todo-to-issue-pr.yml` | PR äº‹ä»¶ | è‡ªåŠ¨åŒ–ç®¡ç† | âœ… æ´»è·ƒ |

## ğŸ”„ å·¥ä½œæµè¯¦ç»†è¯´æ˜

### 1. SAGE CI/CD (`ci.yml`)

**ç›®çš„ï¼š** éªŒè¯ä»£ç è´¨é‡å’ŒåŠŸèƒ½å®Œæ•´æ€§

**è§¦å‘æ¡ä»¶ï¼š**
- æ¨é€åˆ° `main-dev` åˆ†æ”¯
- æ¨é€åˆ° `refactor/*` åˆ†æ”¯
- åˆ›å»ºåˆ° `main` åˆ†æ”¯çš„ Pull Request
- æ‰‹åŠ¨è§¦å‘

**ä¸»è¦ä»»åŠ¡ï¼š**
- **æµ‹è¯•ä»»åŠ¡ (`test`)**: 
  - ä½¿ç”¨å¼€å‘æ¨¡å¼å®‰è£… SAGE (`pip install -e`)
  - è¿è¡Œ pytest æµ‹è¯•å¥—ä»¶
  - æµ‹è¯•å„ç§ AI æœåŠ¡é›†æˆ
  - è¶…æ—¶æ—¶é—´ï¼š60åˆ†é’Ÿ

- **Docker é›†æˆæµ‹è¯•æé†’ (`docker-integration-reminder`)**:
  - è¿è¡Œåœ¨ self-hosted runner
  - æé†’è¿›è¡Œ C++ æ‰©å±•çš„ Docker æµ‹è¯•
  - æ£€æŸ¥ `sage_db`, `sage_queue` ç­‰ç»„ä»¶

- **ä»£ç è´¨é‡æ£€æŸ¥ (`lint`)**:
  - è¿è¡Œåœ¨ self-hosted runner
  - ä»£ç é£æ ¼å’Œç±»å‹æ£€æŸ¥
  - è¶…æ—¶æ—¶é—´ï¼š15åˆ†é’Ÿ

**ç‰¹ç‚¹ï¼š**
- ä¸“æ³¨äº**å¼€å‘ç¯å¢ƒéªŒè¯**
- ä¸æ„å»ºç”Ÿäº§ç¯å¢ƒåŒ…
- åŒ…å«å®Œæ•´çš„æµ‹è¯•è¦†ç›–

### 2. Build and Release (`build-release.yml`)

**ç›®çš„ï¼š** æ„å»ºç”Ÿäº§ç¯å¢ƒåŒ…å¹¶å‘å¸ƒ

**è§¦å‘æ¡ä»¶ï¼š**
- æ¨é€åˆ° `main` åˆ†æ”¯ï¼ˆç¨³å®šç‰ˆï¼‰
- æ¨é€åˆ° `main-dev` åˆ†æ”¯ï¼ˆå¼€å‘ç‰ˆï¼‰
- æ¨é€ `v*` æ ‡ç­¾ï¼ˆæ­£å¼å‘å¸ƒï¼‰
- å‘å¸ƒ GitHub Release

**æ„å»ºæµç¨‹ï¼š**

#### é˜¶æ®µ 1: å­åŒ…æ„å»º (`build-subpackages`)
- **å¹¶è¡Œæ„å»º 4 ä¸ªå­åŒ…ï¼š**
  - `sage-common` â†’ `isage-common-*.whl`
  - `sage-kernel` â†’ `isage-kernel-*.whl`
  - `sage-middleware` â†’ `isage-middleware-*.whl`
  - `sage-libs` â†’ `isage-libs-*.whl`
- **ç­–ç•¥ï¼š** Matrix å¹¶è¡Œæ‰§è¡Œ
- **è¾“å‡ºï¼š** å„å­åŒ…çš„ wheel æ–‡ä»¶

#### é˜¶æ®µ 2: Meta åŒ…æ„å»º (`build-metapackage`)
- **ä¾èµ–ï¼š** ç­‰å¾…æ‰€æœ‰å­åŒ…æ„å»ºå®Œæˆ
- **ç‰¹æ®Šå¤„ç†ï¼š** å‘å¸ƒæ—¶æ›¿æ¢æœ¬åœ°ä¾èµ–ä¸º PyPI åŒ…å
  ```bash
  # å¼€å‘æ—¶: "isage-common @ file:./packages/sage-common"
  # å‘å¸ƒæ—¶: "isage-common"
  ```
- **è¾“å‡ºï¼š** ä¸»åŒ… `isage-*.whl`

#### é˜¶æ®µ 3: åŸºæœ¬æµ‹è¯• (`test`)
- **å¤šç‰ˆæœ¬æµ‹è¯•ï¼š** Python 3.10, 3.11, 3.12
- **éªŒè¯å†…å®¹ï¼š** wheel åŒ…å®‰è£…å’ŒåŸºæœ¬å¯¼å…¥
- **ç­–ç•¥ï¼š** å¿«é€ŸéªŒè¯ï¼Œä¸è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

#### é˜¶æ®µ 4: å‘å¸ƒ (`release`)
- **æ¡ä»¶ï¼š** ä»…åœ¨ `v*` æ ‡ç­¾æ—¶æ‰§è¡Œ
- **GitHub Releaseï¼š** è‡ªåŠ¨åˆ›å»º release å¹¶ä¸Šä¼ æ‰€æœ‰ wheel æ–‡ä»¶
- **PyPI å‘å¸ƒï¼š** å¦‚æœé…ç½®äº† `PYPI_API_TOKEN`

#### é˜¶æ®µ 5: æ¸…ç† (`cleanup`)
- **æ‰§è¡Œï¼š** æ— è®ºå…¶ä»–ä»»åŠ¡æˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
- **åŠŸèƒ½ï¼š** åˆ é™¤è¶…è¿‡ 30 å¤©çš„ artifacts

**ä¾èµ–å…³ç³»æµç¨‹ï¼š**
```
build-subpackages (å¹¶è¡Œæ‰§è¡Œ)
        â†“
build-metapackage (ç­‰å¾…æ‰€æœ‰å­åŒ…)
        â†“
     test (éªŒè¯)
        â†“
    release (ä»…æ ‡ç­¾)
        â†“
    cleanup (æ€»æ˜¯æ‰§è¡Œ)
```

**ç‰¹ç‚¹ï¼š**
- ä¸“æ³¨äº**ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…**
- æ”¯æŒå¤šåŒ…ä¾èµ–ç®¡ç†
- è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹

### 3. Branch Protection (`only-main-dev.yml`)

**ç›®çš„ï¼š** ç»´æŠ¤åˆ†æ”¯ç®¡ç†è§„èŒƒ

**è§¦å‘æ¡ä»¶ï¼š**
- åˆ›å»ºåˆ° `main` åˆ†æ”¯çš„ Pull Request

**åŠŸèƒ½ï¼š**
- æ£€æŸ¥ PR æºåˆ†æ”¯å¿…é¡»æ˜¯ `main-dev`
- é˜»æ­¢å…¶ä»–åˆ†æ”¯ç›´æ¥åˆå¹¶åˆ° `main`
- ç¡®ä¿ä»£ç å®¡æŸ¥æµç¨‹

**åˆ†æ”¯ç­–ç•¥ï¼š**
```
feature/* â†’ main-dev â†’ main
   â†“           â†“        â†“
  å¼€å‘      é›†æˆæµ‹è¯•   ç¨³å®šç‰ˆ
```

### 4. TODO to Issue (`todo-to-issue-pr.yml`)

**ç›®çš„ï¼š** è‡ªåŠ¨åŒ–é¡¹ç›®ç®¡ç†

**è§¦å‘æ¡ä»¶ï¼š**
- Pull Request äº‹ä»¶ (opened, synchronize, reopened)
- æ‰‹åŠ¨è§¦å‘

**åŠŸèƒ½ï¼š**
- æ‰«æä»£ç ä¸­çš„ TODO æ³¨é‡Š
- è‡ªåŠ¨åˆ›å»º GitHub Issues
- åœ¨ä»£ç ä¸­æ’å…¥ Issue URL
- æäº¤æ›´æ”¹å› PR åˆ†æ”¯

## ğŸ”§ å·¥ä½œæµé…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡å’Œå¯†é’¥

**CI/CD ç›¸å…³ï¼š**
- `HF_TOKEN`: HuggingFace API Token
- `SILICONCLOUD_API_KEY`: ç¡…äº‘ API å¯†é’¥
- `OPENAI_API_KEY`: OpenAI API å¯†é’¥
- `JINA_API_KEY`: Jina AI API å¯†é’¥
- `ALIBABA_API_KEY`: é˜¿é‡Œäº‘ API å¯†é’¥
- `VLLM_API_KEY`: vLLM API å¯†é’¥

**å‘å¸ƒç›¸å…³ï¼š**
- `PYPI_API_TOKEN`: PyPI å‘å¸ƒä»¤ç‰Œ (å¯é€‰)
- `GITHUB_TOKEN`: GitHub API è®¿é—®ä»¤ç‰Œ (è‡ªåŠ¨æä¾›)

### Runner é…ç½®

- **ubuntu-latest**: ç”¨äºå¤§éƒ¨åˆ†æ„å»ºå’Œæµ‹è¯•ä»»åŠ¡
- **self-hosted**: ç”¨äºéœ€è¦ç‰¹æ®Šç¯å¢ƒçš„ä»»åŠ¡
  - Docker é›†æˆæµ‹è¯•
  - ä»£ç è´¨é‡æ£€æŸ¥

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¼€å‘å·¥ä½œæµ

1. **åŠŸèƒ½å¼€å‘ï¼š**
   ```bash
   git checkout -b feature/new-feature
   # å¼€å‘ä»£ç ...
   git push origin feature/new-feature
   # åˆ›å»º PR åˆ° main-dev
   ```

2. **é›†æˆæµ‹è¯•ï¼š**
   ```bash
   git checkout main-dev
   git merge feature/new-feature
   git push origin main-dev
   # è§¦å‘ CI/CD å’Œ Build workflows
   ```

3. **ç¨³å®šå‘å¸ƒï¼š**
   ```bash
   git checkout main
   git merge main-dev
   git tag v1.2.3
   git push origin main --tags
   # è§¦å‘æ­£å¼å‘å¸ƒæµç¨‹
   ```

### å‘å¸ƒæµç¨‹

**å¼€å‘ç‰ˆæœ¬å‘å¸ƒï¼š**
- æ¨é€åˆ° `main-dev` â†’ è‡ªåŠ¨æ„å»ºå¼€å‘ç‰ˆæœ¬
- å¯åœ¨ Actions Artifacts ä¸­ä¸‹è½½

**æ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼š**
1. åˆ›å»ºå¹¶æ¨é€ç‰ˆæœ¬æ ‡ç­¾
2. è‡ªåŠ¨è§¦å‘å®Œæ•´æ„å»ºæµç¨‹
3. åˆ›å»º GitHub Release
4. å‘å¸ƒåˆ° PyPI (å¦‚æœé…ç½®)

## ğŸ“Š å·¥ä½œæµçŠ¶æ€ç›‘æ§

### æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
```bash
# æŸ¥çœ‹æœ€è¿‘çš„è¿è¡ŒçŠ¶æ€
gh run list --limit 10

# æŸ¥çœ‹ç‰¹å®šå·¥ä½œæµ
gh run list --workflow="SAGE CI/CD"
gh run list --workflow="Build and Release"

# æŸ¥çœ‹è¿è¡Œè¯¦æƒ…
gh run view <run-id>
```

### å¸¸è§é—®é¢˜æ’æŸ¥

**1. å­åŒ…æ„å»ºå¤±è´¥ï¼š**
- æ£€æŸ¥ `packages/*/pyproject.toml` é…ç½®
- ç¡®è®¤ä¾èµ–å…³ç³»æ­£ç¡®
- æ£€æŸ¥ Python ç‰ˆæœ¬å…¼å®¹æ€§

**2. Meta åŒ…æ„å»ºè¢«é˜»å¡ï¼š**
- æ£€æŸ¥æ‰€æœ‰å­åŒ…æ˜¯å¦æ„å»ºæˆåŠŸ
- `build-metapackage` ä¾èµ– `build-subpackages` å®Œæˆ

**3. PyPI å‘å¸ƒå¤±è´¥ï¼š**
- ç¡®è®¤ `PYPI_API_TOKEN` é…ç½®æ­£ç¡®
- æ£€æŸ¥åŒ…åæ˜¯å¦å†²çª
- éªŒè¯ç‰ˆæœ¬å·æ ¼å¼

**4. æµ‹è¯•è¶…æ—¶ï¼š**
- CI æµ‹è¯•è¶…æ—¶é™åˆ¶ï¼š60åˆ†é’Ÿ
- è€ƒè™‘æ‹†åˆ†å¤§å‹æµ‹è¯•æˆ–ä¼˜åŒ–æµ‹è¯•é€Ÿåº¦

## ğŸ”„ å·¥ä½œæµä¼˜åŒ–å»ºè®®

### å½“å‰é‡å¤é—®é¢˜
- `ci.yml` å’Œ `build-release.yml` åœ¨ `main-dev` åˆ†æ”¯éƒ½ä¼šè§¦å‘
- å¯ä»¥è€ƒè™‘ï¼š
  - CI ä¸“æ³¨äº `main-dev` å’Œ PR
  - Build ä¸“æ³¨äº `main` å’Œ tags

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ Docker layer caching
- ä¼˜åŒ–ä¾èµ–å®‰è£…é€Ÿåº¦
- å¹¶è¡ŒåŒ–æ›´å¤šä»»åŠ¡

### å®‰å…¨æ€§
- å®šæœŸè½®æ¢ API tokens
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- å¯ç”¨ä¾èµ–å®‰å…¨æ‰«æ

---

*æœ€åæ›´æ–°ï¼š2025å¹´9æœˆ2æ—¥*
*ç»´æŠ¤è€…ï¼šSAGE Team*

**è§¦å‘æ¡ä»¶**:
- Pull Request äº‹ä»¶ (opened, synchronize, reopened)
- æ‰‹åŠ¨è§¦å‘

**åŠŸèƒ½**:
- æ‰«æä»£ç ä¸­çš„ TODO æ³¨é‡Š
- è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ GitHub Issues
- åœ¨ä»£ç ä¸­æ’å…¥ Issue URL é“¾æ¥
- æäº¤æ›´æ”¹å› PR åˆ†æ”¯

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### å·¥ä½œæµé‡å¤é—®é¢˜
å½“æ¨é€åˆ° `main-dev` åˆ†æ”¯æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘ï¼š
- âœ… `ci.yml` (æµ‹è¯•éªŒè¯)
- âœ… `build-release.yml` (æ„å»ºåŒ…)

è¿™æ˜¯**æœ‰æ„è®¾è®¡**çš„ï¼š
- `ci.yml` ä¸“æ³¨æµ‹è¯•ï¼Œå¿«é€Ÿåé¦ˆ
- `build-release.yml` ä¸“æ³¨æ„å»ºï¼Œå‡†å¤‡å‘å¸ƒ

### Meta åŒ…æ„å»ºå»¶è¿Ÿ
`build-metapackage` ä»»åŠ¡å¿…é¡»ç­‰å¾…æ‰€æœ‰å­åŒ…æ„å»ºå®Œæˆï¼Œæ‰€ä»¥ï¼š
- å¦‚æœä»»ä½•ä¸€ä¸ªå­åŒ…æ„å»ºå¤±è´¥/è¾ƒæ…¢ï¼Œmeta åŒ…ä¼šè¢«é˜»å¡
- è¿™æ˜¯æ­£å¸¸çš„è®¾è®¡ï¼Œç¡®ä¿ meta åŒ…ä¾èµ–å®Œæ•´

### å‘å¸ƒæ¡ä»¶
- **å¼€å‘æ„å»º**: æ¨é€åˆ° `main-dev` â†’ æ„å»ºä½†ä¸å‘å¸ƒ
- **æ­£å¼å‘å¸ƒ**: æ¨é€ `v*` æ ‡ç­¾ â†’ æ„å»ºå¹¶å‘å¸ƒåˆ° PyPI/GitHub

## ğŸš€ ä½¿ç”¨å»ºè®®

### å¼€å‘æµç¨‹
1. åœ¨ `refactor/feature-name` åˆ†æ”¯å¼€å‘
2. åˆå¹¶åˆ° `main-dev` â†’ è§¦å‘ CI + æ„å»º
3. åˆ›å»º PR `main-dev â†’ main` â†’ è§¦å‘åˆ†æ”¯ä¿æŠ¤ + CI
4. åˆå¹¶åˆ° `main` â†’ å‡†å¤‡å‘å¸ƒ
5. æ‰“æ ‡ç­¾ `v1.0.0` â†’ è‡ªåŠ¨å‘å¸ƒ

### æ•…éšœæ’æŸ¥
- **CI å¤±è´¥**: æ£€æŸ¥ `ci.yml` çš„æµ‹è¯•ä»»åŠ¡
- **æ„å»ºå¤±è´¥**: æ£€æŸ¥ `build-release.yml` çš„æ„å»ºä»»åŠ¡
- **Meta åŒ…æœªæ„å»º**: ç¡®è®¤æ‰€æœ‰å­åŒ…éƒ½æ„å»ºæˆåŠŸ
- **å‘å¸ƒå¤±è´¥**: æ£€æŸ¥ PyPI API Token é…ç½®

## ğŸ“ é…ç½®è¦æ±‚

### å¿…éœ€çš„ Secrets
- `GITHUB_TOKEN`: GitHub API è®¿é—® (è‡ªåŠ¨æä¾›)
- `PYPI_API_TOKEN`: PyPI å‘å¸ƒ (å¯é€‰ï¼Œå‘å¸ƒæ—¶éœ€è¦)
- å„ç§ AI æœåŠ¡ API Keys (æµ‹è¯•ç”¨):
  - `HF_TOKEN`, `OPENAI_API_KEY`, `JINA_API_KEY` ç­‰

### è¿è¡Œå™¨è¦æ±‚
- `ubuntu-latest`: å¤§éƒ¨åˆ†ä»»åŠ¡
- `self-hosted`: Docker é›†æˆæµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥

---

*æœ€åæ›´æ–°: 2025-09-02*
