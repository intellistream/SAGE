# ========================================
# 🚫 WORKFLOW DISABLED TO SAVE COSTS 🚫
# ========================================
# 此工作流已被禁用以避免自动触发测试，节省费用
# 如需运行测试，请手动触发工作流
# This workflow has been disabled to avoid automatic test triggers and save costs
# To run tests, please trigger the workflow manually
# ========================================

# .github/workflows/ci.yml
name: Lighter runtime tests (DISABLED)

on:
  workflow_dispatch:  # 仅允许手动触发
  push:             # 已禁用自动触发
    branches: [ main ,refactor/refactor0.1]
  pull_request:     # 已禁用自动触发
    branches: [ main ,refactor/refactor0.1]

jobs:
  build-and-test:
    name: Build & Test SAGE
    runs-on: self-hosted
    timeout-minutes: 60

    env:
      CI: true          
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      SILICONCLOUD_API_KEY: ${{ secrets.SILICONCLOUD_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
      ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
      VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
      HF_ENDPOINT: https://hf-mirror.com
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Miniconda (with mamba)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          python-version: 3.11
          auto-activate-base: false

      - name: Reuse setup.sh to provision environment
        shell: bash
        run: |
          set -euxo pipefail          
          
          # 1) turn off any interactive 'pause' in setup.sh
          pause() { :; }

          # 2) ensure the script is executable
          chmod +x ./setup.sh

          # 3) source it (defines minimal_setup, etc.)
          source ./setup.sh

          # 4) run your minimal_setup to install deps, create & install sage env
          minimal_setup_without_HF

      - name: Activate 'sage' env & Install test deps
        shell: bash
        run: |
          # load conda into shell
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate sage

          # ensure pytest is installed
          mamba install -y pytest pytest-cov
          mamba clean --all -y

      # 可选：在这里再做一把“环境探针”，确认变量都还在
      - name: Debug environment variables
        shell: bash
        run: |
          env | grep -E 'CI|HF_TOKEN|SILICONCLOUD_API_KEY|OPENAI_API_KEY|JINA_API_KEY|ALIBABA_API_KEY'

      - name: Run Pytest
        shell: bash
        run: |
          echo senleilaikan: $ALIBABA_API_KEY
          source "$(conda info --base)/etc/profile.d/conda.sh"
          conda activate sage
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          export PYTHONWARNINGS="ignore:DeprecationWarning"
          pytest -v sage
