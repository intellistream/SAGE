name: Code Quality Check

on:
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**.pyi'
      - '.github/workflows/code-quality.yml'
      - 'tools/pre-commit-config.yaml'
  push:
    branches: [main, main-dev]
    paths:
      - '**.py'
      - '**.pyi'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality & Style Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²æ¥è¿›è¡Œ diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Code Quality Tools
        run: |
          echo "ðŸ“¦ å®‰è£…ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·..."
          pip install --upgrade pip
          pip install \
            pre-commit \
            black \
            isort \
            ruff \
            mypy \
            types-PyYAML \
            types-requests \
            types-setuptools

          # ä½¿ç”¨ quickstart.sh å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼ŒåŒ…å« sage-tools å’Œæ‰€æœ‰å¼€å‘å·¥å…·ï¼‰
          echo "ðŸ“¦ ä½¿ç”¨ quickstart.sh å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."
          chmod +x ./quickstart.sh
          ./quickstart.sh --dev --yes --no-sync-submodules

          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
          echo ""
          echo "ðŸ“‹ å·²å®‰è£…ç‰ˆæœ¬:"
          pre-commit --version
          black --version
          ruff --version
          mypy --version
          sage-dev --version || echo "sage-dev å‘½ä»¤å¯ç”¨"

      - name: Check Pre-commit Configuration
        run: |
          echo "ðŸ” æ£€æŸ¥ pre-commit é…ç½®æ–‡ä»¶..."

          if [ ! -f "tools/pre-commit-config.yaml" ]; then
            echo "âŒ pre-commit é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: tools/pre-commit-config.yaml"
            exit 1
          fi

          echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"

      - name: Run Code Quality Checks (Changed Files)
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥ï¼ˆä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶ï¼‰..."
          echo ""
          echo "ðŸ“‹ å½“å‰åˆ†æ”¯: ${{ github.head_ref }}"
          echo "ðŸ“‹ åŸºå‡†åˆ†æ”¯: ${{ github.base_ref }}"
          echo ""

          # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}...HEAD | grep -E '\.(py|pyi)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "â„¹ï¸  æ²¡æœ‰ Python æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
            exit 0
          fi

          echo "ðŸ“ æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶:"
          echo "$CHANGED_FILES"
          echo ""

          # è¿è¡Œ pre-commit æ£€æŸ¥
          echo "ðŸš€ å¼€å§‹æ£€æŸ¥..."
          echo "$CHANGED_FILES" | xargs pre-commit run \
            --config tools/pre-commit-config.yaml \
            --files || {
              echo ""
              echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼"
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ’¡ å¸¸è§é—®é¢˜ä¿®å¤æ–¹æ³•ï¼š"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              echo "1ï¸âƒ£ ä»£ç æ ¼å¼é—®é¢˜ï¼š"
              echo "   black --line-length=100 ."
              echo "   isort --profile=black --line-length=100 ."
              echo ""
              echo "2ï¸âƒ£ Ruff æ£€æŸ¥é”™è¯¯ï¼š"
              echo "   ruff check --fix ."
              echo ""
              echo "3ï¸âƒ£ ç±»åž‹æ£€æŸ¥é”™è¯¯ï¼š"
              echo "   æŸ¥çœ‹ mypy è¾“å‡ºå¹¶ä¿®å¤ç±»åž‹æ³¨è§£"
              echo ""
              echo "4ï¸âƒ£ æœ¬åœ°å®Œæ•´æ£€æŸ¥ï¼š"
              echo "   pre-commit run --config tools/pre-commit-config.yaml --all-files"
              echo ""
              echo "5ï¸âƒ£ å®‰è£…æœ¬åœ° Git é’©å­ï¼ˆæŽ¨èï¼‰ï¼š"
              echo "   ./quickstart.sh  # ä¼šè‡ªåŠ¨å®‰è£… pre-commit é’©å­"
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            }

          echo ""
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"

      - name: Run Code Quality Checks (All Files)
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥ï¼ˆæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶ï¼‰..."
          echo ""

          # è¿è¡Œæ‰€æœ‰æ–‡ä»¶çš„æ£€æŸ¥
          pre-commit run \
            --config tools/pre-commit-config.yaml \
            --all-files \
            --show-diff-on-failure || {
              echo ""
              echo "âš ï¸ ä»£ç è´¨é‡æ£€æŸ¥å‘çŽ°é—®é¢˜"
              echo ""
              echo "ðŸ’¡ è¿™å¯èƒ½åŒ…å«åŽ†å²é—ç•™é—®é¢˜ã€‚"
              echo "   è¯·é‡ç‚¹å…³æ³¨æœ¬æ¬¡æäº¤å¼•å…¥çš„é—®é¢˜ã€‚"
              echo ""
              # å¯¹äºŽç›´æŽ¥ pushï¼Œä¸å¼ºåˆ¶å¤±è´¥ï¼ˆé¿å…åŽ†å²é—®é¢˜é˜»å¡žï¼‰
              # ä½†ä¼šæ˜¾ç¤ºè­¦å‘Š
            }

          echo ""
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

      - name: Architecture Compliance Check
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ—ï¸  è¿è¡Œæž¶æž„åˆè§„æ€§æ£€æŸ¥..."
          echo ""

          # ä½¿ç”¨æ–°çš„ sage-dev å‘½ä»¤
          sage-dev check-architecture --changed-only || {
            echo ""
            echo "âŒ æž¶æž„åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼"
            echo ""
            echo "ðŸ’¡ è¯·æŸ¥çœ‹ SAGE æž¶æž„è§„èŒƒæ–‡æ¡£ï¼š"
            echo "   docs/PACKAGE_ARCHITECTURE.md"
            echo ""
            echo "ðŸ’¡ æˆ–è¿è¡Œä»¥ä¸‹å‘½ä»¤èŽ·å–è¯¦ç»†ä¿¡æ¯ï¼š"
            echo "   sage-dev check-architecture --verbose"
            echo ""
            exit 1
          }

          echo "âœ… æž¶æž„åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

      - name: Documentation Standards Check
        if: github.event_name == 'pull_request'
        continue-on-error: true  # æ–‡æ¡£æ£€æŸ¥å¤±è´¥ä¸é˜»æ­¢ PR
        run: |
          echo "ðŸ“š è¿è¡Œ dev-notes æ–‡æ¡£è§„èŒƒæ£€æŸ¥..."
          echo ""

          # æ£€æŸ¥æ˜¯å¦æœ‰ dev-notes å˜æ›´
          DEVNOTES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^docs/dev-notes/.*\.md$' || true)

          if [ -z "$DEVNOTES_CHANGED" ]; then
            echo "â„¹ï¸  æ²¡æœ‰ dev-notes æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
            exit 0
          fi

          # ä½¿ç”¨æ–°çš„ sage-dev å‘½ä»¤
          sage-dev check-devnotes --changed-only || {
            echo ""
            echo "âš ï¸  æ–‡æ¡£è§„èŒƒæ£€æŸ¥å‘çŽ°é—®é¢˜"
            echo ""
            echo "ðŸ’¡ è¯·ç¡®ä¿æ–‡æ¡£åŒ…å«å¿…éœ€çš„å…ƒæ•°æ®ï¼š"
            echo "   - Date: YYYY-MM-DD"
            echo "   - Author: Your Name"
            echo "   - Summary: Brief description"
            echo ""
            echo "ðŸ’¡ æŸ¥çœ‹æ–‡æ¡£æ¨¡æ¿ï¼š"
            echo "   docs/dev-notes/TEMPLATE.md"
            echo ""
            # ä¸é€€å‡ºï¼Œåªæ˜¯è­¦å‘Š
          }

          echo "âœ… æ–‡æ¡£æ£€æŸ¥å®Œæˆ"

      - name: Generate Quality Report
        if: always()
        run: |
          echo "ðŸ“Š ç”Ÿæˆä»£ç è´¨é‡æŠ¥å‘Š..."

          # ç»Ÿè®¡ Python æ–‡ä»¶æ•°é‡
          TOTAL_PY_FILES=$(find packages -name "*.py" -type f | wc -l)
          echo "æ€» Python æ–‡ä»¶æ•°: $TOTAL_PY_FILES"

          # æ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§é—®é¢˜
          echo ""
          echo "ðŸ” å¿«é€Ÿæ£€æŸ¥å¸¸è§é—®é¢˜..."

          # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡é•¿çš„è¡Œ
          LONG_LINES=$(find packages -name "*.py" -type f -exec grep -l ".\{120\}" {} \; 2>/dev/null | wc -l || echo 0)
          if [ "$LONG_LINES" -gt 0 ]; then
            echo "âš ï¸  å‘çŽ° $LONG_LINES ä¸ªæ–‡ä»¶åŒ…å«è¶…è¿‡ 120 å­—ç¬¦çš„è¡Œ"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ TODO/FIXME
          TODO_COUNT=$(grep -r "TODO\|FIXME" packages --include="*.py" 2>/dev/null | wc -l || echo 0)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "â„¹ï¸  å‘çŽ° $TODO_COUNT ä¸ª TODO/FIXME æ³¨é‡Š"
          fi

          echo ""
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¨ ä»£ç è´¨é‡æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æ£€æŸ¥é€šè¿‡** - ä»£ç ç¬¦åˆè´¨é‡æ ‡å‡†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ› ï¸ ä½¿ç”¨çš„å·¥å…·" >> $GITHUB_STEP_SUMMARY
            echo "- Black (ä»£ç æ ¼å¼åŒ–)" >> $GITHUB_STEP_SUMMARY
            echo "- isort (å¯¼å…¥æŽ’åº)" >> $GITHUB_STEP_SUMMARY
            echo "- Ruff (å¿«é€Ÿ linter)" >> $GITHUB_STEP_SUMMARY
            echo "- Mypy (ç±»åž‹æ£€æŸ¥)" >> $GITHUB_STEP_SUMMARY
            echo "- SAGE æž¶æž„æ£€æŸ¥å™¨ (åˆ†å±‚æž¶æž„åˆè§„)" >> $GITHUB_STEP_SUMMARY
            echo "- SAGE æ–‡æ¡£æ£€æŸ¥å™¨ (dev-notes è§„èŒƒ)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ£€æŸ¥å¤±è´¥** - å‘çŽ°ä»£ç è´¨é‡é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ å¿«é€Ÿä¿®å¤" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç " >> $GITHUB_STEP_SUMMARY
            echo "black --line-length=100 ." >> $GITHUB_STEP_SUMMARY
            echo "isort --profile=black --line-length=100 ." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# è‡ªåŠ¨ä¿®å¤ linting é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "ruff check --fix ." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# è¿è¡Œæ‰€æœ‰è´¨é‡æ£€æŸ¥ï¼ˆæŽ¨èï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "sage-dev quality" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# è¿è¡Œç‰¹å®šæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "sage-dev check-architecture" >> $GITHUB_STEP_SUMMARY
            echo "sage-dev check-devnotes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# å®‰è£… pre-commit é’©å­ï¼ˆæŽ¨èï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "./quickstart.sh" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
