name: Deploy SAGE Studio to Self-Hosted Server

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Studio port (default: 4200)'
        required: false
        default: '4200'
  push:
    branches:
      - main
      - main-dev
      - feat/unified-chat-canvas-rebased
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'
      - '.github/workflows/deploy-studio.yml'

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Stop existing services
        continue-on-error: true
        run: |
          echo "ðŸ›‘ Stopping existing SAGE Studio services..."
          pkill -f "sage studio" || true
          pkill -f "sage-gateway" || true
          sleep 2

      - name: Install System Dependencies
        run: |
          echo "ï¿½ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            git
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install/Update SAGE
        run: |
          echo "ðŸ“¦ å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"
          chmod +x ./quickstart.sh

          ./quickstart.sh --dev --yes

          echo "âœ… SAGE å®‰è£…å®Œæˆ"
        timeout-minutes: 25

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."

          export PATH="$HOME/.local/bin:$PATH"

          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.cli; print('âœ… sage.cli imported')"
          python -c "import sage.studio; print('âœ… sage.studio imported')"

          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… sage å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage å‘½ä»¤ä¸å¯ç”¨"
          fi

      - name: Build Studio (Production)
        run: |
          echo "ðŸ—ï¸  æž„å»º SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"

          sage studio build

          echo "âœ… Studio æž„å»ºå®Œæˆ"

      - name: Start SAGE Studio
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ðŸš€ å¯åŠ¨ SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"

          # Production mode for better performance and stability
          # 1. Builds RAG index from docs-public if needed
          # 2. Starts Gateway on port 8000
          # 3. Builds and serves optimized frontend on port 4200
          nohup sage studio start --prod --host 0.0.0.0 --port ${{ github.event.inputs.port || '4200' }} > ~/sage-studio-deploy.log 2>&1 &

          sleep 15  # Production build needs more time

          echo "âœ… Studio å·²å¯åŠ¨"

      - name: Health check
        run: |
          echo "ðŸ” Checking service health..."

          # Check Studio
          if curl -f http://localhost:${{ github.event.inputs.port || '4200' }} 2>/dev/null; then
            echo "âœ… Studio is healthy on port ${{ github.event.inputs.port || '4200' }}"
          else
            echo "âš ï¸  Studio health check failed, checking logs..."
            tail -50 ~/sage-studio-deploy.log || echo "No logs yet"
          fi

      - name: Deployment summary
        run: |
          SERVER_IP=$(hostname -I | awk '{print $1}')
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "Check manually")
          echo "## ðŸŽ‰ SAGE Studio Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Server IP**: http://$PUBLIC_IP:${{ github.event.inputs.port || '4200' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Local Network**: http://$SERVER_IP:${{ github.event.inputs.port || '4200' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ **Access Note**: Accessible within campus network or via VPN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Visual Pipeline Editor" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI Chat with RAG (auto-indexed SAGE documentation)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow Generation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Interactive Playground" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Logs:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 ~/sage-studio-deploy.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
