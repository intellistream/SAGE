name: Deploy SAGE Studio to Self-Hosted Server

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Studio port (default: 5173)'
        required: false
        default: '5173'
  push:
    branches:
      - main
      - main-dev
      - feat/unified-chat-canvas-rebased
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'
      - '.github/workflows/deploy-studio.yml'

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Stop existing services
        continue-on-error: true
        run: |
          echo "ðŸ›‘ Stopping existing SAGE Studio services..."
          pkill -f "sage studio" || true
          pkill -f "sage-gateway" || true
          sleep 2

      - name: Install System Dependencies
        run: |
          echo "ï¿½ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            git
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install/Update SAGE
        run: |
          echo "ðŸ“¦ å®‰è£… SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"
          chmod +x ./quickstart.sh

          # é…ç½®å›½å†… PyPI é•œåƒåŠ é€Ÿ
          export PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
          export PIP_TRUSTED_HOST=pypi.tuna.tsinghua.edu.cn

          ./quickstart.sh --dev --yes

          echo "âœ… SAGE å®‰è£…å®Œæˆ"
        timeout-minutes: 45

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."

          export PATH="$HOME/.local/bin:$PATH"

          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.cli; print('âœ… sage.cli imported')"
          python -c "import sage.studio; print('âœ… sage.studio imported')"

          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… sage å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage å‘½ä»¤ä¸å¯ç”¨"
          fi

      - name: Build Studio (Production)
        run: |
          echo "ðŸ—ï¸  æž„å»º SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"

          sage studio build

          echo "âœ… Studio æž„å»ºå®Œæˆ"

      - name: Start SAGE Studio
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "ðŸš€ å¯åŠ¨ SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          export PATH="$HOME/.local/bin:$PATH"

          # Production mode for better performance and stability
          # 1. Builds RAG index from docs-public if needed
          # 2. Starts Gateway on port 8000
          # 3. Builds and serves optimized frontend on port 5173 (Vite default)
          nohup sage studio start --prod --host 0.0.0.0 --port ${{ github.event.inputs.port || '5173' }} > ~/sage-studio-deploy.log 2>&1 &

          sleep 15  # Production build needs more time

          echo "âœ… Studio å·²å¯åŠ¨"

      - name: Health check
        run: |
          PORT="${{ github.event.inputs.port || '4200' }}"
          echo "ðŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."

          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨
          if curl -f http://localhost:${PORT} 2>/dev/null; then
            echo "âœ… Studio æœåŠ¡å¥åº·ï¼Œç«¯å£ ${PORT} å¯è®¿é—®"
          else
            echo "âš ï¸  Studio å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
            tail -50 ~/sage-studio-deploy.log || echo "æš‚æ— æ—¥å¿—"
          fi

          # æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
          echo ""
          echo "ðŸ“¡ æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€..."
          if command -v netstat &> /dev/null; then
            netstat -tlnp 2>/dev/null | grep ":${PORT}" || echo "âš ï¸ ç«¯å£ ${PORT} æœªåœ¨ç›‘å¬"
          elif command -v ss &> /dev/null; then
            ss -tlnp 2>/dev/null | grep ":${PORT}" || echo "âš ï¸ ç«¯å£ ${PORT} æœªåœ¨ç›‘å¬"
          fi

          # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
          echo ""
          echo "ðŸ”§ æ£€æŸ¥ SAGE Studio è¿›ç¨‹..."
          ps aux | grep "[s]age studio" || echo "âš ï¸ æœªæ‰¾åˆ° SAGE Studio è¿›ç¨‹"

      - name: Network accessibility check
        continue-on-error: true
        run: |
          PORT="${{ github.event.inputs.port || '4200' }}"
          SERVER_IP=$(hostname -I | awk '{print $1}')

          echo "ðŸŒ æµ‹è¯•ç½‘ç»œå¯è¾¾æ€§..."
          echo ""
          echo "æµ‹è¯•ä»Žæœ¬æœºè®¿é—®ï¼š"

          # æµ‹è¯• localhost
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT} | grep -q "200"; then
            echo "âœ… localhost:${PORT} å¯è®¿é—®"
          else
            echo "âŒ localhost:${PORT} ä¸å¯è®¿é—®"
          fi

          # æµ‹è¯•å†…ç½‘IP
          if curl -s -o /dev/null -w "%{http_code}" http://${SERVER_IP}:${PORT} | grep -q "200"; then
            echo "âœ… ${SERVER_IP}:${PORT} å¯è®¿é—®"
          else
            echo "âŒ ${SERVER_IP}:${PORT} ä¸å¯è®¿é—®"
          fi

          # æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
          echo ""
          echo "ðŸ”¥ é˜²ç«å¢™æ£€æŸ¥ï¼š"
          if command -v ufw &> /dev/null; then
            echo "UFW çŠ¶æ€ï¼š"
            sudo ufw status | grep -E "Status|${PORT}" || echo "ç«¯å£ ${PORT} æœªåœ¨ UFW è§„åˆ™ä¸­"
          fi

          if command -v iptables &> /dev/null; then
            echo ""
            echo "IPTables å…¥ç«™è§„åˆ™ï¼ˆç«¯å£ ${PORT}ï¼‰ï¼š"
            sudo iptables -L INPUT -n -v 2>/dev/null | grep -E "dpt:${PORT}|ACCEPT.*all" | head -5 || echo "æœªæ‰¾åˆ°ç›¸å…³è§„åˆ™"
          fi

          # è¾“å‡ºç½‘ç»œå»ºè®®
          echo ""
          echo "ðŸ“ æ ¡å›­ç½‘è®¿é—®å»ºè®®ï¼š"
          echo "1. âœ… ç¡®è®¤æœåŠ¡å·²å¯åŠ¨å¹¶ç›‘å¬ 0.0.0.0:${PORT}"
          echo "2. ðŸ”§ å¦‚æžœæ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "   - æœåŠ¡å™¨é˜²ç«å¢™é…ç½® (ufw/iptables)"
          echo "   - æ ¡å›­ç½‘é˜²ç«å¢™/å®‰å…¨ç»„è§„åˆ™"
          echo "   - ç½‘ç»œéš”ç¦»ç­–ç•¥ï¼ˆæŸäº›æ ¡å›­ç½‘å¯èƒ½æœ‰VLANéš”ç¦»ï¼‰"
          echo "3. ðŸ’¡ å»ºè®®è”ç³»ç½‘ç»œç®¡ç†å‘˜å¼€æ”¾ç«¯å£ ${PORT}"
          echo "4. ðŸ” æˆ–é…ç½®æ ¡å›­ç½‘VPNä»¥è®¿é—®å†…ç½‘æœåŠ¡"

      - name: Deployment summary
        run: |
          PORT="${{ github.event.inputs.port || '4200' }}"

          # èŽ·å–æœåŠ¡å™¨ç½‘ç»œä¿¡æ¯
          SERVER_IP=$(hostname -I | awk '{print $1}')
          HOSTNAME=$(hostname -f)
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "N/A")

          # æ£€æµ‹é˜²ç«å¢™çŠ¶æ€
          FIREWALL_STATUS="æœªçŸ¥"
          if command -v ufw &> /dev/null; then
            if sudo ufw status | grep -q "Status: active"; then
              if sudo ufw status | grep -q "$PORT"; then
                FIREWALL_STATUS="âœ… UFW: ç«¯å£ $PORT å·²å¼€æ”¾"
              else
                FIREWALL_STATUS="âš ï¸ UFW: ç«¯å£ $PORT å¯èƒ½æœªå¼€æ”¾"
              fi
            else
              FIREWALL_STATUS="âœ… UFW æœªå¯ç”¨"
            fi
          fi

          # ä¿å­˜éƒ¨ç½²ä¿¡æ¯åˆ°æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰
          DEPLOY_INFO_FILE="$HOME/sage-studio-deployment-info.txt"
          cat > "$DEPLOY_INFO_FILE" << EOF
          ======================================
          SAGE Studio éƒ¨ç½²ä¿¡æ¯
          ======================================
          éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')

          è®¿é—®åœ°å€:
          - å†…ç½‘IP: http://${SERVER_IP}:${PORT}
          - ä¸»æœºå: http://${HOSTNAME}:${PORT}
          - å…¬ç½‘IP: http://${PUBLIC_IP}:${PORT} (å¦‚æžœå¯ç”¨)

          æœåŠ¡çŠ¶æ€:
          - ç«¯å£: ${PORT}
          - ç›‘å¬: 0.0.0.0 (æ‰€æœ‰ç½‘ç»œæŽ¥å£)
          - é˜²ç«å¢™: ${FIREWALL_STATUS}

          æ ¡å›­ç½‘è®¿é—®å»ºè®®:
          1. å¦‚æžœåœ¨æ ¡å›­ç½‘å†…ï¼Œä½¿ç”¨å†…ç½‘IP: http://${SERVER_IP}:${PORT}
          2. å¦‚æžœéœ€è¦æ ¡å¤–è®¿é—®ï¼Œéœ€è¦é…ç½®VPNæˆ–ç«¯å£è½¬å‘
          3. è¯·è”ç³»ç½‘ç»œç®¡ç†å‘˜ç¡®è®¤é˜²ç«å¢™é…ç½®

          æ—¥å¿—æ–‡ä»¶:
          - éƒ¨ç½²æ—¥å¿—: ~/sage-studio-deploy.log
          - æœåŠ¡æ—¥å¿—: è¿è¡Œ 'journalctl -f' æŸ¥çœ‹

          ç®¡ç†å‘½ä»¤:
          - æŸ¥çœ‹çŠ¶æ€: ps aux | grep "sage studio"
          - åœæ­¢æœåŠ¡: pkill -f "sage studio"
          - é‡å¯æœåŠ¡: é‡æ–°è¿è¡Œæ­¤ workflow
          ======================================
          EOF

          echo "âœ… éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ°: $DEPLOY_INFO_FILE"
          cat "$DEPLOY_INFO_FILE"

          # è¾“å‡ºåˆ° GitHub Actions Summary
          echo "## ðŸŽ‰ SAGE Studio éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç½‘ç»œçŽ¯å¢ƒ | è®¿é—®åœ°å€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ« æ ¡å›­ç½‘å†… | \`http://${SERVER_IP}:${PORT}\` | **æŽ¨èä½¿ç”¨** |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ ä¸»æœºå | \`http://${HOSTNAME}:${PORT}\` | å¦‚æžœDNSé…ç½®æ­£ç¡® |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ å…¬ç½‘è®¿é—® | \`http://${PUBLIC_IP}:${PORT}\` | éœ€è¦é…ç½®é˜²ç«å¢™/VPN |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æœåŠ¡å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **å†…ç½‘IP**: ${SERVER_IP}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸»æœºå**: ${HOSTNAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›‘å¬ç«¯å£**: ${PORT}" >> $GITHUB_STEP_SUMMARY
          echo "- **é˜²ç«å¢™çŠ¶æ€**: ${FIREWALL_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜**: ç™»å½•æœåŠ¡å™¨åŽå¯æŸ¥çœ‹ \`~/sage-studio-deployment-info.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¯è§†åŒ–æµæ°´çº¿ç¼–è¾‘å™¨" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI å¯¹è¯ï¼ˆåŸºäºŽ SAGE æ–‡æ¡£çš„ RAGï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… äº¤äº’å¼è°ƒè¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” æ•…éšœæŽ’æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ç‚¹å‡»å±•å¼€æœ€è¿‘30è¡Œæ—¥å¿—</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 ~/sage-studio-deploy.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
