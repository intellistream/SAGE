# SAGE Studio éƒ¨ç½²ï¼ˆç³»ç»Ÿçº§ Systemd æœåŠ¡ï¼‰
#
# ä½¿ç”¨ sudo åˆ›å»ºç³»ç»Ÿçº§ systemd æœåŠ¡ï¼Œç¡®ä¿è¿›ç¨‹åœ¨ CI ç»“æŸåæŒç»­è¿è¡Œ
#
# æ¶æ„:
#   Self-hosted Runner (A100) â†’ å®‰è£… SAGE â†’ åˆ›å»ºç³»ç»Ÿçº§ systemd æœåŠ¡
#   cloudflared (Host systemd) â†’ è½¬å‘è¯·æ±‚åˆ° localhost:5173

name: Deploy SAGE Studio

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Studio ç«¯å£ (é»˜è®¤: 5173)'
        required: false
        default: '5173'
      force_reinstall:
        description: 'å¼ºåˆ¶é‡æ–°å®‰è£… SAGE'
        type: boolean
        default: false

  push:
    branches:
      - main
      - feature/studio_deployment
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'
      - '.github/workflows/deploy-studio.yml'

jobs:
  deploy:
    runs-on: [self-hosted, A100]
    timeout-minutes: 60

    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      CONDA_ENV_NAME: sage

    defaults:
      run:
        shell: bash -el {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
          clean: false

      - name: Setup Conda
        run: |
          echo "ğŸ è®¾ç½® Conda ç¯å¢ƒ..."

          # åˆå§‹åŒ– conda
          for conda_path in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
            if [ -f "$conda_path/etc/profile.d/conda.sh" ]; then
              source "$conda_path/etc/profile.d/conda.sh"
              echo "CONDA_PATH=$conda_path" >> $GITHUB_ENV
              break
            fi
          done

          # ç¡®ä¿ç¯å¢ƒå­˜åœ¨
          if ! conda env list | grep -q "^sage "; then
            echo "ğŸ“¦ åˆ›å»º Conda ç¯å¢ƒ..."
            conda create -n sage python=3.11 -y
          fi

          conda activate sage
          echo "âœ… Conda ç¯å¢ƒ: $(conda info --envs | grep '*')"
          python --version

      # NOTE: æœåŠ¡ä¼šåœ¨ "Stop and restart services" æ­¥éª¤ä¸­åœæ­¢
      # è¿™æ ·å¯ä»¥å‡å°‘åœæœºæ—¶é—´ï¼šå…ˆå®Œæˆæ„å»ºï¼Œå†åœæ­¢æ—§æœåŠ¡å¹¶å¯åŠ¨æ–°æœåŠ¡
      - name: Check current service status
        continue-on-error: true
        run: |
          echo "ğŸ“Š æ£€æŸ¥å½“å‰æœåŠ¡çŠ¶æ€..."
          for svc in sage-frontend sage-gateway sage-embedding sage-llm; do
            status=$(systemctl is-active $svc 2>/dev/null || echo "not-found")
            echo "  $svc: $status"
          done
          echo ""
          echo "GPU çŠ¶æ€:"
          nvidia-smi --query-gpu=index,memory.used,memory.free --format=csv 2>/dev/null || true

      - name: Install SAGE
        run: |
          source "$CONDA_PATH/etc/profile.d/conda.sh"
          conda activate sage

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…
          NEED_INSTALL=false
          if [ "${{ github.event.inputs.force_reinstall }}" = "true" ]; then
            echo "âš ï¸ å¼ºåˆ¶é‡æ–°å®‰è£…"
            NEED_INSTALL=true

            # åªåœ¨å¼ºåˆ¶é‡è£…æ—¶æ¸…ç†
            echo "ğŸ§¹ æ¸…ç†æ—§æ„å»º..."
            rm -rf .sage/build/ build/ *.egg-info/
            find packages -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null || true
            find packages -name "build" -type d -exec rm -rf {} + 2>/dev/null || true
          elif ! python -c "import sage.studio" 2>/dev/null; then
            echo "ğŸ“¦ sage.studio æœªå®‰è£…"
            NEED_INSTALL=true
          # æ£€æŸ¥ C++ æ‰©å±•æ˜¯å¦å­˜åœ¨ (checkout ä¼šæ¸…ç† gitignored çš„ .so æ–‡ä»¶ï¼Œå¯¼è‡´ editable install å¤±æ•ˆ)
          elif ! python -c "from sage.middleware.components.sage_flow.python import _sage_flow" 2>/dev/null; then
            echo "âš ï¸ C++ æ‰©å±•ä¸¢å¤± (å¯èƒ½æ˜¯ checkout æ¸…ç†äº†æ„å»ºäº§ç‰©)"
            NEED_INSTALL=true
          fi

          if [ "$NEED_INSTALL" = "true" ]; then
            echo "ğŸ”¨ ä½¿ç”¨ quickstart.sh å®‰è£… SAGE..."

            # ä½¿ç”¨ quickstart.sh å®‰è£…ï¼ˆ--pip ä½¿ç”¨å½“å‰ conda ç¯å¢ƒï¼‰
            # å–æ¶ˆ CI ç¯å¢ƒå˜é‡ï¼Œé¿å…å®‰è£…åˆ° ~/.local
            chmod +x ./quickstart.sh
            unset CI GITHUB_ACTIONS
            export AUTO_CONFIRM=true
            export AUTO_YES=true
            SAGE_FORCE_CHINA_MIRROR=true ./quickstart.sh --dev --yes --pip

            echo "âœ… SAGE å®‰è£…å®Œæˆ"
          else
            echo "âœ… SAGE å·²å®‰è£…ï¼Œè·³è¿‡"
          fi

          # éªŒè¯å®‰è£…
          echo "ğŸ” éªŒè¯å®‰è£…..."
          python -c "import sage.studio; print('sage.studio OK')"
          python -c "import sage.gateway; print('sage.gateway OK')"
          which sage

          # éªŒè¯ C++ æ‰©å±•
          echo "ğŸ” éªŒè¯ C++ æ‰©å±•..."
          echo "æŸ¥æ‰¾ .so æ–‡ä»¶..."
          find . -name "_sage_flow*.so" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° _sage_flow.so"
          find . -name "_sage_db*.so" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° _sage_db.so"
          find . -name "_sage_tsdb*.so" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° _sage_tsdb.so"

          echo "æµ‹è¯• C++ æ‰©å±•å¯¼å…¥..."
          python -c "from sage.middleware.components.sage_flow.python import _sage_flow; print('sage_flow OK')" || echo "sage_flow not available (optional)"
          python -c "from sage.middleware.components.sage_db.python import _sage_db; print('sage_db OK')" || echo "sage_db not available (optional)"

          # æµ‹è¯•å®Œæ•´çš„ Gateway å¯¼å…¥é“¾
          echo "æµ‹è¯• Gateway å®Œæ•´å¯¼å…¥é“¾..."
          python -c "from sage.gateway.server import app; print('sage.gateway.app OK')" || {
            echo "âš ï¸ Gateway å¯¼å…¥å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯..."
            python -c "from sage.gateway.server import app" 2>&1 | head -50
            exit 1
          }

      - name: Setup Node.js
        run: |
          echo "ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ..."

          # æ£€æŸ¥å½“å‰ Node.js ç‰ˆæœ¬
          CURRENT_NODE=$(node --version 2>/dev/null || echo "not installed")
          echo "å½“å‰ Node.js ç‰ˆæœ¬: $CURRENT_NODE"

          # Vite 5.x éœ€è¦ Node.js 18+
          REQUIRED_NODE_MAJOR=18

          # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…/å‡çº§
          if [[ "$CURRENT_NODE" == "not installed" ]] || [[ "${CURRENT_NODE:1:2}" -lt "$REQUIRED_NODE_MAJOR" ]]; then
            echo "âš ï¸ Node.js ç‰ˆæœ¬ä¸æ»¡è¶³è¦æ±‚ (éœ€è¦ v$REQUIRED_NODE_MAJOR+)"

            # å°è¯•ä½¿ç”¨ nvm
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              source "$NVM_DIR/nvm.sh"
              nvm install 20
              nvm use 20
            else
              # ä½¿ç”¨ conda å®‰è£… nodejs
              echo "ä½¿ç”¨ conda å®‰è£… Node.js..."
              source "$CONDA_PATH/etc/profile.d/conda.sh"
              conda activate sage
              conda install -y -c conda-forge nodejs=20
            fi
          fi

          # éªŒè¯ç‰ˆæœ¬
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"

          # ä¿å­˜ Node.js è·¯å¾„ä¾›åç»­ä½¿ç”¨
          echo "NODE_BIN=$(dirname $(which node))" >> $GITHUB_ENV

      - name: Build Frontend
        run: |
          source "$CONDA_PATH/etc/profile.d/conda.sh"
          conda activate sage

          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Node.js
          export PATH="$NODE_BIN:$PATH"
          echo "Using Node.js: $(node --version)"

          FRONTEND_DIR="packages/sage-studio/src/sage/studio/frontend"

          if [ ! -d "$FRONTEND_DIR/dist" ] || [ "${{ github.event.inputs.force_reinstall }}" = "true" ]; then
            echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
            cd "$FRONTEND_DIR"
            npm ci --prefer-offline 2>/dev/null || npm install

            # ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /apiï¼Œç”± nginx åå‘ä»£ç†åˆ° Gateway
            # ä¸è®¾ç½® VITE_API_BASE_URLï¼Œä½¿ç”¨é»˜è®¤çš„ /api
            npm run build
            echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          else
            echo "âœ… å‰ç«¯å·²æ„å»ºï¼Œè·³è¿‡"
          fi

      - name: Setup nginx reverse proxy
        run: |
          echo "ğŸ”§ é…ç½® nginx åå‘ä»£ç†..."

          # æ£€æŸ¥ nginx æ˜¯å¦å·²å®‰è£…
          if ! command -v nginx &> /dev/null; then
            echo "å®‰è£… nginx..."
            sudo apt-get update && sudo apt-get install -y nginx
          fi

          PORT="${{ github.event.inputs.port || '5173' }}"
          WORKSPACE="${{ github.workspace }}"
          FRONTEND_DIST="$WORKSPACE/packages/sage-studio/src/sage/studio/frontend/dist"

          # éªŒè¯å‰ç«¯æ„å»ºç›®å½•å­˜åœ¨
          if [ ! -d "$FRONTEND_DIST" ]; then
            echo "âŒ é”™è¯¯: å‰ç«¯æ„å»ºç›®å½•ä¸å­˜åœ¨: $FRONTEND_DIST"
            ls -la "$WORKSPACE/packages/sage-studio/src/sage/studio/frontend/" || true
            exit 1
          fi
          echo "âœ… å‰ç«¯æ„å»ºç›®å½•: $FRONTEND_DIST"
          ls -la "$FRONTEND_DIST" | head -10

          # ä¿®å¤æƒé™ï¼šnginx (www-data) éœ€è¦èƒ½è®¿é—® dist ç›®å½•
          # ç¡®ä¿ä» /home/action-runner åˆ° dist çš„æ•´ä¸ªè·¯å¾„éƒ½æœ‰ execute æƒé™
          echo "ğŸ”§ ä¿®å¤ç›®å½•æƒé™ï¼Œè®© nginx å¯ä»¥è®¿é—®..."
          # WORKSPACE = /home/action-runner/actions-runner/_work/SAGE/SAGE
          # éœ€è¦ç»™ /home/action-runner, actions-runner, _work, SAGE, SAGE éƒ½åŠ  o+x
          sudo chmod o+x /home/action-runner || true
          sudo chmod o+x /home/action-runner/actions-runner || true
          sudo chmod o+x /home/action-runner/actions-runner/_work || true
          sudo chmod o+x /home/action-runner/actions-runner/_work/SAGE || true
          sudo chmod o+x "$WORKSPACE" || true
          sudo chmod -R o+rX "$FRONTEND_DIST"
          echo "âœ… æƒé™ä¿®å¤å®Œæˆ"
          # éªŒè¯æƒé™
          echo "éªŒè¯ nginx ç”¨æˆ·å¯è®¿é—®æ€§..."
          sudo -u www-data test -r "$FRONTEND_DIST/index.html" && echo "âœ… www-data å¯ä»¥è¯»å– index.html" || echo "âŒ www-data æ— æ³•è¯»å– index.html"

          # åˆ›å»º nginx é…ç½®ï¼ˆä½¿ç”¨ printf é¿å… YAML heredoc ç¼©è¿›é—®é¢˜ï¼‰
          # è·¯ç”±è¯´æ˜ï¼š
          # - /api/chat/v1/* -> Gateway /v1/* (OpenAI å…¼å®¹ chat completions)
          # - /api/chat/memory/* -> Gateway /memory/* (è®°å¿†é…ç½®)
          # - /api/* -> Gateway /api/* (Studio åç«¯ APIï¼Œç”± Gateway çš„ studio_router æä¾›)
          # - /sessions, /v1/, /health -> Gateway åŸç”Ÿè·¯ç”±
          NGINX_CONF="/etc/nginx/sites-available/sage-studio"
          printf '%s\n' \
            'server {' \
            '    listen 5173;' \
            '    server_name _;' \
            "    root $FRONTEND_DIST;" \
            '    index index.html;' \
            '' \
            '    # é™æ€æ–‡ä»¶å’Œ SPA fallback' \
            '    location / {' \
            '        try_files $uri $uri/ /index.html;' \
            '    }' \
            '' \
            '    # /api/chat/v1/* -> /v1/* (OpenAI å…¼å®¹ chat completions)' \
            '    location /api/chat/v1/ {' \
            '        proxy_pass http://127.0.0.1:8888/v1/;' \
            '        proxy_http_version 1.1;' \
            '        proxy_set_header Upgrade $http_upgrade;' \
            '        proxy_set_header Connection "upgrade";' \
            '        proxy_set_header Host $host;' \
            '        proxy_set_header X-Real-IP $remote_addr;' \
            '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
            '        proxy_set_header X-Forwarded-Proto $scheme;' \
            '        proxy_read_timeout 300s;' \
            '        proxy_connect_timeout 75s;' \
            '    }' \
            '' \
            '    # /api/chat/memory/* -> /memory/* (Gateway è®°å¿†é…ç½®)' \
            '    location /api/chat/memory/ {' \
            '        proxy_pass http://127.0.0.1:8888/memory/;' \
            '        proxy_http_version 1.1;' \
            '        proxy_set_header Host $host;' \
            '        proxy_set_header X-Real-IP $remote_addr;' \
            '    }' \
            '' \
            '    # /api/* -> Gateway /api/* (Studio åç«¯ API)' \
            '    location /api/ {' \
            '        proxy_pass http://127.0.0.1:8888/api/;' \
            '        proxy_http_version 1.1;' \
            '        proxy_set_header Upgrade $http_upgrade;' \
            '        proxy_set_header Connection "upgrade";' \
            '        proxy_set_header Host $host;' \
            '        proxy_set_header X-Real-IP $remote_addr;' \
            '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
            '        proxy_set_header X-Forwarded-Proto $scheme;' \
            '        proxy_read_timeout 300s;' \
            '        proxy_connect_timeout 75s;' \
            '    }' \
            '' \
            '    # Gateway åŸç”Ÿè·¯ç”±' \
            '    location /sessions {' \
            '        proxy_pass http://127.0.0.1:8888/sessions;' \
            '        proxy_http_version 1.1;' \
            '        proxy_set_header Host $host;' \
            '        proxy_set_header X-Real-IP $remote_addr;' \
            '    }' \
            '' \
            '    location /v1/ {' \
            '        proxy_pass http://127.0.0.1:8888/v1/;' \
            '        proxy_http_version 1.1;' \
            '        proxy_set_header Host $host;' \
            '        proxy_set_header X-Real-IP $remote_addr;' \
            '        proxy_read_timeout 300s;' \
            '    }' \
            '' \
            '    location /health {' \
            '        proxy_pass http://127.0.0.1:8888/health;' \
            '    }' \
            '}' \
            | sudo tee "$NGINX_CONF" > /dev/null
          sudo ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/sage-studio
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          echo "=== nginx é…ç½®å†…å®¹ ==="
          cat "$NGINX_CONF"
          echo "==="
          sudo nginx -t
          echo "âœ… nginx é…ç½®å®Œæˆ"

          # === åˆ›å»º sage-frontend æœåŠ¡ï¼ˆä½¿ç”¨ nginxï¼‰===
          RUNNER_USER=$(whoami)
          cat > /tmp/sage-frontend.service << EOF
          [Unit]
          Description=SAGE Frontend Service (nginx reverse proxy)
          After=network.target sage-gateway.service
          Wants=sage-gateway.service

          [Service]
          Type=forking
          PIDFile=/run/nginx.pid
          ExecStartPre=/usr/sbin/nginx -t
          ExecStart=/usr/sbin/nginx
          ExecReload=/bin/kill -s HUP \$MAINPID
          ExecStop=/bin/kill -s QUIT \$MAINPID
          PrivateTmp=true

          [Install]
          WantedBy=multi-user.target
          EOF
          sed -i 's/^[[:space:]]*//' /tmp/sage-frontend.service
          sudo cp /tmp/sage-frontend.service /etc/systemd/system/sage-frontend.service

          # ç¦ç”¨é»˜è®¤çš„ nginx æœåŠ¡ï¼Œä½¿ç”¨ sage-frontend ä»£æ›¿
          sudo systemctl stop nginx 2>/dev/null || true
          sudo systemctl disable nginx 2>/dev/null || true
          echo "âœ… sage-frontend.service å·²åˆ›å»ºï¼ˆåŸºäº nginxï¼‰"

      - name: Create systemd services
        run: |
          echo "ğŸ”§ åˆ›å»ºç³»ç»Ÿçº§ systemd æœåŠ¡ï¼ˆå¤šæœåŠ¡æ¶æ„ï¼‰..."

          PORT="${{ github.event.inputs.port || '5173' }}"
          CONDA_PATH_VAL="$CONDA_PATH"
          CONDA_BIN="$CONDA_PATH/envs/sage/bin"
          WORKSPACE="${{ github.workspace }}"
          RUNNER_USER=$(whoami)
          HF_TOKEN_VAL="${{ secrets.HF_TOKEN }}"
          FRONTEND_DIR="$WORKSPACE/packages/sage-studio/src/sage/studio/frontend"

          # åˆ›å»º wrapper è„šæœ¬ç›®å½•
          WRAPPER_DIR="$WORKSPACE/.sage/bin"
          mkdir -p "$WRAPPER_DIR"

          # === åˆ›å»ºé€šç”¨çš„ conda wrapper è„šæœ¬ ===
          # è¿™ä¸ªè„šæœ¬ä¼šæ­£ç¡®æ¿€æ´» conda ç¯å¢ƒåæ‰§è¡Œå‘½ä»¤
          # ä½¿ç”¨ printf é¿å… YAML heredoc è§£æé—®é¢˜
          printf '%s\n' '#!/bin/bash' \
            '# Conda environment wrapper for systemd services' \
            '# Usage: conda-run.sh <conda_path> <env_name> <command> [args...]' \
            '' \
            'CONDA_PATH="$1"' \
            'ENV_NAME="$2"' \
            'shift 2' \
            '' \
            '# Initialize conda' \
            'source "$CONDA_PATH/etc/profile.d/conda.sh"' \
            'conda activate "$ENV_NAME"' \
            '' \
            '# Execute the command' \
            'exec "$@"' \
            > "$WRAPPER_DIR/conda-run.sh"
          chmod +x "$WRAPPER_DIR/conda-run.sh"

          # === 1. LLM æœåŠ¡ (vLLM) ===
          cat > /tmp/sage-llm.service << EOF
          [Unit]
          Description=SAGE LLM Service (vLLM)
          After=network.target

          [Service]
          Type=simple
          User=$RUNNER_USER
          WorkingDirectory=$WORKSPACE
          Environment=HF_ENDPOINT=https://hf-mirror.com
          Environment=HF_TOKEN=$HF_TOKEN_VAL
          Environment=CUDA_VISIBLE_DEVICES=0
          ExecStart=$WRAPPER_DIR/conda-run.sh $CONDA_PATH_VAL sage python -m vllm.entrypoints.openai.api_server --model Qwen/Qwen2.5-7B-Instruct --served-model-name Qwen/Qwen2.5-7B-Instruct --host 0.0.0.0 --port 8901 --gpu-memory-utilization 0.9 --max-model-len 4096 --disable-log-stats
          Restart=on-failure
          RestartSec=30

          [Install]
          WantedBy=multi-user.target
          EOF
          # å»é™¤ systemd æ–‡ä»¶è¡Œé¦–ç©ºæ ¼
          sed -i 's/^[[:space:]]*//' /tmp/sage-llm.service
          sudo cp /tmp/sage-llm.service /etc/systemd/system/sage-llm.service
          echo "âœ… sage-llm.service å·²åˆ›å»º"

          # === 2. Embedding æœåŠ¡ ===
          cat > /tmp/sage-embedding.service << EOF
          [Unit]
          Description=SAGE Embedding Service
          After=network.target

          [Service]
          Type=simple
          User=$RUNNER_USER
          WorkingDirectory=$WORKSPACE
          Environment=HF_ENDPOINT=https://hf-mirror.com
          Environment=HF_TOKEN=$HF_TOKEN_VAL
          ExecStart=$WRAPPER_DIR/conda-run.sh $CONDA_PATH_VAL sage python -m sage.common.components.sage_embedding.embedding_server --model BAAI/bge-m3 --port 8090 --host 0.0.0.0
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          sed -i 's/^[[:space:]]*//' /tmp/sage-embedding.service
          sudo cp /tmp/sage-embedding.service /etc/systemd/system/sage-embedding.service
          echo "âœ… sage-embedding.service å·²åˆ›å»º"

          # === 3. Gateway æœåŠ¡ ===
          # è·å– Python site-packages è·¯å¾„
          SITE_PACKAGES=$($CONDA_BIN/python -c "import site; print(site.getsitepackages()[0])")

          # æ„å»º PYTHONPATHï¼ŒåŒ…å« editable install çš„åŒ…è·¯å¾„
          # C++ æ‰©å±• .so æ–‡ä»¶åœ¨æºç ç›®å½•ä¸­
          SAGE_PYTHONPATH="$WORKSPACE/packages/sage-middleware/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-studio/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-gateway/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-common/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-kernel/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-libs/src"
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$WORKSPACE/packages/sage-platform/src"

          # C++ æ‰©å±•åº“è·¯å¾„ - å¿…é¡»åŠ å…¥ PYTHONPATH æ‰èƒ½è¢« importlib.import_module æ‰¾åˆ°
          SAGE_FLOW_PATH="$WORKSPACE/packages/sage-middleware/src/sage/middleware/components/sage_flow/python"
          SAGE_DB_PATH="$WORKSPACE/packages/sage-middleware/src/sage/middleware/components/sage_db/python"
          SAGE_TSDB_PATH="$WORKSPACE/packages/sage-middleware/src/sage/middleware/components/sage_tsdb/python"

          # å°† C++ æ‰©å±•è·¯å¾„åŠ å…¥ PYTHONPATH
          SAGE_PYTHONPATH="$SAGE_PYTHONPATH:$SAGE_FLOW_PATH:$SAGE_DB_PATH:$SAGE_TSDB_PATH"

          cat > /tmp/sage-gateway.service << EOF
          [Unit]
          Description=SAGE Gateway Service
          After=network.target sage-llm.service sage-embedding.service
          Wants=sage-llm.service sage-embedding.service

          [Service]
          Type=simple
          User=$RUNNER_USER
          WorkingDirectory=$WORKSPACE
          Environment=HF_ENDPOINT=https://hf-mirror.com
          Environment=HF_TOKEN=$HF_TOKEN_VAL
          Environment=SAGE_GATEWAY_HOST=0.0.0.0
          Environment=SAGE_GATEWAY_PORT=8888
          Environment=SAGE_CHAT_BASE_URL=http://localhost:8901/v1
          Environment=SAGE_CHAT_MODEL=Qwen/Qwen2.5-7B-Instruct
          Environment=PYTHONPATH=$SAGE_PYTHONPATH
          ExecStart=$WRAPPER_DIR/conda-run.sh $CONDA_PATH_VAL sage sage-gateway
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          sed -i 's/^[[:space:]]*//' /tmp/sage-gateway.service
          sudo cp /tmp/sage-gateway.service /etc/systemd/system/sage-gateway.service
          echo "âœ… sage-gateway.service å·²åˆ›å»º"

          # é‡æ–°åŠ è½½ systemd
          sudo systemctl daemon-reload
          echo "âœ… æ‰€æœ‰æœåŠ¡æ–‡ä»¶å·²åˆ›å»ºå¹¶åŠ è½½"

          # éªŒè¯ wrapper è„šæœ¬
          echo "ğŸ” éªŒè¯ conda wrapper..."
          "$WRAPPER_DIR/conda-run.sh" "$CONDA_PATH_VAL" sage python --version
          "$WRAPPER_DIR/conda-run.sh" "$CONDA_PATH_VAL" sage python -c "import sage.gateway; print('Gateway import OK')"


      - name: Stop existing services before restart
        run: |
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆå‡†å¤‡é‡å¯ï¼‰..."

          # æŒ‰åå‘ä¾èµ–é¡ºåºåœæ­¢
          for svc in sage-frontend sage-gateway sage-embedding sage-llm; do
            if systemctl is-active --quiet $svc 2>/dev/null; then
              echo "åœæ­¢ $svc..."
              sudo systemctl stop $svc || true
            else
              echo "$svc æœªè¿è¡Œ"
            fi
          done

          # é‡Šæ”¾ GPU æ˜¾å­˜
          echo "ğŸ§¹ æ¸…ç† GPU æ˜¾å­˜..."
          pkill -f "vllm" || true
          pkill -f "embedding" || true
          sleep 3

          # æ˜¾ç¤º GPU çŠ¶æ€
          if command -v nvidia-smi &> /dev/null; then
            echo "ğŸ“Š GPU çŠ¶æ€ï¼š"
            nvidia-smi --query-gpu=index,name,memory.used,memory.free --format=csv || true
          fi

          echo "âœ… æœåŠ¡å·²åœæ­¢ï¼ŒGPU æ˜¾å­˜å·²é‡Šæ”¾"

      - name: Start services
        run: |
          echo "ğŸš€ å¯åŠ¨ SAGE Studio æœåŠ¡æ ˆ..."

          # æŒ‰ä¾èµ–é¡ºåºå¯åŠ¨
          echo "1/4 å¯åŠ¨ LLM æœåŠ¡..."
          sudo systemctl start sage-llm
          sudo systemctl enable sage-llm

          echo "2/4 å¯åŠ¨ Embedding æœåŠ¡..."
          sudo systemctl start sage-embedding
          sudo systemctl enable sage-embedding

          # ç­‰å¾… LLM å’Œ Embedding ä¸€ä¼šå„¿ï¼ŒGateway ä¾èµ–å®ƒä»¬
          sleep 5

          echo "3/4 å¯åŠ¨ Gateway æœåŠ¡..."
          sudo systemctl start sage-gateway
          sudo systemctl enable sage-gateway
          # ç«‹å³æ£€æŸ¥ Gateway çŠ¶æ€
          sleep 3
          echo "--- Gateway å¯åŠ¨çŠ¶æ€ ---"
          sudo systemctl status sage-gateway --no-pager || true
          echo "--- Gateway æœ€è¿‘æ—¥å¿— ---"
          sudo journalctl -u sage-gateway --no-pager -n 30 || true
          echo "---"

          echo "4/4 å¯åŠ¨ Frontend æœåŠ¡ (nginx)..."
          sudo systemctl start sage-frontend
          sudo systemctl enable sage-frontend
          # ç«‹å³æ£€æŸ¥ Frontend çŠ¶æ€
          sleep 2
          echo "--- Frontend å¯åŠ¨çŠ¶æ€ ---"
          sudo systemctl status sage-frontend --no-pager || true
          echo "---"

          echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"

          echo ""
          echo "=== æœåŠ¡çŠ¶æ€ ==="
          for svc in sage-llm sage-embedding sage-gateway sage-frontend; do
            status=$(systemctl is-active $svc 2>/dev/null || echo "unknown")
            echo "$svc: $status"
          done

          echo ""
          echo "=== æŸ¥çœ‹æ—¥å¿—å‘½ä»¤ ==="
          echo "sudo journalctl -u sage-llm -f        # LLM æ—¥å¿—"
          echo "sudo journalctl -u sage-embedding -f  # Embedding æ—¥å¿—"
          echo "sudo journalctl -u sage-gateway -f    # Gateway æ—¥å¿—"
          echo "sudo journalctl -u sage-frontend -f   # Frontend æ—¥å¿— (nginx)"
          echo "sudo tail -f /var/log/nginx/*.log    # nginx è¯¦ç»†æ—¥å¿—"

      - name: Wait for services
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."

          PORT="${{ github.event.inputs.port || '5173' }}"

          # ç­‰å¾… LLM æœåŠ¡ï¼ˆæœ€é•¿ 10 åˆ†é’Ÿï¼Œå› ä¸ºè¦åŠ è½½æ¨¡å‹ï¼‰
          echo "ç­‰å¾… LLM æœåŠ¡ (æœ€é•¿ 600 ç§’)..."
          for i in $(seq 1 600); do
            if curl -sf http://localhost:8901/health > /dev/null 2>&1; then
              echo "âœ… LLM æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi
            if [ $((i % 60)) -eq 0 ]; then
              echo "â³ LLM ç­‰å¾…ä¸­... ($i/600 ç§’)"
              sudo journalctl -u sage-llm --no-pager -n 5 2>/dev/null || true
            fi
            sleep 1
          done

          # ç­‰å¾… Embedding æœåŠ¡
          echo "ç­‰å¾… Embedding æœåŠ¡..."
          for i in $(seq 1 120); do
            if curl -sf http://localhost:8090/health > /dev/null 2>&1; then
              echo "âœ… Embedding æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi
            sleep 1
          done

          # ç­‰å¾… Gateway æœåŠ¡
          echo "ç­‰å¾… Gateway æœåŠ¡..."
          for i in $(seq 1 120); do
            if curl -sf http://localhost:8888/ > /dev/null 2>&1 || \
               curl -sf http://localhost:8888/health > /dev/null 2>&1; then
              echo "âœ… Gateway æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi
            if [ $((i % 30)) -eq 0 ]; then
              echo "â³ Gateway ç­‰å¾…ä¸­... ($i/120 ç§’)"
              sudo journalctl -u sage-gateway --no-pager -n 5 2>/dev/null || true
            fi
            sleep 1
          done

          # ç­‰å¾… Frontend æœåŠ¡ (nginx)
          echo "ç­‰å¾… Frontend æœåŠ¡ (nginx)..."
          for i in $(seq 1 60); do
            if curl -sf http://localhost:$PORT > /dev/null 2>&1; then
              echo "âœ… Frontend æœåŠ¡å°±ç»ªï¼ˆç¬¬ $i ç§’ï¼‰"
              break
            fi
            if [ $((i % 20)) -eq 0 ]; then
              echo "â³ Frontend ç­‰å¾…ä¸­... ($i/60 ç§’)"
              sudo nginx -t 2>&1 || true
            fi
            sleep 1
          done

      - name: Health check
        run: |
          echo "ğŸ” å¥åº·æ£€æŸ¥..."
          PORT="${{ github.event.inputs.port || '5173' }}"

          echo ""
          echo "=== æœåŠ¡çŠ¶æ€ ==="
          for svc in sage-llm sage-embedding sage-gateway sage-frontend; do
            status=$(systemctl is-active $svc 2>/dev/null || echo "unknown")
            echo "$svc: $status"
          done

          echo ""
          echo "| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |"
          echo "|------|------|------|"

          for svc_port in "Frontend:$PORT" "Gateway:8888" "LLM:8901" "Embedding:8090"; do
            name="${svc_port%%:*}"
            port="${svc_port##*:}"
            # å°è¯•å¤šä¸ªç«¯ç‚¹ï¼š/ å’Œ /health
            if curl -sf "http://localhost:$port/" > /dev/null 2>&1 || \
               curl -sf "http://localhost:$port/health" > /dev/null 2>&1 || \
               curl -sf "http://localhost:$port/v1/models" > /dev/null 2>&1; then
              echo "| $name | $port | âœ… |"
            else
              echo "| $name | $port | âš ï¸ |"
              # æ‰“å°å¤±è´¥æœåŠ¡çš„æœ€è¿‘æ—¥å¿—
              svc_name="sage-$(echo $name | tr '[:upper:]' '[:lower:]')"
              echo ""
              echo "--- $svc_name æœ€è¿‘æ—¥å¿— ---"
              sudo journalctl -u $svc_name --no-pager -n 20 2>/dev/null || true
              echo "---"
            fi
          done

          echo ""
          echo "=== GPU çŠ¶æ€ ==="
          nvidia-smi --query-gpu=name,memory.used,memory.free --format=csv 2>/dev/null || true

      - name: Verify Cloudflare Tunnel
        continue-on-error: true
        run: |
          echo "ğŸŒ æ£€æŸ¥ Cloudflare Tunnel..."

          if systemctl is-active --quiet cloudflared 2>/dev/null; then
            echo "âœ… cloudflared ç³»ç»ŸæœåŠ¡è¿è¡Œä¸­"
          else
            echo "âš ï¸ cloudflared æœªè¿è¡Œ"
          fi

          # æµ‹è¯•å…¬ç½‘è®¿é—®
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://studio.sage.org.ai 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… https://studio.sage.org.ai å¯è®¿é—®"
          else
            echo "âš ï¸ å…¬ç½‘è®¿é—®è¿”å› HTTP $HTTP_CODE"
          fi

      - name: Summary
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"

          echo "## ğŸ‰ SAGE Studio éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "| æ–¹å¼ | åœ°å€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ Cloudflare | https://studio.sage.org.ai |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ  æœ¬åœ° | http://localhost:$PORT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ç®¡ç†å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "for svc in sage-llm sage-embedding sage-gateway sage-frontend; do sudo systemctl status \$svc; done" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u sage-llm -f        # LLM æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u sage-embedding -f  # Embedding æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u sage-gateway -f    # Gateway æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u sage-frontend -f   # Frontend æ—¥å¿— (nginx)" >> $GITHUB_STEP_SUMMARY
          echo "sudo tail -f /var/log/nginx/*.log    # nginx è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# é‡å¯æ‰€æœ‰æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "for svc in sage-llm sage-embedding sage-gateway sage-frontend; do sudo systemctl restart \$svc; done" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# åœæ­¢æ‰€æœ‰æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "for svc in sage-frontend sage-gateway sage-embedding sage-llm; do sudo systemctl stop \$svc; done" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
