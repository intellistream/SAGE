name: Deploy SAGE Studio to Self-Hosted Server

on:
  # Manual trigger - recommended for production deployment
  workflow_dispatch:
    inputs:
      port:
        description: 'Studio port (default: 5173)'
        required: false
        default: '5173'
      tunnel_domain:
        description: 'Cloudflare Tunnel domain (e.g., sage-studio.example.com)'
        required: false
        default: ''
  # Auto deploy only on main branch (stable releases)
  push:
    branches:
      - main
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'

env:
  # Default Cloudflare Tunnel domain
  DEFAULT_TUNNEL_DOMAIN: 'studio.sage.org.ai'

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 120  # é¦–æ¬¡å®‰è£… NVIDIA CUDA åŒ…éœ€è¦è¾ƒé•¿æ—¶é—´

    # Define secrets as env vars at job level for conditional checks
    env:
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      # Conda çŽ¯å¢ƒåç§°ï¼ˆæŒä¹…åŒ–ï¼Œå¤ç”¨å·²å®‰è£…çš„åŒ…ï¼‰
      CONDA_ENV_NAME: sage-studio

    # é»˜è®¤ä½¿ç”¨ bashï¼Œå¹¶è‡ªåŠ¨æ¿€æ´» conda çŽ¯å¢ƒ
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      # ä½¿ç”¨æŒä¹…åŒ–çš„ conda çŽ¯å¢ƒï¼Œé¿å…æ¯æ¬¡é‡æ–°ä¸‹è½½å¤§åŒ…
      - name: Setup Conda Environment
        run: |
          echo "ðŸ è®¾ç½® Conda çŽ¯å¢ƒ..."
          echo "HOME=$HOME, USER=$(whoami)"

          # åˆå§‹åŒ– condaï¼ˆæ”¯æŒå¤šç§å®‰è£…ä½ç½®ï¼ŒåŒ…æ‹¬ç‰¹å®šç”¨æˆ·ç›®å½•ï¼‰
          CONDA_SH=""
          CONDA_PATHS=(
            "$HOME/miniconda3/etc/profile.d/conda.sh"
            "/home/shuhao/miniconda3/etc/profile.d/conda.sh"
            "$HOME/anaconda3/etc/profile.d/conda.sh"
            "$HOME/miniforge3/etc/profile.d/conda.sh"
            "/opt/conda/etc/profile.d/conda.sh"
            "/usr/local/conda/etc/profile.d/conda.sh"
          )

          echo "æ£€æŸ¥ conda è·¯å¾„..."
          for path in "${CONDA_PATHS[@]}"; do
            if [ -f "$path" ]; then
              CONDA_SH="$path"
              echo "âœ… æ‰¾åˆ° conda: $path"
              break
            fi
          done

          # å¦‚æžœæ²¡æ‰¾åˆ°ï¼Œè‡ªåŠ¨å®‰è£… miniconda
          if [ -z "$CONDA_SH" ]; then
            echo "ðŸ“¦ æœªæ‰¾åˆ° condaï¼Œæ­£åœ¨å®‰è£… Miniconda..."
            MINICONDA_PATH="$HOME/miniconda3"

            # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å®‰è£…ç¨‹åºç¼“å­˜
            INSTALLER="$HOME/.cache/miniconda_installer.sh"
            mkdir -p "$HOME/.cache"

            if [ ! -f "$INSTALLER" ]; then
              echo "ä¸‹è½½ Miniconda å®‰è£…ç¨‹åº..."
              # ä½¿ç”¨æ¸…åŽé•œåƒåŠ é€Ÿä¸‹è½½
              curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh -o "$INSTALLER"
            fi

            echo "å®‰è£… Miniconda åˆ° $MINICONDA_PATH..."
            bash "$INSTALLER" -b -p "$MINICONDA_PATH"

            CONDA_SH="$MINICONDA_PATH/etc/profile.d/conda.sh"
            echo "âœ… Miniconda å®‰è£…å®Œæˆ"
          fi

          source "$CONDA_SH"
          echo "âœ… Conda å·²åˆå§‹åŒ–"

          # é…ç½® conda ä½¿ç”¨æ¸…åŽé•œåƒ
          conda config --set show_channel_urls yes
          conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
          conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
          conda config --set channel_priority flexible

          # ä¼˜å…ˆä½¿ç”¨å·²æœ‰çš„ sage çŽ¯å¢ƒï¼ˆæœåŠ¡å™¨ä¸Šå·²ç»å­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ CONDA_ENV_NAME
          if conda env list | grep -q "^sage "; then
            ACTUAL_ENV="sage"
            echo "âœ… ä½¿ç”¨å·²æœ‰çš„ 'sage' çŽ¯å¢ƒï¼ˆåŒ…å«å·²å®‰è£…çš„ä¾èµ–ï¼‰"
          elif conda env list | grep -q "^${CONDA_ENV_NAME} "; then
            ACTUAL_ENV="${CONDA_ENV_NAME}"
            echo "âœ… ä½¿ç”¨ '${CONDA_ENV_NAME}' çŽ¯å¢ƒ"
          else
            ACTUAL_ENV="${CONDA_ENV_NAME}"
            echo "ðŸ“¦ åˆ›å»ºæ–°çš„ Conda çŽ¯å¢ƒ '${ACTUAL_ENV}'..."
            conda create -n ${ACTUAL_ENV} python=3.11 -y
          fi

          # æ¿€æ´»çŽ¯å¢ƒå¹¶æ˜¾ç¤ºä¿¡æ¯
          conda activate ${ACTUAL_ENV}

          echo "Python ç‰ˆæœ¬: $(python --version)"
          echo "Python è·¯å¾„: $(which python)"
          echo "pip è·¯å¾„: $(which pip)"

          # æ£€æŸ¥å·²å®‰è£…çš„ NVIDIA åŒ…ï¼ˆéªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆï¼‰
          echo ""
          echo "ðŸ“¦ å·²å®‰è£…çš„ NVIDIA CUDA åŒ…ï¼š"
          pip list 2>/dev/null | grep -i nvidia || echo "ï¼ˆæš‚æ— ï¼Œé¦–æ¬¡å®‰è£…æ—¶ä¼šä¸‹è½½ï¼‰"

          # å¯¼å‡ºå®žé™…ä½¿ç”¨çš„çŽ¯å¢ƒåï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "ACTUAL_CONDA_ENV=${ACTUAL_ENV}" >> $GITHUB_ENV

          # å°† conda åˆå§‹åŒ–å‘½ä»¤å†™å…¥ ~/.bashrcï¼Œä¾›åŽç»­æ­¥éª¤è‡ªåŠ¨åŠ è½½
          # è¿™æ ·é…åˆ shell: bash -el {0} å¯ä»¥è‡ªåŠ¨æ¿€æ´»çŽ¯å¢ƒ
          if ! grep -q "conda.sh" ~/.bashrc 2>/dev/null; then
            echo "source ${CONDA_SH}" >> ~/.bashrc
          fi
          # ä½¿ç”¨å®žé™…çš„çŽ¯å¢ƒå
          if ! grep -q "conda activate ${ACTUAL_ENV}" ~/.bashrc 2>/dev/null; then
            # å…ˆç§»é™¤æ—§çš„ conda activate è¡Œ
            sed -i '/conda activate/d' ~/.bashrc 2>/dev/null || true
            echo "conda activate ${ACTUAL_ENV}" >> ~/.bashrc
          fi
          echo "âœ… Conda çŽ¯å¢ƒ '${ACTUAL_ENV}' é…ç½®å®Œæˆï¼ŒåŽç»­æ­¥éª¤å°†è‡ªåŠ¨æ¿€æ´»"

      - name: Stop existing services
        continue-on-error: true
        run: |
          echo "ðŸ›‘ Stopping existing SAGE Studio services..."
          pkill -f "sage studio" || true
          pkill -f "sage-gateway" || true
          pkill -f "cloudflared tunnel" || true
          sleep 2

      - name: Install System Dependencies
        continue-on-error: true
        run: |
          echo "ðŸ“¦ æ£€æŸ¥/å®‰è£…ç³»ç»Ÿä¾èµ–..."
          # Try with sudo if available, skip if not (dependencies should be pre-installed on self-hosted runner)
          if sudo -n true 2>/dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends \
              build-essential \
              cmake \
              pkg-config \
              git
            echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
          else
            echo "âš ï¸ æ—  sudo æƒé™ï¼Œè·³è¿‡ç³»ç»Ÿä¾èµ–å®‰è£…ï¼ˆå‡è®¾å·²é¢„è£…ï¼‰"
            # Verify essential commands exist
            command -v cmake && command -v git && echo "âœ… å¿…è¦å·¥å…·å·²å­˜åœ¨"
          fi

      - name: Check existing SAGE installation
        id: check-sage
        run: |
          echo "ðŸ” æ£€æŸ¥çŽ°æœ‰ SAGE å®‰è£…..."
          echo "å½“å‰ Python: $(which python)"
          echo "å½“å‰ Conda çŽ¯å¢ƒ: ${ACTUAL_CONDA_ENV:-æœªè®¾ç½®}"

          CURRENT_COMMIT="${{ github.sha }}"
          DEPLOYED_COMMIT_FILE="$HOME/.sage_deployed_commit_${ACTUAL_CONDA_ENV:-sage}"

          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…å¹¶å¯å¯¼å…¥
          if python -c "import sage.studio; import sage.gateway" 2>/dev/null; then
            echo "sage_installed=true" >> $GITHUB_OUTPUT
            echo "âœ… SAGE å·²å®‰è£…"

            # æ£€æŸ¥ä¸Šæ¬¡éƒ¨ç½²çš„ commit
            if [ -f "$DEPLOYED_COMMIT_FILE" ]; then
              DEPLOYED_COMMIT=$(cat "$DEPLOYED_COMMIT_FILE")
              echo "ä¸Šæ¬¡éƒ¨ç½² commit: $DEPLOYED_COMMIT"
              echo "å½“å‰éƒ¨ç½² commit: $CURRENT_COMMIT"

              if [ "$DEPLOYED_COMMIT" = "$CURRENT_COMMIT" ]; then
                echo "needs_update=false" >> $GITHUB_OUTPUT
                echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€é‡æ–°å®‰è£…"
              else
                echo "needs_update=true" >> $GITHUB_OUTPUT
                echo "ðŸ“¦ ç‰ˆæœ¬ä¸åŒï¼Œéœ€è¦æ›´æ–°"
              fi
            else
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ é¦–æ¬¡éƒ¨ç½²è®°å½•ï¼Œéœ€è¦æ›´æ–°"
            fi
          else
            echo "sage_installed=false" >> $GITHUB_OUTPUT
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ SAGE æœªå®‰è£…ï¼Œéœ€è¦å®Œæ•´å®‰è£…"
          fi

      - name: Install/Update SAGE
        if: steps.check-sage.outputs.needs_update == 'true'
        run: |
          echo "ðŸ“¦ å®‰è£…/æ›´æ–° SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."
          echo "å½“å‰ Python: $(which python)"
          echo "å½“å‰ pip: $(which pip)"

          chmod +x ./quickstart.sh

          # é…ç½®å›½å†… PyPI é•œåƒåŠ é€Ÿï¼ˆæ¸…åŽæºï¼‰
          export PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
          export PIP_TRUSTED_HOST=pypi.tuna.tsinghua.edu.cn
          # å¢žåŠ è¶…æ—¶å’Œé‡è¯•é…ç½®
          export PIP_DEFAULT_TIMEOUT=300
          export PIP_RETRIES=5

          # å¦‚æžœå·²å®‰è£…ï¼Œä½¿ç”¨å¢žé‡æ›´æ–°æ¨¡å¼
          if [ "${{ steps.check-sage.outputs.sage_installed }}" = "true" ]; then
            echo "ðŸ”„ æ‰§è¡Œå¢žé‡æ›´æ–°..."
            # åªé‡æ–°å®‰è£… editable åŒ…ï¼Œä¸é‡è£…ä¾èµ–
            pip install -e packages/sage-common --no-deps -q
            pip install -e packages/sage-platform --no-deps -q
            pip install -e packages/sage-kernel --no-deps -q
            pip install -e packages/sage-libs --no-deps -q
            pip install -e packages/sage-middleware --no-deps -q
            pip install -e packages/sage-apps --no-deps -q
            pip install -e packages/sage-studio --no-deps -q
            pip install -e packages/sage-gateway --no-deps -q
            pip install -e packages/sage-cli --no-deps -q
            pip install -e packages/sage-tools --no-deps -q
            pip install -e packages/sage --no-deps -q
            echo "âœ… å¢žé‡æ›´æ–°å®Œæˆ"
          else
            echo "ðŸ“¦ æ‰§è¡Œå®Œæ•´å®‰è£…..."
            # å¼ºåˆ¶ä½¿ç”¨ä¸­å›½é•œåƒ + ä½¿ç”¨å½“å‰ conda çŽ¯å¢ƒçš„ pip
            export SAGE_FORCE_CHINA_MIRROR=true
            # å–æ¶ˆ CI å˜é‡ï¼Œè®© quickstart.sh å®‰è£…åˆ°å½“å‰ conda çŽ¯å¢ƒ
            unset CI GITHUB_ACTIONS
            ./quickstart.sh --dev --yes --pip
          fi

          # è®°å½•éƒ¨ç½²çš„ commitï¼Œç”¨äºŽä¸‹æ¬¡å¢žé‡æ£€æµ‹ï¼ˆæŒ‰çŽ¯å¢ƒååŒºåˆ†ï¼‰
          echo "${{ github.sha }}" > "$HOME/.sage_deployed_commit_${ACTUAL_CONDA_ENV:-sage}"

          echo "âœ… SAGE å®‰è£…/æ›´æ–°å®Œæˆ"
        timeout-minutes: 90  # NVIDIA CUDA åŒ…å¾ˆå¤§ï¼Œéœ€è¦æ›´é•¿æ—¶é—´

      - name: Skip installation (up to date)
        if: steps.check-sage.outputs.needs_update != 'true'
        run: |
          echo "â­ï¸ SAGE å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."
          echo "å½“å‰ Python: $(which python)"

          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.cli; print('âœ… sage.cli imported')"
          python -c "import sage.studio; print('âœ… sage.studio imported')"

          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… sage å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage å‘½ä»¤ä¸å¯ç”¨"
          fi

      - name: Build Studio (Production)
        if: steps.check-sage.outputs.needs_update == 'true'
        run: |
          echo "ðŸ—ï¸  æž„å»º SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          sage studio build

          echo "âœ… Studio æž„å»ºå®Œæˆ"

      - name: Skip build (up to date)
        if: steps.check-sage.outputs.needs_update != 'true'
        run: |
          echo "â­ï¸ ä»£ç æ— å˜åŒ–ï¼Œè·³è¿‡å‰ç«¯æž„å»º"

      - name: Start SAGE Studio
        run: |
          echo "ðŸš€ å¯åŠ¨ SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          # Production mode for better performance and stability
          # 1. Builds RAG index from docs-public if needed
          # 2. Starts Gateway on port 8000
          # 3. Starts local LLM service via sageLLM (default: Qwen2.5-0.5B-Instruct)
          # 4. Builds and serves optimized frontend on port 5173 (Vite default)
          #
          # CI Mode Options:
          # -y: Non-interactive mode (skip all prompts, use default LLM/Embedding config)
          nohup sage studio start --prod --host 0.0.0.0 --port ${{ github.event.inputs.port || '5173' }} -y > ~/sage-studio-deploy.log 2>&1 &

          sleep 15  # Production build needs more time

          echo "âœ… Studio å·²å¯åŠ¨"

      - name: Health check
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"
          echo "ðŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."

          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨
          if curl -f http://localhost:${PORT} 2>/dev/null; then
            echo "âœ… Studio æœåŠ¡å¥åº·ï¼Œç«¯å£ ${PORT} å¯è®¿é—®"
          else
            echo "âš ï¸  Studio å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
            tail -50 ~/sage-studio-deploy.log || echo "æš‚æ— æ—¥å¿—"
          fi

          # æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
          echo ""
          echo "ðŸ“¡ æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€..."
          if command -v netstat &> /dev/null; then
            netstat -tlnp 2>/dev/null | grep ":${PORT}" || echo "âš ï¸ ç«¯å£ ${PORT} æœªåœ¨ç›‘å¬"
          elif command -v ss &> /dev/null; then
            ss -tlnp 2>/dev/null | grep ":${PORT}" || echo "âš ï¸ ç«¯å£ ${PORT} æœªåœ¨ç›‘å¬"
          fi

          # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
          echo ""
          echo "ðŸ”§ æ£€æŸ¥ SAGE Studio è¿›ç¨‹..."
          ps aux | grep "[s]age studio" || echo "âš ï¸ æœªæ‰¾åˆ° SAGE Studio è¿›ç¨‹"

      - name: Setup Cloudflare Tunnel
        if: ${{ env.CLOUDFLARE_TUNNEL_TOKEN != '' }}
        run: |
          echo "ðŸŒ é…ç½® Cloudflare Tunnel..."

          # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­ï¼ˆcloudflared å®‰è£…ä½ç½®ï¼‰
          export PATH="$HOME/.local/bin:$PATH"

          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£… cloudflared
          if ! command -v cloudflared &> /dev/null; then
            echo "ðŸ“¦ å®‰è£… cloudflared..."
            mkdir -p ~/.local/bin
            curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o ~/.local/bin/cloudflared
            chmod +x ~/.local/bin/cloudflared
          fi

          cloudflared --version
          echo "âœ… cloudflared å·²å°±ç»ª"

      - name: Start Cloudflare Tunnel
        if: ${{ env.CLOUDFLARE_TUNNEL_TOKEN != '' }}
        run: |
          echo "ðŸš€ å¯åŠ¨ Cloudflare Tunnel..."

          export PATH="$HOME/.local/bin:$PATH"

          # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§ tunnel è¿›ç¨‹
          pkill -f "cloudflared tunnel" || true
          sleep 2

          # å¯åŠ¨ tunnel
          nohup cloudflared tunnel run --token "${CLOUDFLARE_TUNNEL_TOKEN}" > ~/cloudflared.log 2>&1 &

          sleep 5

          # éªŒè¯ tunnel æ˜¯å¦å¯åŠ¨
          if pgrep -f "cloudflared tunnel" > /dev/null; then
            echo "âœ… Cloudflare Tunnel å·²å¯åŠ¨"
          else
            echo "âŒ Cloudflare Tunnel å¯åŠ¨å¤±è´¥"
            tail -20 ~/cloudflared.log || echo "æš‚æ— æ—¥å¿—"
            exit 1
          fi

      - name: Network accessibility check
        continue-on-error: true
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"
          SERVER_IP=$(hostname -I | awk '{print $1}')

          echo "ðŸŒ æµ‹è¯•ç½‘ç»œå¯è¾¾æ€§..."
          echo ""
          echo "æµ‹è¯•ä»Žæœ¬æœºè®¿é—®ï¼š"

          # æµ‹è¯• localhost
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT} | grep -q "200"; then
            echo "âœ… localhost:${PORT} å¯è®¿é—®"
          else
            echo "âŒ localhost:${PORT} ä¸å¯è®¿é—®"
          fi

          # æµ‹è¯•å†…ç½‘IP
          if curl -s -o /dev/null -w "%{http_code}" http://${SERVER_IP}:${PORT} | grep -q "200"; then
            echo "âœ… ${SERVER_IP}:${PORT} å¯è®¿é—®"
          else
            echo "âŒ ${SERVER_IP}:${PORT} ä¸å¯è®¿é—®"
          fi

          # æ£€æŸ¥é˜²ç«å¢™è§„åˆ™ï¼ˆå¯é€‰ï¼Œä»…ä¾›å‚è€ƒï¼‰
          echo ""
          echo "ðŸ”¥ é˜²ç«å¢™æ£€æŸ¥ï¼š"
          if command -v ufw &> /dev/null && sudo -n true 2>/dev/null; then
            echo "UFW çŠ¶æ€ï¼š"
            sudo ufw status | grep -E "Status|${PORT}" || echo "ç«¯å£ ${PORT} æœªåœ¨ UFW è§„åˆ™ä¸­"
          else
            echo "âš ï¸ è·³è¿‡ UFW æ£€æŸ¥ï¼ˆæ—  sudo æƒé™æˆ–æœªå®‰è£…ï¼‰"
          fi

          if command -v iptables &> /dev/null && sudo -n true 2>/dev/null; then
            echo ""
            echo "IPTables å…¥ç«™è§„åˆ™ï¼ˆç«¯å£ ${PORT}ï¼‰ï¼š"
            sudo iptables -L INPUT -n -v 2>/dev/null | grep -E "dpt:${PORT}|ACCEPT.*all" | head -5 || echo "æœªæ‰¾åˆ°ç›¸å…³è§„åˆ™"
          fi

          # è¾“å‡ºç½‘ç»œå»ºè®®
          echo ""
          echo "ðŸ“ æ ¡å›­ç½‘è®¿é—®å»ºè®®ï¼š"
          echo "1. âœ… ç¡®è®¤æœåŠ¡å·²å¯åŠ¨å¹¶ç›‘å¬ 0.0.0.0:${PORT}"
          echo "2. ðŸ”§ å¦‚æžœæ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "   - æœåŠ¡å™¨é˜²ç«å¢™é…ç½® (ufw/iptables)"
          echo "   - æ ¡å›­ç½‘é˜²ç«å¢™/å®‰å…¨ç»„è§„åˆ™"
          echo "   - ç½‘ç»œéš”ç¦»ç­–ç•¥ï¼ˆæŸäº›æ ¡å›­ç½‘å¯èƒ½æœ‰VLANéš”ç¦»ï¼‰"
          echo "3. ðŸ’¡ å»ºè®®è”ç³»ç½‘ç»œç®¡ç†å‘˜å¼€æ”¾ç«¯å£ ${PORT}"
          echo "4. ðŸ” æˆ–é…ç½®æ ¡å›­ç½‘VPNä»¥è®¿é—®å†…ç½‘æœåŠ¡"

      - name: Deployment summary
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"
          TUNNEL_DOMAIN="${{ github.event.inputs.tunnel_domain || env.DEFAULT_TUNNEL_DOMAIN }}"

          # èŽ·å–æœåŠ¡å™¨ç½‘ç»œä¿¡æ¯
          SERVER_IP=$(hostname -I | awk '{print $1}')
          HOSTNAME=$(hostname -f)
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "N/A")

          # æ£€æµ‹ Cloudflare Tunnel çŠ¶æ€
          TUNNEL_STATUS="âŒ æœªè¿è¡Œ"
          if pgrep -f "cloudflared tunnel" > /dev/null; then
            TUNNEL_STATUS="âœ… è¿è¡Œä¸­"
          fi

          # æ£€æµ‹é˜²ç«å¢™çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
          FIREWALL_STATUS="æœªæ£€æŸ¥"
          if command -v ufw &> /dev/null && sudo -n true 2>/dev/null; then
            if sudo ufw status | grep -q "Status: active"; then
              if sudo ufw status | grep -q "$PORT"; then
                FIREWALL_STATUS="âœ… UFW: ç«¯å£ $PORT å·²å¼€æ”¾"
              else
                FIREWALL_STATUS="âš ï¸ UFW: ç«¯å£ $PORT å¯èƒ½æœªå¼€æ”¾"
              fi
            else
              FIREWALL_STATUS="âœ… UFW æœªå¯ç”¨"
            fi
          fi

          # ä¿å­˜éƒ¨ç½²ä¿¡æ¯åˆ°æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰
          DEPLOY_INFO_FILE="$HOME/sage-studio-deployment-info.txt"
          cat > "$DEPLOY_INFO_FILE" << EOF
          ======================================
          SAGE Studio éƒ¨ç½²ä¿¡æ¯
          ======================================
          éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')

          è®¿é—®åœ°å€:
          - Cloudflare Tunnel: https://${TUNNEL_DOMAIN} (æŽ¨èï¼Œå…¨çƒå¯è®¿é—®)
          - å†…ç½‘IP: http://${SERVER_IP}:${PORT}
          - ä¸»æœºå: http://${HOSTNAME}:${PORT}
          - å…¬ç½‘IP: http://${PUBLIC_IP}:${PORT} (å¦‚æžœå¯ç”¨)

          æœåŠ¡çŠ¶æ€:
          - ç«¯å£: ${PORT}
          - ç›‘å¬: 0.0.0.0 (æ‰€æœ‰ç½‘ç»œæŽ¥å£)
          - Cloudflare Tunnel: ${TUNNEL_STATUS}
          - é˜²ç«å¢™: ${FIREWALL_STATUS}

          æ—¥å¿—æ–‡ä»¶:
          - Studio æ—¥å¿—: ~/sage-studio-deploy.log
          - Tunnel æ—¥å¿—: ~/cloudflared.log

          ç®¡ç†å‘½ä»¤:
          - æŸ¥çœ‹çŠ¶æ€: ps aux | grep -E "sage studio|cloudflared"
          - åœæ­¢æœåŠ¡: pkill -f "sage studio" && pkill -f "cloudflared tunnel"
          - é‡å¯æœåŠ¡: é‡æ–°è¿è¡Œæ­¤ workflow
          ======================================
          EOF

          echo "âœ… éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ°: $DEPLOY_INFO_FILE"
          cat "$DEPLOY_INFO_FILE"

          # è¾“å‡ºåˆ° GitHub Actions Summary
          echo "## ðŸŽ‰ SAGE Studio éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–¹å¼ | è®¿é—®åœ°å€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ **Cloudflare Tunnel** | [\`https://${TUNNEL_DOMAIN}\`](https://${TUNNEL_DOMAIN}) | **æŽ¨è - å…¨çƒå¯è®¿é—®ï¼Œè‡ªåŠ¨ HTTPS** |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ« æ ¡å›­ç½‘å†… | \`http://${SERVER_IP}:${PORT}\` | å†…ç½‘ç›´è¿ž |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ ä¸»æœºå | \`http://${HOSTNAME}:${PORT}\` | å¦‚æžœDNSé…ç½®æ­£ç¡® |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAGE Studio | âœ… è¿è¡Œä¸­ (ç«¯å£ ${PORT}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Tunnel | ${TUNNEL_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| é˜²ç«å¢™ | ${FIREWALL_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¯è§†åŒ–æµæ°´çº¿ç¼–è¾‘å™¨" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI å¯¹è¯ï¼ˆæœ¬åœ° LLM + RAGï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… äº¤äº’å¼è°ƒè¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Studio æ—¥å¿—ï¼ˆæœ€è¿‘30è¡Œï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 ~/sage-studio-deploy.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Cloudflare Tunnel æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 ~/cloudflared.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Tunnel logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
