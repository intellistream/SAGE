name: Deploy SAGE Studio to Self-Hosted Server

on:
  # Manual trigger - recommended for production deployment
  workflow_dispatch:
    inputs:
      port:
        description: 'Studio port (default: 5173)'
        required: false
        default: '5173'
      tunnel_domain:
        description: 'Cloudflare Tunnel domain (e.g., sage-studio.example.com)'
        required: false
        default: ''
  # Auto deploy only on main branch (stable releases)
  push:
    branches:
      - main
    paths:
      - 'packages/sage-studio/**'
      - 'packages/sage-gateway/**'

env:
  # Default Cloudflare Tunnel domain
  DEFAULT_TUNNEL_DOMAIN: 'studio.sage.org.ai'

jobs:
  deploy:
    # å¼ºåˆ¶ä½¿ç”¨ A100 runnerï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§ï¼ˆä¸ paper1-experiments.yml ç›¸åŒï¼‰
    runs-on: [self-hosted, A100]
    timeout-minutes: 120  # é¦–æ¬¡å®‰è£… NVIDIA CUDA åŒ…éœ€è¦è¾ƒé•¿æ—¶é—´

    # Define secrets as env vars at job level for conditional checks
    env:
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      # äº‘ç«¯ Chat API é…ç½®ï¼ˆå½“ --no-llm æ—¶ä½¿ç”¨ï¼‰
      SAGE_CHAT_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      SAGE_CHAT_MODEL: qwen-turbo-2025-02-11
      SAGE_CHAT_BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1
      # Conda ç¯å¢ƒåç§°ï¼ˆç»Ÿä¸€ä½¿ç”¨ sageï¼Œä¸å¼€å‘ç¯å¢ƒä¸€è‡´ï¼‰
      CONDA_ENV_NAME: sage

    # é»˜è®¤ä½¿ç”¨ bashï¼Œå¹¶è‡ªåŠ¨æ¿€æ´» conda ç¯å¢ƒ
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      # ä½¿ç”¨æŒä¹…åŒ–çš„ conda ç¯å¢ƒï¼Œé¿å…æ¯æ¬¡é‡æ–°ä¸‹è½½å¤§åŒ…
      # å‚è€ƒ paper1-experiments.yml çš„æ¨¡å¼
      - name: Setup Conda Environment
        run: |
          echo "ğŸ è®¾ç½® Conda ç¯å¢ƒ..."

          # å®šä¹‰ conda åˆå§‹åŒ–å‡½æ•°
          init_conda() {
            for conda_path in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda" "/usr/local/miniconda3"; do
              if [ -f "$conda_path/etc/profile.d/conda.sh" ]; then
                source "$conda_path/etc/profile.d/conda.sh"
                return 0
              fi
            done
            return 1
          }

          # å°è¯•åˆå§‹åŒ– conda
          if ! init_conda; then
            echo "ğŸ“¦ æœªæ‰¾åˆ° condaï¼Œæ­£åœ¨å®‰è£… Miniconda..."
            wget -q https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
            bash /tmp/miniconda.sh -b -p $HOME/miniconda3
            source "$HOME/miniconda3/etc/profile.d/conda.sh"
            rm /tmp/miniconda.sh
          fi

          conda --version
          echo "âœ… Conda å·²åˆå§‹åŒ–"

          # é…ç½® conda ä½¿ç”¨æ¸…åé•œåƒ
          conda config --set show_channel_urls yes 2>/dev/null || true
          conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/ 2>/dev/null || true
          conda config --set channel_priority flexible 2>/dev/null || true

          # ç¡®å®šä½¿ç”¨çš„ç¯å¢ƒåï¼ˆä¼˜å…ˆä½¿ç”¨å·²æœ‰çš„ sage ç¯å¢ƒï¼‰
          if conda env list | grep -q "^sage "; then
            ACTUAL_ENV="sage"
            echo "âœ… å¤ç”¨å·²æœ‰çš„ 'sage' ç¯å¢ƒ"
          elif conda env list | grep -q "^${CONDA_ENV_NAME} "; then
            ACTUAL_ENV="${CONDA_ENV_NAME}"
            echo "âœ… ä½¿ç”¨ '${CONDA_ENV_NAME}' ç¯å¢ƒ"
          else
            ACTUAL_ENV="${CONDA_ENV_NAME}"
            echo "ğŸ“¦ åˆ›å»ºæ–°çš„ Conda ç¯å¢ƒ '${ACTUAL_ENV}'..."
            conda create -n ${ACTUAL_ENV} python=3.11 -y
          fi

          # éªŒè¯ç¯å¢ƒ
          conda run -n ${ACTUAL_ENV} python --version
          echo "âœ… Conda ç¯å¢ƒå°±ç»ª"

          # æ£€æŸ¥æ ¸å¿ƒä¾èµ–æ˜¯å¦å·²å®‰è£…
          NVIDIA_COUNT=$(conda run -n ${ACTUAL_ENV} pip list 2>/dev/null | grep -c -i "nvidia" || echo "0")
          TORCH_COUNT=$(conda run -n ${ACTUAL_ENV} pip list 2>/dev/null | grep -c "^torch " || echo "0")

          if [ "$NVIDIA_COUNT" -gt 5 ] && [ "$TORCH_COUNT" -gt 0 ]; then
            echo "deps_installed=true" >> $GITHUB_ENV
            echo "âœ… æ ¸å¿ƒä¾èµ–å·²å®‰è£…ï¼ˆNVIDIA: $NVIDIA_COUNT, PyTorch: $TORCH_COUNTï¼‰"
          else
            echo "deps_installed=false" >> $GITHUB_ENV
            echo "ğŸ“¦ éœ€è¦å®‰è£…æ ¸å¿ƒä¾èµ–"
          fi

          # ä¿å­˜ç¯å¢ƒä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CONDA_PATH=$(dirname $(dirname $(which conda)))" >> $GITHUB_ENV
          echo "ACTUAL_CONDA_ENV=${ACTUAL_ENV}" >> $GITHUB_ENV

      - name: Stop existing services
        continue-on-error: true
        run: |
          echo "ğŸ›‘ Stopping existing SAGE Studio services..."
          pkill -f "sage studio" || true
          pkill -f "sage-gateway" || true
          # æ³¨æ„ï¼šä¸åœæ­¢ cloudflared tunnelï¼Œä¿æŒå…¬ç½‘è®¿é—®è¿ç»­æ€§
          # Tunnel ä¼šåœ¨åé¢çš„ Start Cloudflare Tunnel æ­¥éª¤ä¸­æŒ‰éœ€é‡å¯
          sleep 2

      - name: Install System Dependencies
        continue-on-error: true
        run: |
          echo "ğŸ“¦ æ£€æŸ¥/å®‰è£…ç³»ç»Ÿä¾èµ–..."
          # Try with sudo if available, skip if not (dependencies should be pre-installed on self-hosted runner)
          if sudo -n true 2>/dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends \
              build-essential \
              cmake \
              pkg-config \
              git
            echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
          else
            echo "âš ï¸ æ—  sudo æƒé™ï¼Œè·³è¿‡ç³»ç»Ÿä¾èµ–å®‰è£…ï¼ˆå‡è®¾å·²é¢„è£…ï¼‰"
            # Verify essential commands exist
            command -v cmake && command -v git && echo "âœ… å¿…è¦å·¥å…·å·²å­˜åœ¨"
          fi

      - name: Check existing SAGE installation
        id: check-sage
        run: |
          echo "ğŸ” æ£€æŸ¥ç°æœ‰ SAGE å®‰è£…..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» condaï¼ˆå‚è€ƒ paper1-experiments.ymlï¼‰
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          echo "å½“å‰ Python: $(which python)"
          echo "å½“å‰ Conda ç¯å¢ƒ: ${ACTUAL_CONDA_ENV:-æœªè®¾ç½®}"
          echo "CONDA_PREFIX: $CONDA_PREFIX"

          CURRENT_COMMIT="${{ github.sha }}"
          DEPLOYED_COMMIT_FILE="$HOME/.sage_deployed_commit_${ACTUAL_CONDA_ENV:-sage}"

          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…å¹¶å¯å¯¼å…¥
          if python -c "import sage.studio; import sage.gateway" 2>/dev/null; then
            echo "sage_installed=true" >> $GITHUB_OUTPUT
            echo "âœ… SAGE å·²å®‰è£…"

            # æ£€æŸ¥ä¸Šæ¬¡éƒ¨ç½²çš„ commit
            if [ -f "$DEPLOYED_COMMIT_FILE" ]; then
              DEPLOYED_COMMIT=$(cat "$DEPLOYED_COMMIT_FILE")
              echo "ä¸Šæ¬¡éƒ¨ç½² commit: $DEPLOYED_COMMIT"
              echo "å½“å‰éƒ¨ç½² commit: $CURRENT_COMMIT"

              if [ "$DEPLOYED_COMMIT" = "$CURRENT_COMMIT" ]; then
                echo "needs_update=false" >> $GITHUB_OUTPUT
                echo "âœ… ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€é‡æ–°å®‰è£…"
              else
                echo "needs_update=true" >> $GITHUB_OUTPUT
                echo "ğŸ“¦ ç‰ˆæœ¬ä¸åŒï¼Œéœ€è¦æ›´æ–°"
              fi
            else
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ é¦–æ¬¡éƒ¨ç½²è®°å½•ï¼Œéœ€è¦æ›´æ–°"
            fi
          else
            echo "sage_installed=false" >> $GITHUB_OUTPUT
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ SAGE æœªå®‰è£…ï¼Œéœ€è¦å®Œæ•´å®‰è£…"
          fi

      - name: Install/Update SAGE
        if: steps.check-sage.outputs.needs_update == 'true'
        run: |
          echo "ğŸ“¦ å®‰è£…/æ›´æ–° SAGEï¼ˆå¼€å‘æ¨¡å¼ï¼‰..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» condaï¼ˆå‚è€ƒ paper1-experiments.ymlï¼‰
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          echo "å½“å‰ Python: $(which python)"
          echo "å½“å‰ pip: $(which pip)"
          echo "CONDA_PREFIX: ${CONDA_PREFIX:-æœªè®¾ç½®}"

          chmod +x ./quickstart.sh

          # é…ç½®å›½å†… PyPI é•œåƒåŠ é€Ÿï¼ˆæ¸…åæºï¼‰
          export PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
          export PIP_TRUSTED_HOST=pypi.tuna.tsinghua.edu.cn
          # å¢åŠ è¶…æ—¶å’Œé‡è¯•é…ç½®
          export PIP_DEFAULT_TIMEOUT=300
          export PIP_RETRIES=5

          # å¦‚æœå·²å®‰è£…ï¼Œä½¿ç”¨å¢é‡æ›´æ–°æ¨¡å¼
          if [ "${{ steps.check-sage.outputs.sage_installed }}" = "true" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¢é‡æ›´æ–°ï¼ˆä»…æ›´æ–° SAGE åŒ…ï¼Œä¸é‡è£…ä¾èµ–ï¼‰..."
            echo "   è¿™å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."

            # å®šä¹‰è¦æ›´æ–°çš„åŒ…åˆ—è¡¨
            packages=(
              "sage-common"
              "sage-platform"
              "sage-kernel"
              "sage-libs"
              "sage-middleware"
              "sage-apps"
              "sage-studio"
              "sage-gateway"
              "sage-cli"
              "sage-tools"
              "sage"
            )

            total=${#packages[@]}
            current=0

            for pkg in "${packages[@]}"; do
              current=$((current + 1))
              echo "   [$current/$total] æ›´æ–° $pkg..."
              pip install -e "packages/$pkg" --no-deps -q 2>&1 || echo "      âš ï¸  $pkg æ›´æ–°å¯èƒ½æœ‰è­¦å‘Š"
            done

            echo "âœ… å¢é‡æ›´æ–°å®Œæˆ"
          elif [ "$deps_installed" = "true" ]; then
            echo "ğŸ”„ æ ¸å¿ƒä¾èµ–å·²å­˜åœ¨ï¼Œä»…å®‰è£… SAGE åŒ…ï¼ˆå¸¦ä¾èµ–æ£€æŸ¥ï¼‰..."
            echo "   è¿™å¯èƒ½éœ€è¦ 2-5 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."

            # å®šä¹‰è¦å®‰è£…çš„åŒ…åˆ—è¡¨
            packages=(
              "sage-common"
              "sage-platform"
              "sage-kernel"
              "sage-libs"
              "sage-middleware"
              "sage-apps"
              "sage-studio"
              "sage-gateway"
              "sage-cli"
              "sage-tools"
              "sage"
            )

            total=${#packages[@]}
            current=0

            for pkg in "${packages[@]}"; do
              current=$((current + 1))
              echo "   [$current/$total] å®‰è£… $pkg..."
              pip install -e "packages/$pkg" -q 2>&1 || echo "      âš ï¸  $pkg å®‰è£…å¯èƒ½æœ‰è­¦å‘Š"
            done

            echo "âœ… SAGE åŒ…å®‰è£…å®Œæˆï¼ˆå¤ç”¨å·²æœ‰ä¾èµ–ï¼‰"
          else
            echo "ğŸ“¦ æ‰§è¡Œå®Œæ•´å®‰è£…ï¼ˆé¦–æ¬¡å®‰è£…ï¼Œéœ€è¦ä¸‹è½½æ‰€æœ‰ä¾èµ–ï¼‰..."
            # å¼ºåˆ¶ä½¿ç”¨ä¸­å›½é•œåƒ + ä½¿ç”¨å½“å‰ conda ç¯å¢ƒçš„ pip
            export SAGE_FORCE_CHINA_MIRROR=true
            # å–æ¶ˆ CI å˜é‡ï¼Œè®© quickstart.sh å®‰è£…åˆ°å½“å‰ conda ç¯å¢ƒ
            unset CI GITHUB_ACTIONS
            ./quickstart.sh --dev --yes --pip
          fi

          # è®°å½•éƒ¨ç½²çš„ commitï¼Œç”¨äºä¸‹æ¬¡å¢é‡æ£€æµ‹ï¼ˆæŒ‰ç¯å¢ƒååŒºåˆ†ï¼‰
          echo "${{ github.sha }}" > "$HOME/.sage_deployed_commit_${ACTUAL_CONDA_ENV:-sage}"

          echo "âœ… SAGE å®‰è£…/æ›´æ–°å®Œæˆ"
        timeout-minutes: 90  # NVIDIA CUDA åŒ…å¾ˆå¤§ï¼Œéœ€è¦æ›´é•¿æ—¶é—´

      - name: Skip installation (up to date)
        if: steps.check-sage.outputs.needs_update != 'true'
        run: |
          echo "â­ï¸ SAGE å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"

      - name: Verify Installation
        run: |
          echo "âœ… éªŒè¯ SAGE å®‰è£…..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» conda
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          echo "å½“å‰ Python: $(which python)"
          echo "CONDA_PREFIX: $CONDA_PREFIX"

          python -c "import sage; print('âœ… SAGE imported')"
          python -c "import sage.cli; print('âœ… sage.cli imported')"
          python -c "import sage.studio; print('âœ… sage.studio imported')"

          if command -v sage >/dev/null 2>&1; then
            sage --help > /dev/null && echo "âœ… sage å‘½ä»¤å¯ç”¨"
          else
            echo "âš ï¸  sage å‘½ä»¤ä¸å¯ç”¨"
          fi



      - name: Install Frontend Dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» conda
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          echo "CONDA_PREFIX: $CONDA_PREFIX"
          echo "PATH (first 3): $(echo $PATH | tr ':' '\n' | head -3 | tr '\n' ':')"

          # ç¡®ä¿ Node.js 20+ å¯ç”¨ï¼ˆTypeScript 5.x éœ€è¦ Node.js 14+ï¼Œæ¨è 20+ï¼‰
          # æ£€æŸ¥ç‰ˆæœ¬å·è€Œä¸æ˜¯ä»…æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå› ä¸ºç³»ç»Ÿå¯èƒ½æœ‰æ—§ç‰ˆæœ¬ Node.js
          NODE_VERSION=""
          if command -v node &> /dev/null; then
            NODE_VERSION=$(node --version | sed 's/v//' | cut -d. -f1)
            echo "å½“å‰ Node.js: $(node --version) at $(which node)"
          fi

          if [ -z "$NODE_VERSION" ] || [ "$NODE_VERSION" -lt 18 ]; then
            echo "ğŸ“¦ å®‰è£… Node.js 20ï¼ˆå½“å‰ç‰ˆæœ¬: ${NODE_VERSION:-æœªå®‰è£…}ï¼Œéœ€è¦ 18+ï¼‰..."
            conda install -y nodejs=20 -c conda-forge

            # å¼ºåˆ¶é‡æ–°æ¿€æ´» conda ç¯å¢ƒä»¥æ›´æ–° PATH
            conda deactivate
            conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

            # åˆ·æ–°å‘½ä»¤ç¼“å­˜
            hash -r

            echo "å®‰è£…å Node.js: $(node --version) at $(which node)"
          fi

          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"

          # éªŒè¯ Node.js ç‰ˆæœ¬æ»¡è¶³è¦æ±‚
          FINAL_VERSION=$(node --version | sed 's/v//' | cut -d. -f1)
          if [ "$FINAL_VERSION" -lt 18 ]; then
            echo "âŒ Node.js ç‰ˆæœ¬è¿‡ä½: $(node --version)ï¼Œéœ€è¦ 18+"
            echo "   å½“å‰ Node.js è·¯å¾„: $(which node)"
            echo "   conda ç¯å¢ƒ: $CONDA_PREFIX"
            echo "   æ£€æŸ¥æ˜¯å¦å­˜åœ¨ conda node: ls -la $CONDA_PREFIX/bin/node"
            ls -la "$CONDA_PREFIX/bin/node" 2>/dev/null || echo "   conda ä¸­æœªæ‰¾åˆ° node"
            echo "   è¯·ç¡®ä¿ conda ç¯å¢ƒçš„ bin ç›®å½•åœ¨ PATH å‰é¢"
            exit 1
          fi

          # å®‰è£…å‰ç«¯ä¾èµ–
          sage studio install

          echo "âœ… å‰ç«¯ä¾èµ–å°±ç»ª"

      - name: Build Studio (Production)
        run: |
          echo "ğŸ—ï¸  æ„å»º SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» conda
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          # éªŒè¯ Node.js ç‰ˆæœ¬ï¼ˆå¿…é¡»åœ¨ conda ç¯å¢ƒä¸­ï¼‰
          echo "Node.js: $(node --version) at $(which node)"
          NODE_MAJOR=$(node --version | sed 's/v//' | cut -d. -f1)
          if [ "$NODE_MAJOR" -lt 18 ]; then
            echo "âŒ Node.js ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 18+"
            exit 1
          fi

          # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
          sage studio build

          echo "âœ… Studio æ„å»ºå®Œæˆ"

      - name: Start SAGE Studio
        run: |
          echo "ğŸš€ å¯åŠ¨ SAGE Studioï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰..."

          # åˆå§‹åŒ–å¹¶æ¿€æ´» conda
          if [ -n "$CONDA_PATH" ]; then
            source "$CONDA_PATH/etc/profile.d/conda.sh"
          else
            for p in "$HOME/miniconda3" "$HOME/anaconda3" "/opt/conda"; do
              [ -f "$p/etc/profile.d/conda.sh" ] && source "$p/etc/profile.d/conda.sh" && break
            done
          fi
          conda activate ${ACTUAL_CONDA_ENV:-sage-studio}

          # ä½¿ç”¨ç”Ÿäº§æ¨¡å¼å¯åŠ¨ï¼ˆVite previewï¼ŒåŸºäºæ„å»ºäº§ç‰©ï¼‰
          #
          # åŠŸèƒ½æµç¨‹ï¼š
          # 1. Builds RAG index from docs-public if needed
          # 2. Starts Gateway on port 8000 (auto-detects existing LLM/Embedding services)
          # 3. Starts local LLM service via sageLLM (if not already running)
          # 4. Starts local Embedding service (if not already running)
          # 5. Starts Vite preview server on port 5173 (from built assets)
          #
          # Self-hosted Runner Mode:
          # -y: Non-interactive mode (skip all prompts)
          # Gateway ä¼šè‡ªåŠ¨æ‰«æå¹¶è¿æ¥å·²è¿è¡Œçš„ LLM/Embedding æœåŠ¡
          #
          # æ³¨æ„ï¼šSelf-hosted runner æœ‰ GPUï¼Œæ”¯æŒæœ¬åœ° LLM/Embedding
          # å¦‚æœæœåŠ¡å·²åœ¨è¿è¡Œï¼ŒGateway ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¤ç”¨

          # å¯åŠ¨æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
          nohup sage studio start --prod --host 0.0.0.0 --port ${{ github.event.inputs.port || '5173' }} -y 2>&1 | tee ~/sage-studio-deploy.log &

          # ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆè½®è¯¢æ£€æŸ¥ç«¯å£ï¼Œå¢åŠ ç­‰å¾…æ—¶é—´ï¼‰
          PORT="${{ github.event.inputs.port || '5173' }}"
          MAX_WAIT=60  # å¢åŠ åˆ° 60 æ¬¡ï¼Œå…± 120 ç§’
          for i in $(seq 1 $MAX_WAIT); do
            if curl -sf http://localhost:$PORT > /dev/null 2>&1; then
              echo "âœ… Studio æœåŠ¡å·²å°±ç»ªï¼ˆç¬¬ $i æ¬¡æ£€æŸ¥ï¼‰"
              break
            fi
            # æ¯ 10 æ¬¡è¾“å‡ºä¸€æ¬¡è¯¦ç»†çŠ¶æ€
            if [ $((i % 10)) -eq 0 ]; then
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/$MAX_WAIT)"
              echo "   æ£€æŸ¥æ—¥å¿—æœ€å 5 è¡Œ:"
              tail -5 ~/sage-studio-deploy.log 2>/dev/null || true
            else
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/$MAX_WAIT)"
            fi
            sleep 2
          done

          echo "âœ… Studio å·²å¯åŠ¨"


          # è¾“å‡º Studio çŠ¶æ€
          sage studio status || true
      - name: Health check
        run: |
          # ç¦ç”¨ errexitï¼Œé˜²æ­¢æ£€æŸ¥å‘½ä»¤çš„éé›¶è¿”å›å€¼å¯¼è‡´è„šæœ¬å¤±è´¥
          set +e

          PORT="${{ github.event.inputs.port || '5173' }}"
          BACKEND_PORT="8080"
          echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          echo ""

          # === å‰ç«¯æœåŠ¡æ£€æŸ¥ ===
          echo "=== å‰ç«¯æœåŠ¡æ£€æŸ¥ (ç«¯å£ ${PORT}) ==="
          if curl -sf http://localhost:${PORT} > /dev/null 2>&1; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·ï¼Œç«¯å£ ${PORT} å¯è®¿é—®"
          else
            echo "âš ï¸  å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
            tail -30 ~/sage-studio-deploy.log 2>/dev/null || echo "æš‚æ— æ—¥å¿—"
          fi

          # === åç«¯ API æ£€æŸ¥ ===
          echo ""
          echo "=== åç«¯ API æ£€æŸ¥ (ç«¯å£ ${BACKEND_PORT}) ==="
          BACKEND_HEALTH=$(curl -sf http://localhost:${BACKEND_PORT}/health 2>/dev/null || echo "")
          if [ -n "$BACKEND_HEALTH" ]; then
            echo "âœ… åç«¯ API å¥åº·ï¼Œç«¯å£ ${BACKEND_PORT} å¯è®¿é—®"
            echo "   å“åº”: $BACKEND_HEALTH"
          else
            # æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨ç›‘å¬
            BACKEND_PID=$(lsof -ti:${BACKEND_PORT} 2>/dev/null || true)
            if [ -n "$BACKEND_PID" ]; then
              echo "âš ï¸  åç«¯ API ç«¯å£ ${BACKEND_PORT} æœ‰è¿›ç¨‹ç›‘å¬ (PID: $BACKEND_PID)ï¼Œä½†å¥åº·æ£€æŸ¥æ— å“åº”"
              echo "   è¿›ç¨‹å¯èƒ½ä»åœ¨åˆå§‹åŒ–ä¸­..."
            else
              echo "âš ï¸  åç«¯ API æœªè¿è¡Œï¼ˆç«¯å£ ${BACKEND_PORT} æ— ç›‘å¬ï¼‰"
            fi
          fi

          # === ç«¯å£ç›‘å¬çŠ¶æ€æ±‡æ€» ===
          echo ""
          echo "ğŸ“¡ ç«¯å£ç›‘å¬çŠ¶æ€æ±‡æ€»..."
          echo "| ç«¯å£ | æœåŠ¡ | çŠ¶æ€ |"
          echo "|------|------|------|"

          # å‰ç«¯ç«¯å£
          if lsof -ti:${PORT} > /dev/null 2>&1; then
            echo "| ${PORT} | Frontend (Vite) | âœ… ç›‘å¬ä¸­ |"
          else
            echo "| ${PORT} | Frontend (Vite) | âŒ æœªç›‘å¬ |"
          fi

          # åç«¯ç«¯å£
          if lsof -ti:${BACKEND_PORT} > /dev/null 2>&1; then
            echo "| ${BACKEND_PORT} | Backend API | âœ… ç›‘å¬ä¸­ |"
          else
            echo "| ${BACKEND_PORT} | Backend API | âŒ æœªç›‘å¬ |"
          fi

          # Gateway ç«¯å£
          if lsof -ti:8000 > /dev/null 2>&1; then
            echo "| 8000 | Gateway | âœ… ç›‘å¬ä¸­ |"
          else
            echo "| 8000 | Gateway | âš ï¸ æœªç›‘å¬ |"
          fi

          # === è¿›ç¨‹çŠ¶æ€æ£€æŸ¥ ===
          echo ""
          echo "ğŸ”§ æ£€æŸ¥ SAGE Studio è¿›ç¨‹..."
          # å‰ç«¯è¿›ç¨‹
          STUDIO_PID=$(lsof -ti:${PORT} 2>/dev/null || true)
          if [ -n "$STUDIO_PID" ]; then
            echo "âœ… å‰ç«¯è¿›ç¨‹è¿è¡Œä¸­ (PID: $STUDIO_PID)"
            ps -p $STUDIO_PID -o pid,cmd --no-headers 2>/dev/null || true
          else
            if pgrep -f "vite preview" > /dev/null 2>&1; then
              echo "âœ… Vite preview è¿›ç¨‹è¿è¡Œä¸­"
              pgrep -af "vite preview" | head -2
            elif pgrep -f "node.*preview" > /dev/null 2>&1; then
              echo "âœ… Node preview è¿›ç¨‹è¿è¡Œä¸­"
              pgrep -af "node.*preview" | head -2
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å‰ç«¯è¿›ç¨‹"
            fi
          fi

          # åç«¯è¿›ç¨‹
          BACKEND_PID=$(lsof -ti:${BACKEND_PORT} 2>/dev/null || true)
          if [ -n "$BACKEND_PID" ]; then
            echo "âœ… åç«¯è¿›ç¨‹è¿è¡Œä¸­ (PID: $BACKEND_PID)"
            ps -p $BACKEND_PID -o pid,cmd --no-headers 2>/dev/null || true
          else
            echo "âš ï¸ æœªæ‰¾åˆ°åç«¯è¿›ç¨‹"
          fi

      - name: Setup Cloudflare Tunnel
        if: ${{ env.CLOUDFLARE_TUNNEL_TOKEN != '' }}
        run: |
          echo "ğŸŒ é…ç½® Cloudflare Tunnel..."

          # ç¡®ä¿ ~/.local/bin åœ¨ PATH ä¸­ï¼ˆcloudflared å®‰è£…ä½ç½®ï¼‰
          export PATH="$HOME/.local/bin:$PATH"

          # æ£€æŸ¥æ˜¯å¦å·²å®‰è£… cloudflared
          if ! command -v cloudflared &> /dev/null; then
            echo "ğŸ“¦ å®‰è£… cloudflared..."
            mkdir -p ~/.local/bin
            curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o ~/.local/bin/cloudflared
            chmod +x ~/.local/bin/cloudflared
          fi

          cloudflared --version
          echo "âœ… cloudflared å·²å°±ç»ª"

      - name: Start Cloudflare Tunnel
        if: ${{ env.CLOUDFLARE_TUNNEL_TOKEN != '' }}
        run: |
          echo "ğŸš€ å¯åŠ¨ Cloudflare Tunnel..."

          export PATH="$HOME/.local/bin:$PATH"

          # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§ tunnel è¿›ç¨‹
          pkill -f "cloudflared tunnel" || true
          sleep 2

          # å¯åŠ¨ tunnelï¼ˆå¢åŠ  --protocol http2 æé«˜å…¼å®¹æ€§ï¼‰
          echo "å¯åŠ¨å‘½ä»¤: cloudflared tunnel run --token <hidden>"
          nohup cloudflared tunnel run --token "${CLOUDFLARE_TUNNEL_TOKEN}" > ~/cloudflared.log 2>&1 &
          TUNNEL_PID=$!
          echo "Tunnel è¿›ç¨‹ PID: $TUNNEL_PID"

          # ç­‰å¾… Tunnel è¿æ¥ï¼ˆæ£€æŸ¥æ—¥å¿—ä¸­çš„è¿æ¥çŠ¶æ€ï¼‰
          echo ""
          echo "â³ ç­‰å¾… Tunnel è¿æ¥åˆ° Cloudflare..."
          TUNNEL_CONNECTED=false
          for i in $(seq 1 30); do
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
            if ! pgrep -f "cloudflared tunnel" > /dev/null; then
              echo "âŒ Tunnel è¿›ç¨‹å·²é€€å‡º"
              echo "=== æœ€å 30 è¡Œæ—¥å¿— ==="
              tail -30 ~/cloudflared.log || true
              exit 1
            fi

            # æ£€æŸ¥æ˜¯å¦æˆåŠŸè¿æ¥ï¼ˆæ—¥å¿—ä¸­ä¼šå‡ºç° "Registered tunnel connection"ï¼‰
            if grep -q "Registered tunnel connection" ~/cloudflared.log 2>/dev/null; then
              TUNNEL_CONNECTED=true
              echo "âœ… Tunnel å·²è¿æ¥åˆ° Cloudflare (ç¬¬ $i æ¬¡æ£€æŸ¥)"
              break
            fi

            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if grep -qi "error\|failed\|unauthorized" ~/cloudflared.log 2>/dev/null; then
              echo "âš ï¸  æ£€æµ‹åˆ°å¯èƒ½çš„é”™è¯¯ï¼Œç»§ç»­ç­‰å¾…..."
            fi

            echo "   ç­‰å¾…ä¸­... ($i/30)"
            sleep 2
          done

          if [ "$TUNNEL_CONNECTED" = "false" ]; then
            echo ""
            echo "âš ï¸  Tunnel è¿›ç¨‹è¿è¡Œä¸­ï¼Œä½†æœªæ£€æµ‹åˆ°è¿æ¥ç¡®è®¤"
            echo "   å¯èƒ½åŸå› ï¼š"
            echo "   1. Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
            echo "   2. Tunnel é…ç½®æœªæ­£ç¡®æŒ‡å‘æœ¬åœ°ç«¯å£"
            echo "   3. ç½‘ç»œé—®é¢˜å¯¼è‡´è¿æ¥å»¶è¿Ÿ"
            echo ""
            echo "=== cloudflared æ—¥å¿— ==="
            tail -50 ~/cloudflared.log || true
            echo ""
            echo "ç»§ç»­æ‰§è¡Œï¼Œè¯·æ£€æŸ¥ Cloudflare Dashboard ç¡®è®¤ Tunnel çŠ¶æ€"
          fi

          # æ˜¾ç¤º Tunnel ä¿¡æ¯
          echo ""
          echo "=== Tunnel è¿æ¥ä¿¡æ¯ ==="
          grep -E "Registered|connection|INF" ~/cloudflared.log 2>/dev/null | tail -10 || echo "æš‚æ— è¿æ¥ä¿¡æ¯"

      - name: Verify Tunnel connectivity
        if: ${{ env.CLOUDFLARE_TUNNEL_TOKEN != '' }}
        continue-on-error: true
        run: |
          TUNNEL_DOMAIN="${{ github.event.inputs.tunnel_domain || env.DEFAULT_TUNNEL_DOMAIN }}"
          echo "ğŸ” éªŒè¯ Tunnel è¿æ¥..."
          echo ""

          # æ£€æŸ¥ cloudflared è¿›ç¨‹
          echo "=== cloudflared è¿›ç¨‹çŠ¶æ€ ==="
          if pgrep -f "cloudflared tunnel" > /dev/null; then
            echo "âœ… cloudflared è¿›ç¨‹è¿è¡Œä¸­"
            pgrep -af "cloudflared" | head -3
          else
            echo "âŒ cloudflared è¿›ç¨‹æœªè¿è¡Œ"
          fi

          # æ£€æŸ¥æœ¬åœ°æœåŠ¡
          PORT="${{ github.event.inputs.port || '5173' }}"
          echo ""
          echo "=== æœ¬åœ°æœåŠ¡çŠ¶æ€ ==="
          if curl -sf http://localhost:${PORT} > /dev/null 2>&1; then
            echo "âœ… æœ¬åœ°æœåŠ¡ http://localhost:${PORT} å¯è®¿é—®"
          else
            echo "âŒ æœ¬åœ°æœåŠ¡ http://localhost:${PORT} ä¸å¯è®¿é—®"
            echo "   è¿™å¯èƒ½æ˜¯ Tunnel æ— æ³•è½¬å‘è¯·æ±‚çš„åŸå› "
          fi

          # å°è¯•é€šè¿‡å…¬ç½‘è®¿é—®ï¼ˆå¯èƒ½éœ€è¦ç­‰å¾… DNS ä¼ æ’­ï¼‰
          echo ""
          echo "=== å…¬ç½‘è®¿é—®æµ‹è¯• ==="
          echo "å°è¯•è®¿é—®: https://${TUNNEL_DOMAIN}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${TUNNEL_DOMAIN}" 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… https://${TUNNEL_DOMAIN} å¯è®¿é—® (HTTP $HTTP_CODE)"
          elif [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "503" ]; then
            echo "âš ï¸  https://${TUNNEL_DOMAIN} è¿”å› $HTTP_CODE"
            echo "   å¯èƒ½åŸå› : Tunnel å·²è¿æ¥ä½†æœ¬åœ°æœåŠ¡ä¸å¯è¾¾"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "âš ï¸  æ— æ³•è¿æ¥åˆ° https://${TUNNEL_DOMAIN}"
            echo "   å¯èƒ½åŸå› : DNS å°šæœªä¼ æ’­æˆ– Tunnel æœªæ­£ç¡®é…ç½®"
          else
            echo "âš ï¸  https://${TUNNEL_DOMAIN} è¿”å› HTTP $HTTP_CODE"
          fi

          # æ˜¾ç¤ºè¯Šæ–­å»ºè®®
          echo ""
          echo "ğŸ“ å¦‚æœé‡åˆ° Host errorï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "   1. Cloudflare Dashboard -> Zero Trust -> Access -> Tunnels"
          echo "   2. ç¡®è®¤ Tunnel çŠ¶æ€ä¸º HEALTHY"
          echo "   3. æ£€æŸ¥ Public Hostname é…ç½®æ˜¯å¦æŒ‡å‘ http://localhost:${PORT}"
          echo "   4. ç¡®è®¤ DNS è®°å½•å·²æ­£ç¡®è®¾ç½® (CNAME åˆ° tunnel UUID)"

      - name: Network accessibility check
        continue-on-error: true
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"
          SERVER_IP=$(hostname -I | awk '{print $1}')

          echo "ğŸŒ æµ‹è¯•ç½‘ç»œå¯è¾¾æ€§..."
          echo ""
          echo "æµ‹è¯•ä»æœ¬æœºè®¿é—®ï¼š"

          # æµ‹è¯• localhost
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT} | grep -q "200"; then
            echo "âœ… localhost:${PORT} å¯è®¿é—®"
          else
            echo "âŒ localhost:${PORT} ä¸å¯è®¿é—®"
          fi

          # æµ‹è¯•å†…ç½‘IP
          if curl -s -o /dev/null -w "%{http_code}" http://${SERVER_IP}:${PORT} | grep -q "200"; then
            echo "âœ… ${SERVER_IP}:${PORT} å¯è®¿é—®"
          else
            echo "âŒ ${SERVER_IP}:${PORT} ä¸å¯è®¿é—®"
          fi

          # æ£€æŸ¥é˜²ç«å¢™è§„åˆ™ï¼ˆå¯é€‰ï¼Œä»…ä¾›å‚è€ƒï¼‰
          echo ""
          echo "ğŸ”¥ é˜²ç«å¢™æ£€æŸ¥ï¼š"
          if command -v ufw &> /dev/null && sudo -n true 2>/dev/null; then
            echo "UFW çŠ¶æ€ï¼š"
            sudo ufw status | grep -E "Status|${PORT}" || echo "ç«¯å£ ${PORT} æœªåœ¨ UFW è§„åˆ™ä¸­"
          else
            echo "âš ï¸ è·³è¿‡ UFW æ£€æŸ¥ï¼ˆæ—  sudo æƒé™æˆ–æœªå®‰è£…ï¼‰"
          fi

          if command -v iptables &> /dev/null && sudo -n true 2>/dev/null; then
            echo ""
            echo "IPTables å…¥ç«™è§„åˆ™ï¼ˆç«¯å£ ${PORT}ï¼‰ï¼š"
            sudo iptables -L INPUT -n -v 2>/dev/null | grep -E "dpt:${PORT}|ACCEPT.*all" | head -5 || echo "æœªæ‰¾åˆ°ç›¸å…³è§„åˆ™"
          fi

          # è¾“å‡ºç½‘ç»œå»ºè®®
          echo ""
          echo "ğŸ“ æ ¡å›­ç½‘è®¿é—®å»ºè®®ï¼š"
          echo "1. âœ… ç¡®è®¤æœåŠ¡å·²å¯åŠ¨å¹¶ç›‘å¬ 0.0.0.0:${PORT}"
          echo "2. ğŸ”§ å¦‚æœæ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "   - æœåŠ¡å™¨é˜²ç«å¢™é…ç½® (ufw/iptables)"
          echo "   - æ ¡å›­ç½‘é˜²ç«å¢™/å®‰å…¨ç»„è§„åˆ™"
          echo "   - ç½‘ç»œéš”ç¦»ç­–ç•¥ï¼ˆæŸäº›æ ¡å›­ç½‘å¯èƒ½æœ‰VLANéš”ç¦»ï¼‰"
          echo "3. ğŸ’¡ å»ºè®®è”ç³»ç½‘ç»œç®¡ç†å‘˜å¼€æ”¾ç«¯å£ ${PORT}"
          echo "4. ğŸ” æˆ–é…ç½®æ ¡å›­ç½‘VPNä»¥è®¿é—®å†…ç½‘æœåŠ¡"

      - name: Deployment summary
        run: |
          PORT="${{ github.event.inputs.port || '5173' }}"
          TUNNEL_DOMAIN="${{ github.event.inputs.tunnel_domain || env.DEFAULT_TUNNEL_DOMAIN }}"

          # è·å–æœåŠ¡å™¨ç½‘ç»œä¿¡æ¯
          SERVER_IP=$(hostname -I | awk '{print $1}')
          HOSTNAME=$(hostname -f)
          PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "N/A")

          # æ£€æµ‹ Cloudflare Tunnel çŠ¶æ€
          TUNNEL_STATUS="âŒ æœªè¿è¡Œ"
          if pgrep -f "cloudflared tunnel" > /dev/null; then
            TUNNEL_STATUS="âœ… è¿è¡Œä¸­"
          fi

          # æ£€æµ‹é˜²ç«å¢™çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
          FIREWALL_STATUS="æœªæ£€æŸ¥"
          if command -v ufw &> /dev/null && sudo -n true 2>/dev/null; then
            if sudo ufw status | grep -q "Status: active"; then
              if sudo ufw status | grep -q "$PORT"; then
                FIREWALL_STATUS="âœ… UFW: ç«¯å£ $PORT å·²å¼€æ”¾"
              else
                FIREWALL_STATUS="âš ï¸ UFW: ç«¯å£ $PORT å¯èƒ½æœªå¼€æ”¾"
              fi
            else
              FIREWALL_STATUS="âœ… UFW æœªå¯ç”¨"
            fi
          fi

          # ä¿å­˜éƒ¨ç½²ä¿¡æ¯åˆ°æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰
          DEPLOY_INFO_FILE="$HOME/sage-studio-deployment-info.txt"
          cat > "$DEPLOY_INFO_FILE" << EOF
          ======================================
          SAGE Studio éƒ¨ç½²ä¿¡æ¯
          ======================================
          éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')

          è®¿é—®åœ°å€:
          - Cloudflare Tunnel: https://${TUNNEL_DOMAIN} (æ¨èï¼Œå…¨çƒå¯è®¿é—®)
          - å†…ç½‘IP: http://${SERVER_IP}:${PORT}
          - ä¸»æœºå: http://${HOSTNAME}:${PORT}
          - å…¬ç½‘IP: http://${PUBLIC_IP}:${PORT} (å¦‚æœå¯ç”¨)

          æœåŠ¡çŠ¶æ€:
          - ç«¯å£: ${PORT}
          - ç›‘å¬: 0.0.0.0 (æ‰€æœ‰ç½‘ç»œæ¥å£)
          - Cloudflare Tunnel: ${TUNNEL_STATUS}
          - é˜²ç«å¢™: ${FIREWALL_STATUS}

          æ—¥å¿—æ–‡ä»¶:
          - Studio æ—¥å¿—: ~/sage-studio-deploy.log
          - Tunnel æ—¥å¿—: ~/cloudflared.log

          ç®¡ç†å‘½ä»¤:
          - æŸ¥çœ‹çŠ¶æ€: ps aux | grep -E "sage studio|cloudflared"
          - åœæ­¢æœåŠ¡: pkill -f "sage studio" && pkill -f "cloudflared tunnel"
          - é‡å¯æœåŠ¡: é‡æ–°è¿è¡Œæ­¤ workflow
          ======================================
          EOF

          echo "âœ… éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ°: $DEPLOY_INFO_FILE"
          cat "$DEPLOY_INFO_FILE"

          # è¾“å‡ºåˆ° GitHub Actions Summary
          echo "## ğŸ‰ SAGE Studio éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–¹å¼ | è®¿é—®åœ°å€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| â˜ï¸ **Cloudflare Tunnel** | [\`https://${TUNNEL_DOMAIN}\`](https://${TUNNEL_DOMAIN}) | **æ¨è - å…¨çƒå¯è®¿é—®ï¼Œè‡ªåŠ¨ HTTPS** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ« æ ¡å›­ç½‘å†… | \`http://${SERVER_IP}:${PORT}\` | å†…ç½‘ç›´è¿ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ–¥ï¸ ä¸»æœºå | \`http://${HOSTNAME}:${PORT}\` | å¦‚æœDNSé…ç½®æ­£ç¡® |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ æœåŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAGE Studio | âœ… è¿è¡Œä¸­ (ç«¯å£ ${PORT}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Tunnel | ${TUNNEL_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| é˜²ç«å¢™ | ${FIREWALL_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¯è§†åŒ–æµæ°´çº¿ç¼–è¾‘å™¨" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI å¯¹è¯ï¼ˆæœ¬åœ° LLM + RAGï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… äº¤äº’å¼è°ƒè¯•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Studio æ—¥å¿—ï¼ˆæœ€è¿‘30è¡Œï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 ~/sage-studio-deploy.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Cloudflare Tunnel æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 ~/cloudflared.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Tunnel logs will appear shortly..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Final service verification
        continue-on-error: false
        run: |
          # ç¦ç”¨ errexitï¼Œé˜²æ­¢ä¸­é—´å‘½ä»¤çš„éé›¶è¿”å›å€¼å¯¼è‡´è„šæœ¬æå‰é€€å‡º
          set +e

          PORT="${{ github.event.inputs.port || '5173' }}"
          echo "ğŸ” æœ€ç»ˆæœåŠ¡éªŒè¯..."
          echo ""

          # === å‰ç«¯è¿›ç¨‹æ£€æŸ¥ ===
          echo "=== å‰ç«¯æœåŠ¡æ£€æŸ¥ ==="
          FRONTEND_OK=false

          # æ£€æŸ¥ç«¯å£ç›‘å¬
          FRONTEND_PID=$(lsof -ti:${PORT} 2>/dev/null || true)
          if [ -n "$FRONTEND_PID" ]; then
            echo "âœ… å‰ç«¯è¿›ç¨‹å­˜åœ¨ (PID: $FRONTEND_PID)"
            echo "   è¿›ç¨‹è¯¦æƒ…:"
            ps -p $FRONTEND_PID -o pid,user,%cpu,%mem,start,cmd --no-headers 2>/dev/null | head -1
            FRONTEND_OK=true
          else
            echo "âŒ å‰ç«¯ç«¯å£ ${PORT} æ— è¿›ç¨‹ç›‘å¬"
          fi

          # æ£€æŸ¥ Vite/Node è¿›ç¨‹
          echo ""
          echo "Vite/Node ç›¸å…³è¿›ç¨‹:"
          pgrep -af "vite|node.*preview" 2>/dev/null | head -3 || echo "   æœªæ‰¾åˆ° Vite/Node è¿›ç¨‹"

          # æ£€æŸ¥ç«¯å£å“åº”
          echo ""
          echo "ç«¯å£å“åº”æµ‹è¯•:"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:${PORT} 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… http://localhost:${PORT} å“åº”æ­£å¸¸ (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  http://localhost:${PORT} å“åº”å¼‚å¸¸ (HTTP $HTTP_CODE)"
          fi

          # === åç«¯è¿›ç¨‹æ£€æŸ¥ ===
          echo ""
          echo "=== åç«¯æœåŠ¡æ£€æŸ¥ ==="

          # æ£€æŸ¥ Gateway (ç«¯å£ 8000)
          GATEWAY_PID=$(lsof -ti:8000 2>/dev/null || true)
          if [ -n "$GATEWAY_PID" ]; then
            echo "âœ… Gateway è¿›ç¨‹å­˜åœ¨ (PID: $GATEWAY_PID, ç«¯å£ 8000)"
          else
            echo "âš ï¸  Gateway ç«¯å£ 8000 æ— è¿›ç¨‹ç›‘å¬"
          fi

          # æ£€æŸ¥ LLM æœåŠ¡ (ç«¯å£ 8901)
          LLM_PID=$(lsof -ti:8901 2>/dev/null || true)
          if [ -n "$LLM_PID" ]; then
            echo "âœ… LLM æœåŠ¡è¿›ç¨‹å­˜åœ¨ (PID: $LLM_PID, ç«¯å£ 8901)"
          else
            echo "â„¹ï¸  LLM æœåŠ¡ç«¯å£ 8901 æ— è¿›ç¨‹ç›‘å¬ï¼ˆå¯èƒ½ä½¿ç”¨äº‘ç«¯ APIï¼‰"
          fi

          # æ£€æŸ¥ Embedding æœåŠ¡ (ç«¯å£ 8090)
          EMBED_PID=$(lsof -ti:8090 2>/dev/null || true)
          if [ -n "$EMBED_PID" ]; then
            echo "âœ… Embedding æœåŠ¡è¿›ç¨‹å­˜åœ¨ (PID: $EMBED_PID, ç«¯å£ 8090)"
          else
            echo "â„¹ï¸  Embedding æœåŠ¡ç«¯å£ 8090 æ— è¿›ç¨‹ç›‘å¬ï¼ˆå¯èƒ½ä½¿ç”¨äº‘ç«¯ APIï¼‰"
          fi

          # === æ±‡æ€» ===
          echo ""
          echo "=== æœåŠ¡çŠ¶æ€æ±‡æ€» ==="
          echo "| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |"
          echo "|------|------|------|"

          if [ "$FRONTEND_OK" = "true" ]; then
            echo "| Frontend (Vite) | ${PORT} | âœ… è¿è¡Œä¸­ |"
          else
            echo "| Frontend (Vite) | ${PORT} | âŒ æœªè¿è¡Œ |"
          fi

          if [ -n "$GATEWAY_PID" ]; then
            echo "| Gateway | 8000 | âœ… è¿è¡Œä¸­ |"
          else
            echo "| Gateway | 8000 | âš ï¸ æœªæ£€æµ‹åˆ° |"
          fi

          if [ -n "$LLM_PID" ]; then
            echo "| LLM Service | 8901 | âœ… è¿è¡Œä¸­ |"
          else
            echo "| LLM Service | 8901 | â„¹ï¸ æœªå¯åŠ¨ |"
          fi

          if [ -n "$EMBED_PID" ]; then
            echo "| Embedding | 8090 | âœ… è¿è¡Œä¸­ |"
          else
            echo "| Embedding | 8090 | â„¹ï¸ æœªå¯åŠ¨ |"
          fi

          # å†™å…¥ GitHub Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” æœ€ç»ˆæœåŠ¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_OK" = "true" ]; then
            echo "| Frontend (Vite) | ${PORT} | âœ… è¿è¡Œä¸­ (PID: $FRONTEND_PID) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Frontend (Vite) | ${PORT} | âŒ æœªè¿è¡Œ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$GATEWAY_PID" ]; then
            echo "| Gateway | 8000 | âœ… è¿è¡Œä¸­ (PID: $GATEWAY_PID) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Gateway | 8000 | âš ï¸ æœªæ£€æµ‹åˆ° |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$LLM_PID" ]; then
            echo "| LLM Service | 8901 | âœ… è¿è¡Œä¸­ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| LLM Service | 8901 | â„¹ï¸ æœªå¯åŠ¨ï¼ˆä½¿ç”¨äº‘ç«¯APIï¼‰ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$EMBED_PID" ]; then
            echo "| Embedding | 8090 | âœ… è¿è¡Œä¸­ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Embedding | 8090 | â„¹ï¸ æœªå¯åŠ¨ï¼ˆä½¿ç”¨äº‘ç«¯APIï¼‰ |" >> $GITHUB_STEP_SUMMARY
          fi

          # æœ€ç»ˆçŠ¶æ€åˆ¤æ–­
          echo ""
          if [ "$FRONTEND_OK" = "true" ]; then
            echo "ğŸ‰ éƒ¨ç½²éªŒè¯é€šè¿‡ï¼šå‰ç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ"
            exit 0
          else
            echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼šå‰ç«¯æœåŠ¡æœªèƒ½æ­£å¸¸å¯åŠ¨"
            echo "   è¯·æ£€æŸ¥æ—¥å¿—: ~/sage-studio-deploy.log"
            exit 1
          fi
