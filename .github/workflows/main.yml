name: Test LLH with Pytest and Conda

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Test LLH
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5

    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # Free disk space for CUDA and dependencies
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      # Remove conflicting CUDA repositories
      - name: Remove Existing CUDA Repositories
        run: sudo rm -f /etc/apt/sources.list.d/cuda* /etc/apt/sources.list.d/nvidia-*

      # Remove Python 3.10 and Install Python 3.11
      - name: Set up Python 3.11 as Default System Python
        run: |
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get purge -y python3.10 python3.10-dev python3.10-minimal
          sudo apt-get install -y python3.11 python3.11-distutils python3.11-venv python3-pip python3.11-dev
          sudo apt-get autoremove -y
          sudo rm -rf /usr/bin/python3.10* /usr/lib/python3.10*
          sudo ln -sf /usr/bin/python3.11 /usr/bin/python3
          sudo ln -sf /usr/bin/python3.11 /usr/bin/python
          python3 --version
          python --version
          python3.11 -m pip install --upgrade pip

      # Use Deploy Key to Clone CANDY Repository
      - name: Configure SSH for Deploy Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CANDY_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # Clone CANDY Repository
      - name: Clone CANDY Repository
        run: |
          mkdir -p deps
          cd deps
          git clone git@github.com:intellistream/CANDY.git

      # Setup Miniconda and Python environment
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          python-version: "3.11"
          auto-activate-base: false
          
      # Install Base Dependencies
      - name: Install Base Dependencies
        run: |
          mamba install -y python=3.11 pip
          mamba clean --all -y

      # Install CUDA Toolkit and PyTorch
      - name: Install CUDA and PyTorch
        run: |
          mamba install -y \
            pytorch=2.4.0 \
            pytorch-cuda=12.1 \
            torchaudio=2.4.0 \
            torchvision=0.19.0 \
            cuda-runtime=12.1.0 \
            -c pytorch -c nvidia
          mamba clean --all -y

      # Install PyTorch CPU Version in Base Python
      - name: Install PyTorch CPU Version in Base Python
        run: |
          pip install --no-cache-dir \
            torch==2.4.0 \
            torchvision==0.19.0 \
            torchaudio==2.4.0 \
            --index-url https://download.pytorch.org/whl/cpu

      # Create or Update Conda Environment
      - name: Create or Update Environment
        run: |
          if conda env list | grep -q "llh"; then
            echo "Environment 'llh' already exists. Updating..."
            mamba env update --name llh --file installation/environment.yml --prune
          else
            echo "Creating environment 'llh'..."
            mamba env create --file installation/environment.yml
          fi

      # Install `pycandy`
      - name: Install pycandy
        run: |
          cd deps/CANDY/installation
          bash candy_build.sh
          cd ../../../installation/
          conda run -n llh bash install_pycandy.sh
          cd ../

      # Install Extra Pip Dependencies
      - name: Install Extra Pip Dependencies
        run: |
          conda run -n llh pip install --no-cache-dir \
            rouge-score==0.1.2 \
            evaluate==0.4.3 \
            datasets==3.0.1
          conda run -n llh python -c "import nltk; nltk.download('wordnet')"

      # Run Pytest
      - name: Run Tests
        run: |
          conda run -n llh pytest -v tests/
