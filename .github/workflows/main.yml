name: Test SAGE with Pytest and Conda

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Test SAGE
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5

    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # Cache Conda Environment
      - name: Cache Conda Environment
        uses: actions/cache@v3
        with:
          path: |
            $HOME/miniconda3/envs/sage
            $HOME/.conda/envs/sage
            $HOME/.cache/pip
            $HOME/miniconda3/pkgs
            $HOME/.condarc
          key: ${{ runner.os }}-conda-${{ hashFiles('installation/env_setup/environment.yml') }}
          restore-keys: |
            ${{ runner.os }}-conda-
        env:
          ACTIONS_STEP_DEBUG: true

      # Free disk space for CUDA and dependencies
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      # Remove conflicting CUDA repositories
      - name: Remove Existing CUDA Repositories
        run: sudo rm -f /etc/apt/sources.list.d/cuda* /etc/apt/sources.list.d/nvidia-*

      # Remove Python 3.10 and Install Python 3.11
      - name: Set up Python 3.11 as Default System Python
        run: |
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get purge -y python3.10 python3.10-dev python3.10-minimal
          sudo apt-get install -y python3.11 python3.11-distutils python3.11-venv python3-pip python3.11-dev
          sudo apt-get autoremove -y
          sudo rm -rf /usr/bin/python3.10* /usr/lib/python3.10*
          sudo ln -sf /usr/bin/python3.11 /usr/bin/python3
          sudo ln -sf /usr/bin/python3.11 /usr/bin/python
          python3 --version
          python --version
          python3.11 -m pip install --upgrade pip

      # Install PyTorch CPU Version in Base Python
      - name: Install PyTorch CPU Version in Base Python
        run: |
          pip install --no-cache-dir \
            torch==2.4.0 \
            torchvision==0.19.0 \
            torchaudio==2.4.0 \
            --index-url https://download.pytorch.org/whl/cpu

      # Setup Miniconda and Python environment
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          python-version: "3.11"
          activate-environment: sage
          auto-activate-base: false

      # Cache CANDY Installation
      - name: Cache CANDY Installation
        id: cache-candy  # Add step ID
        uses: actions/cache@v3
        with:
          path: deps/CANDY
          key: ${{ runner.os }}-candy-${{ hashFiles('deps/CANDY/installation/candy_build.sh') }}
          restore-keys: |
            ${{ runner.os }}-candy-

      # Use Deploy Key to Clone CANDY Repository
      - name: Configure SSH for Deploy Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CANDY_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # Clone CANDY Repository
      - name: Clone CANDY Repository
        if: steps.cache-candy.outputs.cache-hit != 'true'
        run: |
          mkdir -p deps
          cd deps
          git clone git@github.com:intellistream/CANDY.git

       # Install pycandy
      - name: Install pycandy
        run: |
          cd deps/CANDY/installation
          bash candy_build.sh
          cd install_pycandy
          conda run -n sage bash install_pycandy.sh
          cd ../../../../

      # Install Base Dependencies
      - name: Install Base Dependencies
        run: |
          mamba install -y python=3.11 pip
          mamba clean --all -y

      # Install CUDA Toolkit and PyTorch
      - name: Install CUDA and PyTorch
        run: |
          mamba install -y \
            pytorch=2.4.0 \
            pytorch-cuda=12.1 \
            torchaudio=2.4.0 \
            torchvision=0.19.0 \
            cuda-runtime=12.1.0 \
            -c pytorch -c nvidia
          mamba clean --all -y

      # Create or Update Conda Environment
      - name: Create or Update Environment
        run: |
          if conda env list | grep -q "sage"; then
            echo "Environment 'sage' already exists. Updating..."
            mamba env update --name sage --file installation/env_setup/environment.yml
          else
            echo "Creating environment 'sage'..."
            mamba env create --file installation/env_setup/environment.yml
          fi

      # Install Extra Pip Dependencies
      - name: Install Extra Pip Dependencies
        run: |
          conda run -n sage pip install --no-cache-dir \
            rouge-score==0.1.2 \
            evaluate==0.4.3 \
            datasets==3.0.1
          conda run -n sage python -c "import nltk; nltk.download('wordnet')"

      - name: Set up Hugging Face CLI
        run: |
          conda run -n sage huggingface-cli login --token ${{ secrets.HF_TOKEN }}

      # Run Pytest
      - name: Run Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          export SILICONCLOUD_API_KEY=${{ secrets.SILICONCLOUD_API_KEY }}
          export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          export JINA_API_KEY=${{ secrets.JINA_API_KEY }}
          export ALIBABA_API_KEY=${{ secrets.ALIBABA_API_KEY }}
          conda run -n sage pytest -v sage_tests
