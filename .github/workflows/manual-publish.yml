name: Manual Publish to PyPI

# è¿™ä¸ªå·¥ä½œæµä¸“é—¨ç”¨äºæ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬å‡çº§å’ŒPyPIå‘å¸ƒ
# ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼Œä¸å½±å“ä¸»CI/CDæµç¨‹çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€
# é€‚ç”¨åœºæ™¯ï¼šmain-devåˆå¹¶åˆ°mainåï¼Œéœ€è¦æ‰‹åŠ¨å†³å®šæ˜¯å¦å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to publish from'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - main-dev
      repository:
        description: 'Target repository (testpypi or pypi)'
        required: true
        default: 'pypi'
        type: choice
        options:
          - testpypi
          - pypi
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - none    # Keep current version
          - patch   # 0.1.6.2 -> 0.1.6.3
          - micro   # 0.1.6.2 -> 0.1.7.0
          - minor   # 0.1.6.2 -> 0.2.0.0
          - major   # 0.1.6.2 -> 1.0.0.0
      create_release:
        description: 'Create GitHub Release (only for pypi)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  manual-publish:
    name: Manual Publish
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Validate inputs
        run: |
          echo "ğŸ“‹ Validating workflow inputs..."
          echo "- Target Branch: ${{ inputs.target_branch }}"
          echo "- Repository: ${{ inputs.repository }}"
          echo "- Version Bump: ${{ inputs.version_bump }}"
          echo "- Create Release: ${{ inputs.create_release }}"

          # éªŒè¯ï¼šå‘å¸ƒåˆ°PyPIæ—¶å¿…é¡»ä»mainåˆ†æ”¯
          if [ "${{ inputs.repository }}" = "pypi" ] && [ "${{ inputs.target_branch }}" != "main" ]; then
            echo "âŒ Error: Publishing to PyPI requires 'main' branch"
            exit 1
          fi

          # éªŒè¯ï¼šåˆ›å»ºReleaseæ—¶å¿…é¡»bumpç‰ˆæœ¬
          if [ "${{ inputs.create_release }}" = "true" ] && [ "${{ inputs.version_bump }}" = "none" ]; then
            echo "âŒ Error: Cannot create release without version bump"
            exit 1
          fi

          echo "âœ… Input validation passed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twine build wheel setuptools
          # Install sage-tools for version management
          pip install -e packages/sage-tools

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        if: inputs.version_bump != 'none'
        id: bump_version
        run: |
          # Get current version from any package's _version.py
          CURRENT_VERSION=$(python -c "import sys; sys.path.insert(0, 'packages/sage/src'); from sage._version import __version__; print(__version__)")
          echo "Current version: $CURRENT_VERSION"

          # Parse version parts
          IFS='.' read -r -a version_parts <<< "$CURRENT_VERSION"
          major="${version_parts[0]}"
          minor="${version_parts[1]}"
          micro="${version_parts[2]}"
          patch="${version_parts[3]:-0}"

          # Bump based on input
          case "${{ inputs.version_bump }}" in
            patch)
              patch=$((patch + 1))
              ;;
            micro)
              micro=$((micro + 1))
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              micro=0
              patch=0
              ;;
            major)
              major=$((major + 1))
              minor=0
              micro=0
              patch=0
              ;;
          esac

          # Create new version
          NEW_VERSION="${major}.${minor}.${micro}.${patch}"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update version using sage-dev
          sage-dev package version set "$NEW_VERSION"

          # Commit version bump
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION [version bump]"

          # Pull latest changes with rebase to avoid conflicts
          BRANCH="${{ inputs.target_branch }}"
          git pull --rebase origin $BRANCH || {
            echo "âŒ Failed to rebase. Please resolve conflicts manually."
            exit 1
          }

          # Push with retry logic
          max_retries=3
          retry_count=0
          until git push origin $BRANCH; do
            retry_count=$((retry_count + 1))
            if [ $retry_count -ge $max_retries ]; then
              echo "âŒ Failed to push after $max_retries attempts"
              exit 1
            fi
            echo "Push failed, retrying (attempt $retry_count/$max_retries)..."
            sleep 2
            git pull --rebase origin $BRANCH
          done

          echo "âœ… Version bumped and pushed successfully"

      - name: Get current version for summary
        id: current_version
        run: |
          CURRENT_VERSION=$(python -c "import sys; sys.path.insert(0, 'packages/sage/src'); from sage._version import __version__; print(__version__)")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Build and publish packages
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ inputs.repository == 'pypi' && secrets.PYPI_API_TOKEN || secrets.TEST_PYPI_API_TOKEN }}
          TWINE_REPOSITORY: ${{ inputs.repository }}
        run: |
          # Configure repository URL
          if [ "${{ inputs.repository }}" = "testpypi" ]; then
            export TWINE_REPOSITORY_URL="https://test.pypi.org/legacy/"
          fi

          # Build and publish all packages
          sage-dev package pypi publish-sage --no-dry-run -r ${{ inputs.repository }}

      # æ„å»ºé¢„ç¼–è¯‘ wheelsï¼ˆé’ˆå¯¹ sage-middlewareï¼‰
      - name: Build precompiled wheels for sage-middleware
        run: |
          echo "ğŸ”§ Building precompiled wheels for sage-middleware..."
          python -m pip install cibuildwheel==2.22.0

          cd packages/sage-middleware

          # é…ç½® cibuildwheel
          export CIBW_BUILD="cp310-* cp311-* cp312-*"
          export CIBW_SKIP="*-musllinux_*"
          export CIBW_MANYLINUX_X86_64_IMAGE="manylinux_2_28"
          export CIBW_MANYLINUX_AARCH64_IMAGE="manylinux_2_28"
          export CIBW_BEFORE_BUILD="pip install setuptools wheel scikit-build-core pybind11"

          # ä»…æ„å»ºå½“å‰å¹³å°çš„ wheels
          python -m cibuildwheel --output-dir ../../dist-wheels

          echo "âœ… Wheels built successfully"
          ls -lh ../../dist-wheels/

      # ä¸Šä¼ é¢„ç¼–è¯‘ wheels åˆ° PyPI
      - name: Upload precompiled wheels
        run: |
          echo "ğŸ“¦ Uploading precompiled wheels to ${{ inputs.repository }}..."
          python -m pip install twine

          if [ "${{ inputs.repository }}" = "pypi" ]; then
            twine upload --skip-existing dist-wheels/*.whl \
              --username __token__ \
              --password ${{ secrets.PYPI_API_TOKEN }}
          else
            twine upload --skip-existing dist-wheels/*.whl \
              --repository-url https://test.pypi.org/legacy/ \
              --username __token__ \
              --password ${{ secrets.TEST_PYPI_API_TOKEN }}
          fi

          echo "âœ… Precompiled wheels uploaded"

      - name: Create GitHub Release
        if: inputs.create_release && inputs.repository == 'pypi' && inputs.version_bump != 'none'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: Release v${{ steps.bump_version.outputs.new_version }}
          body: |
            ## SAGE v${{ steps.bump_version.outputs.new_version }}

            **Released from**: `${{ inputs.target_branch }}` branch
            **Triggered by**: @${{ github.actor }} (Manual Release)
            **Commit**: ${{ github.sha }}

            ### Published Packages
            - isage-common
            - isage-kernel
            - isage-libs
            - isage-middleware
            - isage-platform
            - isage-cli
            - isage-apps
            - isage-benchmark
            - isage-studio
            - isage-tools
            - isage (meta-package)

            ### Installation
            \`\`\`bash
            pip install isage==${{ steps.bump_version.outputs.new_version }}
            \`\`\`

            ### PyPI Links
            - [isage on PyPI](https://pypi.org/project/isage/${{ steps.bump_version.outputs.new_version }}/)

            ---
            *This release was manually triggered via GitHub Actions workflow.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: success()
        run: |
          echo "## ğŸ“¦ Manual Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump**: ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.version_bump }}" != "none" ]; then
            echo "- **New Version**: ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Packages Published**: 11 packages" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: ${{ inputs.create_release && inputs.repository == 'pypi' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.repository }}" = "pypi" ]; then
            echo "### ğŸ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
            echo "Users can now install with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install isage==${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ§ª Published to TestPyPI" >> $GITHUB_STEP_SUMMARY
            echo "Test installation with:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ isage" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Failure Summary
        if: failure()
        run: |
          echo "## âŒ Publication Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The manual publication workflow encountered an error." >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Inputs**:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version Bump: ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
