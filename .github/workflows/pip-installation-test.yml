name: PyPI Installation Test

on:
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'packages/*/setup.cfg'
      - '.github/workflows/pip-installation-test.yml'
  push:
    branches: [main, main-dev]
    paths:
      - 'packages/*/pyproject.toml'
      - 'packages/*/setup.py'
      - 'packages/*/setup.cfg'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: true
        default: 'local'
        type: choice
        options:
          - local  # æœ¬åœ°æ„å»ºæµ‹è¯•
          - testpypi  # TestPyPI æµ‹è¯•
          - pypi  # PyPI æµ‹è¯•ï¼ˆå‘å¸ƒåï¼‰

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-local-build:
    name: Test Local Build Installation (${{ matrix.install-mode }}, Py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    # Skip version bump commits - package structure not changed, only version numbers
    if: |
      !contains(github.event.head_commit.message, '[version bump]') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.test_mode == 'local')

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        install-mode: ['core', 'standard', 'full', 'dev']
      fail-fast: false  # å…è®¸æŸäº›ç»„åˆå¤±è´¥ï¼Œç»§ç»­æµ‹è¯•å…¶ä»–ç»„åˆ

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'  # éœ€è¦åˆå§‹åŒ–å­æ¨¡å—ä»¥æ„å»ºC++æ‰©å±•

      - name: Switch Submodules to main-dev Branch
        run: |
          echo "ğŸ”€ åˆ‡æ¢æ‰€æœ‰å­æ¨¡å—åˆ° main-dev åˆ†æ”¯..."
          git submodule foreach --recursive '
            if git show-ref --verify --quiet refs/remotes/origin/main-dev; then
              echo "åˆ‡æ¢ $name åˆ° main-dev..."
              git checkout main-dev
              git pull origin main-dev || true
            else
              echo "âš ï¸  $name æ²¡æœ‰ main-dev åˆ†æ”¯ï¼Œä¿æŒå½“å‰çŠ¶æ€"
            fi
          '
          echo "âœ… å­æ¨¡å—åˆ†æ”¯åˆ‡æ¢å®Œæˆ"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Build Tools
        run: |
          echo "ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·..."
          pip install --upgrade pip setuptools wheel build twine

      - name: Build All Packages
        run: |
          echo "ğŸ—ï¸ æ„å»ºæ‰€æœ‰ SAGE åŒ…..."

          # æŒ‰ä¾èµ–é¡ºåºæ„å»ºåŒ…
          packages=(
            "packages/sage-common"
            "packages/sage-platform"
            "packages/sage-kernel"
            "packages/sage-libs"
            "packages/sage-middleware"
            "packages/sage-apps"
            "packages/sage-benchmark"
            "packages/sage-studio"
            "packages/sage-tools"
            "packages/sage-cli"
            "packages/sage"
          )

          mkdir -p dist

          for package_dir in "${packages[@]}"; do
            if [ -d "$package_dir" ]; then
              echo "ğŸ”¨ æ„å»º $package_dir..."
              cd "$package_dir"
              python -m build --outdir ../../dist
              cd ../..
            else
              echo "âš ï¸  è·³è¿‡ä¸å­˜åœ¨çš„åŒ…: $package_dir"
            fi
          done

          echo "âœ… æ‰€æœ‰åŒ…æ„å»ºå®Œæˆ"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          ls -lh dist/

      - name: Test Installation from Local Wheels
        run: |
          echo "ğŸ§ª æµ‹è¯•ä»æœ¬åœ° wheel å®‰è£…..."

          # åˆ›å»ºå¹²å‡€çš„è™šæ‹Ÿç¯å¢ƒ
          python -m venv /tmp/test_env
          source /tmp/test_env/bin/activate

          echo "ğŸ“¦ ä»æœ¬åœ° wheel å®‰è£… SAGE[${{ matrix.install-mode }}]..."

          # å…ˆå®‰è£…åŸºç¡€ä¾èµ–
          pip install --upgrade pip setuptools wheel

          # ä»æœ¬åœ° dist ç›®å½•å®‰è£…ï¼ˆæ¨¡æ‹Ÿ PyPI å®‰è£…ï¼‰
          # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ --find-links è®© pip ä»æœ¬åœ°æŸ¥æ‰¾ä¾èµ–
          pip install --find-links dist "isage[${{ matrix.install-mode }}]" || {
            echo "âŒ å®‰è£…å¤±è´¥ï¼"
            deactivate
            exit 1
          }

          echo "âœ… å®‰è£…æˆåŠŸ"
          echo ""
          echo "ğŸ” éªŒè¯å®‰è£…..."

          # éªŒè¯ Python å¯¼å…¥
          python -c "import sage; print(f'âœ… SAGE version: {sage.__version__}')" || {
            echo "âŒ æ— æ³•å¯¼å…¥ sage"
            deactivate
            exit 1
          }

          # éªŒè¯æ ¸å¿ƒæ¨¡å—
          python -c "from sage.common import config; print('âœ… sage.common å¯ç”¨')"
          python -c "from sage.kernel import LocalEnvironment; print('âœ… sage.kernel å¯ç”¨')"

          # æ ¹æ®å®‰è£…æ¨¡å¼éªŒè¯ç›¸åº”çš„åŒ…
          case "${{ matrix.install-mode }}" in
            standard|full|dev)
              # éªŒè¯ CLI
              if command -v sage >/dev/null 2>&1; then
                sage --version && echo "âœ… sage CLI å¯ç”¨"
              else
                echo "âš ï¸  sage CLI æœªæ‰¾åˆ°ï¼ˆå¯èƒ½éœ€è¦æ·»åŠ åˆ° PATHï¼‰"
              fi

              # éªŒè¯ sage-benchmarkï¼ˆstandard/full/dev éƒ½åº”è¯¥åŒ…å«ï¼‰
              if pip show isage-benchmark >/dev/null 2>&1; then
                python -c "import sage.benchmark; print('âœ… sage.benchmark å¯ç”¨')" || {
                  echo "âŒ sage.benchmark å¯¼å…¥å¤±è´¥"
                  deactivate
                  exit 1
                }
                python -c "from sage.data import load_qa_dataset; print('âœ… sage.data å¯ç”¨')" || {
                  echo "âŒ sage.data å¯¼å…¥å¤±è´¥"
                  deactivate
                  exit 1
                }
              fi

              # éªŒè¯ sage-appsï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
              if pip show isage-apps >/dev/null 2>&1; then
                python -c "import sage.apps; print('âœ… sage.apps å¯ç”¨')" || {
                  echo "âŒ sage.apps å¯¼å…¥å¤±è´¥"
                  deactivate
                  exit 1
                }
              fi
              ;;
          esac

          # dev æ¨¡å¼é¢å¤–éªŒè¯
          if [ "${{ matrix.install-mode }}" = "dev" ]; then
            python -c "import sage.tools; print('âœ… sage.tools å¯ç”¨')" || {
              echo "âŒ sage.tools å¯¼å…¥å¤±è´¥"
              deactivate
              exit 1
            }
          fi

          # éªŒè¯å®‰è£…çš„åŒ…åˆ—è¡¨
          echo ""
          echo "ğŸ“‹ å·²å®‰è£…çš„ SAGE åŒ…:"
          pip list | grep -i sage || true

          echo ""
          echo "âœ… éªŒè¯é€šè¿‡ï¼"

          deactivate
          rm -rf /tmp/test_env

      - name: Test Installation from Source
        run: |
          echo "ğŸ§ª æµ‹è¯•ä»æºç å®‰è£…ï¼ˆpip install .ï¼‰..."

          # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆC++ æ‰©å±•æ„å»ºéœ€è¦ï¼‰
          echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            libopenblas-dev \
            liblapack-dev \
            gfortran

          # åˆ›å»ºå¹²å‡€çš„è™šæ‹Ÿç¯å¢ƒ
          python -m venv /tmp/test_source_env
          source /tmp/test_source_env/bin/activate

          pip install --upgrade pip setuptools wheel

          # è®¾ç½® CMake å‚æ•°ç¦ç”¨ LibAMMï¼ˆCI ç¯å¢ƒé€šå¸¸æ²¡æœ‰ CUDAï¼‰
          export CMAKE_ARGS="-DENABLE_LIBAMM=OFF"

          echo "ğŸ“¦ æŒ‰ä¾èµ–é¡ºåºä»æºç å®‰è£…..."

          # æ ¹æ®å®‰è£…æ¨¡å¼ç¡®å®šéœ€è¦å®‰è£…çš„åŒ…
          packages=(
            "packages/sage-common"
            "packages/sage-platform"
            "packages/sage-kernel"
            "packages/sage-libs"
            "packages/sage-middleware"
          )

          # standard/full/dev æ¨¡å¼éœ€è¦ sage-cli
          if [ "${{ matrix.install-mode }}" != "core" ]; then
            packages+=("packages/sage-cli")
          fi

          # standard/full/dev æ¨¡å¼éœ€è¦ L5 åº”ç”¨åŒ… (apps, benchmark)
          if [ "${{ matrix.install-mode }}" != "core" ]; then
            packages+=(
              "packages/sage-apps"
              "packages/sage-benchmark"
            )
          fi

          # full å’Œ dev æ¨¡å¼éœ€è¦ studio
          if [ "${{ matrix.install-mode }}" = "full" ] || [ "${{ matrix.install-mode }}" = "dev" ]; then
            packages+=("packages/sage-studio")
          fi

          # åªæœ‰ dev æ¨¡å¼éœ€è¦ sage-tools
          if [ "${{ matrix.install-mode }}" = "dev" ]; then
            packages+=("packages/sage-tools")
          fi

          for package_dir in "${packages[@]}"; do
            if [ -d "$package_dir" ]; then
              echo "ğŸ“¦ å®‰è£… $package_dir..."
              pip install "$package_dir" || {
                echo "âŒ å®‰è£… $package_dir å¤±è´¥"
                deactivate
                exit 1
              }
            fi
          done

          # æœ€åå®‰è£…ä¸»åŒ…
          echo "ğŸ“¦ å®‰è£… sage[${{ matrix.install-mode }}]..."
          pip install "packages/sage[${{ matrix.install-mode }}]" || {
            echo "âŒ å®‰è£…ä¸»åŒ…å¤±è´¥"
            deactivate
            exit 1
          }

          echo "âœ… æºç å®‰è£…æˆåŠŸ"
          echo ""
          echo "ğŸ” éªŒè¯å®‰è£…..."

          python -c "import sage; print(f'âœ… SAGE version: {sage.__version__}')"

          # æ ¹æ®æ¨¡å¼éªŒè¯ç‰¹å®šåŠŸèƒ½
          case "${{ matrix.install-mode }}" in
            core)
              echo "éªŒè¯ core æ¨¡å¼åŸºç¡€åŠŸèƒ½..."
              python -c "from sage.kernel import LocalEnvironment; print('âœ… LocalEnvironment å¯ç”¨')"
              python -c "from sage.middleware.operators.rag.pipeline import RAGPipeline; print('âœ… RAGPipeline å¯ç”¨')"
              ;;
            standard)
              echo "éªŒè¯ standard æ¨¡å¼åŠŸèƒ½..."
              python -c "from sage.middleware.operators.rag.pipeline import RAGPipeline; print('âœ… RAGPipeline å¯ç”¨')"
              if command -v sage >/dev/null 2>&1; then
                sage --version && echo "âœ… sage CLI å¯ç”¨"
              fi
              # éªŒè¯ sage-appsï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
              if pip show isage-apps >/dev/null 2>&1; then
                python -c "import sage.apps; print('âœ… sage.apps å¯ç”¨')" || {
                  echo "âŒ sage.apps å¯¼å…¥å¤±è´¥"
                  exit 1
                }
              fi
              # éªŒè¯ sage-benchmarkï¼ˆå¿…é¡»éªŒè¯ï¼‰
              if pip show isage-benchmark >/dev/null 2>&1; then
                python -c "import sage.benchmark; print('âœ… sage.benchmark å¯ç”¨')" || {
                  echo "âŒ sage.benchmark å¯¼å…¥å¤±è´¥"
                  exit 1
                }
                # éªŒè¯ sage.data å­åŒ…
                python -c "from sage.data import load_qa_dataset; print('âœ… sage.data å¯ç”¨')" || {
                  echo "âŒ sage.data å¯¼å…¥å¤±è´¥"
                  exit 1
                }
              fi
              ;;
            full)
              echo "éªŒè¯ full æ¨¡å¼åŠŸèƒ½..."
              python -c "from sage.middleware.operators.rag.pipeline import RAGPipeline; print('âœ… RAGPipeline å¯ç”¨')"
              python -c "import sage.studio; print('âœ… sage.studio å¯ç”¨')"
              if command -v sage >/dev/null 2>&1; then
                sage --version && echo "âœ… sage CLI å¯ç”¨"
              fi
              # éªŒè¯ sage-apps
              if pip show isage-apps >/dev/null 2>&1; then
                python -c "import sage.apps; print('âœ… sage.apps å¯ç”¨')" || {
                  echo "âŒ sage.apps å¯¼å…¥å¤±è´¥"
                  exit 1
                }
              fi
              # éªŒè¯ sage-benchmark
              if pip show isage-benchmark >/dev/null 2>&1; then
                python -c "import sage.benchmark; print('âœ… sage.benchmark å¯ç”¨')" || {
                  echo "âŒ sage.benchmark å¯¼å…¥å¤±è´¥"
                  exit 1
                }
                python -c "from sage.data import load_qa_dataset; print('âœ… sage.data å¯ç”¨')" || {
                  echo "âŒ sage.data å¯¼å…¥å¤±è´¥"
                  exit 1
                }
              fi
              ;;
            dev)
              echo "éªŒè¯ dev æ¨¡å¼åŠŸèƒ½..."
              python -c "from sage.middleware.operators.rag.pipeline import RAGPipeline; print('âœ… RAGPipeline å¯ç”¨')"
              python -c "import sage.studio; print('âœ… sage.studio å¯ç”¨')"
              python -c "import sage.tools; print('âœ… sage.tools å¯ç”¨')"
              python -c "import pytest; print('âœ… pytest å¯ç”¨')"
              # éªŒè¯ sage-apps
              if pip show isage-apps >/dev/null 2>&1; then
                python -c "import sage.apps; print('âœ… sage.apps å¯ç”¨')" || {
                  echo "âŒ sage.apps å¯¼å…¥å¤±è´¥"
                  exit 1
                }
              fi
              # éªŒè¯ sage-benchmarkï¼ˆå¿…é¡»å­˜åœ¨ï¼‰
              python -c "import sage.benchmark; print('âœ… sage.benchmark å¯ç”¨')" || {
                echo "âŒ sage.benchmark å¯¼å…¥å¤±è´¥"
                exit 1
              }
              python -c "from sage.data import load_qa_dataset; print('âœ… sage.data å¯ç”¨')" || {
                echo "âŒ sage.data å¯¼å…¥å¤±è´¥"
                exit 1
              }
              ;;
          esac

          echo ""
          echo "âœ… æºç å®‰è£…éªŒè¯é€šè¿‡ï¼"

          deactivate
          rm -rf /tmp/test_source_env

      - name: ğŸ” Verify No PyPI Downloads (Security Check)
        if: always()  # å³ä½¿ä¹‹å‰çš„æ­¥éª¤å¤±è´¥ä¹Ÿè¦æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦ä» PyPI ä¸‹è½½äº†æœ¬åœ°åŒ…ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰..."

          # æŸ¥æ‰¾æ‰€æœ‰ pip æ—¥å¿—
          pip_logs=(
            "$HOME/.cache/pip/log"
            "/tmp/pip-*"
            "build/pip-*.log"
          )

          # åˆ›å»ºä¸€ä¸ªåˆå¹¶çš„æ—¥å¿—ç”¨äºåˆ†æ
          combined_log=$(mktemp)

          # å¦‚æœæœ‰ pip ç¼“å­˜æ—¥å¿—ï¼Œåˆå¹¶å®ƒä»¬
          find "$HOME/.cache/pip/" -name "*.log" -type f 2>/dev/null | while read log; do
            cat "$log" >> "$combined_log" 2>/dev/null || true
          done

          # æ£€æŸ¥æ˜¯å¦ä¸‹è½½äº†æœ¬åœ°åŒ…
          violations=0
          for pkg in isage-common isage-platform isage-kernel isage-libs isage-middleware \
                     isage-apps isage-benchmark isage-cli isage-studio isage-tools isage; do
            if grep -i "Downloading.*${pkg}" "$combined_log" 2>/dev/null | grep -v "editable\|file://" | grep -q .; then
              echo "âŒ æ£€æµ‹åˆ°ä» PyPI ä¸‹è½½ï¼š${pkg}"
              violations=$((violations + 1))
            fi
          done

          rm -f "$combined_log"

          if [ $violations -gt 0 ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ° $violations ä¸ªåŒ…ä» PyPI ä¸‹è½½ï¼"
            echo "è¿™å¯èƒ½è¡¨æ˜ pyproject.toml ä¸­å­˜åœ¨ä¸å¿…è¦çš„ä¾èµ–å£°æ˜ã€‚"
            echo ""
            # ä¸è®©æµ‹è¯•å¤±è´¥ï¼Œåªæ˜¯è­¦å‘Š
            exit 0
          else
            echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼šæ²¡æœ‰ä» PyPI ä¸‹è½½æœ¬åœ°åŒ…"
          fi

      - name: Upload Build Artifacts
        if: matrix.python-version == '3.11' && matrix.install-mode == 'standard'
        uses: actions/upload-artifact@v4
        with:
          name: sage-dist-packages
          path: dist/
          retention-days: 7

  test-import-paths:
    name: Test Import Paths
    runs-on: ubuntu-latest
    needs: test-local-build
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sage-dist-packages
          path: dist/

      - name: Test Import Paths
        run: |
          echo "ğŸ§ª æµ‹è¯•æ‰€æœ‰å¯¼å…¥è·¯å¾„..."

          python -m venv /tmp/import_test_env
          source /tmp/import_test_env/bin/activate

          pip install --upgrade pip
          pip install --find-links dist "isage[standard]"

          echo "ğŸ” æµ‹è¯•æ ¸å¿ƒå¯¼å…¥è·¯å¾„..."

          # æµ‹è¯•æ‰€æœ‰å±‚çº§çš„å¯¼å…¥
          python << 'EOF'
          import sys

          # L1: Common
          from sage.common import config
          from sage.common.utils.logging import get_logger

          # L2: Platform (queue, service, storage modules)
          from sage.platform.queue import PythonQueueDescriptor, RayQueueDescriptor
          from sage.platform.service import BaseService

          # L3: Kernel
          from sage.kernel import LocalEnvironment, RemoteEnvironment
          from sage.kernel.operators import MapOperator, FilterOperator

          # L4: Libs (RAG)
          from sage.middleware.operators.rag.pipeline import RAGPipeline

          # L6: CLI (from sage-cli package)
          from sage.cli.main import app as cli_app

          print("âœ… æ‰€æœ‰æ ¸å¿ƒå¯¼å…¥è·¯å¾„æ­£å¸¸")
          EOF

          echo "âœ… å¯¼å…¥è·¯å¾„æµ‹è¯•é€šè¿‡"

          deactivate

  test-dependency-resolution:
    name: Test Dependency Resolution
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'  # éœ€è¦åˆå§‹åŒ–å­æ¨¡å—ä»¥æ„å»ºC++æ‰©å±•

      - name: Switch Submodules to main-dev Branch
        run: |
          echo "ğŸ”€ åˆ‡æ¢æ‰€æœ‰å­æ¨¡å—åˆ° main-dev åˆ†æ”¯..."
          git submodule foreach --recursive '
            if git show-ref --verify --quiet refs/remotes/origin/main-dev; then
              echo "åˆ‡æ¢ $name åˆ° main-dev..."
              git checkout main-dev
              git pull origin main-dev || true
            else
              echo "âš ï¸  $name æ²¡æœ‰ main-dev åˆ†æ”¯ï¼Œä¿æŒå½“å‰çŠ¶æ€"
            fi
          '
          echo "âœ… å­æ¨¡å—åˆ†æ”¯åˆ‡æ¢å®Œæˆ"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test Clean Installation
        run: |
          echo "ğŸ§ª æµ‹è¯•å¹²å‡€ç¯å¢ƒå®‰è£…ï¼ˆæ£€æŸ¥ä¾èµ–å†²çªï¼‰..."

          python -m venv /tmp/clean_env
          source /tmp/clean_env/bin/activate

          pip install --upgrade pip

          echo "ğŸ“¦ æ„å»ºæ‰€æœ‰ SAGE åŒ…..."
          pip install build

          # æŒ‰ä¾èµ–é¡ºåºæ„å»ºæ‰€æœ‰åŒ…
          packages=(
            "packages/sage-common"
            "packages/sage-platform"
            "packages/sage-kernel"
            "packages/sage-libs"
            "packages/sage-middleware"
            "packages/sage-apps"
            "packages/sage-benchmark"
            "packages/sage-studio"
            "packages/sage-tools"
            "packages/sage-cli"
            "packages/sage"
          )

          mkdir -p dist

          for package_dir in "${packages[@]}"; do
            if [ -d "$package_dir" ]; then
              echo "ğŸ”¨ æ„å»º $package_dir..."
              cd "$package_dir"
              python -m build --outdir ../../dist
              cd ../..
            else
              echo "âš ï¸  è·³è¿‡ä¸å­˜åœ¨çš„åŒ…: $package_dir"
            fi
          done

          echo "âœ… æ‰€æœ‰åŒ…æ„å»ºå®Œæˆ"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          ls -lh dist/

          echo ""
          echo "ğŸ“¦ ä»æœ¬åœ° wheel å®‰è£… SAGEï¼ˆä½¿ç”¨ --find-linksï¼‰..."

          # ä½¿ç”¨ --find-links è®© pip ä»æœ¬åœ° dist ç›®å½•æŸ¥æ‰¾æ‰€æœ‰ä¾èµ–
          pip install --find-links dist isage || {
            echo "âŒ ä¾èµ–è§£æå¤±è´¥ï¼"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. åŒ…ä¾èµ–ç‰ˆæœ¬å†²çª"
            echo "2. ç¼ºå°‘å¿…éœ€çš„ä¾èµ–å£°æ˜"
            echo "3. PyPI ä¸Šç¼ºå°‘æŸäº›ä¾èµ–åŒ…"
            deactivate
            exit 1
          }

          echo "âœ… ä¾èµ–è§£ææˆåŠŸ"
          echo ""
          echo "ğŸ“‹ å·²å®‰è£…çš„åŒ…:"
          pip list

          # æ£€æŸ¥æ˜¯å¦æœ‰å·²çŸ¥çš„ä¾èµ–å†²çª
          echo ""
          echo "ğŸ” æ£€æŸ¥ä¾èµ–å†²çª..."
          pip check || {
            echo "âš ï¸  æ£€æµ‹åˆ°ä¾èµ–å†²çª"
            exit 1
          }

          echo "âœ… æ— ä¾èµ–å†²çª"

          deactivate

  summary:
    name: Installation Test Summary
    runs-on: ubuntu-latest
    needs: [test-local-build, test-import-paths, test-dependency-resolution]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ğŸ“¦ PyPI å®‰è£…æµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-local-build.result }}" = "success" ] && \
             [ "${{ needs.test-import-paths.result }}" = "success" ] && \
             [ "${{ needs.test-dependency-resolution.result }}" = "success" ]; then
            echo "âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡** - SAGE å¯ä»¥æ­£å¸¸ä» wheel å®‰è£…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æµ‹è¯•è¦†ç›–" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æœ¬åœ° wheel æ„å»ºå®‰è£…" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æºç å®‰è£…ï¼ˆpip install .ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… å¯¼å…¥è·¯å¾„éªŒè¯" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä¾èµ–è§£ææ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… å¤š Python ç‰ˆæœ¬å…¼å®¹æ€§ (3.10, 3.11, 3.12)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… å¤šå®‰è£…æ¨¡å¼ (standard, full)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•å¤±è´¥** - å‘ç°å®‰è£…é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¤±è´¥çš„æµ‹è¯•" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.test-local-build.result }}" != "success" ]; then
              echo "- âŒ æœ¬åœ°æ„å»ºå®‰è£…æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.test-import-paths.result }}" != "success" ]; then
              echo "- âŒ å¯¼å…¥è·¯å¾„æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.test-dependency-resolution.result }}" != "success" ]; then
              echo "- âŒ ä¾èµ–è§£ææµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹å¤±è´¥çš„ job æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
