name: Deployment Readiness Check

on:
  pull_request:
    branches: [main, main-dev]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, main-dev]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deployment-readiness:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²æ¥è¿›è¡Œ diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ å®‰è£…æ£€æŸ¥å·¥å…·ä¾èµ–..."
          pip install --upgrade pip
          pip install pyyaml
          
          echo "ðŸ“¦ å®‰è£… SAGE æ ¸å¿ƒåŒ…ï¼ˆç”¨äºŽ Examples éªŒè¯ï¼‰..."
          # æŒ‰ç…§ä¾èµ–é¡ºåºå®‰è£… SAGE åŒ…ï¼ˆä»…å®‰è£…åŸºç¡€ä¾èµ–ï¼Œä¸å®‰è£…å¯é€‰ä¾èµ–ï¼‰
          pip install -e packages/sage-common --no-deps
          pip install -e packages/sage-kernel --no-deps
          pip install -e packages/sage-middleware --no-deps
          pip install -e packages/sage-libs --no-deps
          pip install -e packages/sage-apps --no-deps
          pip install -e packages/sage-tools --no-deps
          pip install -e packages/sage --no-deps
          
          echo "âœ… SAGE åŒ…å®‰è£…å®Œæˆ"

      - name: Dev-notes Documentation Check
        run: |
          echo "ðŸ“š æ£€æŸ¥ dev-notes æ–‡æ¡£è§„èŒƒ..."

          # æ£€æŸ¥æ˜¯å¦æœ‰ dev-notes å˜æ›´
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            DEVNOTES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^docs/dev-notes/.*\.md$' || true)
          else
            DEVNOTES_CHANGED=$(git diff --name-only HEAD~5...HEAD | grep '^docs/dev-notes/.*\.md$' || true)
          fi

          if [ -n "$DEVNOTES_CHANGED" ]; then
            echo "ðŸ“ å‘çŽ° dev-notes æ–‡æ¡£å˜æ›´:"
            echo "$DEVNOTES_CHANGED"
            echo ""

            if [ "${{ github.event_name }}" = "pull_request" ]; then
              python tools/devnotes_checker.py \
                --changed-only \
                --diff "origin/${{ github.base_ref }}" \
                --strict || {
                  echo ""
                  echo "âŒ Dev-notes æ–‡æ¡£ä¸ç¬¦åˆè§„èŒƒï¼"
                  echo ""
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ðŸ’¡ å¸¸è§é—®é¢˜ä¿®å¤ï¼š"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "1. ä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿: docs/dev-notes/TEMPLATE.md"
                  echo "2. ç¡®ä¿åŒ…å«å¿…éœ€çš„ç« èŠ‚"
                  echo "3. æ£€æŸ¥å…ƒæ•°æ®æ ¼å¼ï¼ˆYAML front matterï¼‰"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  exit 1
                }
            else
              python tools/devnotes_checker.py --changed-only --diff HEAD~5 || {
                echo "âš ï¸  å‘çŽ°æ–‡æ¡£æ ¼å¼é—®é¢˜ï¼Œä½†ä¸é˜»å¡žéƒ¨ç½²"
              }
            fi
          else
            echo "â„¹ï¸  æ²¡æœ‰ dev-notes æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
          fi

          echo ""
          echo "âœ… Dev-notes æ–‡æ¡£æ£€æŸ¥å®Œæˆ"

      - name: Architecture Compliance Check
        run: |
          echo "ðŸ—ï¸ è¿è¡Œæž¶æž„åˆè§„æ€§æ£€æŸ¥..."

          # åœ¨ PR ä¸­ä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ðŸ“ PR æ¨¡å¼ï¼šæ£€æŸ¥å˜æ›´çš„ Python æ–‡ä»¶"

            # æ£€æŸ¥æ˜¯å¦æœ‰ Python æ–‡ä»¶å˜æ›´
            PYTHON_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)

            if [ -n "$PYTHON_CHANGED" ]; then
              echo "ðŸ“ å‘çŽ° Python æ–‡ä»¶å˜æ›´"
              python tools/architecture_checker.py \
                --changed-only \
                --diff "origin/${{ github.base_ref }}" \
                --strict || {
                  echo ""
                  echo "âŒ æž¶æž„åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼"
                  echo ""
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ðŸ’¡ å¸¸è§é—®é¢˜ä¿®å¤ï¼š"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "1. æ£€æŸ¥è·¨å±‚çº§å¯¼å…¥ï¼ˆå¦‚ app å¯¼å…¥ kernelï¼‰"
                  echo "2. ç¡®ä¿å¯¼å…¥è·¯å¾„ç¬¦åˆåŒ…æž¶æž„"
                  echo "3. æŸ¥çœ‹æ–‡æ¡£: docs-public/docs_src/dev-notes/package-architecture.md"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  exit 1
                }
            else
              echo "â„¹ï¸  æ²¡æœ‰ Python æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æž¶æž„æ£€æŸ¥"
            fi
          else
            echo "ðŸ“¦ Push æ¨¡å¼ï¼šå¿«é€Ÿæ£€æŸ¥ï¼ˆä»…æ‰«æå¯¼å…¥è¯­å¥ï¼‰"
            # åœ¨ push æ—¶åšå¿«é€Ÿæ£€æŸ¥ï¼Œé¿å…é˜»å¡ž
            python tools/architecture_checker.py --changed-only --diff HEAD~5 || {
              echo ""
              echo "âš ï¸  å‘çŽ°æž¶æž„é—®é¢˜ï¼Œä½†ä¸é˜»å¡žéƒ¨ç½²"
              echo "è¯·å°½å¿«ä¿®å¤: docs-public/docs_src/dev-notes/package-architecture.md"
            }
          fi

          echo ""
          echo "âœ… æž¶æž„æ£€æŸ¥å®Œæˆ"

      - name: Examples Validation
        run: |
          echo "ðŸŒŸ éªŒè¯ Examples å¯æ‰§è¡Œæ€§..."

          # å®‰è£…å¿…è¦çš„ä¾èµ–
          pip install pytest pytest-timeout pytest-benchmark

          # è¿è¡Œ Examples å¯¼å…¥æµ‹è¯•
          if [ -f "packages/sage-tools/tests/test_examples_imports.py" ]; then
            echo "ðŸ“ è¿è¡Œ Examples å¯¼å…¥æµ‹è¯•..."
            timeout 180s pytest packages/sage-tools/tests/test_examples_imports.py -v || {
              echo ""
              echo "âš ï¸ Examples å¯¼å…¥æµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥"

              if [ "${{ github.event_name }}" = "pull_request" ]; then
                echo "âŒ PR å¿…é¡»é€šè¿‡ Examples éªŒè¯"
                exit 1
              else
                echo "âš ï¸ ä¸é˜»å¡žä¸»åˆ†æ”¯ï¼Œä½†å»ºè®®ä¿®å¤"
                exit 0
              fi
            }
          else
            echo "â„¹ï¸  Examples æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯"
          fi

          echo ""
          echo "âœ… Examples éªŒè¯å®Œæˆ"

      - name: Package README Check
        run: |
          echo "ðŸ“– æ£€æŸ¥åŒ… README æ–‡æ¡£..."

          if python tools/package_readme_checker.py; then
            echo "âœ… æ‰€æœ‰åŒ…çš„ README æ–‡æ¡£å®Œæ•´"
          else
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ’¡ ä¿®å¤å»ºè®®ï¼š"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "1. ç¡®ä¿æ¯ä¸ªåŒ…éƒ½æœ‰ README.md"
              echo "2. README åº”åŒ…å«ï¼šç®€ä»‹ã€å®‰è£…ã€ä½¿ç”¨ç¤ºä¾‹"
              echo "3. ä½¿ç”¨æ¨¡æ¿: tools/templates/PACKAGE_README.md"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            else
              echo "âš ï¸  README æ£€æŸ¥å¤±è´¥ï¼Œä½†ä¸é˜»å¡žéƒ¨ç½²"
            fi
          fi

      - name: Generate Deployment Report
        if: always()
        run: |
          echo "ðŸ“Š ç”Ÿæˆéƒ¨ç½²å°±ç»ªæŠ¥å‘Š..."

          # ç»Ÿè®¡ä¿¡æ¯
          TOTAL_PACKAGES=$(find packages -name "setup.py" -o -name "pyproject.toml" | wc -l)
          TOTAL_EXAMPLES=$(find examples -name "*.py" -type f | wc -l)
          TOTAL_DOCS=$(find docs/dev-notes -name "*.md" -type f | wc -l)

          echo "ðŸ“¦ åŒ…æ•°é‡: $TOTAL_PACKAGES"
          echo "ðŸŒŸ ç¤ºä¾‹æ•°é‡: $TOTAL_EXAMPLES"
          echo "ðŸ“š æ–‡æ¡£æ•°é‡: $TOTAL_DOCS"

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo ""
          echo "ðŸ” å…³é”®æ–‡ä»¶æ£€æŸ¥:"

          CRITICAL_FILES=(
            "README.md"
            "CONTRIBUTING.md"
            "LICENSE"
            "pyrightconfig.json"
            "pytest.ini"
          )

          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  âœ… $file"
            else
              echo "  âŒ $file ç¼ºå¤±"
            fi
          done

          echo ""
          echo "âœ… éƒ¨ç½²æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ éƒ¨ç½²å°±ç»ªæ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æ£€æŸ¥é€šè¿‡** - ä»£ç å·²å°±ç»ªå¯ä»¥éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ£€æŸ¥é¡¹ç›®:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Dev-notes æ–‡æ¡£è§„èŒƒ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æž¶æž„åˆè§„æ€§" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Examples å¯æ‰§è¡Œæ€§" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Package README å®Œæ•´æ€§" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ£€æŸ¥å¤±è´¥** - å‘çŽ°éƒ¨ç½²é˜»å¡žé—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
