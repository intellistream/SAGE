name: Build Wheels

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to build wheels for'
        required: true
        default: 'sage-middleware'
        type: choice
        options:
          - sage-middleware
          - all

  # 发布时自动触发
  release:
    types: [published]

  # PR 到 main 时触发（用于测试）
  pull_request:
    branches:
      - main
    paths:
      - 'packages/sage-middleware/**'
      - '.github/workflows/build-wheels.yml'

jobs:
  # 构建 sage-middleware 的 wheels（包含 C++ 扩展）
  build-sage-middleware-wheels:
    name: Build wheels for sage-middleware on ${{ matrix.os }}
    if: |
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.package == 'sage-middleware' || github.event.inputs.package == 'all')) ||
      github.event_name == 'release' ||
      github.event_name == 'pull_request'

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]  # macos-13=Intel, macos-14=ARM
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # Linux: 安装构建依赖
      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      # macOS: 安装构建依赖
      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja

      # Windows: 安装构建依赖
      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.22.0

      - name: Build wheels
        env:
          CIBW_BUILD: "cp310-* cp311-* cp312-*"
          CIBW_SKIP: "*-musllinux_*"  # 跳过 musl Linux
          CIBW_ARCHS_LINUX: "x86_64 aarch64"
          CIBW_ARCHS_MACOS: "x86_64 arm64"
          CIBW_ARCHS_WINDOWS: "AMD64"
          # 在构建前安装依赖
          CIBW_BEFORE_BUILD: "pip install setuptools wheel scikit-build-core pybind11"
          # 测试安装的 wheel
          CIBW_TEST_COMMAND: "python -c \"import sage.middleware; print('Middleware imported successfully')\""
          CIBW_TEST_SKIP: "*-macosx_arm64"  # 跳过 ARM macOS 的测试（可能在 x86 runner 上运行）
        working-directory: packages/sage-middleware
        run: python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sage-middleware-${{ matrix.os }}-${{ matrix.python-version }}
          path: packages/sage-middleware/wheelhouse/*.whl
          retention-days: 7

  # 构建纯 Python 包的 wheels（不需要编译）
  build-pure-python-wheels:
    name: Build pure Python wheels
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.package == 'all') ||
      github.event_name == 'release'

    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - sage
          - sage-common
          - sage-platform
          - sage-kernel
          - sage-libs
          - sage-cli
          - sage-tools
          - sage-studio
          - sage-apps
          - sage-benchmark

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build wheel for ${{ matrix.package }}
        working-directory: packages/${{ matrix.package }}
        run: python -m build --wheel

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.package }}
          path: packages/${{ matrix.package }}/dist/*.whl
          retention-days: 7

  # 收集所有 wheels 并上传到 PyPI（仅在 release 时）
  upload-to-pypi:
    name: Upload wheels to PyPI
    needs: [build-sage-middleware-wheels, build-pure-python-wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -R dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist/
          skip-existing: true
          verbose: true

  # 测试安装（验证 wheels 可用性）
  test-installation:
    name: Test wheel installation
    needs: build-sage-middleware-wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-sage-middleware-*
          path: dist
          merge-multiple: true

      - name: Install wheel
        run: |
          pip install dist/*.whl
        continue-on-error: true

      - name: Test import
        run: |
          python -c "import sage.middleware; print('✅ Middleware imported successfully')"
          python -c "from sage.middleware.components import *; print('✅ Components imported successfully')"
