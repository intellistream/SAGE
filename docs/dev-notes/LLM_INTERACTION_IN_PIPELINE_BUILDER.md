# SAGE Pipeline Builder ä¸­çš„å¤§æ¨¡å‹äº¤äº’æµç¨‹

## ğŸ“ å¤§æ¨¡å‹å‚ä¸çš„å…³é”®ä½ç½®

### 1. å…¥å£ï¼š`sage chat` å‘½ä»¤
- **æ–‡ä»¶**: `packages/sage-tools/src/sage/tools/cli/commands/chat.py`
- **ç±»**: `PipelineChatCoordinator`
- **æ–¹æ³•**: `handle()` â†’ `_generate_plan()` â†’ `_build_config()`

### 2. æ ¸å¿ƒç”Ÿæˆå™¨ï¼š`PipelinePlanGenerator`
- **æ–‡ä»¶**: `packages/sage-tools/src/sage/tools/cli/commands/pipeline.py`
- **å…³é”®æ–¹æ³•**: `generate()`

## ğŸ”„ å®Œæ•´çš„å¤§æ¨¡å‹äº¤äº’æµç¨‹

```
ç”¨æˆ·è¾“å…¥ï¼š"è¯·å¸®æˆ‘æ„å»ºä¸€ä¸ªé—®ç­”åº”ç”¨"
    â†“
1. æ„å›¾è¯†åˆ« (chat.py)
    _looks_like_pipeline_request() æ£€æµ‹æ˜¯å¦ä¸º pipeline æ„å»ºè¯·æ±‚
    â†“
2. éœ€æ±‚æ”¶é›† (chat.py)
    _collect_requirements() æ”¶é›†ç”¨æˆ·è¯¦ç»†éœ€æ±‚
    {
        "name": "é—®ç­”åŠ©æ‰‹",
        "goal": "æ„å»ºåŸºäºæ–‡æ¡£çš„é—®ç­”ç³»ç»Ÿ",
        "data_sources": ["æ–‡æ¡£çŸ¥è¯†åº“"],
        ...
    }
    â†“
3. æ„å»ºé…ç½® (chat.py)
    _build_config() å‡†å¤‡ç”Ÿæˆå™¨é…ç½®
    - åŠ è½½ domain_contexts (ç¤ºä¾‹é…ç½®æ–‡ä»¶)
    - åˆå§‹åŒ– knowledge_base (æ–‡æ¡£+ä»£ç æ£€ç´¢)
    â†“
4. RAG æ£€ç´¢é˜¶æ®µ (pipeline.py - PipelinePlanGenerator.generate())
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4.1 çŸ¥è¯†åº“æ£€ç´¢                           â”‚
    â”‚  - ä» docs-public/docs_src æ£€ç´¢æ–‡æ¡£     â”‚
    â”‚  - ä» examples/ æ£€ç´¢ä»£ç ç¤ºä¾‹            â”‚
    â”‚  - ä» packages/sage-libs æ£€ç´¢ç»„ä»¶ä¿¡æ¯   â”‚
    â”‚  - è¿”å› top_k=5 ä¸ªæœ€ç›¸å…³ç‰‡æ®µ            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4.2 æ¨¡æ¿åŒ¹é… (templates)                â”‚
    â”‚  - åŒ¹é…åº”ç”¨æ¨¡æ¿ï¼ˆåŸºäºæ ‡ç­¾å’Œæè¿°ï¼‰       â”‚
    â”‚  - ä¾‹å¦‚ï¼šqa_simple, rag_retrieval ç­‰    â”‚
    â”‚  - æä¾›å®Œæ•´çš„ pipeline ç»“æ„å‚è€ƒ         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4.3 è“å›¾åŒ¹é… (blueprints)               â”‚
    â”‚  - åŒ¹é…é…ç½®è“å›¾ï¼ˆå¯ç›´æ¥ä½¿ç”¨çš„é…ç½®ï¼‰     â”‚
    â”‚  - åŒ…å«å…·ä½“çš„ç±»è·¯å¾„å’Œå‚æ•°               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
5. æ„å»ºæç¤ºè¯ (_build_prompt())
    ç»„è£…æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ System Prompt (SYSTEM_PROMPT)           â”‚
    â”‚  - è¯´æ˜ SAGE Pipeline çš„ JSON ç»“æ„      â”‚
    â”‚  - å®šä¹‰å¿…éœ€å­—æ®µå’Œè§„åˆ™                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    +
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User Prompt:                            â”‚
    â”‚  1. ç”¨æˆ·éœ€æ±‚ (JSON)                     â”‚
    â”‚  2. åº”ç”¨æ¨¡æ¿ (template_contexts)        â”‚
    â”‚  3. é…ç½®è“å›¾ (blueprint_contexts)       â”‚
    â”‚  4. çŸ¥è¯†åº“æ£€ç´¢ç»“æœ (knowledge_contexts) â”‚
    â”‚  5. Domain ä¸Šä¸‹æ–‡ (domain_contexts)     â”‚
    â”‚  6. ä¸Šä¸€ç‰ˆé…ç½® (previous_planï¼Œå¦‚æœ‰)    â”‚
    â”‚  7. ç”¨æˆ·åé¦ˆ (feedbackï¼Œå¦‚æœ‰)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
6. å¤§æ¨¡å‹è°ƒç”¨ ğŸ¤–
    self._client.generate(messages, max_tokens=1200, temperature=0.2)
    â†“
7. è§£æå“åº”
    _extract_json_object(response) â†’ JSON é…ç½®
    â†“
8. éªŒè¯é…ç½®
    _validate_plan(plan) â†’ æ£€æŸ¥å¿…éœ€å­—æ®µ
    â†“
9. è¿”å›ç»™ç”¨æˆ·
    æ˜¾ç¤ºé…ç½® â†’ ç”¨æˆ·ç¡®è®¤ â†’ ä¿å­˜/è¿è¡Œ
```

## ğŸ“š å„ç±»ä¸Šä¸‹æ–‡çš„ä½œç”¨

### Domain Contexts
- **æ¥æº**: `pipeline_domain.py` - `load_domain_contexts()`
- **å†…å®¹**: examples/config/*.yaml ä¸­çš„ç¤ºä¾‹é…ç½®
- **ä½œç”¨**: æä¾›ç»„ä»¶é€ŸæŸ¥è¡¨ï¼Œè®© LLM çŸ¥é“æœ‰å“ªäº›å¯ç”¨ç»„ä»¶

### Knowledge Base
- **æ¥æº**: `pipeline_knowledge.py` - `PipelineKnowledgeBase`
- **å†…å®¹**: 
  - `docs-public/docs_src/` - æ–‡æ¡£
  - `examples/` - ä»£ç ç¤ºä¾‹
  - `packages/sage-libs/` - ç»„ä»¶ä»£ç 
- **ä½œç”¨**: RAG æ£€ç´¢ï¼Œæ ¹æ®ç”¨æˆ·éœ€æ±‚æ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡æ¡£å’Œä»£ç 

### Templates
- **æ¥æº**: `sage.tools.templates` - `ApplicationTemplate`
- **å†…å®¹**: é¢„å®šä¹‰çš„åº”ç”¨æ¨¡æ¿ï¼ˆå¦‚ QAã€RAGã€Chat ç­‰ï¼‰
- **ä½œç”¨**: æä¾›å®Œæ•´çš„ pipeline ç»“æ„å‚è€ƒ

### Blueprints
- **æ¥æº**: `sage.tools.cli.pipeline_blueprints`
- **å†…å®¹**: å¯ç›´æ¥å¤ç”¨çš„é…ç½®è“å›¾
- **ä½œç”¨**: æä¾›å¯ç›´æ¥ä½¿ç”¨çš„é…ç½®æ¨¡å¼

## ğŸ¯ å½“å‰å®ç°çš„ä¼˜ç‚¹

âœ… **å·²ç»å®ç° RAG**ï¼šçŸ¥è¯†åº“æ£€ç´¢å·²é›†æˆ
âœ… **å¤šå±‚æ¬¡ä¸Šä¸‹æ–‡**ï¼šæ¨¡æ¿ã€è“å›¾ã€æ–‡æ¡£ã€ä»£ç 
âœ… **è¿­ä»£ä¼˜åŒ–**ï¼šæ”¯æŒç”¨æˆ·åé¦ˆå¤šè½®æ”¹è¿›
âœ… **éªŒè¯æœºåˆ¶**ï¼šç”ŸæˆåéªŒè¯é…ç½®åˆæ³•æ€§

## ğŸ”§ å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹

### 1. å¢å¼ºæç¤ºè¯å·¥ç¨‹
å½“å‰ SYSTEM_PROMPT æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ï¼š
- æ·»åŠ æ›´å¤šç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- å¼ºè°ƒç»„ä»¶çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼
- è¯´æ˜å¸¸è§é”™è¯¯å’Œå¦‚ä½•é¿å…

### 2. æ”¹è¿›çŸ¥è¯†åº“æ£€ç´¢
- æ ¹æ®ä¸åŒåœºæ™¯è°ƒæ•´æ£€ç´¢ç­–ç•¥
- å¢åŠ ä»£ç ç¤ºä¾‹çš„ä¼˜å…ˆçº§
- æ”¯æŒå¤šæ¨¡æ€æ£€ç´¢ï¼ˆæ–‡æ¡£+ä»£ç æ··åˆï¼‰

### 3. æ¨¡æ¿ç³»ç»Ÿå¢å¼º
- æ‰©å±•æ¨¡æ¿åº“ï¼ˆå½“å‰æ•°é‡è¾ƒå°‘ï¼‰
- æ·»åŠ æ›´å¤šé¢†åŸŸç‰¹å®šæ¨¡æ¿
- æ¨¡æ¿ç»„åˆæ¨è

### 4. æ™ºèƒ½æ¨è
- æ ¹æ®ç”¨æˆ·å†å²ç”Ÿæˆæ¨è
- ç»„ä»¶å…¼å®¹æ€§æ£€æŸ¥
- å‚æ•°è‡ªåŠ¨æ¨æ–­

## ğŸ“Š æç¤ºè¯ç¤ºä¾‹

ä¸‹é¢æ˜¯ä¸€ä¸ªå®é™…å‘é€ç»™ LLM çš„æç¤ºè¯ç¤ºä¾‹ï¼š

```
System:
You are SAGE Pipeline Builder, an expert in configuring Streaming-Augmented 
Generative Execution pipelines...

User:
è¯·æ ¹æ®ä»¥ä¸‹éœ€æ±‚ç”Ÿæˆç¬¦åˆ SAGE æ¡†æ¶çš„ pipeline é…ç½® JSONï¼š
{
  "name": "é—®ç­”åŠ©æ‰‹",
  "goal": "æ„å»ºåŸºäºæ–‡æ¡£çš„é—®ç­”ç³»ç»Ÿ",
  "data_sources": ["æ–‡æ¡£çŸ¥è¯†åº“"],
  "latency_budget": "å®æ—¶å“åº”ä¼˜å…ˆ",
  ...
}

ä»¥ä¸‹åº”ç”¨æ¨¡æ¿ä»…ä½œçµæ„Ÿå‚è€ƒï¼Œè¯·ç»“åˆéœ€æ±‚è‡ªè¡Œè®¾è®¡ï¼š
æ¨¡æ¿[1]:
æ¨¡æ¿: ç®€å•é—®ç­”åº”ç”¨ (qa_simple)
ç¤ºä¾‹è·¯å¾„: examples/rag/qa_without_retrieval.py
...

ä»¥ä¸‹è“å›¾å¯ç›´æ¥å¤ç”¨æˆ–åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•ï¼š
è“å›¾[1]:
Blueprint: qa_simple_blueprint
...

ä»¥ä¸‹æ˜¯ä» SAGE çŸ¥è¯†åº“æ£€ç´¢åˆ°çš„å‚è€ƒä¿¡æ¯ï¼š
çŸ¥è¯†[1]:
QA å¿«é€Ÿå…¥é—¨
æ„å»º QA å¤„ç†ç®¡é“éœ€è¦ä»¥ä¸‹ç»„ä»¶...

çŸ¥è¯†[2]:
OpenAIGenerator ä½¿ç”¨è¯´æ˜
...

ä»¥ä¸‹æ˜¯ä¸ SAGE ç®¡é“æ„å»ºç›¸å…³çš„å‚è€ƒèµ„æ–™ï¼š
å‚è€ƒ[1]:
# config_for_qa.yaml ç¤ºä¾‹é…ç½®
...

ä¸¥æ ¼è¾“å‡ºå•ä¸ª JSON å¯¹è±¡ï¼Œä¸è¦åŒ…å« markdownã€æ³¨é‡Šæˆ–å¤šä½™æ–‡å­—ã€‚
```

## ğŸš€ ä½¿ç”¨å»ºè®®

### ä¸ºäº†è·å¾—æœ€ä½³æ•ˆæœï¼š

1. **ä½¿ç”¨çœŸå® LLM åç«¯**ï¼ˆè€Œé mockï¼‰
   ```bash
   export SAGE_CHAT_API_KEY="your-api-key"
   sage chat --backend openai --model qwen-max
   ```

2. **å¯ç”¨çŸ¥è¯†åº“æ£€ç´¢**ï¼ˆé»˜è®¤å¼€å¯ï¼‰
   ```bash
   sage pipeline build --name "MyApp" --goal "..." 
   # çŸ¥è¯†åº“ä¼šè‡ªåŠ¨åŠ è½½
   ```

3. **æŸ¥çœ‹æ£€ç´¢ç»“æœ**ï¼ˆè°ƒè¯•ç”¨ï¼‰
   ```bash
   sage pipeline build --show-knowledge ...
   # ä¼šæ˜¾ç¤ºæ£€ç´¢åˆ°çš„æ–‡æ¡£å’Œæ¨¡æ¿
   ```

4. **æä¾›è¯¦ç»†éœ€æ±‚**
   - æ˜ç¡®è¯´æ˜æ•°æ®æºã€å¤„ç†æµç¨‹ã€è¾“å‡ºè¦æ±‚
   - æåŠç‰¹å®šç»„ä»¶æˆ–æŠ€æœ¯ï¼ˆå¦‚ "ä½¿ç”¨ FAISS"ã€"æ”¯æŒæµå¼è¾“å‡º"ï¼‰

## ğŸ“ æ€»ç»“

**æ˜¯çš„ï¼Œå¤§æ¨¡å‹å·²ç»æ·±åº¦å‚ä¸äº† pipeline æ„å»ºè¿‡ç¨‹ï¼**

æ•´ä¸ªæµç¨‹å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ RAG åº”ç”¨ï¼š
1. ç”¨æˆ·æé—®
2. æ£€ç´¢ç›¸å…³æ–‡æ¡£ã€æ¨¡æ¿ã€ç¤ºä¾‹
3. ç»„è£…ä¸Šä¸‹æ–‡
4. è°ƒç”¨ LLM ç”Ÿæˆé…ç½®
5. éªŒè¯å’Œä¼˜åŒ–

templates ä¸­çš„æ¨¡æ¿ã€docs ä¸­çš„æ–‡æ¡£ã€examples ä¸­çš„ä»£ç éƒ½ä¼šè¢«ï¼š
- ç´¢å¼•åˆ°çŸ¥è¯†åº“
- æ ¹æ®ç”¨æˆ·éœ€æ±‚æ£€ç´¢
- ä½œä¸ºä¸Šä¸‹æ–‡ä¼ é€’ç»™ LLM
- æŒ‡å¯¼ LLM ç”Ÿæˆç¬¦åˆ SAGE è§„èŒƒçš„é…ç½®
