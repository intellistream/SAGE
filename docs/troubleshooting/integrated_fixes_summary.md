# æ„å»ºå’Œå®‰è£…è„šæœ¬é›†æˆä¿®å¤æ€»ç»“

## ğŸ¯ ç›®æ ‡

å°† `outlines_core` å’Œ `xformers` æ„å»ºé—®é¢˜çš„ä¿®å¤ç›´æ¥é›†æˆåˆ°ç°æœ‰çš„ `build_all_wheels.sh` å’Œ `install_wheels.sh` è„šæœ¬ä¸­ï¼Œæ— éœ€é¢å¤–çš„ä¿®å¤è„šæœ¬ã€‚

## âœ… å®Œæˆçš„é›†æˆ

### 1. build_all_wheels.sh é›†æˆä¿®å¤

**æ·»åŠ çš„ä¿®å¤åŠŸèƒ½ï¼š**
- ğŸ”§ è‡ªåŠ¨è®¾ç½®ç¯å¢ƒå˜é‡ (`PIP_USE_PEP517=1`, `PIP_PREFER_BINARY=1`)
- ğŸ“¦ é¢„å®‰è£…é—®é¢˜åŒ… (`outlines`, `xformers`)
- ğŸ¦€ è‡ªåŠ¨æ£€æµ‹å’Œå®‰è£… Rust ç¼–è¯‘å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ğŸ› ï¸ å®‰è£…æ„å»ºä¾èµ– (`setuptools-rust`, `maturin`, `pybind11`)
- ğŸ¯ æ™ºèƒ½å›é€€æœºåˆ¶ï¼šé¢„ç¼–è¯‘å¤±è´¥ â†’ æºç ç¼–è¯‘
- ğŸ“‹ åº”ç”¨æ„å»ºçº¦æŸæ–‡ä»¶ (`constraints-build.txt`)

**ä¿®æ”¹çš„ä½ç½®ï¼š**
```bash
# åœ¨è„šæœ¬å¼€å¤´æ·»åŠ ä¿®å¤é€»è¾‘
echo "ğŸ”§ åº”ç”¨æ„å»ºé—®é¢˜ä¿®å¤..."
export PIP_USE_PEP517=1
# ... å…¶ä»–ä¿®å¤ä»£ç 

# åœ¨ build_package å‡½æ•°ä¸­æ·»åŠ çº¦æŸæ”¯æŒ
constraint_args=""
if [ -f "../constraints-build.txt" ]; then
    constraint_args="--constraint ../constraints-build.txt"
fi
```

### 2. install_wheels.sh é›†æˆä¿®å¤

**æ·»åŠ çš„ä¿®å¤åŠŸèƒ½ï¼š**
- ğŸ”§ è‡ªåŠ¨è®¾ç½®å®‰è£…ç¯å¢ƒå˜é‡
- ğŸ“¦ é¢„å®‰è£…æ ¸å¿ƒåŒ… (`numpy`, `scipy`, `torch`)
- ğŸ¯ é¢„å®‰è£…é—®é¢˜åŒ… (`outlines`, `xformers`)
- ğŸ› ï¸ æ™ºèƒ½å›é€€æœºåˆ¶ï¼šé¢„ç¼–è¯‘å¤±è´¥ â†’ æºç ç¼–è¯‘
- ğŸ“‹ æ™ºèƒ½çº¦æŸæ–‡ä»¶æ£€æµ‹å’Œåº”ç”¨
- ğŸš€ ä¼˜å…ˆä½¿ç”¨ `requirements-lock.txt`

**ä¿®æ”¹çš„ä½ç½®ï¼š**
```bash
# åœ¨è„šæœ¬å¼€å¤´æ·»åŠ ä¿®å¤é€»è¾‘
echo "ğŸ”§ åº”ç”¨å®‰è£…é—®é¢˜ä¿®å¤..."
export PIP_USE_PEP517=1
# ... é¢„å®‰è£…é€»è¾‘

# æ™ºèƒ½çº¦æŸæ–‡ä»¶æ£€æµ‹
constraint_args=""
if [ -f "constraints.txt" ]; then
    constraint_args="$constraint_args --constraint=constraints.txt"
fi
```

### 3. æ–°å¢ç»Ÿä¸€è„šæœ¬

**åˆ›å»º `build_and_install.sh`ï¼š**
- ğŸš€ ä¸€é”®æ„å»ºå’Œå®‰è£…
- ğŸ›ï¸ æ”¯æŒå¤šç§æ¨¡å¼ (`--build-only`, `--install-only`, `--skip-build`)
- â±ï¸ æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
- ğŸ“‹ æ˜¾ç¤ºåº”ç”¨çš„ä¿®å¤
- ğŸ” æä¾›éªŒè¯å‘½ä»¤

### 4. æ›´æ–° Makefile

**å¢å¼ºçš„ Makefile ç›®æ ‡ï¼š**
- `make build` - ä½¿ç”¨ä¿®å¤åçš„æ„å»ºè„šæœ¬
- `make install` - ä½¿ç”¨ä¿®å¤åçš„å®‰è£…è„šæœ¬
- `make all` - ä¸€é”®æ„å»ºå’Œå®‰è£…
- `make clean` - æ¸…ç†æ„å»ºäº§ç‰©
- `make help` - æ˜¾ç¤ºå¸®åŠ©ï¼ˆåŒ…å«ä¿®å¤ä¿¡æ¯ï¼‰

## ğŸ”§ ä¿®å¤çš„é—®é¢˜

### 1. outlines_core æ„å»ºå¤±è´¥
- **åŸå› **: ç¼ºå°‘ Rust ç¼–è¯‘å™¨
- **ä¿®å¤**: è‡ªåŠ¨æ£€æµ‹å’Œå®‰è£… Rustï¼Œé¢„å®‰è£…é¢„ç¼–è¯‘åŒ…
- **å›é€€**: å¦‚æœé¢„ç¼–è¯‘å¤±è´¥ï¼Œè‡ªåŠ¨è®¾ç½® Rust ç¯å¢ƒå¹¶æºç ç¼–è¯‘

### 2. xformers PEP517 å¼ƒç”¨è­¦å‘Š
- **åŸå› **: ä½¿ç”¨äº†å³å°†è¢«å¼ƒç”¨çš„ `setup.py` æ„å»ºæ–¹å¼
- **ä¿®å¤**: è®¾ç½® `PIP_USE_PEP517=1`ï¼Œä½¿ç”¨ `--use-pep517` é€‰é¡¹
- **å¥½å¤„**: ç¬¦åˆæœ€æ–°çš„ Python åŒ…æ„å»ºæ ‡å‡†

### 3. ä¾èµ–è§£æå›æº¯
- **åŸå› **: ç‰ˆæœ¬çº¦æŸå†²çªå¯¼è‡´çš„é•¿æ—¶é—´ä¾èµ–è§£æ
- **ä¿®å¤**: ä½¿ç”¨å¤šå±‚çº¦æŸæ–‡ä»¶ï¼Œä¼˜å…ˆäºŒè¿›åˆ¶åŒ…
- **ä¼˜åŒ–**: é¢„å®‰è£…æ ¸å¿ƒåŒ…ï¼Œåˆ†é˜¶æ®µä¾èµ–è§£æ

## ğŸ“Š ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ä½¿ç”¨
```bash
# æ–¹å¼1: ä½¿ç”¨ Makefile
make all                    # æ„å»º + å®‰è£…
make build                  # ä»…æ„å»º
make install               # ä»…å®‰è£…

# æ–¹å¼2: ç›´æ¥è¿è¡Œè„šæœ¬
./build_and_install.sh     # æ„å»º + å®‰è£…
./scripts/build_all_wheels.sh    # ä»…æ„å»º
./scripts/install_wheels.sh      # ä»…å®‰è£…

# æ–¹å¼3: é«˜çº§é€‰é¡¹
./build_and_install.sh --build-only     # ä»…æ„å»º
./build_and_install.sh --install-only   # ä»…å®‰è£…
./build_and_install.sh --skip-build     # è·³è¿‡æ„å»º
```

### éªŒè¯å®‰è£…
```bash
python -c "import sage; print('âœ… SAGE:', sage.__version__)"
python -c "import outlines; print('âœ… outlines:', outlines.__version__)"
python -c "import xformers; print('âœ… xformers:', xformers.__version__)"
```

## ğŸ‰ ä¼˜åŠ¿

1. **æ— ç¼é›†æˆ**: ä¿®å¤ç›´æ¥é›†æˆåˆ°ç°æœ‰è„šæœ¬ï¼Œæ— éœ€è®°å¿†é¢å¤–å‘½ä»¤
2. **æ™ºèƒ½å›é€€**: é¢„ç¼–è¯‘å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æºç ç¼–è¯‘
3. **ç¯å¢ƒè‡ªé€‚åº”**: è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®æ‰€éœ€çš„æ„å»ºç¯å¢ƒ
4. **å¤šå±‚ä¿æŠ¤**: å¤šç§çº¦æŸæ–‡ä»¶ç¡®ä¿ä¾èµ–å…¼å®¹æ€§
5. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„è¿›åº¦æç¤ºå’Œé”™è¯¯å¤„ç†
6. **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰è„šæœ¬çš„æ‰€æœ‰åŠŸèƒ½

## ğŸ“ æ–‡ä»¶ç»“æ„

```
SAGE/
â”œâ”€â”€ build_and_install.sh           # æ–°å¢ï¼šç»Ÿä¸€æ„å»ºå®‰è£…è„šæœ¬
â”œâ”€â”€ constraints-build.txt          # æ–°å¢ï¼šæ„å»ºçº¦æŸæ–‡ä»¶
â”œâ”€â”€ Makefile                       # æ›´æ–°ï¼šé›†æˆä¿®å¤çš„ç›®æ ‡
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build_all_wheels.sh       # æ›´æ–°ï¼šé›†æˆæ„å»ºä¿®å¤
â”‚   â”œâ”€â”€ install_wheels.sh         # æ›´æ–°ï¼šé›†æˆå®‰è£…ä¿®å¤
â”‚   â”œâ”€â”€ fix_build_issues.sh       # ä¿ç•™ï¼šç‹¬ç«‹ä¿®å¤è„šæœ¬
â”‚   â””â”€â”€ quick_fix_build.sh        # ä¿ç•™ï¼šå¿«é€Ÿä¿®å¤è„šæœ¬
â”œâ”€â”€ requirements-lock.txt          # æ›´æ–°ï¼šåŒ…å«ä¿®å¤çš„ä¾èµ–
â””â”€â”€ docs/troubleshooting/
    â””â”€â”€ build_issues_fix.md       # è¯¦ç»†æ–‡æ¡£
```

## ğŸš€ ä¸‹ä¸€æ­¥

æ‰€æœ‰ä¿®å¤å·²ç»é›†æˆå®Œæˆï¼Œæ‚¨ç°åœ¨å¯ä»¥ï¼š

1. **ä½¿ç”¨ä¿®å¤åçš„è„šæœ¬**ï¼š
   ```bash
   make all  # æˆ– ./build_and_install.sh
   ```

2. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼šè§‚å¯Ÿæ˜¯å¦è¿˜æœ‰ `outlines_core` å’Œ `xformers` çš„æ„å»ºé—®é¢˜

3. **æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶**ï¼šç‹¬ç«‹çš„ä¿®å¤è„šæœ¬å¯ä»¥ä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼Œæˆ–è€…åˆ é™¤ä»¥ç®€åŒ–é¡¹ç›®ç»“æ„

ä¿®å¤å·²ç»å®Œå…¨é›†æˆï¼Œæ‚¨çš„æ„å»ºå’Œå®‰è£…æµç¨‹ç°åœ¨æ›´åŠ ç¨³å®šå’Œç”¨æˆ·å‹å¥½ï¼
