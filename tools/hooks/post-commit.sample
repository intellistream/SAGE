#!/bin/bash
# SAGE Post-Commit Hook - Auto-publish to PyPI
#
# å®‰è£…æ–¹æ³•:
#   cp tools/hooks/post-commit.sample .git/hooks/post-commit
#   chmod +x .git/hooks/post-commit
#
# é…ç½®:
#   ç¼–è¾‘ä¸‹é¢çš„å˜é‡ä»¥é€‚é…ä½ çš„ç¯å¢ƒ

set -e

# ==================== é…ç½®åŒºåŸŸ ====================

# sage-pypi-publisher ä»“åº“è·¯å¾„
PUBLISHER_PATH="${HOME}/sage-pypi-publisher"

# æ˜¯å¦å¯ç”¨è‡ªåŠ¨å‘å¸ƒ (true/false)
AUTO_PUBLISH_ENABLED=false

# ä»…åœ¨ç‰¹å®šåˆ†æ”¯è‡ªåŠ¨å‘å¸ƒ (ç•™ç©ºè¡¨ç¤ºæ‰€æœ‰åˆ†æ”¯)
AUTO_PUBLISH_BRANCH="main"

# äº¤äº’å¼ç¡®è®¤ (true/false) - è®¾ä¸º false è¡¨ç¤ºè‡ªåŠ¨å‘å¸ƒæ— éœ€ç¡®è®¤
REQUIRE_CONFIRMATION=true

# å‘å¸ƒæ¨¡å¼: "patch" (0.0.1), "minor" (0.1.0), "major" (1.0.0)
VERSION_BUMP_TYPE="patch"

# æ˜¯å¦å…ˆå‘å¸ƒåˆ° TestPyPI (true/false)
TEST_PYPI_FIRST=false

# ==================== è„šæœ¬å¼€å§‹ ====================

# è·å–å½“å‰åˆ†æ”¯
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨å‘å¸ƒ
if [ "$AUTO_PUBLISH_ENABLED" != "true" ]; then
    echo "â„¹ï¸  Auto-publish is disabled. Set AUTO_PUBLISH_ENABLED=true to enable."
    exit 0
fi

# æ£€æŸ¥åˆ†æ”¯é™åˆ¶
if [ -n "$AUTO_PUBLISH_BRANCH" ] && [ "$current_branch" != "$AUTO_PUBLISH_BRANCH" ]; then
    echo "â„¹ï¸  Auto-publish only enabled for branch '$AUTO_PUBLISH_BRANCH', current branch is '$current_branch'"
    exit 0
fi

# æ£€æŸ¥ publisher æ˜¯å¦å­˜åœ¨
if [ ! -d "$PUBLISHER_PATH" ]; then
    echo "âš ï¸  sage-pypi-publisher not found at $PUBLISHER_PATH"
    echo "   Clone it: git clone https://github.com/intellistream/sage-pypi-publisher.git ~/sage-pypi-publisher"
    exit 0
fi

# æ£€æŸ¥ publisher ä¸­çš„ publish.sh æ˜¯å¦å­˜åœ¨
if [ ! -x "$PUBLISHER_PATH/publish.sh" ]; then
    echo "âŒ publish.sh not found or not executable at $PUBLISHER_PATH/publish.sh"
    exit 1
fi

echo ""
echo "======================================================"
echo "  ğŸ“¦ SAGE PyPI Auto-Publisher"
echo "======================================================"
echo ""

# æ£€æµ‹ä¿®æ”¹çš„åŒ…
affected_packages=$(git diff HEAD~1 HEAD --name-only 2>/dev/null | \
    grep '^packages/' | \
    cut -d'/' -f2 | \
    sort -u)

if [ -z "$affected_packages" ]; then
    echo "âœ… No packages affected by this commit"
    exit 0
fi

echo "ğŸ“¦ Affected packages:"
for pkg in $affected_packages; do
    echo "   - $pkg"
done
echo ""

# äº¤äº’å¼ç¡®è®¤
if [ "$REQUIRE_CONFIRMATION" = "true" ]; then
    echo "ğŸ¤” Do you want to publish these packages to PyPI?"
    echo "   Version bump: $VERSION_BUMP_TYPE"
    if [ "$TEST_PYPI_FIRST" = "true" ]; then
        echo "   Mode: TestPyPI first, then PyPI"
    else
        echo "   Mode: Direct to PyPI"
    fi
    echo ""
    read -p "Continue? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Publishing cancelled"
        exit 0
    fi
fi

echo ""
echo "ğŸš€ Publishing packages..."
echo ""

# åˆ‡æ¢åˆ° publisher ç›®å½•
cd "$PUBLISHER_PATH"

# å‘å¸ƒæ¯ä¸ªåŒ…
for pkg in $affected_packages; do
    echo ""
    echo "======================================================"
    echo "  Publishing: $pkg"
    echo "======================================================"
    echo ""

    # å¦‚æœå¯ç”¨äº† TestPyPI first
    if [ "$TEST_PYPI_FIRST" = "true" ]; then
        echo "ğŸ§ª Testing on TestPyPI first..."
        if ./publish.sh "$pkg" --auto-bump "$VERSION_BUMP_TYPE" --test-pypi --no-dry-run; then
            echo "âœ… TestPyPI publish successful"
            echo ""
            read -p "Proceed to publish to production PyPI? [y/N] " -n 1 -r
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "âš ï¸  Skipping production PyPI for $pkg"
                continue
            fi
        else
            echo "âŒ TestPyPI publish failed for $pkg, skipping production"
            continue
        fi
    fi

    # å‘å¸ƒåˆ° PyPI
    echo "ğŸ“¤ Publishing to PyPI..."
    if ./publish.sh "$pkg" --auto-bump "$VERSION_BUMP_TYPE" --no-dry-run; then
        echo "âœ… Successfully published $pkg"
    else
        echo "âŒ Failed to publish $pkg"
    fi
    echo ""
done

echo ""
echo "======================================================"
echo "  âœ… Auto-publish complete!"
echo "======================================================"
echo ""
