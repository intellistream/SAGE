#!/bin/bash
# è‡ªåŠ¨æäº¤æ‰€æœ‰å­æ¨¡å—çš„ SUBMODULE.md æ–‡ä»¶

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "ğŸš€ è‡ªåŠ¨æäº¤å­æ¨¡å—æ ‡è®°æ–‡ä»¶..."
echo ""

cd "$REPO_ROOT"

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
    echo "âš ï¸  è­¦å‘Š: ä¸»ä»“åº“æœ‰æœªæäº¤çš„æ›´æ”¹"
    echo "å»ºè®®å…ˆæäº¤æˆ–æš‚å­˜è¿™äº›æ›´æ”¹"
    echo ""
    read -p "ç»§ç»­å—? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ç»Ÿè®¡
total=0
committed=0
no_changes=0

# éå†æ‰€æœ‰å­æ¨¡å— (ä½¿ç”¨è¿›ç¨‹æ›¿æ¢é¿å…å­shellé—®é¢˜)
while IFS= read -r submodule_path; do
    # ç¡®ä¿å›åˆ°ä¸»ä»“åº“æ ¹ç›®å½•
    cd "$REPO_ROOT"

    if [ ! -d "$submodule_path" ]; then
        echo "âš ï¸  è·³è¿‡: $submodule_path (ä¸å­˜åœ¨)"
        continue
    fi

    total=$((total + 1))

    echo "ğŸ“‚ å¤„ç†å­æ¨¡å—: $submodule_path"

    # è¿›å…¥å­æ¨¡å—
    cd "$REPO_ROOT/$submodule_path"

    # æ£€æŸ¥æ˜¯å¦æœ‰ SUBMODULE.md
    if [ ! -f "SUBMODULE.md" ]; then
        echo "   âš ï¸  æœªæ‰¾åˆ° SUBMODULE.mdï¼Œè·³è¿‡"
        continue
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
    if [ -z "$(git status --porcelain SUBMODULE.md)" ]; then
        echo "   â„¹ï¸  æ— æ›´æ”¹"
        no_changes=$((no_changes + 1))
        continue
    fi

    # è·å–å½“å‰åˆ†æ”¯
    branch=$(git config --file "$REPO_ROOT/.gitmodules" --get "submodule.$submodule_path.branch" || echo "main-dev")

    # ç¡®ä¿åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Š
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    if [ "$current_branch" != "$branch" ]; then
        echo "   âš ï¸  å½“å‰åˆ†æ”¯: $current_branch, æœŸæœ›: $branch"
        echo "   åˆ‡æ¢åˆ° $branch..."
        git checkout "$branch" || {
            echo "   âŒ æ— æ³•åˆ‡æ¢åˆ†æ”¯ï¼Œè·³è¿‡"
            continue
        }
    fi

    # æäº¤
    git add SUBMODULE.md
    git commit -m "docs: add submodule marker file

This file helps identify this directory as a Git submodule and provides
quick reference for common submodule operations.

Auto-generated by tools/git-tools/generate-submodule-markers.sh" || {
        echo "   âš ï¸  æäº¤å¤±è´¥ï¼ˆå¯èƒ½å·²ç»æäº¤è¿‡ï¼‰"
        continue
    }

    echo "   âœ… å·²æäº¤åˆ°æœ¬åœ°"

    # æ¨é€åˆ°è¿œç¨‹
    if git push origin "$branch" 2>&1; then
        echo "   âœ… å·²æ¨é€åˆ°è¿œç¨‹"
        committed=$((committed + 1))
    else
        echo "   âš ï¸  æ¨é€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ¨é€"
    fi

    echo ""
done < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')

# å›åˆ°ä¸»ä»“åº“
cd "$REPO_ROOT"

echo "=========================================="
echo "ğŸ“Š æäº¤æ‘˜è¦"
echo "=========================================="
echo "å¤„ç†çš„å­æ¨¡å—:   $total"
echo "å·²æäº¤:         $committed"
echo "æ— æ›´æ”¹:         $no_changes"
echo "=========================================="
echo ""

if [ $committed -gt 0 ]; then
    echo "ğŸ”„ æ›´æ–°ä¸»ä»“åº“çš„å­æ¨¡å—å¼•ç”¨..."
    echo ""

    # æ˜¾ç¤ºæœ‰æ›´æ”¹çš„å­æ¨¡å—
    changed_submodules=$(git status --porcelain | grep "^ M " | grep -o "packages/[^ ]*" || true)

    if [ -n "$changed_submodules" ]; then
        echo "ğŸ“ ä»¥ä¸‹å­æ¨¡å—æœ‰æ›´æ–°:"
        echo "$changed_submodules"
        echo ""

        read -p "æäº¤è¿™äº›å­æ¨¡å—å¼•ç”¨æ›´æ–°? (Y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            # æ·»åŠ æ‰€æœ‰å­æ¨¡å—æ›´æ”¹
            git add $(echo "$changed_submodules")

            # æäº¤
            git commit -m "chore: update submodule references with marker files

Updated submodules:
$changed_submodules

These submodules now include SUBMODULE.md marker files for better
discoverability and developer guidance."

            echo "âœ… å·²æäº¤ä¸»ä»“åº“æ›´æ”¹"
            echo ""
            echo "ğŸ’¡ æç¤º: ä¸è¦å¿˜è®°æ¨é€ä¸»ä»“åº“:"
            echo "   git push origin main-dev"
        fi
    else
        echo "â„¹ï¸  ä¸»ä»“åº“æ— éœ€æ›´æ–°"
    fi
else
    echo "â„¹ï¸  æ²¡æœ‰å­æ¨¡å—è¢«æäº¤"
fi

echo ""
echo "âœ… å®Œæˆï¼"
