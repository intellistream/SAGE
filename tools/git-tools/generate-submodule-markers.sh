#!/bin/bash
# è‡ªåŠ¨ä¸ºæ‰€æœ‰ Git å­æ¨¡å—ç”Ÿæˆ SUBMODULE.md æ ‡è®°æ–‡ä»¶

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# è§£æå‚æ•°
QUIET_MODE=false
if [[ "$1" == "--quiet" ]]; then
    QUIET_MODE=true
fi

if [[ ! $QUIET_MODE == true ]]; then
    echo "ğŸ” æ‰«æ Git å­æ¨¡å—..."
fi

cd "$REPO_ROOT"

# æ£€æŸ¥æ˜¯å¦åœ¨ git ä»“åº“ä¸­
if [ ! -f .gitmodules ]; then
    if [[ ! $QUIET_MODE == true ]]; then
        echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° .gitmodules æ–‡ä»¶"
    fi
    exit 1
fi

# ç»Ÿè®¡
total=0
created=0
updated=0
skipped=0

# éå†æ‰€æœ‰å­æ¨¡å—
while IFS= read -r line; do
    if [[ $line =~ ^\[submodule\ \"(.+)\"\]$ ]]; then
        submodule_name="${BASH_REMATCH[1]}"
    elif [[ $line =~ ^[[:space:]]*path[[:space:]]*=[[:space:]]*(.+)$ ]]; then
        path="${BASH_REMATCH[1]}"
    elif [[ $line =~ ^[[:space:]]*url[[:space:]]*=[[:space:]]*(.+)$ ]]; then
        url="${BASH_REMATCH[1]}"
    elif [[ $line =~ ^[[:space:]]*branch[[:space:]]*=[[:space:]]*(.+)$ ]]; then
        branch="${BASH_REMATCH[1]}"

        # ç°åœ¨æˆ‘ä»¬æœ‰äº†å®Œæ•´çš„ä¿¡æ¯ï¼Œç”Ÿæˆæ ‡è®°æ–‡ä»¶
        if [ -d "$path" ]; then
            total=$((total + 1))
            marker_file="$path/SUBMODULE.md"

            # æå–ä»“åº“åç§°
            repo_name=$(basename "$url" .git)

            # è®¡ç®—ç›¸å¯¹è·¯å¾„å›åˆ°ä¸»ä»“åº“
            depth=$(echo "$path" | tr -cd '/' | wc -c)
            back_path=$(printf '../%.0s' $(seq 1 $depth))

            if [[ ! $QUIET_MODE == true ]]; then
                echo ""
                echo "ğŸ“ å¤„ç†å­æ¨¡å—: $submodule_name"
                echo "   è·¯å¾„: $path"
                echo "   ä»“åº“: $repo_name"
                echo "   åˆ†æ”¯: ${branch:-main}"
            fi

            # ç”Ÿæˆæ ‡è®°æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
            temp_file="${marker_file}.tmp"
            cat > "$temp_file" << EOF
# Git Submodule: $repo_name

âš ï¸ **This directory is a Git submodule** - it's a separate repository!

## Repository Information

- **Name:** $submodule_name
- **Repository:** $url
- **Branch:** ${branch:-main}
- **Path:** \`$path\`

## Quick Guide for Committing Changes

### 1ï¸âƒ£ Commit in This Submodule

\`\`\`bash
# Navigate to this directory (if not already here)
cd $path

# Make your changes, then:
git add .
git commit -m "feat: your change description"
git push origin ${branch:-main}
\`\`\`

### 2ï¸âƒ£ Update Reference in Main Repository

\`\`\`bash
# Navigate back to main repository root
cd ${back_path}

# Add the submodule reference update
git add $path
git commit -m "chore: update $repo_name submodule reference"
git push origin main-dev
\`\`\`

## Updating This Submodule

To pull latest changes from the submodule repository:

\`\`\`bash
# In this directory
cd $path
git pull origin ${branch:-main}

# Update reference in main repo
cd ${back_path}
git add $path
git commit -m "chore: update $repo_name to latest"
\`\`\`

## Common Issues

### âŒ "fatal: Pathspec ... is in submodule"

**Problem:** You're in the main repository trying to commit submodule files.

**Solution:**
\`\`\`bash
cd $path  # Enter the submodule first
git add .
git commit -m "your message"
\`\`\`

### âŒ Changes not showing in main repository

**Problem:** You committed in the submodule but forgot to update the reference.

**Solution:**
\`\`\`bash
cd ${back_path}  # Back to main repo
git add $path
git commit -m "chore: update $repo_name reference"
\`\`\`

### âŒ "You are not currently on a branch"

**Problem:** Submodule is in detached HEAD state.

**Solution:**
\`\`\`bash
cd $path
git checkout ${branch:-main}
git pull origin ${branch:-main}
\`\`\`

## Development Workflow

1. **Always work on the correct branch:** \`${branch:-main}\`
2. **Commit in submodule first**, then update reference in main repo
3. **Push both repositories** to share your changes
4. **Pull both repositories** when updating

---

ğŸ“š For more details, see [CONTRIBUTING.md](${back_path}CONTRIBUTING.md#working-with-submodules)

ğŸ¤– This file is auto-generated by \`tools/git-tools/generate-submodule-markers.sh\`
EOF

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å†…å®¹ç›¸åŒ
            if [ -f "$marker_file" ]; then
                if cmp -s "$marker_file" "$temp_file"; then
                    # æ–‡ä»¶å­˜åœ¨ä¸”å†…å®¹ç›¸åŒï¼Œè·³è¿‡
                    rm "$temp_file"
                    skipped=$((skipped + 1))
                    if [[ ! $QUIET_MODE == true ]]; then
                        echo "   â„¹ï¸  è·³è¿‡: å†…å®¹æœªå˜åŒ–"
                    fi
                else
                    # æ–‡ä»¶å­˜åœ¨ä½†å†…å®¹ä¸åŒï¼Œæ›´æ–°
                    mv "$temp_file" "$marker_file"
                    updated=$((updated + 1))
                    if [[ ! $QUIET_MODE == true ]]; then
                        echo "   âœ… æ›´æ–°: $marker_file"
                    fi
                fi
            else
                # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»º
                mv "$temp_file" "$marker_file"
                created=$((created + 1))
                if [[ ! $QUIET_MODE == true ]]; then
                    echo "   âœ… åˆ›å»º: $marker_file"
                fi
            fi
        else
            skipped=$((skipped + 1))
            if [[ ! $QUIET_MODE == true ]]; then
                echo "   âš ï¸  è·³è¿‡: $path (ç›®å½•ä¸å­˜åœ¨)"
            fi
        fi

        # é‡ç½®å˜é‡
        submodule_name=""
        path=""
        url=""
        branch=""
    fi
done < .gitmodules

# è¾“å‡ºå¤„ç†ç»“æœæ‘˜è¦ï¼ˆquietæ¨¡å¼ä¸‹åªè¾“å‡ºç»Ÿè®¡æ•°å­—ä¾›è„šæœ¬ä½¿ç”¨ï¼‰
if [[ $QUIET_MODE == true ]]; then
    echo "total=$total created=$created updated=$updated skipped=$skipped"
else
    # æ‘˜è¦
    echo ""
    echo "=========================================="
    echo "ğŸ“Š å¤„ç†æ‘˜è¦"
    echo "=========================================="
    echo "æ€»å­æ¨¡å—æ•°:   $total"
    echo "æ–°åˆ›å»º:       $created"
    echo "å·²æ›´æ–°:       $updated"
    echo "å·²è·³è¿‡:       $skipped"
    echo "=========================================="
    echo ""

    if [ $created -gt 0 ] || [ $updated -gt 0 ]; then
        echo "âœ… æˆåŠŸç”Ÿæˆå­æ¨¡å—æ ‡è®°æ–‡ä»¶ï¼"
        echo ""
        echo "ğŸ“ ä¸‹ä¸€æ­¥:"
        echo "   1. æ£€æŸ¥ç”Ÿæˆçš„ SUBMODULE.md æ–‡ä»¶"
        echo "   2. åœ¨å„å­æ¨¡å—ä¸­æäº¤è¿™äº›æ–‡ä»¶:"
        echo "      cd <submodule-path>"
        echo "      git add SUBMODULE.md"
        echo "      git commit -m 'docs: add submodule marker file'"
        echo "      git push origin ${branch:-main-dev}"
        echo ""
        echo "   3. åœ¨ä¸»ä»“åº“ä¸­æ›´æ–°å­æ¨¡å—å¼•ç”¨:"
        echo "      git add <submodule-path>"
        echo "      git commit -m 'chore: update submodule with marker file'"
        echo ""
        echo "ğŸ’¡ æç¤º: ä½¿ç”¨ tools/git-tools/commit-all-submodule-markers.sh è‡ªåŠ¨æäº¤"
    else
        echo "â„¹ï¸  æ‰€æœ‰å­æ¨¡å—æ ‡è®°æ–‡ä»¶éƒ½å·²æ˜¯æœ€æ–°"
    fi
fi
