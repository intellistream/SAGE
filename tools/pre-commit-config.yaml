# Pre-commit hooks configuration for SAGE project
# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks
#
# Usage:
#   - Install pre-commit: pip install pre-commit
#   - Install hooks: pre-commit install --config tools/pre-commit-config.yaml
#   - Run manually: pre-commit run --all-files --config tools/pre-commit-config.yaml
#
# Mypy Type Checking:
#   - Mypy runs automatically on changed Python files
#   - Shows type errors as warnings (doesn't block commits/CI)
#   - To run mypy explicitly: pre-commit run mypy --all-files --config tools/pre-commit-config.yaml

default_language_version:
  python: python3.11

repos:
  # General file checks
- repo: https://github.com/pre-commit/pre-commit-hooks
  rev: v6.0.0
  hooks:
  - id: trailing-whitespace
    args: [--markdown-linebreak-ext=md]
  - id: end-of-file-fixer
    exclude: '\.svg$'
  - id: check-yaml
    args: [--unsafe]      # Allow custom YAML tags
  - id: check-json
  - id: check-toml
  - id: check-added-large-files
    args: ['--maxkb=1000']
  - id: check-merge-conflict
  - id: check-case-conflict
    exclude: ^(.*/benchmark_(libamm)/|.*/(libamm|sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)
  - id: mixed-line-ending
    args: [--fix=lf]
  - id: detect-private-key

  # Python: Black formatter (DISABLED - using ruff format instead)
  # Black and ruff format can conflict in edge cases, causing infinite reformatting
  # Ruff format is now mature enough to replace Black completely
# - repo: https://github.com/psf/black
#   rev: 25.9.0
#   hooks:
#   - id: black
#     language_version: python3.11
#     args: [--line-length=100]
#     exclude: ^(docs/|docs-public/|examples/data/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)

  # Python: isort import sorting
# - repo: https://github.com/pycqa/isort
#   rev: 7.0.0
#   hooks:
#   - id: isort
#     args: [--profile=black, --line-length=100]
#     exclude: ^(docs/|docs-public/|examples/data/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)
#
  # Python: Ruff linter and formatter (replaces flake8, isort, pyupgrade)
- repo: https://github.com/astral-sh/ruff-pre-commit
  rev: v0.14.2
  hooks:
  - id: ruff
    name: ruff check
    args: [--fix, --exit-non-zero-on-fix]
    exclude: ^(docs/|docs-public/|examples/data/|tests/fixtures/|.*/benchmark_(libamm)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/build/)
  - id: ruff-format
    name: ruff format
    exclude: ^(docs/|docs-public/|examples/data/|tests/fixtures/|.*/benchmark_(libamm)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/build/)

# Python: mypy type checking (warning mode - shows errors but doesn't block commit)
- repo: local
  hooks:
  - id: mypy
    name: mypy type checking (warnings only)
    entry: tools/mypy-wrapper.sh
    language: system
    types: [python]
    require_serial: true
    args:
    - --cache-dir=.sage/cache/mypy
    - --ignore-missing-imports
    - --show-error-codes
    - --explicit-package-bases
    - --warn-unused-ignores
    - --namespace-packages
    exclude: ^(docs/|docs-public/|examples/|tests/|.*/tests/|setup.py|.*/setup.py|.*/benchmark_(libamm)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/src/sage/__init__.py)
    # This hook will always succeed (exit 0) to avoid blocking commits/CI
    # Errors are shown but treated as warnings
  - id: markdown-files-location-check
    name: check markdown files are in proper locations
    entry: bash -c
    args:
    - |
      # Get all markdown files (staged if in commit, or all files if --all-files)
      if [ -n "$PRE_COMMIT_FROM_REF" ] && [ -n "$PRE_COMMIT_TO_REF" ]; then
        # Running with --all-files or during push
        all_md_files=$(git ls-files "*.md")
      else
        # Running in normal commit mode
        all_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep "\.md$" || true)
      fi

      if [ -z "$all_md_files" ]; then
        exit 0
      fi

      # Define allowed patterns (whitelist)
      allowed_patterns=(
        "^README\.md$"
        "^CHANGELOG\.md$"
        "^CONTRIBUTING\.md$"
        "^LICENSE\.md$"
        "^DEVELOPER\.md$"
        "^docs/dev-notes/"
        "^docs/assets/"
        "^docs/security/"
        "^docs-public/"
        "^packages/.*/README\.md$"
        "^packages/.*README.*\.md$"  # Allow README variants like README_LIBAMM.md
        "^packages/.*/CHANGELOG\.md$"
        "^packages/.*/(docs|documentation)/"
        "^packages/.*\.md$"  # Allow any .md in packages root (installation guides, etc.)
        "^examples/README\.md$"  # Allow top-level examples README
        "^examples/.*/README\.md$"
        "^examples/tutorials/"
        "^tools/.*/README\.md$"
        "^tools/.*\.md$"  # Allow any .md in tools (installation guides, etc.)
        "^\.sage/.*\.md$"
        "^\.github/.*\.md$"  # Allow any .md in .github directory
      )

      # Check each file
      violations=""
      for file in $all_md_files; do
        allowed=false
        for pattern in "${allowed_patterns[@]}"; do
          if echo "$file" | grep -qE "$pattern"; then
            allowed=true
            break
          fi
        done

        if [ "$allowed" = false ]; then
          violations="$violations$file\n"
        fi
      done

      # Report violations
      if [ -n "$violations" ]; then
        echo "âŒ é”™è¯¯: ä»¥ä¸‹ markdown æ–‡ä»¶ä¸åœ¨å…è®¸çš„ä½ç½®:"
        echo -e "$violations" | sed "s/^/  - /"
        echo ""
        echo "ï¿½ å…è®¸çš„ä½ç½®:"
        echo "  - é¡¹ç›®æ ¹ç›®å½•: README.md, CHANGELOG.md, CONTRIBUTING.md, LICENSE.md, DEVELOPER.md"
        echo "  - å¼€å‘ç¬”è®°: docs/dev-notes/"
        echo "  - ç”¨æˆ·æ–‡æ¡£: docs-public/"
        echo "  - åŒ…æ–‡æ¡£: packages/<package-name>/README.md, packages/<package-name>/CHANGELOG.md"
        echo "  - åŒ…æ–‡æ¡£ç›®å½•: packages/<package-name>/docs/, packages/<package-name>/documentation/"
        echo "  - ç¤ºä¾‹æ–‡æ¡£: examples/<example-name>/README.md, examples/tutorials/"
        echo "  - GitHub æ¨¡æ¿: .github/ISSUE_TEMPLATE/, .github/PULL_REQUEST_TEMPLATE/"
        echo ""
        echo "ğŸ’¡ å»ºè®®: è¯·å°†æ–‡æ¡£ç§»åŠ¨åˆ°åˆé€‚çš„ä½ç½®æˆ–æ›´æ–°å…è®¸åˆ—è¡¨"
        exit 1
      else
        exit 0
      fi
    language: system
    pass_filenames: false
    always_run: false
    files: \.md$
  - id: python-test-files-location-check
    name: check Python test files are in proper locations
    entry: bash -c
    args:
    - |
      # Get all Python test files (staged if in commit, or all files if --all-files)
      if [ -n "$PRE_COMMIT_FROM_REF" ] && [ -n "$PRE_COMMIT_TO_REF" ]; then
        # Running with --all-files or during push
        all_test_files=$(git ls-files "*.py" | grep -E "(^|/)test_.*\.py$|_test\.py$|tests\.py$" || true)
      else
        # Running in normal commit mode
        all_test_files=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$" | grep -E "(^|/)test_.*\.py$|_test\.py$|tests\.py$" || true)
      fi

      if [ -z "$all_test_files" ]; then
        exit 0
      fi

      # Define disallowed patterns (blacklist for test files)
      violations=""
      for file in $all_test_files; do
        # Test files should be in tests/ directories or test scripts in examples/
        if echo "$file" | grep -qE "^(packages/[^/]+/tests/|tests/|examples/.*/tests?\.py$|examples/.*test.*\.py$)"; then
          # Allowed location
          continue
        else
          # Disallowed location
          violations="$violations$file\n"
        fi
      done

      # Report violations
      if [ -n "$violations" ]; then
        echo "âŒ é”™è¯¯: ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶ä¸åœ¨æ­£ç¡®çš„ä½ç½®:"
        echo -e "$violations" | sed "s/^/  - /"
        echo ""
        echo "ğŸ“ æµ‹è¯•æ–‡ä»¶åº”è¯¥æ”¾åœ¨:"
        echo "  - packages/<package-name>/tests/ - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•"
        echo "  - packages/<package-name>/tests/unit/ - å•å…ƒæµ‹è¯•"
        echo "  - packages/<package-name>/tests/integration/ - é›†æˆæµ‹è¯•"
        echo "  - packages/<package-name>/tests/manual/ - æ‰‹åŠ¨æµ‹è¯•è„šæœ¬"
        echo "  - examples/ - ç¤ºä¾‹å’Œæ¼”ç¤ºè„šæœ¬ï¼ˆå¯ä»¥åŒ…å« test åç§°ï¼‰"
        echo ""
        echo "ğŸ’¡ å»ºè®®: è¯·å°†æµ‹è¯•æ–‡ä»¶ç§»åŠ¨åˆ°å¯¹åº”åŒ…çš„ tests/ ç›®å½•"
        exit 1
      else
        exit 0
      fi
    language: system
    pass_filenames: false
    always_run: false
    files: \.py$
  - id: devnotes-check
    name: dev-notes documentation standards
    entry: bash -c 'if git diff --cached --name-only --diff-filter=ACM | grep -q "^docs/dev-notes/.*\.md$"; then sage-dev quality devnotes || true; else exit 0; fi'
    language: system
    pass_filenames: false
    always_run: false
    files: ^docs/dev-notes/.*\.md$
  - id: installation-consistency-check
    name: installation consistency check (local vs CI/CD)
    entry: bash tools/install/examination_tools/installation_consistency_check.sh
    language: system
    pass_filenames: false
    # ä»…åœ¨ä¿®æ”¹å®‰è£…ç›¸å…³æ–‡ä»¶æ—¶è¿è¡Œ
    files: ^(quickstart\.sh|tools/install/.*\.sh|packages/.*/pyproject\.toml|packages/.*/setup\.py|\.github/workflows/.*\.yml)$
    # ä¹Ÿåœ¨æ‰‹åŠ¨è¿è¡Œ pre-commit run --all-files æ—¶æ‰§è¡Œ
    stages: [commit, manual]
  # Shell: shellcheck
- repo: https://github.com/shellcheck-py/shellcheck-py
  rev: v0.11.0.1
  hooks:
  - id: shellcheck
    args: [-x, -e, SC1091, -S, error]      # -x: follow sources, -e SC1091: ignore source errors, -S error: only fail on errors
    files: \.(sh|bash)$
    exclude: ^(tools/conda/)

  # YAML formatting
- repo: https://github.com/macisamuele/language-formatters-pre-commit-hooks
  rev: v2.15.0
  hooks:
  - id: pretty-format-yaml
    args: [--autofix, --indent=2, --preserve-quotes]
    exclude: ^(\.github/|examples/config/)

  # Markdown formatting
- repo: https://github.com/executablebooks/mdformat
  rev: 1.0.0
  hooks:
  - id: mdformat
    additional_dependencies:
    - mdformat-gfm        # GitHub Flavored Markdown
    # Note: mdformat-black is disabled because it fails on code blocks with:
    # - Template placeholders (e.g., {module_name})
    # - Special symbols in comments (e.g., âœ… âŒ)
    # - Pseudo-code or incomplete Python snippets
    # - mdformat-black        # Black formatter for code blocks
    args: [--wrap=100]
    exclude: ^(CHANGELOG.md|\.github/|docs/dev-notes/|docs-public/docs_src/api-reference/)

  # Security: Check for secrets
- repo: https://github.com/Yelp/detect-secrets
  rev: v1.5.0
  hooks:
  - id: detect-secrets
    args: [--baseline, tools/secrets.baseline]
    exclude: ^(\.env\.template|examples/config/.*\.yaml|tests/fixtures/|.*package-lock\.json$|.*\.ipynb$|docs/.*\.md$|docs-public/.*\.md$|examples/.*\.py$|packages/.*/src/sage/libs/integrations/.*\.py$|.*\.html$|packages/sage-benchmark/.*\.yaml$|packages/.*/src/.*\.md$)

  # SAGE Data Architecture Validation
- repo: local
  hooks:
  - id: validate-data-architecture
    name: Validate SAGE Data Architecture
    entry: python tools/hooks/validate_data_architecture.py
    language: system
    pass_filenames: false
    files: ^packages/sage-benchmark/src/sage/data/(sources|usages)/.*\.(yaml|py)$
    description: Validate that datasets follow the two-layer architecture

# To install pre-commit hooks:
#   pre-commit install
#
# To run manually:
#   pre-commit run --all-files
#
# To update hook versions:
#   pre-commit autoupdate
#
# To skip hooks temporarily:
#   git commit --no-verify
