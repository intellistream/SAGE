# Pre-commit hooks configuration for SAGE project
# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks
#
# Usage:
#   - Install pre-commit: pip install pre-commit
#   - Install hooks: pre-commit install --config tools/pre-commit-config.yaml
#   - Run manually: pre-commit run --all-files --config tools/pre-commit-config.yaml
#
# Mypy Type Checking:
#   - Mypy runs automatically on changed Python files
#   - Shows type errors as warnings (doesn't block commits/CI)
#   - To run mypy explicitly: pre-commit run mypy --all-files --config tools/pre-commit-config.yaml

default_language_version:
  python: python3.11

repos:
  # General file checks
- repo: https://github.com/pre-commit/pre-commit-hooks
  rev: v6.0.0
  hooks:
  - id: trailing-whitespace
    args: [--markdown-linebreak-ext=md]
  - id: end-of-file-fixer
    exclude: '\.svg$'
  - id: check-yaml
    args: [--unsafe]      # Allow custom YAML tags
    exclude: ^(.*/benchmark_db/)
  - id: check-json
  - id: check-toml
  - id: check-added-large-files
    args: ['--maxkb=1000']
  - id: check-merge-conflict
  - id: check-case-conflict
    exclude: ^(.*/benchmark_(libamm|db)/|.*/(libamm|sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)
  - id: mixed-line-ending
    args: [--fix=lf]
  - id: detect-private-key

  # Python: Black formatter (DISABLED - using ruff format instead)
  # Black and ruff format can conflict in edge cases, causing infinite reformatting
  # Ruff format is now mature enough to replace Black completely
# - repo: https://github.com/psf/black
#   rev: 25.9.0
#   hooks:
#   - id: black
#     language_version: python3.11
#     args: [--line-length=100]
#     exclude: ^(docs/|docs-public/|examples/data/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)

  # Python: isort import sorting
# - repo: https://github.com/pycqa/isort
#   rev: 7.0.0
#   hooks:
#   - id: isort
#     args: [--profile=black, --line-length=100]
#     exclude: ^(docs/|docs-public/|examples/data/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB)/|.*/vendors/|.*/build/)
#
  # Python: Ruff linter and formatter (replaces flake8, isort, pyupgrade)
- repo: https://github.com/astral-sh/ruff-pre-commit
  rev: v0.14.6
  hooks:
  - id: ruff
    name: ruff check
    args: [--fix, --exit-non-zero-on-fix, --config, tools/ruff.toml]
    exclude: ^(docs/|docs-public/|examples/data/|tests/fixtures/|.*/benchmark_(libamm|db)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/build/)
  - id: ruff-format
    name: ruff format
    args: [--config, tools/ruff.toml]
    exclude: ^(docs/|docs-public/|examples/data/|tests/fixtures/|.*/benchmark_(libamm|db)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/build/)

# Python: mypy type checking (warning mode - shows errors but doesn't block commit)
- repo: local
  hooks:
  - id: mypy
    name: mypy type checking (warnings only)
    entry: tools/mypy-wrapper.sh
    language: system
    types: [python]
    require_serial: true
    args:
    - --cache-dir=.sage/cache/mypy
    - --ignore-missing-imports
    - --show-error-codes
    - --explicit-package-bases
    - --warn-unused-ignores
    - --namespace-packages
    exclude: ^(docs/|docs-public/|examples/|tests/|.*/tests/|setup.py|.*/setup.py|.*/benchmark_(libamm|db)/|.*/(sageLLM|sageDB|sageFlow|neuromem|sageTSDB|libamm)/|.*/vendors/|.*/src/sage/__init__.py)
    # This hook will always succeed (exit 0) to avoid blocking commits/CI
    # Errors are shown but treated as warnings
  - id: markdown-files-location-check
    name: check markdown files are in proper locations
    entry: bash -c
    args:
    - |
      # Get all markdown files (staged if in commit, or all files if --all-files)
      if [ -n "$PRE_COMMIT_FROM_REF" ] && [ -n "$PRE_COMMIT_TO_REF" ]; then
        # Running with --all-files or during push
        all_md_files=$(git ls-files "*.md")
      else
        # Running in normal commit mode
        all_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep "\.md$" || true)
      fi

      if [ -z "$all_md_files" ]; then
        exit 0
      fi

      # Define allowed patterns (whitelist)
      allowed_patterns=(
        "^README\.md$"
        "^CHANGELOG\.md$"
        "^CONTRIBUTING\.md$"
        "^LICENSE\.md$"
        "^DEVELOPER\.md$"
        "^docs-public/docs_src/dev-notes/README\.md$"
        "^docs-public/docs_src/dev-notes/TEMPLATE\.md$"
        "^docs-public/docs_src/dev-notes/.+/"
        "^docs-public/docs_src/assets/"
        "^docs-public/docs_src/security/"
        "^docs-public/"
        "^docker/.*\.md$"  # Allow any .md in docker directory (deployment docs)
        "^packages/.*/README\.md$"
        "^packages/.*README.*\.md$"  # Allow README variants like README_LIBAMM.md
        "^packages/.*/CHANGELOG\.md$"
        "^packages/.*/(docs|documentation)/"
        "^packages/.*\.md$"  # Allow any .md in packages root (installation guides, etc.)
        "^examples/README\.md$"  # Allow top-level examples README
        "^examples/.*/README\.md$"
        "^examples/tutorials/"
        "^config/README\.md$"  # Allow config directory README
        "^tools/.*/README\.md$"
        "^tools/.*\.md$"  # Allow any .md in tools (installation guides, etc.)
        "^\.sage/.*\.md$"
        "^\.github/.*\.md$"  # Allow any .md in .github directory
      )

      # Check each file
      violations=""
      for file in $all_md_files; do
        allowed=false
        for pattern in "${allowed_patterns[@]}"; do
          if echo "$file" | grep -qE "$pattern"; then
            allowed=true
            break
          fi
        done

        if [ "$allowed" = false ]; then
          violations="$violations$file\n"
        fi
      done

      # Report violations
      if [ -n "$violations" ]; then
        echo "âŒ é”™è¯¯: ä»¥ä¸‹ markdown æ–‡ä»¶ä¸åœ¨å…è®¸çš„ä½ç½®:"
        echo -e "$violations" | sed "s/^/  - /"
        echo ""
        echo "ï¿½ å…è®¸çš„ä½ç½®:"
        echo "  - é¡¹ç›®æ ¹ç›®å½•: README.md, CHANGELOG.md, CONTRIBUTING.md, LICENSE.md, DEVELOPER.md"
        echo "  - å¼€å‘ç¬”è®°: docs/dev-notes/"
        echo "  - ç”¨æˆ·æ–‡æ¡£: docs-public/"
        echo "  - åŒ…æ–‡æ¡£: packages/<package-name>/README.md, packages/<package-name>/CHANGELOG.md"
        echo "  - åŒ…æ–‡æ¡£ç›®å½•: packages/<package-name>/docs/, packages/<package-name>/documentation/"
        echo "  - ç¤ºä¾‹æ–‡æ¡£: examples/<example-name>/README.md, examples/tutorials/"
        echo "  - GitHub æ¨¡æ¿: .github/ISSUE_TEMPLATE/, .github/PULL_REQUEST_TEMPLATE/"
        echo ""
        echo "ğŸ’¡ å»ºè®®: è¯·å°†æ–‡æ¡£ç§»åŠ¨åˆ°åˆé€‚çš„ä½ç½®æˆ–æ›´æ–°å…è®¸åˆ—è¡¨"
        exit 1
      else
        exit 0
      fi
    language: system
    pass_filenames: false
    always_run: false
    files: \.md$
  - id: python-test-files-location-check
    name: check Python test files are in proper locations
    entry: bash -c
    args:
    - |
      # Get all Python test files (staged if in commit, or all files if --all-files)
      if [ -n "$PRE_COMMIT_FROM_REF" ] && [ -n "$PRE_COMMIT_TO_REF" ]; then
        # Running with --all-files or during push
        all_test_files=$(git ls-files "*.py" | grep -E "(^|/)test_.*\.py$|_test\.py$|tests\.py$" || true)
      else
        # Running in normal commit mode
        all_test_files=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$" | grep -E "(^|/)test_.*\.py$|_test\.py$|tests\.py$" || true)
      fi

      if [ -z "$all_test_files" ]; then
        exit 0
      fi

      # Define disallowed patterns (blacklist for test files)
      violations=""
      for file in $all_test_files; do
        # Test files should be in tests/ directories or test scripts in examples/
        if echo "$file" | grep -qE "^(packages/[^/]+/tests/|tests/|examples/.*/tests?\.py$|examples/.*test.*\.py$)"; then
          # Allowed location
          continue
        else
          # Disallowed location
          violations="$violations$file\n"
        fi
      done

      # Report violations
      if [ -n "$violations" ]; then
        echo "âŒ é”™è¯¯: ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶ä¸åœ¨æ­£ç¡®çš„ä½ç½®:"
        echo -e "$violations" | sed "s/^/  - /"
        echo ""
        echo "ğŸ“ æµ‹è¯•æ–‡ä»¶åº”è¯¥æ”¾åœ¨:"
        echo "  - packages/<package-name>/tests/ - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•"
        echo "  - packages/<package-name>/tests/unit/ - å•å…ƒæµ‹è¯•"
        echo "  - packages/<package-name>/tests/integration/ - é›†æˆæµ‹è¯•"
        echo "  - packages/<package-name>/tests/manual/ - æ‰‹åŠ¨æµ‹è¯•è„šæœ¬"
        echo "  - examples/ - ç¤ºä¾‹å’Œæ¼”ç¤ºè„šæœ¬ï¼ˆå¯ä»¥åŒ…å« test åç§°ï¼‰"
        echo ""
        echo "ğŸ’¡ å»ºè®®: è¯·å°†æµ‹è¯•æ–‡ä»¶ç§»åŠ¨åˆ°å¯¹åº”åŒ…çš„ tests/ ç›®å½•"
        exit 1
      else
        exit 0
      fi
    language: system
    pass_filenames: false
    always_run: false
    files: \.py$
  - id: devnotes-check
    name: dev-notes documentation standards
    entry: bash -c 'if git diff --cached --name-only --diff-filter=ACM | grep -q "^docs-public/docs_src/dev-notes/.*\.md$"; then sage-dev quality devnotes || true; else exit 0; fi'
    language: system
    pass_filenames: false
    always_run: false
    files: ^docs-public/docs_src/dev-notes/.*\.md$
  - id: devnotes-structure-check
    name: dev-notes directory structure validation
    entry: bash -c
    args:
    - |
      # Check if any files were staged in docs-public/docs_src/dev-notes/
      if [ -n "$PRE_COMMIT_FROM_REF" ] && [ -n "$PRE_COMMIT_TO_REF" ]; then
        # Running with --all-files or during push
        staged_files=$(git ls-files "docs-public/docs_src/dev-notes/*")
      else
        # Running in normal commit mode
        staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep "^docs-public/docs_src/dev-notes/" || true)
      fi

      if [ -z "$staged_files" ]; then
        exit 0
      fi

      # Allowed top-level directories under docs-public/docs_src/dev-notes/
      # NOTE: When adding new directories, update this list
      allowed_dirs=(
        "l1-common"
        "l2-platform"
        "l3-kernel"
        "l3-libs"
        "l4-middleware"
        "l5-apps"
        "l5-benchmark"
        "l6-cli"
        "l6-gateway"
        "l6-studio"
        "l6-tools"
        "cross-layer"
        "testing"
        "archive"
        "research_work"
      )

      # Get all first-level directories under docs-public/docs_src/dev-notes/
      violations=""
      for file in $staged_files; do
        # Extract the first directory component after docs-public/docs_src/dev-notes/
        # e.g., docs-public/docs_src/dev-notes/foo/bar.md -> foo
        dir_component=$(echo "$file" | sed -n 's|^docs-public/docs_src/dev-notes/\([^/]*\)/.*|\1|p')

        # Skip root-level files (README.md, TEMPLATE.md)
        if [ -z "$dir_component" ]; then
          continue
        fi

        # Check if directory is allowed
        allowed=false
        for allowed_dir in "${allowed_dirs[@]}"; do
          if [ "$dir_component" = "$allowed_dir" ]; then
            allowed=true
            break
          fi
        done

        if [ "$allowed" = false ]; then
          # Only add unique violations
          if [[ ! "$violations" =~ "$dir_component" ]]; then
            violations="$violations$dir_component\n"
          fi
        fi
      done

      # Report violations
      if [ -n "$violations" ]; then
        echo "âŒ é”™è¯¯: docs-public/docs_src/dev-notes/ ä¸‹å­˜åœ¨æœªæˆæƒçš„ç›®å½•:"
        echo -e "$violations" | sort -u | sed "s/^/  - /"
        echo ""
        echo "ğŸ“ å…è®¸çš„ç›®å½•:"
        echo "  - åˆ†å±‚ç›®å½•: l1-common, l2-platform, l3-kernel, l3-libs, l4-middleware"
        echo "               l5-apps, l5-benchmark, l6-cli, l6-gateway, l6-studio, l6-tools"
        echo "  - äº¤å‰ä¸»é¢˜: cross-layer, testing, archive"
        echo "  - ç ”ç©¶å·¥ä½œ: research_work"
        echo ""
        echo "ğŸ’¡ å»ºè®®: å°†æ–‡æ¡£ç§»åŠ¨åˆ°åˆé€‚çš„ç›®å½•ï¼Œæˆ–è”ç³»ç»´æŠ¤è€…æ›´æ–°å…è®¸åˆ—è¡¨"
        exit 1
      fi
      exit 0
    language: system
    pass_filenames: false
    always_run: false
    files: ^docs-public/docs_src/dev-notes/
  - id: installation-consistency-check
    name: installation consistency check (local vs CI/CD)
    entry: bash tools/install/examination_tools/installation_consistency_check.sh
    language: system
    pass_filenames: false
    # ä»…åœ¨ä¿®æ”¹å®‰è£…ç›¸å…³æ–‡ä»¶æ—¶è¿è¡Œ
    files: ^(quickstart\.sh|tools/install/.*\.sh|packages/.*/pyproject\.toml|packages/.*/setup\.py|\.github/workflows/.*\.yml)$
    # ä¹Ÿåœ¨æ‰‹åŠ¨è¿è¡Œ pre-commit run --all-files æ—¶æ‰§è¡Œ
    stages: [pre-commit, manual]
  - id: root-directory-cleanup-check
    name: check for unwanted files/directories in project root
    entry: bash -c
    args:
    - |
      # Whitelist mode: Only allow known files/directories in project root
      # Any unexpected item will trigger a warning

      # Allowed files in project root (whitelist)
      allowed_files=(
        ".env"
        ".env.template"
        ".github_token"
        ".gitignore"
        ".gitmodules"
        ".pre-commit-config.yaml"
        ".pypirc"
        ".pyrightconfig.json"
        "codecov.yml"
        "CONTRIBUTING.md"
        "coverage.xml"
        "DEVELOPER.md"
        "LICENSE"
        "Makefile"
        "manage.sh"
        "quickstart.sh"
        "README.md"
        "CHANGELOG.md"
        "tasks.md"
      )

      # Allowed directories in project root (whitelist)
      allowed_dirs=(
        # ".benchmarks"  # Deprecated - now uses .sage/benchmarks
        ".git"
        ".github"
        ".mypy_cache"
        ".pytest_cache"
        ".ruff_cache"
        ".sage"
        ".vscode"
        "build"
        "config"
        "docker"
        "docs"
        "docs-public"
        "examples"
        "htmlcov"
        "packages"
        "tools"
      )

      violations=""

      # Check all items in project root
      for item in * .*; do
        # Skip . and ..
        [ "$item" = "." ] || [ "$item" = ".." ] && continue
        # Skip if item doesn't exist (glob didn't match)
        [ -e "$item" ] || continue

        allowed=false

        if [ -d "$item" ]; then
          # Check directories
          for allowed_dir in "${allowed_dirs[@]}"; do
            if [ "$item" = "$allowed_dir" ]; then
              allowed=true
              break
            fi
          done
        else
          # Check files
          for allowed_file in "${allowed_files[@]}"; do
            if [ "$item" = "$allowed_file" ]; then
              allowed=true
              break
            fi
          done
        fi

        if [ "$allowed" = false ]; then
          violations="$violations$item\n"
        fi
      done

      if [ -n "$violations" ]; then
        echo "âš ï¸  è­¦å‘Š: é¡¹ç›®æ ¹ç›®å½•ä¸‹å­˜åœ¨æœªæˆæƒçš„æ–‡ä»¶/ç›®å½•:"
        echo -e "$violations" | grep -v "^$" | sed "s/^/  - /"
        echo ""
        echo "ğŸ“ å¯èƒ½çš„åŸå› :"
        echo "   - è¿è¡Œè„šæœ¬/æµ‹è¯•æ—¶é”™è¯¯åˆ›å»ºçš„ä¸´æ—¶ç›®å½•"
        echo "   - ä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†"
        echo ""
        echo "ğŸ’¡ å»ºè®®:"
        echo "   - ä¸´æ—¶æ–‡ä»¶åº”æ”¾åœ¨ .sage/ ç›®å½•ä¸‹"
        echo "   - å¦‚æœæ˜¯æ–°å¢çš„åˆæ³•æ–‡ä»¶/ç›®å½•ï¼Œè¯·æ›´æ–° tools/pre-commit-config.yaml ä¸­çš„ç™½åå•"
        echo ""
        echo "ğŸ“– å‚è€ƒ: docs/dev-notes/l6-tools/CACHE_MANAGEMENT.md"
        exit 1
      fi
      exit 0
    language: system
    pass_filenames: false
    always_run: true
    stages: [pre-commit, manual]
  # Shell: shellcheck
- repo: https://github.com/shellcheck-py/shellcheck-py
  rev: v0.11.0.1
  hooks:
  - id: shellcheck
    args: [-x, -e, SC1091, -S, error]      # -x: follow sources, -e SC1091: ignore source errors, -S error: only fail on errors
    files: \.(sh|bash)$
    exclude: ^(tools/conda/|.*/benchmark_db/)

  # YAML formatting
- repo: https://github.com/macisamuele/language-formatters-pre-commit-hooks
  rev: v2.15.0
  hooks:
  - id: pretty-format-yaml
    args: [--autofix, --indent=2, --preserve-quotes]
    exclude: ^(\.github/|examples/config/|.*/benchmark_db/)

  # Markdown formatting
- repo: https://github.com/executablebooks/mdformat
  rev: 1.0.0
  hooks:
  - id: mdformat
    additional_dependencies:
    - mdformat-gfm        # GitHub Flavored Markdown
    # Note: mdformat-black is disabled because it fails on code blocks with:
    # - Template placeholders (e.g., {module_name})
    # - Special symbols in comments (e.g., âœ… âŒ)
    # - Pseudo-code or incomplete Python snippets
    # - mdformat-black        # Black formatter for code blocks
    args: [--wrap=100]
    exclude: ^(CHANGELOG.md|\.github/|docs/dev-notes/|docs-public/docs_src/api-reference/)

  # Security: Check for secrets
- repo: https://github.com/Yelp/detect-secrets
  rev: v1.5.0
  hooks:
  - id: detect-secrets
    args: [--baseline, tools/secrets.baseline]
    exclude: ^(\.env\.template|examples/config/.*\.yaml|tests/fixtures/|.*package-lock\.json$|.*\.ipynb$|docs/.*\.md$|docs-public/.*\.md$|examples/.*\.py$|packages/.*/src/sage/libs/integrations/.*\.py$|.*\.html$|packages/sage-benchmark/.*\.yaml$|packages/.*/src/.*\.md$|.*/benchmark_db/.*)

  # SAGE Data Architecture Validation
- repo: local
  hooks:
  - id: validate-data-architecture
    name: Validate SAGE Data Architecture
    entry: python tools/hooks/validate_data_architecture.py
    language: system
    pass_filenames: false
    files: ^packages/sage-benchmark/src/sage/data/(sources|usages)/.*\.(yaml|py)$
    description: Validate that datasets follow the two-layer architecture
  - id: copilot-instructions-sync-check
    name: check copilot-instructions and my-agent sync
    entry: bash tools/hooks/check_copilot_instructions_sync.sh
    language: system
    pass_filenames: false
    # Trigger on: doc files, installation scripts, CI/CD, config, ports, CLI, LLM/Gateway
    files: ^(\.github/(copilot-instructions\.md|agents/my-agent\.agent\.md|workflows/.*\.yml)|quickstart\.sh|manage\.sh|Makefile|tools/(install/.*\.sh|pre-commit-config\.yaml|pytest\.ini|ruff\.toml)|packages/sage-common/src/sage/common/config/(ports|user_paths)\.py|packages/sage-cli/src/sage/cli/|packages/sage-gateway/src/sage/gateway/|packages/sage-common/src/sage/common/components/sage_(llm|embedding)/|packages/sage-[^/]+/pyproject\.toml|config/(config|cluster)\.yaml|packages/sage-benchmark/src/sage/benchmark/)
    stages: [pre-commit, manual]
    description: Warn if critical project files change without updating copilot instructions

  # SAGE Benchmark Architecture Validation
  - id: validate-benchmark-architecture
    name: Validate SAGE Benchmark Architecture (warnings only)
    entry: python tools/hooks/validate_benchmark_architecture.py
    language: system
    pass_filenames: false
    files: ^packages/sage-(benchmark|cli)/.*\.(py)$
    description: Check that benchmarks are registered under `sage bench` CLI

# To install pre-commit hooks:
#   pre-commit install
#
# To run manually:
#   pre-commit run --all-files
#
# To update hook versions:
#   pre-commit autoupdate
#
# To skip hooks temporarily:
#   git commit --no-verify
