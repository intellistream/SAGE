#!/bin/bash
#
# Git Pre-commit Hook for SAGE Architecture Compliance
#
# åœ¨ git commit å‰è‡ªåŠ¨æ£€æŸ¥æ¶æ„åˆè§„æ€§
#
# å®‰è£…æ–¹æ³•:
#   cp tools/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# æˆ–ä½¿ç”¨ç¬¦å·é“¾æ¥:
#   ln -s ../../tools/git-hooks/pre-commit .git/hooks/pre-commit
#

set -e

echo "ğŸ” è¿è¡Œ SAGE æ¶æ„åˆè§„æ€§æ£€æŸ¥..."

# è·å–é¡¹ç›®æ ¹ç›®å½•
ROOT_DIR="$(git rev-parse --show-toplevel)"

# æ£€æŸ¥ architecture_checker.py æ˜¯å¦å­˜åœ¨
if [ ! -f "$ROOT_DIR/tools/architecture_checker.py" ]; then
    echo "âš ï¸  è­¦å‘Š: æ‰¾ä¸åˆ° architecture_checker.pyï¼Œè·³è¿‡æ£€æŸ¥"
    exit 0
fi

# è·å–æš‚å­˜çš„ Python æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "â„¹ï¸  æ²¡æœ‰ Python æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
    exit 0
fi

echo "ğŸ“ æ£€æŸ¥ $(echo "$STAGED_FILES" | wc -l) ä¸ªæš‚å­˜çš„ Python æ–‡ä»¶"

# è¿è¡Œæ¶æ„æ£€æŸ¥ï¼ˆä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶ï¼‰
if python3 "$ROOT_DIR/tools/architecture_checker.py" \
    --root "$ROOT_DIR" \
    --changed-only \
    --diff HEAD; then
    echo "âœ… æ¶æ„åˆè§„æ€§æ£€æŸ¥é€šè¿‡"
    exit 0
else
    echo ""
    echo "âŒ æ¶æ„åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼"
    echo ""
    echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åå†æäº¤ã€‚"
    echo "å¦‚æœæ‚¨ç¡®å®šè¦å¼ºåˆ¶æäº¤ï¼Œè¯·ä½¿ç”¨: git commit --no-verify"
    echo ""
    exit 1
fi
