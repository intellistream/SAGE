# SAGE 环境医生和友好错误处理系统

## 概述

SAGE 现在配备了全面的环境诊断和友好错误处理系统，旨在：
- 智能检测各种 Python 环境问题
- 提供用户友好的错误解释
- 自动修复常见环境问题
- 避免用户误解为 SAGE 本身的问题

## 功能特点

### 🔍 环境医生 (Environment Doctor)
- **全面诊断**：检测 Python、包管理器、依赖、CUDA 等各方面问题
- **智能分类**：将问题分为严重、重要、建议三个级别
- **自动修复**：对于可修复的问题提供自动解决方案
- **用户友好**：清晰的问题说明和解决建议

### 🛡️ 友好错误处理
- **智能识别**：自动识别常见的环境错误类型
- **清晰解释**：说明错误原因，强调不是 SAGE 的问题
- **解决方案**：提供多种解决方案供用户选择
- **进度显示**：安装过程中的友好进度提示

## 使用方法

### 环境诊断

```bash
# 完整诊断（推荐）
./quickstart.sh --doctor

# 诊断并自动修复
./quickstart.sh --doctor-fix

# 仅诊断，不修复
./quickstart.sh --check-only

# 直接使用环境医生
tools/install/fixes/environment_doctor.sh
```

### 常规安装
环境检查和友好错误处理已自动集成到安装流程中：

```bash
./quickstart.sh
```

## 支持的问题类型

### 依赖冲突问题
- **numpy 安装冲突**：损坏的 numpy 安装记录
- **包管理器冲突**：conda 和 pip 混合管理问题
- **版本不匹配**：PyTorch 与 numpy 版本兼容性
- **依赖解析失败**：复杂的版本要求冲突

### 环境配置问题
- **Python 版本兼容性**：不支持的 Python 版本
- **虚拟环境**：建议使用隔离环境
- **CUDA 环境**：GPU 支持检测和配置
- **磁盘空间**：安装空间不足检测

### 系统级问题
- **权限不足**：安装权限问题
- **网络连接**：PyPI 访问超时
- **受管理 Python**：系统包管理限制

## 错误处理示例

### 用户看到的友好错误信息

```
🚨 安装过程中 遇到问题
═══════════════════════════════════════════════

📋 问题类型：NumPy 安装冲突

🔍 问题说明：
这通常是由于系统中存在多个numpy版本或安装记录损坏导致的，
属于Python生态系统的常见问题

💡 重要提醒：
这不是 SAGE 本身的问题，而是 Python 环境配置相关的常见问题。
类似问题在安装其他深度学习框架时也经常遇到。

🔧 推荐解决方案：
  1. 运行 SAGE 的自动修复工具：
     ./quickstart.sh --doctor --fix
  2. 手动清理并重新安装：
     conda uninstall numpy -y
     pip uninstall numpy -y
     pip install numpy==2.3.3
  3. 使用新的虚拟环境：
     conda create -n sage-fresh python=3.11 -y
     conda activate sage-fresh
     ./quickstart.sh

🤖 自动修复：
SAGE 提供了自动诊断和修复工具，可以帮您解决大部分环境问题：
  ./quickstart.sh --doctor --fix

💡 了解更多：
  https://github.com/intellistream/SAGE/wiki/Installation-Troubleshooting
```

## 架构设计

### 核心文件结构
```
tools/install/fixes/
├── environment_doctor.sh      # 环境医生主模块
├── friendly_error_handler.sh  # 友好错误处理
└── numpy_fix.sh               # 专用 numpy 修复工具
```

### 集成点
- **quickstart.sh**：集成环境检查和医生功能
- **core_installer.sh**：集成友好错误处理
- **argument_parser.sh**：添加医生相关命令行参数

## 最佳实践

### 用户指导
1. **安装前检查**：建议用户在安装前运行 `--doctor` 检查环境
2. **问题分级**：将问题分为必须解决和建议优化两类
3. **自动修复**：优先使用自动修复，失败时提供手动方案
4. **文档链接**：提供详细的故障排除文档链接

### 开发维护
1. **模块化设计**：每个功能独立模块，便于维护
2. **错误映射**：维护错误类型到解决方案的映射表
3. **日志记录**：详细记录诊断和修复过程
4. **用户体验**：始终以用户友好为首要原则

## 技术亮点

### 智能错误检测
使用正则表达式和启发式方法自动识别错误类型，无需用户手动分类。

### 避免重复修复
使用去重机制避免对同一类型问题重复应用修复措施。

### 渐进式修复
从最简单的解决方案开始，逐步尝试更复杂的修复方案。

### 用户教育
每次错误都是教育用户的机会，解释问题根源和预防方法。

## 维护指南

### 添加新的错误类型
1. 在 `ERROR_EXPLANATIONS` 中添加错误描述
2. 在 `ERROR_CAUSES` 中添加原因说明
3. 在 `ERROR_SOLUTIONS` 中添加解决方案
4. 在 `detect_error_type` 函数中添加检测规则

### 添加新的修复功能
1. 创建修复函数
2. 在 `register_all_issues` 中注册问题和修复函数
3. 在环境医生的检查模块中添加检测逻辑

## 贡献指南

欢迎为环境医生系统贡献代码！请遵循以下原则：
- 用户友好优先
- 详细的错误说明
- 多种解决方案
- 充分的测试覆盖

---

这个系统的目标是让用户在遇到环境问题时，能够：
1. **理解问题**：清楚知道发生了什么
2. **明确责任**：知道这不是 SAGE 的问题
3. **找到解决方案**：有多种选择来解决问题
4. **获得帮助**：知道在哪里寻求进一步的帮助