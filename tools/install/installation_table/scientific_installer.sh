#!/bin/bash
# SAGE å®‰è£…è„šæœ¬ - ç§‘å­¦è®¡ç®—åŒ…å®‰è£…å™¨
# è´Ÿè´£å®‰è£…ç§‘å­¦è®¡ç®—ç›¸å…³çš„ä¾èµ–åŒ…

# å¯¼å…¥é¢œè‰²å®šä¹‰
source "$(dirname "${BASH_SOURCE[0]}")/../display_tools/colors.sh"

# å¯¼å…¥æ ¸å¿ƒå®‰è£…å™¨å‡½æ•°
source "$(dirname "${BASH_SOURCE[0]}")/core_installer.sh"

# å®‰è£…ç§‘å­¦è®¡ç®—åŒ…

# ============================================================================
# ç¯å¢ƒå˜é‡å®‰å…¨é»˜è®¤å€¼ï¼ˆé˜²æ­¢ set -u æŠ¥é”™ï¼‰
# ============================================================================
CI="${CI:-}"
GITHUB_ACTIONS="${GITHUB_ACTIONS:-}"
GITLAB_CI="${GITLAB_CI:-}"
JENKINS_URL="${JENKINS_URL:-}"
BUILDKITE="${BUILDKITE:-}"
VIRTUAL_ENV="${VIRTUAL_ENV:-}"
CONDA_DEFAULT_ENV="${CONDA_DEFAULT_ENV:-}"
SAGE_FORCE_CHINA_MIRROR="${SAGE_FORCE_CHINA_MIRROR:-}"
SAGE_DEBUG_OFFSET="${SAGE_DEBUG_OFFSET:-}"
SAGE_CUSTOM_OFFSET="${SAGE_CUSTOM_OFFSET:-}"
LANG="${LANG:-en_US.UTF-8}"
LC_ALL="${LC_ALL:-${LANG}}"
LC_CTYPE="${LC_CTYPE:-${LANG}}"
# ============================================================================

install_scientific_packages() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}  ğŸ”¬ æ­£åœ¨å®‰è£…ç§‘å­¦è®¡ç®—åº“...${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    log_info "å¼€å§‹å®‰è£…ç§‘å­¦è®¡ç®—åº“" "Scientific"

    local packages=(
        "numpy>=2.0.0,<3.0.0"  # ä¸SAGEåŒ…ä¿æŒä¸€è‡´çš„numpyç‰ˆæœ¬
        "pandas>=1.3.0"
        "matplotlib>=3.4.0"
        "scipy>=1.15.0,<2.0.0"  # ä¸SAGEåŒ…ä¿æŒä¸€è‡´çš„scipyç‰ˆæœ¬
        "jupyter>=1.0.0"
        "ipykernel>=6.0.0"
    )

    for package in "${packages[@]}"; do
        echo -e "${BOLD}  ğŸ“Š æ­£åœ¨å®‰è£… $package${NC}"
        echo -e "${DIM}è¿è¡Œå‘½ä»¤: $PIP_CMD install \"$package\"${NC}"
        echo ""

        if log_command "Scientific" "Install" "$PIP_CMD install \"$package\""; then
            log_info "$package å®‰è£…æˆåŠŸï¼" "Scientific"
            echo ""
            echo -e "${CHECK} $package å®‰è£…æˆåŠŸï¼"
            echo ""
        else
            log_warn "$package å®‰è£…å¯èƒ½å¤±è´¥ï¼Œç»§ç»­å®‰è£…å…¶ä»–åŒ…..." "Scientific"
            echo ""
            echo -e "${WARNING} $package å®‰è£…å¯èƒ½å¤±è´¥ï¼Œç»§ç»­å®‰è£…å…¶ä»–åŒ…..."
            echo ""
        fi
    done

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}  ğŸ‰ ç§‘å­¦è®¡ç®—åº“å®‰è£…å®Œæˆï¼${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    log_info "ç§‘å­¦è®¡ç®—åº“å®‰è£…å®Œæˆ" "Scientific"
}

# å®‰è£…å¯é€‰ä¾èµ–ï¼ˆå®Œæ•´å®‰è£…æ¨¡å¼ï¼‰
# åŒ…å« MLã€VDBã€streamingã€compression ç­‰é‡å‹ä¾èµ–
install_optional_packages() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}  ğŸ”§ æ­£åœ¨å®‰è£…å¯é€‰ä¾èµ–ï¼ˆå®Œæ•´å®‰è£…æ¨¡å¼ï¼‰...${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    log_info "å¼€å§‹å®‰è£…å¯é€‰ä¾èµ–" "Optional"

    # å®‰è£…å„ä¸ªå¯é€‰ä¾èµ–ç»„
    local optional_groups=(
        "isage-middleware[ml]"          # ML: transformers, sentence-transformers, accelerate
        "isage-middleware[vdb]"         # VDB: isage-vdb, faiss-cpu
        "isage-middleware[streaming]"   # Streaming: isage-flow, isage-tsdb
        "isage-middleware[compression]" # Compression: llmlingua
        "isage-kernel[ml]"              # Kernel ML: torch, torchvision
    )

    for group in "${optional_groups[@]}"; do
        echo -e "${BOLD}  ğŸ“¦ æ­£åœ¨å®‰è£… $group${NC}"
        echo -e "${DIM}è¿è¡Œå‘½ä»¤: $PIP_CMD install \"$group\"${NC}"
        echo ""

        if log_command "Optional" "Install" "$PIP_CMD install \"$group\""; then
            log_info "$group å®‰è£…æˆåŠŸï¼" "Optional"
            echo -e "${CHECK} $group å®‰è£…æˆåŠŸï¼"
        else
            log_warn "$group å®‰è£…å¤±è´¥ï¼Œç»§ç»­å®‰è£…å…¶ä»–ç»„..." "Optional"
            echo -e "${WARNING} $group å®‰è£…å¤±è´¥ï¼ˆéå…³é”®ï¼Œç»§ç»­å®‰è£…ï¼‰"
        fi
        echo ""
    done

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}  ğŸ‰ å¯é€‰ä¾èµ–å®‰è£…å®Œæˆï¼${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    log_info "å¯é€‰ä¾èµ–å®‰è£…å®Œæˆ" "Optional"
    return 0
}
