[pytest]
# pytest configuration for SAGE project

# Minimum Python version
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Configure pytest cache to use .sage directory
cache_dir = .sage/cache/pytest

# Configure pytest-benchmark to use .sage directory
benchmark_storage = .sage/benchmarks

# Test discovery paths - only include package-level tests
# When pytest is run without arguments, only collect from these paths
testpaths =
    packages/sage-kernel/tests
    packages/sage-platform/tests
    packages/sage-libs/tests
    packages/sage-common/tests
    packages/sage-middleware/tests
    packages/sage-benchmark/tests
    packages/sage-studio/tests
    packages/sage-tools/tests
    packages/sage-cli/tests
    packages/sage-gateway/tests
    packages/sage-apps/tests
    # Submodule tests (explicitly included)
    packages/sage-middleware/src/sage/middleware/components/sage_refiner/sageRefiner/tests

# Exclude problematic paths from test collection
norecursedirs =
    .git
    .tox
    dist
    build
    *.egg
    __pycache__
    .venv
    venv
    node_modules
    _deps
    vendors
    sageLLM
    .sage
    # Exclude all src directories (tests should be in tests/ only)
    src
    # Exclude examples
    examples
    # Exclude third-party algorithm implementations (DiskANN, Faiss, etc.)
    benchmark_db
    algorithms_impl
    tutorials
    # Exclude .sage temp directory
    .sage

# Add markers for test organization
markers =
    unit: Unit tests
    integration: Integration tests
    slow: Slow running tests
    skip: Skip this test (needs external dependencies)
    external: Tests that require external services or APIs
    cuda: Requires CUDA
    llm: Requires LLM/API keys
    ray: Requires Ray distributed framework

# Coverage options
addopts =
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    # Ignore entire directories with problematic tests
    --ignore=examples/tutorials/
    --ignore=packages/sage-common/src/sage/common/components/sage_llm/sageLLM/vendors/
    --ignore=packages/sage-common/src/sage/common/components/sage_llm/sageLLM/tests/
    # Ignore third-party algorithm implementation tests (DiskANN, Faiss, etc.)
    --ignore-glob=**/benchmark_db/algorithms_impl/**/test_*.py
    --ignore-glob=**/DiskANN/**/test_*.py
    --ignore-glob=**/diskann-ms/**/test_*.py
    --ignore-glob=**/faiss/**/test_*.py
    --ignore-glob=**/ipdiskann/**/test_*.py
    --ignore-glob=**/vsag/**/test_*.py
    # Don't collect from package source directories (only from tests/)
    --ignore-glob=**/src/**/*test*.py
    # Ignore .sage temporary directory
    --ignore=.sage/

# Timeout for tests (in seconds)
timeout = 300

# Console output options
console_output_style = progress

# Filter warnings
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    # Ignore SWIG-related warnings from C++ extensions
    ignore:builtin type Swig.*:DeprecationWarning
    ignore:builtin type swigvarlink.*:DeprecationWarning
