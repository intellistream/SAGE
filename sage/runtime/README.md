# Sage Runtime 模块

Sage Runtime 负责将编译后的执行图在不同平台上实际运行，提供分布式计算和本地执行能力。

## 模块架构

### 运行时基础 (`sage.runtime/`)

- **`dispatcher.py`**: 运行时调度器
  - `Dispatcher`: 核心的任务和服务调度器
  - 管理任务生命周期和执行图部署
  - 支持本地和分布式执行模式

- **`runtime_context.py`**: 运行时上下文
  - `RuntimeContext`: 运行时环境信息管理
  - 提供任务、算子和函数共享的上下文
  - 管理配置、日志和资源信息

### 通信系统 (`communication/`)
提供统一的通信框架，支持多种通信模式和数据路由。

主要组件：
- **队列系统**: 统一的队列抽象和多种队列实现
- **路由系统**: 数据包路由、连接管理和负载均衡
- **描述符系统**: 跨进程队列描述符传递

### 工厂系统 (`factory/`)
提供各种运行时组件的工厂类，负责创建和管理核心组件。

主要组件：
- **函数工厂**: 创建和管理函数实例
- **算子工厂**: 创建各种类型的算子实例
- **任务工厂**: 创建本地和远程任务实例
- **服务工厂**: 创建各种类型的服务实例

### 任务系统 (`task/`)
提供任务执行抽象，支持本地和分布式任务执行模式。

主要组件：
- **任务基类**: 统一的任务接口和生命周期管理
- **本地任务**: 本地进程内的任务执行
- **Ray任务**: 基于 Ray Actor 的分布式任务

### 服务系统 (`service/`)
提供服务任务的执行框架，支持本地和分布式服务调用。

主要组件：
- **服务任务**: 统一的服务接口和队列监听
- **服务调用器**: 同步和异步服务调用管理
- **服务发现**: 服务注册和发现机制

## 运行时架构

### 核心架构
```
┌─────────────────────────────────────┐
│             Dispatcher              │  调度器和生命周期管理
├─────────────────────────────────────┤
│    Service Layer    │  Task Layer   │  服务调用和任务执行
├─────────────────────┼───────────────┤
│ Communication Layer │ Factory Layer │  通信路由和组件创建
├─────────────────────┴───────────────┤
│         Runtime Context             │  共享运行时上下文
└─────────────────────────────────────┘
```

### 组件交互
- **Dispatcher** 负责整个执行图的部署和管理
- **RuntimeContext** 提供所有组件共享的运行时信息
- **Factory** 创建各种运行时组件实例
- **Task** 管理算子的执行和生命周期
- **Communication** 处理组件间的数据传输
- **Service** 提供服务化的调用接口

## 执行流程

1. **图解析与初始化**: Dispatcher 接收执行图并解析节点信息
2. **服务实例创建**: 根据服务节点创建服务任务实例
3. **任务实例创建**: 根据计算节点创建任务实例
4. **连接建立**: 建立任务间的数据通信连接
5. **任务启动**: 启动所有任务的工作循环
6. **数据流执行**: 任务按照数据依赖关系处理数据流
7. **停止信号处理**: 接收并处理任务的停止信号
8. **资源清理**: 清理所有任务和服务资源

## 性能优化

- **并行执行**: 支持算子级别的并行化
- **流水线处理**: 数据在管道中流式处理
- **内存管理**: 优化内存使用和垃圾回收
- **网络优化**: 减少分布式环境下的通信开销