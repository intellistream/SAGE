# Sage Runtime 模块

Sage Runtime 负责将编译后的执行图在不同平台上实际运行，提供分布式计算和本地执行能力。

## 模块架构

### 运行时基础 (`sage.runtime/`)

- **`base_runtime.py`**: 运行时基类
  - `BaseRuntime`: 所有运行时实现的基础接口
  - 定义统一的执行接口和生命周期管理

- **`runtime_manager.py`**: 运行时管理器
  - 协调不同运行时实例
  - 管理资源分配和任务调度

- **`job_manager.py`**: 作业管理
  - 管理管道执行作业的生命周期
  - 提供作业状态跟踪和控制

- **`runtime_context.py`**: 运行时上下文
  - 提供执行期间的环境信息
  - 管理配置和元数据

- **`mixed_dag.py`**: 混合执行图
  - 支持跨平台的执行图表示
  - 处理不同运行时间的协调

- **`message.py`**: 消息系统
  - 定义运行时组件间的通信协议
  - 支持分布式环境下的消息传递

### 本地运行时 (`sage.runtime/local/`)
提供单机执行能力，适用于开发和小规模数据处理。

主要组件：
- **本地 DAG 节点**: 在本地进程中执行算子
- **线程池管理**: 支持多线程并行执行
- **内存数据传输**: 高效的进程内数据交换

### 远程运行时 (`sage.runtime/remote/`)
提供分布式执行能力，基于 Ray 等分布式计算框架。

主要组件：
- **远程 DAG 节点**: 在分布式集群中执行算子
- **网络通信**: 处理跨节点的数据传输
- **资源管理**: 管理集群资源分配

### IO 系统 (`sage.runtime/io/`)
处理运行时的数据输入输出和网络通信。

主要组件：
- **发送上下文**: 管理数据的输出和路由
- **网络传输**: 处理分布式环境下的数据传输
- **序列化**: 数据的序列化和反序列化

### 监控系统 (`sage.runtime/metrics/`)
提供运行时性能监控和指标收集。

主要功能：
- **性能指标**: 收集执行时间、吞吐量等指标
- **资源监控**: 监控 CPU、内存等资源使用
- **调试支持**: 提供调试和诊断信息

## 运行时类型

### 1. 本地运行时 (Local Runtime)
```python
from sage.runtime.local import LocalThreadPool

runtime = LocalThreadPool(parallelism=4)
runtime.execute(compiled_graph)
```

**特点**：
- 单机执行，适合开发和测试
- 多线程并行处理
- 低延迟的内存数据传输

### 2. 分布式运行时 (Remote Runtime)
```python
from sage.runtime.remote import RayRuntime

runtime = RayRuntime(cluster_config="ray://head-node:10001")
runtime.execute(compiled_graph)
```

**特点**：
- 分布式集群执行
- 自动负载均衡和容错
- 适合大规模数据处理

## 执行流程

1. **图接收**: 接收编译器生成的执行图
2. **资源分配**: 根据并行度和资源需求分配计算资源
3. **节点启动**: 启动图中的所有执行节点
4. **数据流执行**: 按照数据依赖关系执行计算
5. **结果收集**: 收集执行结果和性能指标
6. **资源清理**: 释放分配的计算资源

## 性能优化

- **并行执行**: 支持算子级别的并行化
- **流水线处理**: 数据在管道中流式处理
- **内存管理**: 优化内存使用和垃圾回收
- **网络优化**: 减少分布式环境下的通信开销