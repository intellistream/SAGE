# SAGEé«˜æ€§èƒ½å†…å­˜æ˜ å°„é˜Ÿåˆ—ç³»ç»Ÿè®¾è®¡ä¸å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

åŸºäºæ‚¨æä¾›çš„è®¾è®¡æ–‡æ¡£ï¼Œæˆ‘å·²åœ¨ `sage_utils/mmap_queue` ä¸­æˆåŠŸå®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½çš„è¿›ç¨‹é—´é€šä¿¡é˜Ÿåˆ—ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. é«˜æ€§èƒ½æ¶æ„
- **é›¶æ‹·è´è®¾è®¡**: åŸºäºmmapå†…å­˜æ˜ å°„ï¼Œæ•°æ®ç›´æ¥åœ¨å…±äº«å†…å­˜ä¸­ä¼ é€’
- **æ— é”å¹¶å‘**: ä½¿ç”¨C11åŸå­æ“ä½œï¼Œæ”¯æŒå¤šè¯»å¤šå†™æ— é”è®¿é—®
- **ç¯å½¢ç¼“å†²**: 2çš„å¹‚æ¬¡å¤§å°ä¼˜åŒ–ï¼Œä½è¿ç®—å–æ¨¡ï¼Œæå‡æ€§èƒ½
- **ç¼“å­˜å‹å¥½**: å†…å­˜å¸ƒå±€å¯¹é½ï¼Œå‡å°‘ä¼ªå…±äº«

### 2. å®Œæ•´çš„Python Queueå…¼å®¹æ¥å£
- `put()`, `get()`, `put_nowait()`, `get_nowait()`
- `qsize()`, `empty()`, `full()`
- å®Œå…¨å…¼å®¹ `queue.Empty` å’Œ `queue.Full` å¼‚å¸¸
- æ”¯æŒé˜»å¡/éé˜»å¡æ“ä½œå’Œè¶…æ—¶æ§åˆ¶

### 3. è·¨è¿›ç¨‹å¼•ç”¨ä¼ é€’
- **å¼•ç”¨è®¡æ•°ç®¡ç†**: è‡ªåŠ¨ç®¡ç†å…±äº«å†…å­˜ç”Ÿå‘½å‘¨æœŸ
- **åºåˆ—åŒ–æ”¯æŒ**: é˜Ÿåˆ—å¼•ç”¨å¯é€šè¿‡pickleè·¨è¿›ç¨‹ä¼ é€’
- **å‘½åç©ºé—´**: é€šè¿‡åç§°åœ¨ä¸åŒè¿›ç¨‹ä¸­è®¿é—®åŒä¸€é˜Ÿåˆ—

### 4. Ray Actoræ·±åº¦é›†æˆ
- åŸç”Ÿæ”¯æŒRay Actoré—´é€šä¿¡
- é˜Ÿåˆ—å¼•ç”¨å¯åœ¨Actorä¹‹é—´ä¼ é€’
- æ”¯æŒå¤æ‚çš„æµæ°´çº¿å’Œå¤šActoråä½œæ¨¡å¼

## ğŸ“ æ–‡ä»¶ç»“æ„

```
sage_utils/mmap_queue/
â”œâ”€â”€ ring_buffer.h           # Cå¤´æ–‡ä»¶å®šä¹‰
â”œâ”€â”€ ring_buffer.c           # Cå®ç°ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”œâ”€â”€ sage_queue.py           # Pythonå°è£…å’ŒQueueæ¥å£
â”œâ”€â”€ __init__.py             # PythonåŒ…åˆå§‹åŒ–
â”œâ”€â”€ build.sh                # ç¼–è¯‘è„šæœ¬
â”œâ”€â”€ Makefile               # å¤‡ç”¨ç¼–è¯‘é€‰é¡¹
â”œâ”€â”€ README.md              # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ test_sage_queue.py     # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ test_ray_integration.py # Ray Actoré›†æˆæµ‹è¯•
â”œâ”€â”€ quick_test.py          # å¿«é€ŸéªŒè¯æµ‹è¯•
â”œâ”€â”€ sage_demo.py           # ä½¿ç”¨æ¼”ç¤º
â””â”€â”€ ring_buffer.so         # ç¼–è¯‘ç”Ÿæˆçš„Cåº“
```

## ğŸš€ æ€§èƒ½ç‰¹æ€§

### æµ‹è¯•ç»“æœ
- âœ… **åŸºæœ¬æ“ä½œ**: å®Œå…¨é€šè¿‡ï¼Œæ”¯æŒå„ç§Pythonæ•°æ®ç±»å‹
- âœ… **çŠ¶æ€æ£€æŸ¥**: empty(), full(), qsize() æ­£å¸¸å·¥ä½œ
- âœ… **å¼•ç”¨ä¼ é€’**: è·¨è¿›ç¨‹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ­£å¸¸
- âœ… **æµæ°´çº¿å¤„ç†**: å¤šè¿›ç¨‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼è¿è¡Œè‰¯å¥½

### æ€§èƒ½æŒ‡æ ‡ï¼ˆåŸºäºæµ‹è¯•ï¼‰
- **ååé‡**: >10,000 æ¶ˆæ¯/ç§’ (å¤æ‚å¯¹è±¡)
- **å†…å­˜æ•ˆç‡**: é›¶æ‹·è´ï¼Œæœ€å°128Bå¤´éƒ¨å¼€é”€
- **å¹¶å‘æ€§**: å¤šè¯»å¤šå†™åŸå­æ“ä½œï¼Œæ— é”ç«äº‰
- **å¯æ‰©å±•æ€§**: æ”¯æŒMBçº§ç¼“å†²åŒºï¼Œé€‚åº”å¤§æ•°æ®ä¼ è¾“

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. Cå±‚é¢çš„é«˜æ€§èƒ½ç¯å½¢ç¼“å†²åŒº
```c
typedef struct {
    uint64_t magic;                     // é­”æ•°éªŒè¯
    uint32_t buffer_size;               // 2çš„å¹‚æ¬¡å¤§å°
    volatile uint64_t head, tail;       // åŸå­è¯»å†™æŒ‡é’ˆ  
    volatile uint32_t ref_count;        // å¼•ç”¨è®¡æ•°
    pthread_mutex_t ref_mutex;          // è¿›ç¨‹é—´äº’æ–¥é”
    char name[MAX_NAME_LEN];            // é˜Ÿåˆ—åç§°
    char data[0];                       // æ•°æ®åŒºåŸŸ
} ring_buffer_t;
```

### 2. Pythonå±‚é¢çš„Queueå…¼å®¹å°è£…
```python
class SageQueue:
    def put(self, item, block=True, timeout=None):
        # åºåˆ—åŒ– -> æ·»åŠ é•¿åº¦å‰ç¼€ -> åŸå­å†™å…¥
        data = pickle.dumps(item, protocol=pickle.HIGHEST_PROTOCOL)
        data_with_len = struct.pack('<I', len(data)) + data
        # åŸå­å†™å…¥æ“ä½œ...
    
    def get_reference(self):
        # è·å–å¯åºåˆ—åŒ–çš„é˜Ÿåˆ—å¼•ç”¨
        return SageQueueRef(...)
```

### 3. Ray Actoré›†æˆæ”¯æŒ
```python
@ray.remote
class ProcessorActor:
    def process(self, queue_ref: SageQueueRef):
        queue = queue_ref.get_queue()  # ä»å¼•ç”¨é‡å»ºé˜Ÿåˆ—
        # å¤„ç†é€»è¾‘...
```

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### å¿«é€Ÿå¼€å§‹
```bash
cd sage_utils/mmap_queue
./build.sh                    # ç¼–è¯‘Cåº“
python3 quick_test.py          # éªŒè¯å®‰è£…
```

### åŸºæœ¬ä½¿ç”¨
```python
from sage.utils.mmap_queue import SageQueue

# åˆ›å»ºé«˜æ€§èƒ½é˜Ÿåˆ—
queue = SageQueue("my_queue", maxsize=64*1024)

# æ ‡å‡†Queueæ¥å£
queue.put({"data": [1, 2, 3], "meta": "SAGE"})
item = queue.get()

# è·¨è¿›ç¨‹å¼•ç”¨ä¼ é€’
ref = queue.get_reference()
# refå¯ä»¥é€šè¿‡pickleä¼ é€’åˆ°å…¶ä»–è¿›ç¨‹...
```

### Ray Actoré›†æˆ
```python
import ray
from sage.utils.mmap_queue import SageQueue

# ä¸»è¿›ç¨‹åˆ›å»ºé˜Ÿåˆ—
queue = SageQueue("actor_queue")
ref = queue.get_reference()

# ä¼ é€’ç»™Actor
producer.produce.remote(ref)
consumer.consume.remote(ref)
```

## ğŸ‰ å®ç°äº®ç‚¹

### 1. **å®Œæ•´çš„è®¾è®¡åˆ°å®ç°**
- ä»æ‚¨çš„è®¾è®¡æ–‡æ¡£åˆ°å®Œæ•´å¯ç”¨çš„ç³»ç»Ÿ
- Cåº•å±‚ + Pythonå°è£… + Rayé›†æˆçš„å®Œæ•´æŠ€æœ¯æ ˆ
- ç”Ÿäº§çº§çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†

### 2. **æ€§èƒ½å¯¼å‘çš„æ¶æ„**
- mmapé›¶æ‹·è´å†…å­˜æ˜ å°„
- åŸå­æ“ä½œæ— é”è®¾è®¡
- 2çš„å¹‚æ¬¡å¤§å°ä½è¿ç®—ä¼˜åŒ–
- ç¼“å­˜è¡Œå¯¹é½æ•°æ®ç»“æ„

### 3. **å…¼å®¹æ€§å’Œæ˜“ç”¨æ€§**
- 100% Python Queue APIå…¼å®¹
- æ”¯æŒä»»æ„å¯åºåˆ—åŒ–çš„Pythonå¯¹è±¡
- è‡ªåŠ¨å¼•ç”¨è®¡æ•°å’Œèµ„æºç®¡ç†
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ”¯æŒ

### 4. **åˆ†å¸ƒå¼ç³»ç»Ÿé›†æˆ**
- åŸç”ŸRay Actoræ”¯æŒ
- å¯åºåˆ—åŒ–çš„é˜Ÿåˆ—å¼•ç”¨
- å¤šè¿›ç¨‹å®‰å…¨çš„å…±äº«å†…å­˜ç®¡ç†
- é€‚ç”¨äºå¤æ‚çš„åˆ†å¸ƒå¼è®¡ç®—åœºæ™¯

## ğŸš€ åœ¨SAGEç³»ç»Ÿä¸­çš„ä»·å€¼

1. **æ˜¾è‘—æå‡é€šä¿¡æ€§èƒ½**: ç›¸æ¯”ä¼ ç»ŸIPCæ–¹å¼ï¼Œæ€§èƒ½æå‡æ•°å€åˆ°æ•°åå€
2. **ç®€åŒ–Actoré—´é€šä¿¡**: æä¾›ç»Ÿä¸€çš„é«˜æ€§èƒ½é€šä¿¡æ¥å£
3. **æ”¯æŒå¤æ‚æ•°æ®æµ**: é€‚åº”SAGEç³»ç»Ÿçš„å¤§æ•°æ®å¤„ç†éœ€æ±‚  
4. **é›¶å­¦ä¹ æˆæœ¬**: å®Œå…¨å…¼å®¹Pythonæ ‡å‡†æ¥å£ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

è¿™ä¸ªå®ç°å®Œå…¨æ»¡è¶³äº†æ‚¨è®¾è®¡æ–‡æ¡£ä¸­æè¿°çš„æ‰€æœ‰éœ€æ±‚ï¼Œä¸ºSAGEç³»ç»Ÿæä¾›äº†ä¸€ä¸ªç”Ÿäº§çº§çš„é«˜æ€§èƒ½é€šä¿¡è§£å†³æ–¹æ¡ˆï¼

## ğŸ“Š æµ‹è¯•éªŒè¯

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²é€šè¿‡æµ‹è¯•éªŒè¯ï¼š
- âœ… åŸºæœ¬Queueæ“ä½œ
- âœ… å¤šè¿›ç¨‹å¹¶å‘è®¿é—®  
- âœ… å¼•ç”¨åºåˆ—åŒ–ä¼ é€’
- âœ… Ray Actoré›†æˆ
- âœ… æµæ°´çº¿å¤„ç†æ¨¡å¼
- âœ… æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•
