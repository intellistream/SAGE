# RAG Pipeline with EmbeddingService
# Generated by: sage pipeline create-embedding -t rag -e hf -m BAAI/bge-small-zh-v1.5

pipeline:
  name: rag-with-embedding-service
  description: RAG pipeline powered by EmbeddingService with HuggingFace embeddings
  version: 1.0.0
  type: local

environment:
  config:
    log_level: INFO

services:
  # EmbeddingService for document and query embedding
  - name: embedding-service
    class: sage.components.sage_embedding.service.EmbeddingService
    params:
      method: hf
      model_name: BAAI/bge-small-zh-v1.5
      cache_embeddings: true
      normalize: true
      device: cuda:0

  # VLLMService for generation
  - name: vllm-service
    class: sage.common.components.sage_vllm.service.VLLMService
    params:
      model_name: Qwen/Qwen2.5-7B-Instruct
      tensor_parallel_size: 1
      gpu_memory_utilization: 0.9

  # Vector database service
  - name: vector-db
    class: sage.middleware.components.sage_db.service.SageDBService
    params:
      collection_name: rag_documents
      vector_dim: 512
      metric_type: cosine

source:
  kind: batch
  class: sage.libs.rag.loader.DirectoryLoader
  params:
    directory: ./data/documents
    file_pattern: "*.{txt,md,pdf}"
    recursive: true

stages:
  # Stage 1: Load documents
  - id: load-documents
    kind: batch
    class: sage.libs.rag.loader.DocumentLoader
    params:
      max_docs: 1000
    summary: Load documents from source

  # Stage 2: Chunk documents
  - id: chunk-documents
    kind: map
    class: sage.libs.rag.chunker.RecursiveCharacterTextSplitter
    params:
      chunk_size: 512
      chunk_overlap: 50
      separators: ["\n\n", "\n", " ", ""]
    summary: Split documents into chunks

  # Stage 3: Embed chunks using EmbeddingService
  - id: embed-chunks
    kind: service
    class: embedding-service
    params:
      batch_size: 32
      show_progress: true
    summary: Generate embeddings for chunks

  # Stage 4: Index into vector database
  - id: index-vectors
    kind: map
    class: vector-db
    params:
      operation: insert
      batch_insert: true
    summary: Index embeddings into vector store

  # Stage 5: Save index
  - id: save-index
    kind: map
    class: sage.libs.rag.storage.IndexPersister
    params:
      index_path: ./output/rag_index
    summary: Persist vector index to disk

sink:
  class: sage.libs.sinks.ConsoleSink
  params:
    format: json
    pretty: true

monitors:
  - type: metrics
    params:
      track_latency: true
      track_throughput: true

notes:
  - "This pipeline uses EmbeddingService with HuggingFace BAAI/bge-small-zh-v1.5 model"
  - "Embeddings are cached for better performance on repeated queries"
  - "Vector normalization is enabled for cosine similarity"
  - "Batch size of 32 balances throughput and memory usage"
  - "After indexing, use sage.libs.rag.retriever.VectorRetriever for queries"
