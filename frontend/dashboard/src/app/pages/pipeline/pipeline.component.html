<div class="pipeline-canvas-container">
  <div class="canvas-area" 
       #pipelineCanvasList="cdkDropList" 
       cdkDropList 
       id="pipelineCanvasList"
       [cdkDropListConnectedTo]="['operatorsList']"
       (cdkDropListDropped)="drop($event)">

    <svg [attr.width]="canvasWidth" [attr.height]="canvasHeight" class="pipeline-svg">
      <defs>
        <marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" 
                markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#555"></path>
        </marker>
      </defs>
      <!-- 边缘层 - 确保在节点下方绘制 -->
      <g class="edges-layer">
        <g *ngFor="let edge of pipelineService.edges$ | async" class="edge">
          <!-- 使用贝塞尔曲线代替直线，更美观 -->
          <path 
            [attr.d]="getEdgePath(edge)"
            stroke="#555"
            stroke-width="2"
            fill="none"
            marker-end="url(#arrowhead)"
            [attr.data-edge-id]="edge.id"
            (contextmenu)="$event.preventDefault(); showEdgeMenu($event, edge.id)"></path>
          <!-- 可选：添加边缘标签 -->
          <text 
            [attr.x]="getEdgeLabelPosition(edge).x" 
            [attr.y]="getEdgeLabelPosition(edge).y"
            text-anchor="middle"
            alignment-baseline="middle"
            class="edge-label">连接</text>
        </g>
      </g>
    
      <!-- 节点层 - 在边缘之上绘制 -->
      <g class="nodes-layer">
        <g *ngFor="let node of pipelineService.nodes$ | async; trackBy: trackByNodeId"
           [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
           [attr.data-node-id]="node.id"
           cdkDrag
           cdkDragBoundary=".canvas-area"
           (cdkDragStarted)="nodeDragStarted(node.id)"
           (cdkDragEnded)="nodeDragEnded($event, node.id)"
           (click)="nodeClicked(node.id)"
           (contextmenu)="$event.preventDefault(); showNodeMenu($event, node.id)"
           [class.selected]="node.id === selectedNodeId"
           [class.source-node]="node.isSource"
           [class.sink-node]="node.isSink"
           class="node">
          <!-- 添加SVG title元素用于悬浮提示，包含完整名称和描述 -->
          <title>{{node.fullName || node.name}}{{node.description ? '\n\n' + node.description : ''}}</title>
          <!-- 节点外圈 - 用于选中状态 -->
          <circle r="35" class="node-highlight" [class.visible]="node.id === selectedNodeId"></circle>
          <!-- 节点主体 -->
          <circle r="32" class="node-body"></circle>
          <!-- 节点类型图标 - 可选 -->
          <text x="0" y="-8" class="node-type">{{node.type}}</text>
          <!-- 节点名称 -->
          <text x="0" y="12" class="node-name">{{node.name}}</text>
        </g>
      </g>

   
    </svg>

  </div>
  
  <!-- 将菜单移到SVG外部 -->
  <!-- 节点右键菜单 -->
  <div class="node-context-menu" *ngIf="contextMenuPosition" [style.left.px]="contextMenuPosition.x" [style.top.px]="contextMenuPosition.y">
    <div class="menu-item" (click)="setAsSourceNode(contextMenuNodeId); hideNodeMenu()">
      设为源节点
    </div>
    <div class="menu-item" (click)="setAsSinkNode(contextMenuNodeId); hideNodeMenu()">
      设为终结点
    </div>
    <div class="menu-item delete-item" (click)="deleteNode(contextMenuNodeId); hideNodeMenu()">
      删除节点
    </div>
    <div class="menu-item" (click)="hideNodeMenu()">
      取消
    </div>
  </div>

  <!-- 边的右键菜单 -->
  <div class="edge-context-menu" *ngIf="edgeContextMenuPosition" [style.left.px]="edgeContextMenuPosition.x" [style.top.px]="edgeContextMenuPosition.y">
    <div class="menu-item delete-item" (click)="deleteEdge(contextMenuEdgeId); hideEdgeMenu()">
      删除连接
    </div>
    <div class="menu-item" (click)="hideEdgeMenu()">
      取消
    </div>
  </div>
</div>

<div class="control-panel">
  <!-- 添加Pipeline名称和描述输入区域 -->
  <div class="pipeline-info-inputs">
    <div class="input-group">
      <label for="pipelineName">拓扑图名称:</label>
      <input 
        type="text" 
        id="pipelineName" 
        [(ngModel)]="pipelineName" 
        placeholder="请输入拓扑图名称" 
        class="pipeline-name-input">
    </div>
    <div class="input-group">
      <label for="pipelineDesc">拓扑图描述:</label>
      <textarea 
        id="pipelineDesc" 
        [(ngModel)]="pipelineDescription" 
        placeholder="请输入拓扑图描述(可选)" 
        class="pipeline-desc-input"></textarea>
    </div>
  </div>

  <button (click)="savePipeline()" class="save-btn">保存拓扑图</button>
  <!-- 在控制面板上方添加 -->
  <div class="edge-creation-hint" *ngIf="pipelineService['firstNodeForEdge'] !== null">
    请点击目标节点完成连线
  </div>
  <button (click)="cancelEdgeCreation()" *ngIf="pipelineService['firstNodeForEdge'] !== null" class="cancel-btn">取消连线</button>
</div>