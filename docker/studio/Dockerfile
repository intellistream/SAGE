# SAGE Studio Docker Image
# åŸºäº NVIDIA CUDA é•œåƒï¼Œæ”¯æŒ GPU åŠ é€Ÿ
#
# æ„å»º: docker build -t sage-studio:latest -f docker/studio/Dockerfile .
# è¿è¡Œ: docker run -d --gpus all -p 5173:5173 -p 8888:8888 sage-studio:latest

ARG CUDA_VERSION=12.1.0
ARG UBUNTU_VERSION=22.04

FROM nvidia/cuda:${CUDA_VERSION}-runtime-ubuntu${UBUNTU_VERSION}

LABEL maintainer="SAGE Team"
LABEL description="SAGE Studio - AI/LLM Data Processing Pipeline Editor"

# é¿å…äº¤äº’å¼å®‰è£…
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Python å’Œ Node.js ç‰ˆæœ¬
ENV PYTHON_VERSION=3.11
ENV NODE_VERSION=20

# SAGE é…ç½®
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# HuggingFace é•œåƒï¼ˆä¸­å›½åŒºåŠ é€Ÿï¼‰
ENV HF_ENDPOINT=https://hf-mirror.com

# ç«¯å£é…ç½®
ENV STUDIO_PORT=5173
ENV GATEWAY_PORT=8888
ENV LLM_PORT=8901
ENV EMBEDDING_PORT=8090

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    curl \
    wget \
    git \
    build-essential \
    cmake \
    pkg-config \
    libopenblas-dev \
    liblapack-dev \
    && add-apt-repository -y ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-dev \
    python${PYTHON_VERSION}-venv \
    python${PYTHON_VERSION}-distutils \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½® Python é»˜è®¤ç‰ˆæœ¬
RUN update-alternatives --install /usr/bin/python python /usr/bin/python${PYTHON_VERSION} 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${PYTHON_VERSION} 1

# å®‰è£… pip
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python${PYTHON_VERSION}

# å®‰è£… Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰
COPY packages/sage-common/pyproject.toml packages/sage-common/
COPY packages/sage-platform/pyproject.toml packages/sage-platform/
COPY packages/sage-kernel/pyproject.toml packages/sage-kernel/
COPY packages/sage-libs/pyproject.toml packages/sage-libs/
COPY packages/sage-middleware/pyproject.toml packages/sage-middleware/
COPY packages/sage-apps/pyproject.toml packages/sage-apps/
COPY packages/sage-studio/pyproject.toml packages/sage-studio/
COPY packages/sage-gateway/pyproject.toml packages/sage-gateway/
COPY packages/sage-cli/pyproject.toml packages/sage-cli/
COPY packages/sage-tools/pyproject.toml packages/sage-tools/
COPY packages/sage/pyproject.toml packages/sage/

# å¤åˆ¶å®Œæ•´æºç 
COPY . .

# é…ç½® PyPI é•œåƒï¼ˆæ¸…åæºï¼‰
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple \
    && pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn

# å®‰è£… SAGEï¼ˆæ ‡å‡†å®‰è£…ï¼Œé editableï¼‰
# æŒ‰ä¾èµ–é¡ºåºå®‰è£…
RUN pip install ./packages/sage-common \
    && pip install ./packages/sage-platform \
    && pip install ./packages/sage-kernel \
    && pip install ./packages/sage-libs \
    && pip install ./packages/sage-middleware \
    && pip install ./packages/sage-apps \
    && pip install ./packages/sage-studio \
    && pip install ./packages/sage-gateway \
    && pip install ./packages/sage-cli \
    && pip install ./packages/sage-tools \
    && pip install ./packages/sage

# å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
WORKDIR /app/packages/sage-studio/src/sage/studio/frontend
RUN npm ci --prefer-offline \
    && npm run build \
    && mv dist /app/studio-dist

# æ¸…ç†æ„å»ºç¼“å­˜
RUN rm -rf node_modules .npm

# å›åˆ°å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting SAGE Studio..."
echo ""
echo "Configuration:"
echo "  - Studio Port: ${STUDIO_PORT:-5173}"
echo "  - Gateway Port: ${GATEWAY_PORT:-8888}"
echo "  - LLM Port: ${LLM_PORT:-8901}"
echo "  - Embedding Port: ${EMBEDDING_PORT:-8090}"
echo ""

# æ£€æŸ¥ GPU å¯ç”¨æ€§
if command -v nvidia-smi &> /dev/null; then
    echo "GPU Status:"
    nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv
    echo ""
fi

# å¯åŠ¨ Studioï¼ˆåŒ…å« Gateway + LLM + Embedding + Frontendï¼‰
exec sage studio start \
    --prod \
    --host 0.0.0.0 \
    --port ${STUDIO_PORT:-5173} \
    -y
EOF
RUN chmod +x /app/start.sh

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -sf http://localhost:${STUDIO_PORT:-5173}/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 5173 8888 8901 8090

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"]
